<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=5.0, user-scalable=yes">
    <title>THE SONGA - Library</title>
    <!-- Preconnect to critical domains -->
    <link rel="preconnect" href="https://cdnjs.cloudflare.com">
    <link rel="preconnect" href="https://www.gstatic.com">
    <link rel="preconnect" href="https://i.postimg.cc">
    <link rel="preconnect" href="https://accounts.google.com">
    
    <!-- Preload critical resources -->
    <link rel="preload" as="style" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <link rel="icon" type="image/x-icon" href="https://i.postimg.cc/BbdzCkxQ/20260116-0851-Elegant-Lion-Emblem-remix-01kf2npwbtf06ttr4htekjnd47-removebg-preview-2.webp">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <!-- Inline critical CSS -->
    <style>
        /* RESET AND BASE STYLES */
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
            -webkit-tap-highlight-color: transparent;
        }

        :root {
            --gold: #D4AF37;
            --gold-light: #F5E6B3;
            --gold-dark: #B8860B;
            --black: #000000;
            --white: #ffffff;
            --gray: #f5f5f5;
            --dark-gray: #666666;
            --light-gray: #e5e5e5;
            --accent: #25D366;
            --available: #2ecc71;
            --borrowed: #e74c3c;
            --reserved: #f39c12;
            --digital: #3498db;
            --fiction: #9b59b6;
            --non-fiction: #e67e22;
            --business: #1abc9c;
            --shadow: rgba(0, 0, 0, 0.1);
            --modal-overlay: rgba(0, 0, 0, 0.92);
            --card-shadow: 0 1px 3px rgba(0, 0, 0, 0.05);
            --hover-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
            --background: #fafafa;
            --success: #2ecc71;
            --error: #e74c3c;
            --info: #3498db;
        }

        html {
            scroll-behavior: smooth;
            font-size: 16px;
        }

        body {
            background-color: var(--background);
            color: var(--black);
            line-height: 1.5;
            overflow-x: hidden;
            -webkit-font-smoothing: antialiased;
            -moz-osx-font-smoothing: grayscale;
            padding-bottom: 80px;
            min-height: 100vh;
        }

        body.modal-open {
            overflow: hidden;
            height: 100vh;
        }

        /* SESSION STATUS */
        .session-status {
            position: fixed;
            top: 80px;
            right: 10px;
            background: var(--gold);
            color: var(--black);
            padding: 8px 12px;
            border-radius: 16px;
            font-size: 0.75rem;
            font-weight: 600;
            z-index: 9999;
            display: none;
            align-items: center;
            gap: 6px;
            box-shadow: 0 3px 10px rgba(212, 175, 55, 0.3);
            max-width: 200px;
            animation: slideIn 0.3s ease;
            backdrop-filter: blur(10px);
        }
        
        .session-status.visible {
            display: flex;
        }
        
        .session-status.restored {
            background: #2ecc71;
            color: white;
        }

        /* BACK TO TOP BUTTON */
        .back-to-top {
            position: fixed;
            bottom: 90px;
            right: 16px;
            width: 44px;
            height: 44px;
            background: linear-gradient(135deg, var(--gold), var(--gold-dark));
            border-radius: 22px;
            display: flex;
            align-items: center;
            justify-content: center;
            color: var(--black);
            cursor: pointer;
            z-index: 98;
            box-shadow: 0 3px 12px rgba(212, 175, 55, 0.3);
            transition: all 0.3s ease;
            opacity: 0;
            transform: translateY(20px);
            visibility: hidden;
            border: none;
        }

        .back-to-top.visible {
            opacity: 1;
            transform: translateY(0);
            visibility: visible;
        }

        .back-to-top:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(212, 175, 55, 0.4);
        }

        /* NOTIFICATION TOAST */
        .notification-toast {
            position: fixed;
            top: 80px;
            right: 10px;
            background: var(--black);
            color: white;
            padding: 12px 16px;
            border-radius: 12px;
            z-index: 9999;
            opacity: 0;
            transform: translateY(-20px);
            transition: all 0.3s ease;
            max-width: calc(100vw - 40px);
            box-shadow: 0 5px 20px var(--shadow);
            font-weight: 500;
            backdrop-filter: blur(10px);
            font-size: 0.85rem;
        }

        .notification-toast.show {
            opacity: 1;
            transform: translateY(0);
        }

        .notification-toast.error {
            background: linear-gradient(135deg, #e74c3c, #c0392b);
        }

        .notification-toast.success {
            background: linear-gradient(135deg, var(--gold), var(--gold-dark));
            color: var(--black);
        }

        .notification-toast.info {
            background: linear-gradient(135deg, #3498db, #2980b9);
        }

        /* BOTTOM NAVIGATION */
        .bottom-nav {
            position: fixed;
            bottom: 0;
            left: 0;
            width: 100%;
            background-color: var(--white);
            display: flex;
            justify-content: space-around;
            padding: 0.5rem 0;
            z-index: 100;
            border-top: 1px solid var(--light-gray);
            backdrop-filter: blur(20px);
            box-shadow: 0 -2px 15px rgba(0, 0, 0, 0.08);
            transition: transform 0.3s ease;
            transform: translateY(0);
        }

        .bottom-nav.hidden {
            transform: translateY(100%);
        }

        .nav-item {
            display: flex;
            flex-direction: column;
            align-items: center;
            color: var(--dark-gray);
            text-decoration: none;
            font-size: 0.7rem;
            transition: all 0.3s ease;
            position: relative;
            padding: 6px 12px;
            border-radius: 12px;
            min-width: 56px;
        }

        .nav-icon {
            font-size: 1.2rem;
            margin-bottom: 2px;
        }

        .nav-item.active {
            color: var(--gold-dark);
            background: var(--gold-light);
            font-weight: 700;
        }

        .nav-item:hover {
            color: var(--gold-dark);
        }

        .nav-badge {
            position: absolute;
            top: -5px;
            right: 0;
            background: #e74c3c;
            color: white;
            font-size: 0.6rem;
            font-weight: bold;
            width: 16px;
            height: 16px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            border: 2px solid var(--white);
        }

        /* HEADER */
        header {
            background-color: var(--white);
            color: var(--black);
            padding: 0.5rem 1rem;
            position: sticky;
            top: 0;
            z-index: 100;
            box-shadow: 0 2px 15px rgba(0, 0, 0, 0.08);
            height: 56px;
            backdrop-filter: blur(20px);
            border-bottom: none;
        }

        .header-container {
            display: flex;
            justify-content: space-between;
            align-items: center;
            height: 100%;
            max-width: 100%;
            margin: 0 auto;
        }

        .logo {
            display: flex;
            align-items: center;
            gap: 10px;
            cursor: pointer;
            text-decoration: none;
            min-width: 0;
            flex-shrink: 0;
        }

        .logo img {
            height: 36px;
            width: 36px;
            border-radius: 10px;
            object-fit: cover;
        }

        .brand-info {
            display: flex;
            flex-direction: column;
            min-width: 0;
        }

        .brand-name {
            font-weight: 800;
            font-size: 1rem;
            color: var(--gold-dark);
            letter-spacing: -0.3px;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .brand-subtitle {
            font-size: 0.6rem;
            color: var(--dark-gray);
            font-style: italic;
            letter-spacing: 0.5px;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        /* USER PROFILE */
        .auth-section {
            display: flex;
            align-items: center;
            gap: 8px;
            position: relative;
        }

        .notification-btn {
            position: relative;
            background: none;
            border: none;
            color: var(--dark-gray);
            cursor: pointer;
            font-size: 1.1rem;
            padding: 6px;
            border-radius: 50%;
            transition: all 0.3s ease;
            width: 40px;
            height: 40px;
            display: flex;
            align-items: center;
            justify-content: center;
            display: none;
        }

        .notification-btn:hover {
            background: var(--gray);
            color: var(--gold-dark);
        }

        .notification-badge {
            position: absolute;
            top: 4px;
            right: 4px;
            width: 16px;
            height: 16px;
            background: #e74c3c;
            border-radius: 50%;
            border: 2px solid var(--white);
            color: white;
            font-size: 0.6rem;
            font-weight: bold;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .user-profile {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 6px 10px;
            border-radius: 20px;
            background: var(--gold-light);
            cursor: pointer;
            position: relative;
            transition: all 0.3s ease;
            border: 1px solid transparent;
            min-width: 0;
            display: none;
        }

        .user-profile:hover {
            background: var(--gold);
            border-color: var(--gold-dark);
        }

        .user-avatar {
            width: 32px;
            height: 32px;
            border-radius: 50%;
            overflow: hidden;
            border: 2px solid var(--gold);
            flex-shrink: 0;
        }

        .user-avatar img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        .user-name {
            font-weight: 600;
            font-size: 0.85rem;
            color: var(--black);
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            max-width: 80px;
        }

        .user-dropdown {
            position: fixed;
            top: 60px;
            right: 10px;
            background: var(--white);
            border-radius: 16px;
            box-shadow: 0 8px 30px var(--shadow);
            min-width: 180px;
            z-index: 1000;
            display: none;
            overflow: hidden;
            border: 1px solid var(--light-gray);
            animation: slideDown 0.2s ease;
            max-width: calc(100vw - 20px);
        }

        .user-dropdown.active {
            display: block;
        }

        @keyframes slideDown {
            from {
                opacity: 0;
                transform: translateY(-10px) scale(0.95);
            }
            to {
                opacity: 1;
                transform: translateY(0) scale(1);
            }
        }

        .dropdown-item {
            padding: 14px 16px;
            display: flex;
            align-items: center;
            gap: 10px;
            cursor: pointer;
            transition: background-color 0.2s;
            border-bottom: 1px solid var(--light-gray);
            color: var(--dark-gray);
            font-size: 0.9rem;
        }

        .dropdown-item:last-child {
            border-bottom: none;
        }

        .dropdown-item:hover {
            background-color: var(--gold-light);
            color: var(--black);
        }

        .dropdown-item i {
            width: 18px;
            text-align: center;
            color: var(--gold-dark);
            font-size: 0.95rem;
            flex-shrink: 0;
        }

        /* MAIN CONTENT */
        .container {
            max-width: 100%;
            margin: 0 auto;
            padding: 0.75rem 1rem;
            padding-bottom: 1rem;
        }

        /* LIBRARY HEADER */
        .library-header {
            margin: 1.5rem 0 1rem 0;
        }

        .library-title {
            font-size: 1.8rem;
            color: var(--gold-dark);
            font-weight: 800;
            margin-bottom: 0.5rem;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .inner-circle-badge {
            display: inline-block;
            background: linear-gradient(135deg, var(--gold), var(--gold-dark));
            color: var(--black);
            padding: 4px 10px;
            border-radius: 12px;
            font-size: 0.7rem;
            font-weight: 700;
            white-space: nowrap;
        }

        .library-subtitle {
            color: var(--dark-gray);
            font-size: 0.9rem;
            line-height: 1.4;
            margin-bottom: 1rem;
        }

        /* READING STATS */
        .reading-stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(140px, 1fr));
            gap: 0.75rem;
            margin-bottom: 1.5rem;
        }

        .stat-card {
            background: var(--white);
            border-radius: 16px;
            padding: 1rem;
            box-shadow: var(--card-shadow);
            text-align: center;
            border: none;
        }

        .stat-icon {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background: var(--gold-light);
            display: flex;
            align-items: center;
            justify-content: center;
            margin: 0 auto 0.75rem;
            color: var(--gold-dark);
            font-size: 1rem;
        }

        .stat-number {
            font-size: 1.5rem;
            font-weight: 800;
            color: var(--gold-dark);
            margin-bottom: 0.25rem;
        }

        .stat-label {
            font-size: 0.75rem;
            color: var(--dark-gray);
            font-weight: 600;
        }

        /* SEARCH BAR */
        .search-container {
            margin: 1rem 0 1.5rem;
        }

        .search-box {
            display: flex;
            align-items: center;
            background: white;
            border-radius: 16px;
            padding: 12px 16px;
            border: 1.5px solid var(--light-gray);
            transition: all 0.3s ease;
        }

        .search-box:focus-within {
            border-color: var(--gold);
            box-shadow: 0 0 0 3px rgba(212, 175, 55, 0.1);
        }

        .search-box i {
            color: var(--dark-gray);
            margin-right: 10px;
            font-size: 1rem;
        }

        .search-box input {
            border: none;
            background: transparent;
            outline: none;
            width: 100%;
            font-size: 0.9rem;
            color: var(--black);
        }

        .search-box input::placeholder {
            color: var(--dark-gray);
        }

        /* FILTERS SECTION */
        .filters-section {
            background: white;
            border-radius: 16px;
            padding: 1.25rem;
            margin-bottom: 1.5rem;
            box-shadow: var(--card-shadow);
            border: none;
        }

        .filter-tabs {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
            margin-bottom: 1.25rem;
        }

        .filter-tab {
            padding: 8px 16px;
            border: 1.5px solid var(--light-gray);
            background: white;
            border-radius: 20px;
            cursor: pointer;
            font-weight: 600;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            gap: 6px;
            font-size: 0.8rem;
            white-space: nowrap;
        }

        .filter-tab.active {
            background: var(--gold);
            border-color: var(--gold);
            color: var(--black);
        }

        .filter-tab:hover:not(.active) {
            border-color: var(--gold);
            color: var(--gold-dark);
        }

        .filter-tab .count {
            background: var(--white);
            color: var(--black);
            padding: 2px 6px;
            border-radius: 10px;
            font-size: 0.7rem;
            margin-left: 2px;
        }

        .filter-tab.active .count {
            background: var(--black);
            color: var(--gold);
        }

        .filter-controls {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 1rem;
        }

        .filter-group {
            display: flex;
            flex-direction: column;
            gap: 0.5rem;
        }

        .filter-group label {
            font-weight: 600;
            color: var(--dark-gray);
            font-size: 0.8rem;
            display: flex;
            align-items: center;
            gap: 6px;
        }

        .filter-group select {
            padding: 10px 12px;
            border: 1.5px solid var(--light-gray);
            border-radius: 12px;
            font-size: 0.85rem;
            outline: none;
            background: white;
            transition: all 0.3s ease;
            -webkit-appearance: none;
            -moz-appearance: none;
            appearance: none;
            background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='16' height='16' viewBox='0 0 24 24' fill='none' stroke='%23666' stroke-width='2' stroke-linecap='round' stroke-linejoin='round'%3E%3Cpath d='M6 9l6 6 6-6'/%3E%3C/svg%3E");
            background-repeat: no-repeat;
            background-position: right 12px center;
            background-size: 16px;
            padding-right: 36px;
        }

        .filter-group select:focus {
            border-color: var(--gold);
            box-shadow: 0 0 0 3px rgba(212, 175, 55, 0.1);
        }

        /* CATEGORY BADGES */
        .category-badges {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
            margin-bottom: 1.5rem;
            padding-bottom: 0.5rem;
            overflow-x: auto;
            -webkit-overflow-scrolling: touch;
            scrollbar-width: none;
        }

        .category-badges::-webkit-scrollbar {
            display: none;
        }

        .category-badge {
            padding: 8px 16px;
            border: 1.5px solid var(--light-gray);
            background: white;
            border-radius: 20px;
            cursor: pointer;
            font-weight: 600;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            gap: 6px;
            font-size: 0.8rem;
            white-space: nowrap;
        }

        .category-badge.active {
            background: var(--gold);
            border-color: var(--gold);
            color: var(--black);
        }

        .category-badge:hover:not(.active) {
            border-color: var(--gold);
            color: var(--gold-dark);
        }

        /* LIBRARY GRID */
        .library-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
            gap: 1rem;
            margin-bottom: 2rem;
        }

        /* BOOK CARD */
        .book-card {
            background: var(--white);
            border-radius: 16px;
            overflow: hidden;
            box-shadow: var(--card-shadow);
            transition: all 0.3s ease;
            position: relative;
            border: none;
        }

        .book-card:hover {
            transform: translateY(-4px);
            box-shadow: var(--hover-shadow);
        }

        .book-card.featured {
            border: 2px solid var(--gold);
        }

        .featured-badge {
            position: absolute;
            top: 12px;
            right: 12px;
            background: var(--gold);
            color: var(--black);
            padding: 6px 10px;
            border-radius: 20px;
            font-size: 0.7rem;
            font-weight: 700;
            z-index: 2;
            display: flex;
            align-items: center;
            gap: 4px;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
        }

        .availability-badge {
            position: absolute;
            top: 12px;
            left: 12px;
            padding: 6px 10px;
            border-radius: 20px;
            font-size: 0.7rem;
            font-weight: 700;
            z-index: 2;
            color: white;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
        }

        .available {
            background: var(--available);
        }

        .borrowed {
            background: var(--borrowed);
        }

        .reserved {
            background: var(--reserved);
        }

        .digital-only {
            background: var(--digital);
        }

        .book-cover {
            height: 200px;
            width: 100%;
            overflow: hidden;
            position: relative;
        }

        .book-cover img {
            width: 100%;
            height: 100%;
            object-fit: cover;
            transition: transform 0.5s ease;
        }

        .book-card:hover .book-cover img {
            transform: scale(1.05);
        }

        .book-content {
            padding: 1.25rem;
        }

        .book-category {
            display: inline-block;
            padding: 4px 10px;
            border-radius: 12px;
            font-size: 0.7rem;
            font-weight: 700;
            margin-bottom: 0.75rem;
            background: var(--gold-light);
            color: var(--gold-dark);
        }

        .book-title {
            font-size: 1.1rem;
            color: var(--black);
            margin-bottom: 0.5rem;
            line-height: 1.3;
            font-weight: 700;
        }

        .book-author {
            color: var(--dark-gray);
            font-size: 0.85rem;
            margin-bottom: 0.75rem;
        }

        .book-meta {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 0.75rem;
            font-size: 0.8rem;
            color: var(--dark-gray);
        }

        .book-rating {
            display: flex;
            align-items: center;
            gap: 4px;
        }

        .stars {
            color: var(--gold);
        }

        .rating-value {
            font-weight: 600;
        }

        .book-actions {
            display: flex;
            gap: 8px;
            margin-top: 1rem;
            padding-top: 1rem;
            border-top: 1px solid var(--light-gray);
        }

        .book-action-btn {
            padding: 8px 16px;
            border-radius: 12px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            font-size: 0.8rem;
            border: none;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 6px;
            flex: 1;
        }

        .borrow-btn {
            background: linear-gradient(135deg, var(--gold), var(--gold-dark));
            color: var(--black);
        }

        .borrow-btn:hover:not(:disabled) {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(212, 175, 55, 0.3);
        }

        .borrow-btn:disabled {
            opacity: 0.6;
            cursor: not-allowed;
        }

        .details-btn {
            background: var(--gray);
            color: var(--dark-gray);
            border: 1.5px solid var(--light-gray);
        }

        .details-btn:hover {
            background: var(--light-gray);
            transform: translateY(-2px);
        }

        /* MY BOOKS SECTION */
        .my-books-section {
            margin: 2rem 0;
            display: none;
        }

        .section-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1rem;
        }

        .section-title {
            font-size: 1.2rem;
            color: var(--gold-dark);
            font-weight: 700;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .view-all-btn {
            background: var(--gold-light);
            color: var(--gold-dark);
            border: none;
            padding: 8px 12px;
            border-radius: 12px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            font-size: 0.8rem;
            display: flex;
            align-items: center;
            gap: 6px;
        }

        .view-all-btn:hover {
            background: var(--gold);
            transform: translateY(-2px);
        }

        .borrowed-books {
            display: grid;
            gap: 1rem;
        }

        .borrowed-book-card {
            background: white;
            border-radius: 12px;
            padding: 1rem;
            display: flex;
            gap: 1rem;
            align-items: center;
            border: 1.5px solid var(--gold-light);
        }

        .borrowed-book-cover {
            width: 60px;
            height: 80px;
            border-radius: 8px;
            overflow: hidden;
            flex-shrink: 0;
        }

        .borrowed-book-cover img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        .borrowed-book-info {
            flex: 1;
            min-width: 0;
        }

        .borrowed-book-title {
            font-weight: 700;
            color: var(--black);
            margin-bottom: 0.25rem;
            font-size: 0.9rem;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .due-date {
            color: var(--borrowed);
            font-weight: 600;
            font-size: 0.75rem;
            display: flex;
            align-items: center;
            gap: 4px;
        }

        .borrowed-actions {
            display: flex;
            gap: 8px;
        }

        .renew-btn {
            background: var(--gold-light);
            color: var(--gold-dark);
            border: none;
            padding: 6px 12px;
            border-radius: 8px;
            font-weight: 600;
            cursor: pointer;
            font-size: 0.75rem;
            transition: all 0.3s ease;
        }

        .renew-btn:hover:not(:disabled) {
            background: var(--gold);
            transform: translateY(-2px);
        }

        .renew-btn:disabled {
            opacity: 0.6;
            cursor: not-allowed;
        }

        /* MODALS */
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: var(--modal-overlay);
            z-index: 2000;
            justify-content: center;
            align-items: center;
            padding: 1rem;
            backdrop-filter: blur(10px);
        }

        .modal.active {
            display: flex;
        }

        .modal-content {
            background-color: var(--white);
            border-radius: 16px;
            width: 100%;
            max-width: 500px;
            max-height: 85vh;
            overflow: hidden;
            display: flex;
            flex-direction: column;
            animation: slideUp 0.3s ease;
        }

        @keyframes slideUp {
            from {
                transform: translateY(50px);
                opacity: 0;
            }
            to {
                transform: translateY(0);
                opacity: 1;
            }
        }

        .modal-header {
            background: linear-gradient(135deg, var(--gold), var(--gold-dark));
            color: var(--black);
            padding: 1.5rem;
            text-align: center;
            position: relative;
            flex-shrink: 0;
        }

        .modal-header h2 {
            font-size: 1.5rem;
            font-weight: 800;
            letter-spacing: -0.3px;
        }

        .close-modal {
            position: absolute;
            top: 1rem;
            right: 1rem;
            background: rgba(0, 0, 0, 0.15);
            border: none;
            color: var(--black);
            width: 36px;
            height: 36px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            font-size: 1.4rem;
            transition: all 0.3s ease;
            z-index: 10;
        }

        .close-modal:hover {
            background: rgba(0, 0, 0, 0.25);
            transform: rotate(90deg);
        }

        .modal-body {
            padding: 1.5rem;
            flex: 1;
            overflow-y: auto;
            -webkit-overflow-scrolling: touch;
        }

        /* SIGNIN MODAL */
        .signin-modal .modal-content {
            max-width: 420px;
        }

        .signin-body {
            text-align: center;
        }

        .signin-body p {
            margin-bottom: 1.5rem;
            color: var(--dark-gray);
            line-height: 1.5;
        }

        .google-signin-container {
            margin: 1.5rem 0;
            display: flex;
            justify-content: center;
        }

        .g_id_signin {
            margin: 0 auto;
        }

        .signin-footer {
            font-size: 0.75rem;
            color: var(--dark-gray);
            margin-top: 1.5rem;
            padding-top: 1rem;
            border-top: 1px solid var(--light-gray);
            line-height: 1.4;
        }

        /* BOOK DETAILS MODAL */
        .book-details-content {
            display: flex;
            flex-direction: column;
            gap: 1.5rem;
        }

        .book-cover-large {
            width: 100%;
            height: 250px;
            border-radius: 12px;
            overflow: hidden;
            margin-bottom: 1rem;
        }

        .book-cover-large img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        .book-info {
            display: flex;
            flex-direction: column;
            gap: 1rem;
        }

        .book-meta-large {
            display: flex;
            flex-wrap: wrap;
            gap: 1rem;
            margin-bottom: 0.5rem;
        }

        .book-meta-item {
            display: flex;
            align-items: center;
            gap: 6px;
            font-size: 0.85rem;
            color: var(--dark-gray);
        }

        .book-meta-item i {
            color: var(--gold-dark);
        }

        .book-description {
            color: var(--dark-gray);
            line-height: 1.5;
            font-size: 0.9rem;
        }

        .book-tags {
            display: flex;
            flex-wrap: wrap;
            gap: 6px;
            margin-top: 1rem;
        }

        .book-tag {
            background: var(--gold-light);
            color: var(--gold-dark);
            padding: 4px 10px;
            border-radius: 16px;
            font-size: 0.75rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            border: none;
        }

        .book-tag:hover {
            background: var(--gold);
            transform: translateY(-1px);
        }

        .book-availability {
            background: var(--gray);
            border-radius: 12px;
            padding: 1rem;
            margin-top: 1rem;
        }

        .availability-status {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 0.75rem;
        }

        .status-label {
            font-weight: 600;
            color: var(--dark-gray);
            font-size: 0.9rem;
        }

        .status-value {
            padding: 6px 12px;
            border-radius: 20px;
            font-weight: 700;
            font-size: 0.8rem;
            color: white;
        }

        .status-available {
            background: var(--available);
        }

        .status-borrowed {
            background: var(--borrowed);
        }

        .status-reserved {
            background: var(--reserved);
        }

        .status-digital {
            background: var(--digital);
        }

        .book-actions-large {
            display: flex;
            gap: 0.75rem;
            margin-top: 1.5rem;
        }

        .book-action-btn-large {
            padding: 12px 20px;
            border-radius: 12px;
            font-weight: 700;
            cursor: pointer;
            transition: all 0.3s ease;
            font-size: 0.9rem;
            border: none;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            flex: 1;
        }

        .borrow-large-btn {
            background: linear-gradient(135deg, var(--gold), var(--gold-dark));
            color: var(--black);
        }

        .borrow-large-btn:hover:not(:disabled) {
            transform: translateY(-2px);
            box-shadow: 0 6px 15px rgba(212, 175, 55, 0.3);
        }

        .borrow-large-btn:disabled {
            opacity: 0.6;
            cursor: not-allowed;
        }

        .wishlist-btn {
            background: var(--gray);
            color: var(--dark-gray);
            border: 1.5px solid var(--light-gray);
        }

        .wishlist-btn:hover {
            background: var(--light-gray);
            transform: translateY(-2px);
        }

        /* BORROW MODAL */
        .borrow-details {
            background: var(--gray);
            border-radius: 12px;
            padding: 1.25rem;
            margin-bottom: 1.25rem;
        }

        .borrow-detail-item {
            display: flex;
            justify-content: space-between;
            margin-bottom: 0.75rem;
            font-size: 0.9rem;
        }

        .borrow-detail-label {
            font-weight: 600;
            color: var(--dark-gray);
        }

        .borrow-detail-value {
            color: var(--black);
            text-align: right;
        }

        .borrow-terms {
            font-size: 0.8rem;
            color: var(--dark-gray);
            line-height: 1.4;
            margin-top: 1.25rem;
            padding-top: 1.25rem;
            border-top: 1px solid var(--light-gray);
        }

        .borrow-modal-footer {
            display: flex;
            gap: 0.75rem;
            margin-top: 1.5rem;
        }

        .confirm-borrow-btn {
            background: linear-gradient(135deg, var(--gold), var(--gold-dark));
            color: var(--black);
            border: none;
            padding: 12px 20px;
            border-radius: 12px;
            font-weight: 700;
            cursor: pointer;
            transition: all 0.3s ease;
            font-size: 0.9rem;
            flex: 1;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
        }

        .confirm-borrow-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 15px rgba(212, 175, 55, 0.3);
        }

        .cancel-borrow-btn {
            background: var(--gray);
            color: var(--dark-gray);
            border: 1.5px solid var(--light-gray);
            padding: 12px 20px;
            border-radius: 12px;
            font-weight: 700;
            cursor: pointer;
            transition: all 0.3s ease;
            font-size: 0.9rem;
            flex: 1;
        }

        .cancel-borrow-btn:hover {
            background: var(--light-gray);
            transform: translateY(-2px);
        }

        /* LOADING AND EMPTY STATES */
        .loading {
            text-align: center;
            padding: 3rem 1rem;
            color: var(--gold-dark);
            grid-column: 1 / -1;
        }

        .loading-spinner {
            border: 3px solid var(--gold-light);
            border-top: 3px solid var(--gold);
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
            margin: 0 auto 1rem;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .empty-state {
            text-align: center;
            padding: 3rem 1rem;
            color: var(--dark-gray);
            grid-column: 1 / -1;
        }

        .empty-state i {
            font-size: 2.5rem;
            margin-bottom: 1rem;
            color: var(--gold-light);
        }

        .empty-state h3 {
            font-size: 1.3rem;
            margin-bottom: 0.5rem;
            color: var(--black);
            font-weight: 700;
        }

        /* UTILITY CLASSES */
        .hidden {
            display: none !important;
        }

        /* RESPONSIVE */
        @media (min-width: 768px) {
            .container {
                max-width: 600px;
                padding: 1rem 1.5rem;
            }
            
            .library-grid {
                grid-template-columns: repeat(auto-fill, minmax(320px, 1fr));
                gap: 1.25rem;
            }
            
            .book-cover {
                height: 220px;
            }
            
            .modal-content {
                border-radius: 20px;
            }
            
            .modal-header {
                border-radius: 20px 20px 0 0;
            }
            
            .book-cover-large {
                height: 300px;
            }
        }

        @media (max-width: 480px) {
            .library-grid {
                grid-template-columns: 1fr;
            }
            
            .book-actions-large {
                flex-direction: column;
            }
            
            .borrow-modal-footer {
                flex-direction: column;
            }
            
            .filter-controls {
                grid-template-columns: 1fr;
            }
        }

        /* SCROLLBAR STYLING */
        .modal-body::-webkit-scrollbar {
            width: 6px;
        }

        .modal-body::-webkit-scrollbar-track {
            background: transparent;
        }

        .modal-body::-webkit-scrollbar-thumb {
            background: var(--gold-light);
            border-radius: 3px;
        }

        .modal-body::-webkit-scrollbar-thumb:hover {
            background: var(--gold);
        }
    </style>
</head>
<body>
    <!-- Session Status Indicator -->
    <div class="session-status" id="sessionStatus">
        <i class="fas fa-check-circle"></i>
        <span>Session restored</span>
    </div>

    <!-- Back to Top Button -->
    <button class="back-to-top" id="backToTop">
        <i class="fas fa-arrow-up"></i>
    </button>

    <!-- Notification Toast -->
    <div class="notification-toast" id="notificationToast"></div>

    <!-- Sign In Modal -->
    <div class="modal signin-modal" id="signinModal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>Join THE SONGA Library</h2>
                <p>UNBOUND | UNBENT | UNBROKEN</p>
                <button class="close-modal" id="closeSigninModal">&times;</button>
            </div>
            <div class="modal-body signin-body">
                <p>Sign in to access our library, borrow books, track your reading, and join reading groups.</p>
                
                <div class="google-signin-container">
                    <div id="g_id_onload"
                         data-client_id="123922889572-9dmjivsoese0b0o78poo5mgu7nqqm6e6.apps.googleusercontent.com"
                         data-context="signin"
                         data-ux_mode="popup"
                         data-callback="handleGoogleSignIn"
                         data-auto_prompt="false">
                    </div>
                    <div class="g_id_signin"
                         data-type="standard"
                         data-shape="rectangular"
                         data-theme="outline"
                         data-text="signin_with"
                         data-size="large"
                         data-logo_alignment="left">
                    </div>
                </div>
                
                <div class="signin-footer">
                    By signing in, you agree to our community guidelines and membership terms.
                </div>
            </div>
        </div>
    </div>

    <!-- Book Details Modal -->
    <div class="modal" id="bookModal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 id="bookModalTitle">Book Title</h2>
                <p id="bookModalAuthor">by Author Name</p>
                <button class="close-modal" id="closeBookModal">&times;</button>
            </div>
            <div class="modal-body">
                <div class="book-details-content">
                    <div class="book-cover-large">
                        <img id="bookModalCover" src="" alt="Book Cover">
                    </div>
                    
                    <div class="book-info">
                        <div class="book-meta-large">
                            <div class="book-meta-item">
                                <i class="fas fa-star"></i>
                                <span id="bookModalRating">4.5</span>
                            </div>
                            <div class="book-meta-item">
                                <i class="fas fa-book"></i>
                                <span id="bookModalPages">320 pages</span>
                            </div>
                            <div class="book-meta-item">
                                <i class="fas fa-calendar"></i>
                                <span id="bookModalYear">2023</span>
                            </div>
                        </div>
                        
                        <div class="book-description" id="bookModalDescription">
                            Book description will appear here...
                        </div>
                        
                        <div class="book-tags" id="bookModalTags">
                            <!-- Tags will be populated here -->
                        </div>
                        
                        <div class="book-availability">
                            <div class="availability-status">
                                <span class="status-label">Availability:</span>
                                <span class="status-value" id="bookModalStatus">Available</span>
                            </div>
                            <div id="bookModalAvailabilityDetails">
                                <!-- Availability details will be populated here -->
                            </div>
                        </div>
                        
                        <div class="book-actions-large">
                            <button class="book-action-btn-large borrow-large-btn" id="borrowFromModalBtn">
                                <i class="fas fa-book-reader"></i> Borrow Book
                            </button>
                            <button class="book-action-btn-large wishlist-btn" id="addToWishlistBtn">
                                <i class="far fa-heart"></i> Wishlist
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Borrow Confirmation Modal -->
    <div class="modal" id="borrowModal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>Borrow Book</h2>
                <p id="borrowBookTitle">Book Title</p>
                <button class="close-modal" id="closeBorrowModal">&times;</button>
            </div>
            <div class="modal-body">
                <div class="borrow-details">
                    <div class="borrow-detail-item">
                        <span class="borrow-detail-label">Book:</span>
                        <span class="borrow-detail-value" id="borrowBookName"></span>
                    </div>
                    <div class="borrow-detail-item">
                        <span class="borrow-detail-label">Author:</span>
                        <span class="borrow-detail-value" id="borrowBookAuthor"></span>
                    </div>
                    <div class="borrow-detail-item">
                        <span class="borrow-detail-label">Borrow Period:</span>
                        <span class="borrow-detail-value" id="borrowPeriod">14 days</span>
                    </div>
                    <div class="borrow-detail-item">
                        <span class="borrow-detail-label">Due Date:</span>
                        <span class="borrow-detail-value" id="borrowDueDate"></span>
                    </div>
                    <div class="borrow-detail-item">
                        <span class="borrow-detail-label">Pickup Location:</span>
                        <span class="borrow-detail-value" id="borrowLocation">THE SONGA Library</span>
                    </div>
                </div>
                
                <div class="borrow-terms">
                    <p><strong>Borrowing Terms:</strong></p>
                    <p>• Return books on or before due date</p>
                    <p>• Late returns incur daily fines of KSh 50</p>
                    <p>• Maximum 2 renewals per book</p>
                    <p>• Handle books with care, no writing/damage</p>
                    <p>• Report lost books immediately</p>
                </div>
                
                <div class="borrow-modal-footer">
                    <button class="cancel-borrow-btn" id="cancelBorrowBtn">Cancel</button>
                    <button class="confirm-borrow-btn" id="confirmBorrowBtn">
                        <i class="fas fa-check-circle"></i> Confirm Borrow
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Header -->
    <header>
        <div class="header-container">
            <div class="logo" id="logo">
                <img src="https://i.postimg.cc/BbdzCkxQ/20260116-0851-Elegant-Lion-Emblem-remix-01kf2npwbtf06ttr4htekjnd47-removebg-preview-2.webp" alt="THE SONGA Logo">
                <div class="brand-info">
                    <div class="brand-name">THE SONGA</div>
                    <div class="brand-subtitle">UNBOUND | UNBENT | UNBROKEN</div>
                </div>
            </div>
            
            <div class="auth-section">
                <div class="notification-btn" id="notificationBtn">
                    <i class="fas fa-bell"></i>
                    <div class="notification-badge hidden" id="notificationBadge"></div>
                </div>
                
                <div id="userProfile" class="user-profile">
                    <div class="user-avatar">
                        <img id="userAvatar" src="" alt="User Avatar">
                    </div>
                    <div class="user-name" id="userDisplayName"></div>
                    <div class="user-dropdown" id="userDropdown">
                        <div class="dropdown-item" id="myBooksOption">
                            <i class="fas fa-book"></i>
                            <span>My Books</span>
                        </div>
                        <div class="dropdown-item" id="myWishlistOption">
                            <i class="fas fa-heart"></i>
                            <span>My Wishlist</span>
                        </div>
                        <div class="dropdown-item" id="readingHistoryOption">
                            <i class="fas fa-history"></i>
                            <span>Reading History</span>
                        </div>
                        <div class="dropdown-item" id="signOutOption">
                            <i class="fas fa-sign-out-alt"></i>
                            <span>Sign Out</span>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </header>

    <!-- Main Content -->
    <main class="container">
        <div class="library-header">
            <h1 class="library-title">
                Knowledge Library
                <span class="inner-circle-badge">Inner Circle</span>
            </h1>
            <p class="library-subtitle">
                Access our curated collection of books and articles on personal growth, business, 
                finance, and spirituality. Expand your knowledge with THE SONGA.
            </p>
        </div>

        <!-- Reading Stats -->
        <div class="reading-stats" id="readingStats" style="display: none;">
            <div class="stat-card">
                <div class="stat-icon">
                    <i class="fas fa-book-reader"></i>
                </div>
                <div class="stat-number" id="booksRead">0</div>
                <div class="stat-label">Books Read</div>
            </div>
            <div class="stat-card">
                <div class="stat-icon">
                    <i class="fas fa-fire"></i>
                </div>
                <div class="stat-number" id="readingStreak">0</div>
                <div class="stat-label">Day Streak</div>
            </div>
            <div class="stat-card">
                <div class="stat-icon">
                    <i class="fas fa-clock"></i>
                </div>
                <div class="stat-number" id="readingTime">0h</div>
                <div class="stat-label">Reading Time</div>
            </div>
            <div class="stat-card">
                <div class="stat-icon">
                    <i class="fas fa-award"></i>
                </div>
                <div class="stat-number" id="achievements">0</div>
                <div class="stat-label">Achievements</div>
            </div>
        </div>

        <!-- Search Bar -->
        <div class="search-container">
            <div class="search-box">
                <i class="fas fa-search"></i>
                <input type="text" placeholder="Search books, authors, topics..." id="searchInput">
            </div>
        </div>

        <!-- Category Badges -->
        <div class="category-badges" id="categoryBadges">
            <button class="category-badge active" data-category="all">
                <i class="fas fa-th-large"></i> All
            </button>
            <button class="category-badge" data-category="business">
                <i class="fas fa-briefcase"></i> Business
            </button>
            <button class="category-badge" data-category="finance">
                <i class="fas fa-chart-line"></i> Finance
            </button>
            <button class="category-badge" data-category="personal-growth">
                <i class="fas fa-brain"></i> Personal Growth
            </button>
            <button class="category-badge" data-category="spirituality">
                <i class="fas fa-yin-yang"></i> Spirituality
            </button>
            <button class="category-badge" data-category="fiction">
                <i class="fas fa-theater-masks"></i> Fiction
            </button>
        </div>

        <!-- Filters Section -->
        <div class="filters-section">
            <div class="filter-tabs" id="filterTabs">
                <button class="filter-tab active" data-filter="all">
                    All Books
                    <span class="count" id="countAll">0</span>
                </button>
                <button class="filter-tab" data-filter="available">
                    <i class="fas fa-check-circle"></i> Available
                    <span class="count" id="countAvailable">0</span>
                </button>
                <button class="filter-tab" data-filter="featured">
                    <i class="fas fa-star"></i> Featured
                    <span class="count" id="countFeatured">0</span>
                </button>
                <button class="filter-tab" data-filter="new">
                    <i class="fas fa-newspaper"></i> New Arrivals
                    <span class="count" id="countNew">0</span>
                </button>
            </div>
            
            <div class="filter-controls">
                <div class="filter-group">
                    <label for="sortFilter"><i class="fas fa-sort"></i> Sort By</label>
                    <select id="sortFilter">
                        <option value="popularity">Most Popular</option>
                        <option value="title">Title A-Z</option>
                        <option value="author">Author A-Z</option>
                        <option value="rating">Highest Rated</option>
                        <option value="date-added">Recently Added</option>
                    </select>
                </div>
                
                <div class="filter-group">
                    <label for="formatFilter"><i class="fas fa-book"></i> Format</label>
                    <select id="formatFilter">
                        <option value="all">All Formats</option>
                        <option value="physical">Physical Books</option>
                        <option value="digital">Digital Books</option>
                    </select>
                </div>
            </div>
        </div>

        <!-- My Books Section -->
        <div class="my-books-section" id="myBooksSection">
            <div class="section-header">
                <h3 class="section-title">
                    <i class="fas fa-bookmark"></i> My Borrowed Books
                </h3>
                <button class="view-all-btn" onclick="viewAllBorrowedBooks()">
                    View All <i class="fas fa-arrow-right"></i>
                </button>
            </div>
            
            <div class="borrowed-books" id="borrowedBooksList">
                <!-- Borrowed books will be populated here -->
            </div>
        </div>

        <!-- Library Grid -->
        <div class="library-grid" id="libraryGrid">
            <div class="loading">
                <div class="loading-spinner"></div>
                <p>Loading library books...</p>
            </div>
        </div>
    </main>

    <!-- Bottom Navigation -->
    <nav class="bottom-nav" id="bottomNav">
        <a href="index.html" class="nav-item">
            <i class="fas fa-home nav-icon"></i>
            <span>Feed</span>
        </a>
        <a href="events.html" class="nav-item">
            <i class="fas fa-calendar-alt nav-icon"></i>
            <span>Events</span>
        </a>
        <a href="library.html" class="nav-item active">
            <i class="fas fa-book nav-icon"></i>
            <span>Library</span>
            <span class="nav-badge hidden" id="libraryBadge"></span>
        </a>
        <a href="profile.html" class="nav-item">
            <i class="fas fa-user nav-icon"></i>
            <span>Profile</span>
        </a>
    </nav>

    <!-- Firebase and Google Sign-In SDKs -->
    <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-database-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-auth-compat.js"></script>
    <script src="https://accounts.google.com/gsi/client" async defer></script>

    <script>
        // Firebase configuration
        // Firebase configuration
        const firebaseConfig = {
            apiKey: "AIzaSyBDZicoo7dFLtSmgRPvQE_gdm-tNOyCTXA",
            authDomain: "the-songa-77b1b.firebaseapp.com",
            databaseURL: "https://the-songa-77b1b-default-rtdb.europe-west1.firebasedatabase.app",
            projectId: "the-songa-77b1b",
            storageBucket: "the-songa-77b1b.firebasestorage.app",
            messagingSenderId: "123922889572",
            appId: "1:123922889572:web:482b2a624930baaf92d871"
        };
        
        // Initialize Firebase
        let firebaseApp;
        let database;
        let auth;
        
        try {
            firebaseApp = firebase.initializeApp(firebaseConfig);
            database = firebase.database();
            auth = firebase.auth();
            console.log("Firebase initialized successfully");
        } catch (error) {
            console.error("Firebase initialization error:", error);
        }
        
        // Global variables
        let currentUser = null;
        let currentUserData = null;
        let books = [];
        let filteredBooks = [];
        let borrowedBooks = [];
        let selectedBook = null;
        let realtimeListeners = [];
        let notifications = [];
        
        // DOM Elements
        const elements = {
            // Session
            sessionStatus: document.getElementById('sessionStatus'),
            
            // Buttons
            backToTop: document.getElementById('backToTop'),
            notificationBtn: document.getElementById('notificationBtn'),
            
            // Modals
            signinModal: document.getElementById('signinModal'),
            bookModal: document.getElementById('bookModal'),
            borrowModal: document.getElementById('borrowModal'),
            
            // Modal close buttons
            closeSigninModal: document.getElementById('closeSigninModal'),
            closeBookModal: document.getElementById('closeBookModal'),
            closeBorrowModal: document.getElementById('closeBorrowModal'),
            
            // User profile
            userProfile: document.getElementById('userProfile'),
            userAvatar: document.getElementById('userAvatar'),
            userDisplayName: document.getElementById('userDisplayName'),
            userDropdown: document.getElementById('userDropdown'),
            
            // Notification
            notificationToast: document.getElementById('notificationToast'),
            notificationBadge: document.getElementById('notificationBadge'),
            libraryBadge: document.getElementById('libraryBadge'),
            
            // Books
            libraryGrid: document.getElementById('libraryGrid'),
            searchInput: document.getElementById('searchInput'),
            readingStats: document.getElementById('readingStats'),
            myBooksSection: document.getElementById('myBooksSection'),
            borrowedBooksList: document.getElementById('borrowedBooksList'),
            
            // Filter elements
            filterTabs: document.getElementById('filterTabs'),
            categoryBadges: document.getElementById('categoryBadges'),
            sortFilter: document.getElementById('sortFilter'),
            formatFilter: document.getElementById('formatFilter'),
            
            // Count elements
            countAll: document.getElementById('countAll'),
            countAvailable: document.getElementById('countAvailable'),
            countFeatured: document.getElementById('countFeatured'),
            countNew: document.getElementById('countNew'),
            
            // Reading stats
            booksRead: document.getElementById('booksRead'),
            readingStreak: document.getElementById('readingStreak'),
            readingTime: document.getElementById('readingTime'),
            achievements: document.getElementById('achievements'),
            
            // Book modal elements
            bookModalTitle: document.getElementById('bookModalTitle'),
            bookModalAuthor: document.getElementById('bookModalAuthor'),
            bookModalCover: document.getElementById('bookModalCover'),
            bookModalRating: document.getElementById('bookModalRating'),
            bookModalPages: document.getElementById('bookModalPages'),
            bookModalYear: document.getElementById('bookModalYear'),
            bookModalDescription: document.getElementById('bookModalDescription'),
            bookModalTags: document.getElementById('bookModalTags'),
            bookModalStatus: document.getElementById('bookModalStatus'),
            bookModalAvailabilityDetails: document.getElementById('bookModalAvailabilityDetails'),
            borrowFromModalBtn: document.getElementById('borrowFromModalBtn'),
            addToWishlistBtn: document.getElementById('addToWishlistBtn'),
            
            // Borrow modal elements
            borrowBookTitle: document.getElementById('borrowBookTitle'),
            borrowBookName: document.getElementById('borrowBookName'),
            borrowBookAuthor: document.getElementById('borrowBookAuthor'),
            borrowDueDate: document.getElementById('borrowDueDate'),
            confirmBorrowBtn: document.getElementById('confirmBorrowBtn'),
            cancelBorrowBtn: document.getElementById('cancelBorrowBtn'),
            
            // Navigation
            signOutOption: document.getElementById('signOutOption'),
            logo: document.getElementById('logo'),
            bottomNav: document.getElementById('bottomNav')
        };
        
        // Show notification
        function showNotification(message, type = 'success', duration = 4000) {
            const toast = elements.notificationToast;
            toast.textContent = message;
            toast.className = `notification-toast show ${type}`;
            setTimeout(() => {
                toast.classList.remove('show');
            }, duration);
        }
        
        // Show session status
        function showSessionStatus(message, type = 'restored') {
            const status = elements.sessionStatus;
            status.innerHTML = `
                <i class="fas fa-${type === 'restored' ? 'check-circle' : 'sync'}"></i>
                <span>${message}</span>
            `;
            status.className = `session-status visible ${type}`;
            
            setTimeout(() => {
                status.classList.remove('visible');
            }, 3000);
        }
        
        // Format time
        function formatTime(timestamp) {
            if (!timestamp) return 'Recently';
            const now = new Date();
            const time = new Date(timestamp);
            const diffInSeconds = Math.floor((now - time) / 1000);
            
            if (diffInSeconds < 60) return 'Just now';
            if (diffInSeconds < 3600) return `${Math.floor(diffInSeconds / 60)}m ago`;
            if (diffInSeconds < 86400) return `${Math.floor(diffInSeconds / 3600)}h ago`;
            if (diffInSeconds < 604800) return `${Math.floor(diffInSeconds / 86400)}d ago`;
            
            return time.toLocaleDateString('en-US', {
                month: 'short',
                day: 'numeric'
            });
        }
        
        // Check authentication status
        function checkAuthStatus() {
            const storedUser = localStorage.getItem('the_songa_user');
            const storedToken = localStorage.getItem('the_songa_token');
            const sessionTime = localStorage.getItem('the_songa_session_time');
            
            // Check if session is still valid (24 hours)
            const isSessionValid = sessionTime && (Date.now() - parseInt(sessionTime)) < (24 * 60 * 60 * 1000);
            
            if (storedUser && storedToken && isSessionValid) {
                try {
                    currentUser = JSON.parse(storedUser);
                    showSessionStatus('Session restored', 'restored');
                    
                    // Update UI
                    updateUIForMember();
                    
                    // Hide signin modal if open
                    elements.signinModal.classList.remove('active');
                    document.body.classList.remove('modal-open');
                    
                    // Fetch user data
                    fetchUserData(currentUser.uid);
                    
                    // Setup realtime listeners
                    setupRealtimeListeners();
                    
                    showNotification(`Welcome back, ${currentUser.firstName}!`, 'success');
                    
                    return true;
                } catch (error) {
                    console.error("Error parsing stored user:", error);
                    clearUserSession();
                    showSigninModal();
                    return false;
                }
            } else {
                clearUserSession();
                showSigninModal();
                return false;
            }
        }
        
        // Store user session
        function storeUserSession(user, token) {
            localStorage.setItem('the_songa_user', JSON.stringify(user));
            localStorage.setItem('the_songa_token', token);
            localStorage.setItem('the_songa_session_time', Date.now().toString());
        }
        
        // Clear user session
        function clearUserSession() {
            localStorage.removeItem('the_songa_user');
            localStorage.removeItem('the_songa_token');
            localStorage.removeItem('the_songa_session_time');
            
            // Remove realtime listeners
            realtimeListeners.forEach(listener => {
                if (typeof listener === 'function') {
                    listener();
                }
            });
            realtimeListeners = [];
        }
        
        // Show signin modal
        function showSigninModal() {
            elements.signinModal.classList.add('active');
            document.body.classList.add('modal-open');
        }
        
        // Update UI for member
        function updateUIForMember() {
            if (currentUser) {
                // Show user profile
                elements.userProfile.style.display = 'flex';
                elements.userAvatar.src = currentUser.picture;
                elements.userDisplayName.textContent = currentUser.firstName;
                
                // Show notification button
                elements.notificationBtn.style.display = 'flex';
                
                // Show reading stats
                elements.readingStats.style.display = 'grid';
            }
        }
        
        // Fetch user data
        async function fetchUserData(userId) {
            try {
                const userRef = database.ref(`users/${userId}`);
                const snapshot = await userRef.once('value');
                if (snapshot.exists()) {
                    currentUserData = snapshot.val();
                    
                    // Update reading stats
                    updateReadingStats();
                    
                    // Load borrowed books
                    loadBorrowedBooks();
                }
            } catch (error) {
                console.error('Error fetching user data:', error);
            }
        }
        
        // Update reading stats
        function updateReadingStats() {
            if (!currentUserData) return;
            
            const stats = currentUserData.readingStats || {};
            
            elements.booksRead.textContent = stats.booksRead || 0;
            elements.readingStreak.textContent = stats.readingStreak || 0;
            elements.readingTime.textContent = stats.readingTime || '0h';
            elements.achievements.textContent = stats.achievements || 0;
        }
        
        // Setup realtime listeners
        function setupRealtimeListeners() {
            // Clear existing listeners
            realtimeListeners.forEach(listener => {
                if (typeof listener === 'function') {
                    listener();
                }
            });
            realtimeListeners = [];
        
            if (!currentUser || !database) return;
        
            // Listen for books
            const booksListener = database.ref('libraryBooks').on('value', (snapshot) => {
                if (snapshot.exists()) {
                    const booksData = snapshot.val();
                    books = Object.keys(booksData).map(key => ({
                        id: key,
                        ...booksData[key]
                    }));
                    
                    // Update book counts
                    updateBookCounts();
                    
                    // Filter and render books
                    filterAndRenderBooks();
                } else {
                    books = [];
                    loadSampleBooks();
                }
            });
            realtimeListeners.push(() => database.ref('libraryBooks').off('value', booksListener));
        
            // Listen for notifications
            const notificationsListener = database.ref(`notifications/${currentUser.uid}`).orderByChild('timestamp').limitToLast(20).on('value', (snapshot) => {
                if (snapshot.exists()) {
                    const notificationsData = snapshot.val();
                    notifications = Object.keys(notificationsData).map(key => ({
                        id: key,
                        ...notificationsData[key]
                    }));
                    
                    // Filter library notifications
                    const libraryNotifications = notifications.filter(n => 
                        n.type && (n.type.includes('book') || n.type.includes('library'))
                    );
                    
                    const unreadCount = libraryNotifications.filter(n => !n.read).length;
                    
                    // Update badges
                    if (unreadCount > 0) {
                        elements.notificationBadge.textContent = unreadCount > 99 ? '99+' : unreadCount;
                        elements.notificationBadge.classList.remove('hidden');
                        elements.libraryBadge.textContent = unreadCount > 3 ? '3+' : unreadCount;
                        elements.libraryBadge.classList.remove('hidden');
                    } else {
                        elements.notificationBadge.classList.add('hidden');
                        elements.libraryBadge.classList.add('hidden');
                    }
                } else {
                    elements.notificationBadge.classList.add('hidden');
                    elements.libraryBadge.classList.add('hidden');
                }
            });
            realtimeListeners.push(() => database.ref(`notifications/${currentUser.uid}`).off('value', notificationsListener));
        
            // Listen for user data updates
            const userListener = database.ref(`users/${currentUser.uid}`).on('value', (snapshot) => {
                if (snapshot.exists()) {
                    currentUserData = snapshot.val();
                    updateReadingStats();
                    loadBorrowedBooks();
                }
            });
            realtimeListeners.push(() => database.ref(`users/${currentUser.uid}`).off('value', userListener));
        }
        
        // Load sample books if none exist
        async function loadSampleBooks() {
            if (!database) return;
            
            try {
                const booksRef = database.ref('libraryBooks');
                const snapshot = await booksRef.once('value');
                
                if (!snapshot.exists()) {
                    const sampleBooks = [
                        {
                            id: "book1",
                            title: "Atomic Habits",
                            author: "James Clear",
                            description: "An Easy & Proven Way to Build Good Habits & Break Bad Ones. Tiny Changes, Remarkable Results.",
                            category: "personal-growth",
                            coverImage: "https://images.unsplash.com/photo-1544716278-e513176f20b5?ixlib=rb-4.0.3&auto=format&fit=crop&w=800&q=80",
                            rating: 4.8,
                            pages: 320,
                            publishedYear: 2018,
                            availability: "available",
                            totalCopies: 5,
                            availableCopies: 3,
                            borrowCount: 15,
                            featured: true,
                            tags: ["habits", "productivity", "self-improvement"],
                            format: "physical",
                            createdAt: new Date().toISOString(),
                            updatedAt: new Date().toISOString()
                        },
                        {
                            id: "book2",
                            title: "The Psychology of Money",
                            author: "Morgan Housel",
                            description: "Timeless lessons on wealth, greed, and happiness doing well with money isn't necessarily about what you know.",
                            category: "finance",
                            coverImage: "https://images.unsplash.com/photo-1554224155-6726b3ff858f?ixlib=rb-4.0.3&auto=format&fit=crop&w=800&q=80",
                            rating: 4.7,
                            pages: 256,
                            publishedYear: 2020,
                            availability: "available",
                            totalCopies: 4,
                            availableCopies: 2,
                            borrowCount: 8,
                            featured: true,
                            tags: ["money", "psychology", "finance"],
                            format: "physical",
                            createdAt: new Date().toISOString(),
                            updatedAt: new Date().toISOString()
                        },
                        {
                            id: "book3",
                            title: "The Lean Startup",
                            author: "Eric Ries",
                            description: "How Today's Entrepreneurs Use Continuous Innovation to Create Radically Successful Businesses.",
                            category: "business",
                            coverImage: "https://images.unsplash.com/photo-1450101499163-c8848c66ca85?ixlib=rb-4.0.3&auto=format&fit=crop&w=800&q=80",
                            rating: 4.6,
                            pages: 336,
                            publishedYear: 2011,
                            availability: "borrowed",
                            totalCopies: 3,
                            availableCopies: 0,
                            borrowCount: 12,
                            featured: false,
                            tags: ["startup", "entrepreneurship", "business"],
                            format: "physical",
                            createdAt: new Date().toISOString(),
                            updatedAt: new Date().toISOString()
                        },
                        {
                            id: "book4",
                            title: "Deep Work",
                            author: "Cal Newport",
                            description: "Rules for Focused Success in a Distracted World. Master the ability to focus without distraction.",
                            category: "personal-growth",
                            coverImage: "https://images.unsplash.com/photo-1543332164-6e82f355badc?ixlib=rb-4.0.3&auto=format&fit=crop&w=800&q=80",
                            rating: 4.5,
                            pages: 304,
                            publishedYear: 2016,
                            availability: "available",
                            totalCopies: 6,
                            availableCopies: 4,
                            borrowCount: 9,
                            featured: false,
                            tags: ["productivity", "focus", "work"],
                            format: "digital",
                            digitalLink: "https://example.com/deep-work",
                            createdAt: new Date().toISOString(),
                            updatedAt: new Date().toISOString()
                        },
                        {
                            id: "book5",
                            title: "The 7 Habits of Highly Effective People",
                            author: "Stephen R. Covey",
                            description: "Powerful lessons in personal change that has transformed the lives of millions worldwide.",
                            category: "personal-growth",
                            coverImage: "https://images.unsplash.com/photo-1541963463532-d68292c34b19?ixlib=rb-4.0.3&auto=format&fit=crop&w=800&q=80",
                            rating: 4.7,
                            pages: 381,
                            publishedYear: 1989,
                            availability: "available",
                            totalCopies: 8,
                            availableCopies: 5,
                            borrowCount: 25,
                            featured: true,
                            tags: ["habits", "effectiveness", "leadership"],
                            format: "physical",
                            createdAt: new Date().toISOString(),
                            updatedAt: new Date().toISOString()
                        },
                        {
                            id: "book6",
                            title: "Thinking, Fast and Slow",
                            author: "Daniel Kahneman",
                            description: "The groundbreaking work on how we make decisions and the two systems that drive the way we think.",
                            category: "personal-growth",
                            coverImage: "https://images.unsplash.com/photo-1589829085413-56de8ae18c73?ixlib=rb-4.0.3&auto=format&fit=crop&w=800&q=80",
                            rating: 4.8,
                            pages: 499,
                            publishedYear: 2011,
                            availability: "reserved",
                            totalCopies: 4,
                            availableCopies: 0,
                            borrowCount: 18,
                            featured: true,
                            tags: ["psychology", "decision-making", "behavior"],
                            format: "physical",
                            createdAt: new Date().toISOString(),
                            updatedAt: new Date().toISOString()
                        }
                    ];
                    
                    // Upload sample books to Firebase
                    const updates = {};
                    sampleBooks.forEach(book => {
                        updates[book.id] = book;
                    });
                    
                    await booksRef.update(updates);
                    console.log("Sample books loaded to Firebase");
                }
            } catch (error) {
                console.error("Error loading sample books:", error);
            }
        }
        
        // Update book counts
        function updateBookCounts() {
            const allBooks = books.length;
            const availableBooks = books.filter(book => book.availability === 'available').length;
            const featuredBooks = books.filter(book => book.featured).length;
            const newBooks = books.filter(book => {
                if (!book.createdAt) return false;
                const bookDate = new Date(book.createdAt);
                const thirtyDaysAgo = new Date(Date.now() - 30 * 24 * 60 * 60 * 1000);
                return bookDate > thirtyDaysAgo;
            }).length;
            
            elements.countAll.textContent = allBooks;
            elements.countAvailable.textContent = availableBooks;
            elements.countFeatured.textContent = featuredBooks;
            elements.countNew.textContent = newBooks;
        }
        
        // Load borrowed books
        function loadBorrowedBooks() {
            if (!currentUserData || !currentUserData.borrowedBooks) {
                elements.myBooksSection.style.display = 'none';
                return;
            }
            
            borrowedBooks = currentUserData.borrowedBooks.filter(record => record.status === 'borrowed');
            
            if (borrowedBooks.length === 0) {
                elements.myBooksSection.style.display = 'none';
                return;
            }
            
            elements.myBooksSection.style.display = 'block';
            displayBorrowedBooks();
        }
        
        // Display borrowed books
        function displayBorrowedBooks() {
            const borrowedBooksList = elements.borrowedBooksList;
            if (!borrowedBooksList) return;
            
            // Sort by due date
            const sortedBooks = [...borrowedBooks].sort((a, b) => {
                return new Date(a.dueDate) - new Date(b.dueDate);
            });
            
            // Take only 3 books for display
            const displayBooks = sortedBooks.slice(0, 3);
            
            borrowedBooksList.innerHTML = displayBooks.map(record => {
                const book = books.find(b => b.id === record.bookId);
                if (!book) return '';
                
                const dueDate = new Date(record.dueDate);
                const now = new Date();
                const daysLeft = Math.ceil((dueDate - now) / (1000 * 60 * 60 * 24));
                const isOverdue = daysLeft < 0;
                
                return `
                    <div class="borrowed-book-card">
                        <div class="borrowed-book-cover">
                            <img src="${book.coverImage || 'https://images.unsplash.com/photo-1544716278-ca5e3f4abd8c?ixlib=rb-4.0.3&auto=format&fit=crop&w=300&q=80'}" alt="${book.title}">
                        </div>
                        <div class="borrowed-book-info">
                            <h4 class="borrowed-book-title">${book.title}</h4>
                            <div class="due-date">
                                <i class="fas fa-calendar ${isOverdue ? 'fa-exclamation-circle' : ''}"></i>
                                ${isOverdue ? 'OVERDUE' : `Due in ${daysLeft} days`}
                            </div>
                        </div>
                        <div class="borrowed-actions">
                            <button class="renew-btn" onclick="renewBook('${record.id}')" ${record.renewalCount >= 2 ? 'disabled' : ''}>
                                <i class="fas fa-redo"></i> Renew
                            </button>
                        </div>
                    </div>
                `;
            }).join('');
        }
        
        // Filter and render books
        function filterAndRenderBooks() {
            const activeFilter = document.querySelector('.filter-tab.active')?.dataset.filter || 'all';
            const activeCategory = document.querySelector('.category-badge.active')?.dataset.category || 'all';
            const sortFilter = elements.sortFilter.value;
            const formatFilter = elements.formatFilter.value;
            const searchTerm = elements.searchInput.value.toLowerCase();
            
            filteredBooks = books.filter(book => {
                // Filter by tab
                let filterMatch = true;
                switch(activeFilter) {
                    case 'available':
                        filterMatch = book.availability === 'available';
                        break;
                    case 'featured':
                        filterMatch = book.featured === true;
                        break;
                    case 'new':
                        if (!book.createdAt) return false;
                        const bookDate = new Date(book.createdAt);
                        const thirtyDaysAgo = new Date(Date.now() - 30 * 24 * 60 * 60 * 1000);
                        filterMatch = bookDate > thirtyDaysAgo;
                        break;
                }
                
                // Filter by category
                const categoryMatch = activeCategory === 'all' || 
                    (book.category && book.category.toLowerCase() === activeCategory);
                
                // Filter by format
                let formatMatch = true;
                switch(formatFilter) {
                    case 'physical':
                        formatMatch = book.format !== 'digital';
                        break;
                    case 'digital':
                        formatMatch = book.format === 'digital';
                        break;
                }
                
                // Filter by search term
                const searchMatch = searchTerm === '' || 
                    book.title.toLowerCase().includes(searchTerm) ||
                    book.author.toLowerCase().includes(searchTerm) ||
                    (book.tags && book.tags.some(tag => tag.toLowerCase().includes(searchTerm))) ||
                    (book.description && book.description.toLowerCase().includes(searchTerm));
                
                return filterMatch && categoryMatch && formatMatch && searchMatch;
            });
            
            // Sort books
            filteredBooks.sort((a, b) => {
                switch(sortFilter) {
                    case 'title':
                        return a.title.localeCompare(b.title);
                    case 'author':
                        return a.author.localeCompare(b.author);
                    case 'rating':
                        return (b.rating || 0) - (a.rating || 0);
                    case 'date-added':
                        return new Date(b.createdAt || 0) - new Date(a.createdAt || 0);
                    case 'popularity':
                    default:
                        return (b.borrowCount || 0) - (a.borrowCount || 0);
                }
            });
            
            renderBooks(filteredBooks);
        }
        
        // Render books
        function renderBooks(booksArray) {
            if (!elements.libraryGrid) return;
            
            if (!booksArray || booksArray.length === 0) {
                elements.libraryGrid.innerHTML = `
                    <div class="empty-state" style="grid-column: 1 / -1;">
                        <i class="fas fa-book-open"></i>
                        <h3>No Books Found</h3>
                        <p>Try adjusting your filters or check back for new additions to our library.</p>
                    </div>
                `;
                return;
            }
        
            elements.libraryGrid.innerHTML = booksArray.map(book => {
                const categoryName = book.category || 'General';
                const isAvailable = book.availability === 'available';
                const isDigital = book.format === 'digital';
                const availabilityClass = isDigital ? 'digital-only' : 
                                        isAvailable ? 'available' : 
                                        book.availability === 'borrowed' ? 'borrowed' : 'reserved';
                const availabilityText = isDigital ? 'Digital Access' : 
                                       isAvailable ? 'Available' : 
                                       book.availability === 'borrowed' ? 'Borrowed' : 'Reserved';
                
                return `
                    <div class="book-card ${book.featured ? 'featured' : ''}">
                        ${book.featured ? `
                            <div class="featured-badge">
                                <i class="fas fa-star"></i> Featured
                            </div>
                        ` : ''}
                        
                        <div class="availability-badge ${availabilityClass}">
                            ${availabilityText}
                        </div>
                        
                        <div class="book-cover">
                            <img src="${book.coverImage || 'https://images.unsplash.com/photo-1544716278-ca5e3f4abd8c?ixlib=rb-4.0.3&auto=format&fit=crop&w=800&q=80'}" alt="${book.title}">
                        </div>
                        
                        <div class="book-content">
                            <div class="book-category">
                                ${categoryName}
                            </div>
                            <h3 class="book-title">${book.title}</h3>
                            <p class="book-author">${book.author}</p>
                            
                            <div class="book-meta">
                                <div class="book-rating">
                                    <div class="stars">
                                        ${'★'.repeat(Math.floor(book.rating || 0))}${'☆'.repeat(5 - Math.floor(book.rating || 0))}
                                    </div>
                                    <span class="rating-value">${(book.rating || 0).toFixed(1)}</span>
                                </div>
                                <span class="book-pages">${book.pages || 'N/A'} pages</span>
                            </div>
                            
                            <div class="book-actions">
                                <button class="book-action-btn borrow-btn" onclick="openBorrowModal('${book.id}')" ${!isAvailable && !isDigital ? 'disabled' : ''}>
                                    <i class="fas fa-book-reader"></i> ${isDigital ? 'Read Online' : 'Borrow'}
                                </button>
                                <button class="book-action-btn details-btn" onclick="openBookDetails('${book.id}')">
                                    <i class="fas fa-eye"></i> Details
                                </button>
                            </div>
                        </div>
                    </div>
                `;
            }).join('');
        }
        
        // Open book details
        function openBookDetails(bookId) {
            selectedBook = books.find(b => b.id === bookId);
            if (!selectedBook) {
                showNotification('Book not found', 'error');
                return;
            }
            
            // Update modal content
            elements.bookModalTitle.textContent = selectedBook.title;
            elements.bookModalAuthor.textContent = `by ${selectedBook.author}`;
            elements.bookModalCover.src = selectedBook.coverImage || 'https://images.unsplash.com/photo-1544716278-ca5e3f4abd8c?ixlib=rb-4.0.3&auto=format&fit=crop&w=800&q=80';
            elements.bookModalRating.textContent = (selectedBook.rating || 0).toFixed(1);
            elements.bookModalPages.textContent = `${selectedBook.pages || 'N/A'} pages`;
            elements.bookModalYear.textContent = selectedBook.publishedYear || 'N/A';
            elements.bookModalDescription.textContent = selectedBook.description || 'No description available.';
            
            // Update tags
            const tagsHtml = selectedBook.tags && selectedBook.tags.length > 0 ? 
                selectedBook.tags.map(tag => `
                    <button class="book-tag" onclick="searchByTag('${tag}')">${tag}</button>
                `).join('') : '<span style="color: var(--dark-gray);">No tags</span>';
            elements.bookModalTags.innerHTML = tagsHtml;
            
            // Update availability
            const isAvailable = selectedBook.availability === 'available';
            const isDigital = selectedBook.format === 'digital';
            const availabilityText = isDigital ? 'Digital Access' : 
                                   isAvailable ? 'Available' : 
                                   selectedBook.availability === 'borrowed' ? 'Borrowed' : 'Reserved';
            
            elements.bookModalStatus.textContent = availabilityText;
            elements.bookModalStatus.className = `status-value ${isDigital ? 'status-digital' : 
                                               isAvailable ? 'status-available' : 
                                               selectedBook.availability === 'borrowed' ? 'status-borrowed' : 'status-reserved'}`;
            
            // Update availability details
            const detailsElement = elements.bookModalAvailabilityDetails;
            if (isDigital) {
                detailsElement.innerHTML = `
                    <p>This book is available for digital reading. Click "Borrow Book" to access the digital version.</p>
                `;
            } else {
                const availableCopies = selectedBook.availableCopies || 0;
                const totalCopies = selectedBook.totalCopies || 0;
                detailsElement.innerHTML = `
                    <p>${availableCopies} of ${totalCopies} copies available</p>
                    ${!isAvailable ? '<p style="margin-top: 0.5rem;">Expected return date: Soon</p>' : ''}
                `;
            }
            
            // Update borrow button
            const borrowBtn = elements.borrowFromModalBtn;
            borrowBtn.innerHTML = isDigital ? '<i class="fas fa-book-reader"></i> Read Online' : '<i class="fas fa-book-reader"></i> Borrow Book';
            borrowBtn.disabled = !isAvailable && !isDigital;
            borrowBtn.onclick = () => {
                if (isDigital) {
                    window.open(selectedBook.digitalLink, '_blank');
                    showNotification('Opening digital book...', 'success');
                } else {
                    elements.bookModal.classList.remove('active');
                    openBorrowModal(selectedBook.id);
                }
            };
            
            // Update wishlist button
            elements.addToWishlistBtn.onclick = () => {
                addToWishlist(selectedBook.id);
            };
            
            // Show modal
            elements.bookModal.classList.add('active');
            document.body.classList.add('modal-open');
        }
        
        // Open borrow modal
        function openBorrowModal(bookId) {
            if (!currentUser) {
                showNotification('Please sign in to borrow books', 'error');
                showSigninModal();
                return;
            }
            
            selectedBook = books.find(b => b.id === bookId);
            if (!selectedBook) {
                showNotification('Book not found', 'error');
                return;
            }
            
            if (selectedBook.format === 'digital') {
                window.open(selectedBook.digitalLink, '_blank');
                showNotification('Opening digital book...', 'success');
                return;
            }
            
            if (selectedBook.availability !== 'available') {
                showNotification('This book is not available for borrowing', 'error');
                return;
            }
            
            // Update modal content
            elements.borrowBookTitle.textContent = selectedBook.title;
            elements.borrowBookName.textContent = selectedBook.title;
            elements.borrowBookAuthor.textContent = selectedBook.author;
            
            // Calculate dates
            const borrowDuration = 14; // 14 days
            const dueDate = new Date();
            dueDate.setDate(dueDate.getDate() + borrowDuration);
            
            elements.borrowDueDate.textContent = dueDate.toLocaleDateString('en-US', {
                weekday: 'short',
                year: 'numeric',
                month: 'short',
                day: 'numeric'
            });
            
            // Show modal
            elements.borrowModal.classList.add('active');
            document.body.classList.add('modal-open');
        }
        
        // Confirm borrow book
        async function confirmBorrowBook() {
            if (!selectedBook || !currentUser || !database) return;
            
            try {
                // Update book availability
                const bookRef = database.ref(`libraryBooks/${selectedBook.id}`);
                const updates = {
                    availableCopies: Math.max((selectedBook.availableCopies || 1) - 1, 0),
                    borrowCount: (selectedBook.borrowCount || 0) + 1,
                    availability: (selectedBook.availableCopies || 1) <= 1 ? 'borrowed' : 'available',
                    updatedAt: new Date().toISOString()
                };
                
                await bookRef.update(updates);
                
                // Update user's borrowed books
                const userRef = database.ref(`users/${currentUser.uid}/borrowedBooks`);
                const newBorrowRecord = {
                    id: `borrow_${Date.now()}`,
                    bookId: selectedBook.id,
                    bookTitle: selectedBook.title,
                    borrowDate: new Date().toISOString(),
                    dueDate: new Date(Date.now() + 14 * 24 * 60 * 60 * 1000).toISOString(),
                    status: 'borrowed',
                    renewalCount: 0
                };
                
                await userRef.push(newBorrowRecord);
                
                // Create notification
                const notificationRef = database.ref(`notifications/${currentUser.uid}`);
                await notificationRef.push({
                    message: `You borrowed "${selectedBook.title}"`,
                    type: 'book_borrowed',
                    read: false,
                    timestamp: new Date().toISOString()
                });
                
                // Update reading stats
                const statsRef = database.ref(`users/${currentUser.uid}/readingStats`);
                await statsRef.update({
                    booksRead: firebase.database.ServerValue.increment(1),
                    lastUpdated: new Date().toISOString()
                });
                
                // Close modal and show success
                elements.borrowModal.classList.remove('active');
                document.body.classList.remove('modal-open');
                
                showNotification(`Successfully borrowed "${selectedBook.title}"!`, 'success');
                
            } catch (error) {
                console.error('Error borrowing book:', error);
                showNotification('Error borrowing book. Please try again.', 'error');
            }
        }
        
        // Renew book
        async function renewBook(recordId) {
            if (!currentUser || !database) return;
            
            try {
                const userRef = database.ref(`users/${currentUser.uid}/borrowedBooks`);
                const snapshot = await userRef.orderByChild('id').equalTo(recordId).once('value');
                
                if (snapshot.exists()) {
                    const recordKey = Object.keys(snapshot.val())[0];
                    const record = snapshot.val()[recordKey];
                    
                    if (record.renewalCount >= 2) {
                        showNotification('Maximum renewals reached for this book', 'error');
                        return;
                    }
                    
                    // Extend due date by 14 days
                    const newDueDate = new Date(Date.now() + 14 * 24 * 60 * 60 * 1000);
                    await userRef.child(recordKey).update({
                        dueDate: newDueDate.toISOString(),
                        renewalCount: (record.renewalCount || 0) + 1
                    });
                    
                    showNotification('Book renewed successfully!', 'success');
                    loadBorrowedBooks();
                }
            } catch (error) {
                console.error('Error renewing book:', error);
                showNotification('Error renewing book. Please try again.', 'error');
            }
        }
        
        // Add to wishlist
        async function addToWishlist(bookId) {
            if (!currentUser) {
                showNotification('Please sign in to add books to wishlist', 'error');
                showSigninModal();
                return;
            }
            
            try {
                const wishlistRef = database.ref(`users/${currentUser.uid}/wishlist`);
                const snapshot = await wishlistRef.orderByChild('bookId').equalTo(bookId).once('value');
                
                if (snapshot.exists()) {
                    showNotification('Book already in your wishlist', 'info');
                } else {
                    await wishlistRef.push({
                        bookId: bookId,
                        addedDate: new Date().toISOString()
                    });
                    showNotification('Book added to wishlist!', 'success');
                }
            } catch (error) {
                console.error('Error adding to wishlist:', error);
                showNotification('Error adding to wishlist', 'error');
            }
        }
        
        // Search by tag
        function searchByTag(tag) {
            elements.searchInput.value = tag;
            filterAndRenderBooks();
            showNotification(`Searching for books tagged: ${tag}`, 'info');
        }
        
        // View all borrowed books
        function viewAllBorrowedBooks() {
            if (borrowedBooks.length === 0) {
                showNotification('You have no borrowed books', 'info');
                return;
            }
            // This would typically open a modal or navigate to a page showing all borrowed books
            showNotification('Showing all borrowed books', 'info');
            // For now, just scroll to the borrowed books section
            elements.myBooksSection.scrollIntoView({ behavior: 'smooth' });
        }
        
        // Google Sign-In Handler
        async function handleGoogleSignIn(response) {
            try {
                // Parse JWT token
                const base64Url = response.credential.split('.')[1];
                const base64 = base64Url.replace(/-/g, '+').replace(/_/g, '/');
                const jsonPayload = decodeURIComponent(atob(base64).split('').map(c => 
                    '%' + ('00' + c.charCodeAt(0).toString(16)).slice(-2)
                ).join(''));
                const userData = JSON.parse(jsonPayload);
                
                // Create user object
                currentUser = {
                    uid: userData.sub,
                    email: userData.email,
                    firstName: userData.given_name,
                    lastName: userData.family_name,
                    fullName: userData.name,
                    picture: userData.picture,
                    emailVerified: userData.email_verified
                };
                
                // Store user session
                storeUserSession(currentUser, response.credential);
                
                // Create or update user in Firebase
                if (database) {
                    const userRef = database.ref(`users/${currentUser.uid}`);
                    const snapshot = await userRef.once('value');
                    
                    if (!snapshot.exists()) {
                        const newUser = {
                            uid: currentUser.uid,
                            email: currentUser.email,
                            firstName: currentUser.firstName,
                            lastName: currentUser.lastName,
                            profilePicture: currentUser.picture,
                            joinedDate: new Date().toISOString(),
                            lastLogin: new Date().toISOString(),
                            membershipStatus: "active",
                            membershipTier: "explorer",
                            borrowedBooks: [],
                            readingStats: {
                                booksRead: 0,
                                readingStreak: 0,
                                readingTime: "0h",
                                achievements: 0
                            },
                            readingPreferences: ["personal-growth", "business"],
                            isAdmin: false,
                            status: "active"
                        };
                        
                        await userRef.set(newUser);
                        currentUserData = newUser;
                        showNotification(`Welcome to THE SONGA Library, ${currentUser.firstName}!`, 'success');
                    } else {
                        await userRef.update({ lastLogin: new Date().toISOString() });
                        currentUserData = snapshot.val();
                        showNotification(`Welcome back, ${currentUser.firstName}!`, 'success');
                    }
                }
                
                // Update UI
                updateUIForMember();
                elements.signinModal.classList.remove('active');
                document.body.classList.remove('modal-open');
                
                // Setup realtime listeners
                setupRealtimeListeners();
                
            } catch (error) {
                console.error('Error in Google Sign-In:', error);
                showNotification('Error signing in. Please try again.', 'error');
            }
        }
        
        // Sign out user
        function signOut() {
            currentUser = null;
            currentUserData = null;
            clearUserSession();
            
            // Hide member-only sections
            elements.userProfile.style.display = 'none';
            elements.notificationBtn.style.display = 'none';
            elements.readingStats.style.display = 'none';
            elements.myBooksSection.style.display = 'none';
            
            // Clear realtime listeners
            realtimeListeners.forEach(listener => {
                if (typeof listener === 'function') {
                    listener();
                }
            });
            realtimeListeners = [];
            
            // Show signin modal
            showSigninModal();
            showNotification('Signed out successfully', 'success');
        }
        
        // Back to top functionality
        window.addEventListener('scroll', function() {
            if (elements.backToTop) {
                if (window.pageYOffset > 300) {
                    elements.backToTop.classList.add('visible');
                } else {
                    elements.backToTop.classList.remove('visible');
                }
            }
        });
        
        if (elements.backToTop) {
            elements.backToTop.addEventListener('click', function() {
                window.scrollTo({
                    top: 0,
                    behavior: 'smooth'
                });
            });
        }
        
        // Event Listeners
        document.addEventListener('DOMContentLoaded', function() {
            // Check authentication status
            checkAuthStatus();
            
            // Setup event listeners
            setupEventListeners();
        });
        
        function setupEventListeners() {
            // Modal close buttons
            if (elements.closeSigninModal) {
                elements.closeSigninModal.addEventListener('click', function() {
                    elements.signinModal.classList.remove('active');
                    document.body.classList.remove('modal-open');
                });
            }
            
            if (elements.closeBookModal) {
                elements.closeBookModal.addEventListener('click', function() {
                    elements.bookModal.classList.remove('active');
                    document.body.classList.remove('modal-open');
                });
            }
            
            if (elements.closeBorrowModal) {
                elements.closeBorrowModal.addEventListener('click', function() {
                    elements.borrowModal.classList.remove('active');
                    document.body.classList.remove('modal-open');
                });
            }
            
            // Borrow modal buttons
            if (elements.confirmBorrowBtn) {
                elements.confirmBorrowBtn.addEventListener('click', confirmBorrowBook);
            }
            
            if (elements.cancelBorrowBtn) {
                elements.cancelBorrowBtn.addEventListener('click', function() {
                    elements.borrowModal.classList.remove('active');
                    document.body.classList.remove('modal-open');
                });
            }
            
            // User dropdown
            if (elements.userProfile) {
                elements.userProfile.addEventListener('click', function(e) {
                    e.stopPropagation();
                    elements.userDropdown.classList.toggle('active');
                });
            }
            
            // Close dropdown when clicking outside
            document.addEventListener('click', function() {
                elements.userDropdown.classList.remove('active');
            });
            
            // Sign out option
            if (elements.signOutOption) {
                elements.signOutOption.addEventListener('click', signOut);
            }
            
            // Logo click
            if (elements.logo) {
                elements.logo.addEventListener('click', function() {
                    window.location.href = 'index.html';
                });
            }
            
            // Filter tabs
            if (elements.filterTabs) {
                elements.filterTabs.addEventListener('click', function(e) {
                    if (e.target.classList.contains('filter-tab')) {
                        document.querySelectorAll('.filter-tab').forEach(tab => {
                            tab.classList.remove('active');
                        });
                        e.target.classList.add('active');
                        filterAndRenderBooks();
                    }
                });
            }
            
            // Category badges
            if (elements.categoryBadges) {
                elements.categoryBadges.addEventListener('click', function(e) {
                    if (e.target.classList.contains('category-badge')) {
                        document.querySelectorAll('.category-badge').forEach(badge => {
                            badge.classList.remove('active');
                        });
                        e.target.classList.add('active');
                        filterAndRenderBooks();
                    }
                });
            }
            
            // Sort filter
            if (elements.sortFilter) {
                elements.sortFilter.addEventListener('change', filterAndRenderBooks);
            }
            
            // Format filter
            if (elements.formatFilter) {
                elements.formatFilter.addEventListener('change', filterAndRenderBooks);
            }
            
            // Search input
            if (elements.searchInput) {
                let searchTimeout;
                elements.searchInput.addEventListener('input', function() {
                    clearTimeout(searchTimeout);
                    searchTimeout = setTimeout(() => {
                        filterAndRenderBooks();
                    }, 500);
                });
            }
            
            // Close modals when clicking outside
            if (elements.signinModal) {
                elements.signinModal.addEventListener('click', function(e) {
                    if (e.target === this) {
                        elements.signinModal.classList.remove('active');
                        document.body.classList.remove('modal-open');
                    }
                });
            }
            
            if (elements.bookModal) {
                elements.bookModal.addEventListener('click', function(e) {
                    if (e.target === this) {
                        elements.bookModal.classList.remove('active');
                        document.body.classList.remove('modal-open');
                    }
                });
            }
            
            if (elements.borrowModal) {
                elements.borrowModal.addEventListener('click', function(e) {
                    if (e.target === this) {
                        elements.borrowModal.classList.remove('active');
                        document.body.classList.remove('modal-open');
                    }
                });
            }
            
            // Escape key to close modals
            document.addEventListener('keydown', function(e) {
                if (e.key === 'Escape') {
                    if (elements.signinModal.classList.contains('active')) {
                        elements.signinModal.classList.remove('active');
                        document.body.classList.remove('modal-open');
                    }
                    if (elements.bookModal.classList.contains('active')) {
                        elements.bookModal.classList.remove('active');
                        document.body.classList.remove('modal-open');
                    }
                    if (elements.borrowModal.classList.contains('active')) {
                        elements.borrowModal.classList.remove('active');
                        document.body.classList.remove('modal-open');
                    }
                }
            });
        }
        
        // Make Google Sign-In callback available globally
        window.handleGoogleSignIn = handleGoogleSignIn;
        </script>
</body>
</html>
