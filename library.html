<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=0.8, maximum-scale=1.0, user-scalable=no">
    <title>THE SONGA - Library</title>
    <!-- Preconnect to critical domains -->
    <link rel="preconnect" href="https://cdnjs.cloudflare.com">
    <link rel="preconnect" href="https://www.gstatic.com">
    <link rel="preconnect" href="https://i.postimg.cc">
    <link rel="preconnect" href="https://accounts.google.com">
    
    <!-- Preload critical resources -->
    <link rel="preload" as="style" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <link rel="icon" type="image/x-icon" href="https://i.postimg.cc/BbdzCkxQ/20260116-0851-Elegant-Lion-Emblem-remix-01kf2npwbtf06ttr4htekjnd47-removebg-preview-2.webp">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <!-- Inline critical CSS -->
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }

        :root {
            --gold: #D4AF37;
            --gold-light: #F5E6B3;
            --gold-dark: #B8860B;
            --black: #000000;
            --white: #ffffff;
            --gray: #f5f5f5;
            --dark-gray: #333333;
            --light-gray: #e0e0e0;
            --accent: #25D366;
            --available: #2ecc71;
            --borrowed: #e74c3c;
            --reserved: #f39c12;
            --digital: #3498db;
            --fiction: #9b59b6;
            --non-fiction: #e67e22;
            --business: #1abc9c;
            --shadow: rgba(0, 0, 0, 0.1);
            --modal-overlay: rgba(0, 0, 0, 0.85);
        }

        html {
            scroll-behavior: smooth;
        }

        body {
            background-color: var(--white);
            color: var(--black);
            line-height: 1.6;
            padding-bottom: 80px;
            overflow-x: hidden;
        }

        body.modal-open {
            overflow: hidden;
        }

        /* BOOK DETAILS MODAL */
        .book-modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: var(--modal-overlay);
            z-index: 3000;
            justify-content: center;
            align-items: center;
            padding: 20px;
        }

        .book-modal.active {
            display: flex;
        }

        .book-modal-content {
            background-color: white;
            border-radius: 16px;
            width: 100%;
            max-width: 900px;
            max-height: 90vh;
            overflow-y: auto;
            box-shadow: 0 25px 50px rgba(0, 0, 0, 0.3);
            animation: modalAppear 0.4s ease-out;
            position: relative;
        }

        @keyframes modalAppear {
            from { 
                transform: translateY(-20px) scale(0.95); 
                opacity: 0; 
            }
            to { 
                transform: translateY(0) scale(1); 
                opacity: 1; 
            }
        }

        .book-modal-header {
            background: linear-gradient(135deg, var(--gold), var(--gold-dark));
            color: var(--black);
            padding: 1.8rem 2rem;
            position: relative;
        }

        .book-modal-header h2 {
            font-size: 1.6rem;
            margin-bottom: 0.5rem;
            font-weight: 700;
            line-height: 1.3;
        }

        .book-modal-header p {
            font-size: 0.9rem;
            opacity: 0.9;
        }

        .close-book-modal {
            position: absolute;
            top: 20px;
            right: 20px;
            background: rgba(0, 0, 0, 0.15);
            border: none;
            color: var(--black);
            width: 36px;
            height: 36px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            font-size: 1.4rem;
            transition: all 0.3s ease;
            z-index: 10;
        }

        .close-book-modal:hover {
            background: rgba(0, 0, 0, 0.25);
            transform: rotate(90deg);
        }

        .book-modal-body {
            padding: 2rem;
            display: grid;
            grid-template-columns: 300px 1fr;
            gap: 2rem;
        }

        @media (max-width: 768px) {
            .book-modal-body {
                grid-template-columns: 1fr;
            }
        }

        .book-cover-large {
            width: 100%;
            height: 400px;
            border-radius: 12px;
            overflow: hidden;
            box-shadow: 0 8px 25px rgba(0, 0, 0, 0.15);
        }

        .book-cover-large img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        .book-info {
            display: flex;
            flex-direction: column;
            gap: 1.5rem;
        }

        .book-meta {
            display: flex;
            flex-wrap: wrap;
            gap: 1rem;
            margin-bottom: 1rem;
        }

        .book-meta-item {
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 0.9rem;
            color: var(--dark-gray);
        }

        .book-meta-item i {
            color: var(--gold-dark);
            width: 20px;
        }

        .book-description {
            color: var(--dark-gray);
            line-height: 1.7;
            margin-bottom: 1.5rem;
        }

        .book-tags {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
            margin-bottom: 1.5rem;
        }

        .book-tag {
            background: var(--gold-light);
            color: var(--gold-dark);
            padding: 6px 12px;
            border-radius: 20px;
            font-size: 0.8rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .book-tag:hover {
            background: var(--gold);
            transform: translateY(-2px);
        }

        .book-availability {
            background: var(--gray);
            border-radius: 12px;
            padding: 1.5rem;
            margin-top: 1rem;
        }

        .availability-status {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 1rem;
        }

        .status-label {
            font-weight: 600;
            color: var(--dark-gray);
        }

        .status-value {
            padding: 6px 12px;
            border-radius: 20px;
            font-weight: 700;
            font-size: 0.9rem;
        }

        .status-available {
            background: var(--available);
            color: white;
        }

        .status-borrowed {
            background: var(--borrowed);
            color: white;
        }

        .status-reserved {
            background: var(--reserved);
            color: white;
        }

        .availability-details {
            font-size: 0.9rem;
            color: var(--dark-gray);
            margin-bottom: 1rem;
        }

        .book-actions {
            display: flex;
            gap: 12px;
            margin-top: 1.5rem;
        }

        .book-action-btn {
            padding: 12px 24px;
            border-radius: 8px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            font-size: 1rem;
            border: none;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .borrow-btn {
            background: linear-gradient(135deg, var(--gold), var(--gold-dark));
            color: var(--black);
            flex: 1;
        }

        .borrow-btn:hover:not(:disabled) {
            transform: translateY(-2px);
            box-shadow: 0 8px 20px rgba(212, 175, 55, 0.3);
        }

        .borrow-btn:disabled {
            opacity: 0.6;
            cursor: not-allowed;
        }

        .digital-btn {
            background: linear-gradient(135deg, var(--digital), #2980b9);
            color: white;
        }

        .digital-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 20px rgba(52, 152, 219, 0.3);
        }

        .wishlist-btn {
            background: var(--gray);
            color: var(--dark-gray);
            border: 1px solid var(--light-gray);
        }

        .wishlist-btn:hover {
            background: var(--light-gray);
            transform: translateY(-2px);
        }

        /* BORROW MODAL */
        .borrow-modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: var(--modal-overlay);
            z-index: 3500;
            justify-content: center;
            align-items: center;
            padding: 20px;
        }

        .borrow-modal.active {
            display: flex;
        }

        .borrow-modal-content {
            background-color: white;
            border-radius: 16px;
            width: 100%;
            max-width: 500px;
            overflow: hidden;
            box-shadow: 0 25px 50px rgba(0, 0, 0, 0.3);
            animation: modalAppear 0.4s ease-out;
            position: relative;
        }

        .borrow-modal-header {
            background: linear-gradient(135deg, var(--gold), var(--gold-dark));
            color: var(--black);
            padding: 1.8rem 2rem;
            text-align: center;
            position: relative;
        }

        .borrow-modal-header h2 {
            font-size: 1.6rem;
            margin-bottom: 0.5rem;
            font-weight: 700;
        }

        .borrow-modal-body {
            padding: 2rem;
        }

        .borrow-details {
            background: var(--gray);
            border-radius: 12px;
            padding: 1.5rem;
            margin-bottom: 1.5rem;
        }

        .borrow-detail-item {
            display: flex;
            justify-content: space-between;
            margin-bottom: 0.8rem;
        }

        .borrow-detail-item:last-child {
            margin-bottom: 0;
        }

        .borrow-detail-label {
            font-weight: 600;
            color: var(--dark-gray);
        }

        .borrow-detail-value {
            color: var(--black);
            text-align: right;
        }

        .borrow-terms {
            font-size: 0.85rem;
            color: var(--dark-gray);
            line-height: 1.5;
            margin-top: 1.5rem;
            padding-top: 1.5rem;
            border-top: 1px solid var(--light-gray);
        }

        .borrow-modal-footer {
            display: flex;
            gap: 12px;
            margin-top: 2rem;
            padding-top: 1.5rem;
            border-top: 1px solid var(--light-gray);
        }

        .confirm-borrow-btn {
            background: linear-gradient(135deg, var(--gold), var(--gold-dark));
            color: var(--black);
            border: none;
            padding: 14px 28px;
            border-radius: 10px;
            font-weight: 700;
            cursor: pointer;
            transition: all 0.3s ease;
            font-size: 1rem;
            flex: 1;
        }

        .confirm-borrow-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 20px rgba(212, 175, 55, 0.3);
        }

        .cancel-borrow-btn {
            background: var(--gray);
            color: var(--dark-gray);
            border: 1px solid var(--light-gray);
            padding: 14px 28px;
            border-radius: 10px;
            font-weight: 700;
            cursor: pointer;
            transition: all 0.3s ease;
            font-size: 1rem;
            flex: 1;
        }

        .cancel-borrow-btn:hover {
            background: var(--light-gray);
            transform: translateY(-2px);
        }

        /* SIGNIN MODAL */
        .signin-modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: var(--modal-overlay);
            z-index: 4000;
            justify-content: center;
            align-items: center;
            padding: 20px;
        }

        .signin-modal.active {
            display: flex;
        }

        .signin-content {
            background-color: white;
            border-radius: 16px;
            width: 100%;
            max-width: 420px;
            overflow: hidden;
            box-shadow: 0 25px 50px rgba(0, 0, 0, 0.3);
            animation: modalAppear 0.4s ease-out;
            position: relative;
        }

        .signin-header {
            background: linear-gradient(135deg, var(--gold), var(--gold-dark));
            color: var(--black);
            padding: 2rem;
            text-align: center;
            position: relative;
        }

        .signin-header h2 {
            font-size: 1.8rem;
            margin-bottom: 0.5rem;
            font-weight: 700;
        }

        /* HEADER */
        header {
            background-color: var(--white);
            color: var(--black);
            padding: 0.5rem 1rem;
            position: sticky;
            top: 0;
            z-index: 100;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
            border-bottom: 1px solid var(--light-gray);
            height: 60px;
            backdrop-filter: blur(10px);
        }

        .header-container {
            display: flex;
            justify-content: space-between;
            align-items: center;
            height: 100%;
        }

        .logo {
            display: flex;
            align-items: center;
            gap: 10px;
            cursor: pointer;
        }

        .logo img {
            height: 40px;
            width: auto;
        }

        .brand-info {
            display: flex;
            flex-direction: column;
        }

        .brand-name {
            font-weight: bold;
            font-size: 1.2rem;
            color: var(--gold-dark);
        }

        .brand-subtitle {
            font-size: 0.7rem;
            color: var(--dark-gray);
            font-style: italic;
        }

        /* SEARCH BAR */
        .search-container {
            flex: 1;
            max-width: 400px;
            margin: 0 20px;
        }

        .search-box {
            display: flex;
            align-items: center;
            background: var(--gray);
            border-radius: 20px;
            padding: 8px 15px;
            border: 1px solid var(--light-gray);
        }

        .search-box i {
            color: var(--dark-gray);
            margin-right: 10px;
        }

        .search-box input {
            border: none;
            background: transparent;
            outline: none;
            width: 100%;
            font-size: 0.9rem;
        }

        /* USER PROFILE */
        .auth-section {
            display: flex;
            align-items: center;
            gap: 10px;
            position: relative;
        }

        .user-profile {
            display: flex;
            align-items: center;
            gap: 10px;
            padding: 5px 10px;
            border-radius: 20px;
            background: var(--gold-light);
            cursor: pointer;
            position: relative;
            transition: all 0.3s ease;
        }

        .user-profile:hover {
            background: var(--gold);
        }

        .user-avatar {
            width: 32px;
            height: 32px;
            border-radius: 50%;
            overflow: hidden;
        }

        .user-avatar img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        .user-name {
            font-weight: 600;
            font-size: 0.9rem;
            color: var(--black);
        }

        .user-dropdown {
            position: absolute;
            top: 100%;
            right: 0;
            background: white;
            border-radius: 8px;
            box-shadow: 0 4px 20px var(--shadow);
            min-width: 200px;
            z-index: 1000;
            display: none;
            margin-top: 5px;
            overflow: hidden;
            border: 1px solid var(--light-gray);
        }

        .user-dropdown.active {
            display: block;
            animation: slideDown 0.2s ease-out;
        }

        @keyframes slideDown {
            from {
                opacity: 0;
                transform: translateY(-10px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .dropdown-item {
            padding: 12px 16px;
            display: flex;
            align-items: center;
            gap: 10px;
            cursor: pointer;
            transition: background-color 0.2s;
            border-bottom: 1px solid var(--light-gray);
        }

        .dropdown-item:last-child {
            border-bottom: none;
        }

        .dropdown-item:hover {
            background-color: var(--gold-light);
        }

        .dropdown-item i {
            width: 20px;
            text-align: center;
            color: var(--gold-dark);
        }

        /* MAIN CONTENT */
        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 1rem;
        }

        /* LIBRARY HEADER */
        .library-header {
            margin: 2rem 0 1.5rem 0;
            text-align: center;
        }

        .library-title {
            font-size: 2.2rem;
            color: var(--gold-dark);
            font-weight: 800;
            margin-bottom: 0.5rem;
            position: relative;
            display: inline-block;
        }

        .library-title:after {
            content: '';
            position: absolute;
            bottom: -10px;
            left: 50%;
            transform: translateX(-50%);
            width: 80px;
            height: 4px;
            background: linear-gradient(to right, var(--gold), var(--gold-dark));
            border-radius: 2px;
        }

        .library-subtitle {
            font-size: 1.1rem;
            color: var(--dark-gray);
            margin-top: 1.5rem;
            max-width: 600px;
            margin-left: auto;
            margin-right: auto;
            line-height: 1.7;
        }

        /* MEMBERSHIP INFO */
        .membership-info {
            background: linear-gradient(135deg, var(--gold-light), #fef3c7);
            border-radius: 16px;
            padding: 1.5rem;
            margin-bottom: 2rem;
            border: 2px solid var(--gold);
            display: flex;
            align-items: center;
            justify-content: space-between;
            flex-wrap: wrap;
            gap: 1rem;
        }

        .membership-details {
            flex: 1;
            min-width: 300px;
        }

        .membership-tier {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-bottom: 0.5rem;
        }

        .tier-badge {
            background: var(--gold-dark);
            color: white;
            padding: 4px 12px;
            border-radius: 20px;
            font-size: 0.8rem;
            font-weight: 700;
        }

        .tier-name {
            font-weight: 700;
            color: var(--gold-dark);
            font-size: 1.2rem;
        }

        .membership-stats {
            display: flex;
            gap: 1.5rem;
            flex-wrap: wrap;
            margin-top: 1rem;
        }

        .stat-item {
            display: flex;
            flex-direction: column;
            align-items: center;
            padding: 0.8rem 1.2rem;
            background: white;
            border-radius: 10px;
            min-width: 120px;
        }

        .stat-value {
            font-size: 1.8rem;
            font-weight: 800;
            color: var(--gold-dark);
        }

        .stat-label {
            font-size: 0.85rem;
            color: var(--dark-gray);
            text-align: center;
        }

        .upgrade-prompt {
            background: white;
            padding: 1.2rem 1.8rem;
            border-radius: 12px;
            text-align: center;
            border: 1px solid var(--gold);
        }

        .upgrade-prompt h4 {
            color: var(--gold-dark);
            margin-bottom: 0.5rem;
        }

        .upgrade-btn {
            background: linear-gradient(135deg, var(--gold), var(--gold-dark));
            color: var(--black);
            border: none;
            padding: 10px 20px;
            border-radius: 8px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            margin-top: 0.8rem;
            display: inline-block;
        }

        .upgrade-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 20px rgba(212, 175, 55, 0.3);
        }

        /* FILTERS SECTION */
        .filters-section {
            background: white;
            border-radius: 16px;
            padding: 1.5rem;
            margin-bottom: 2rem;
            box-shadow: 0 4px 15px var(--shadow);
            border: 1px solid var(--light-gray);
        }

        .filter-tabs {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            margin-bottom: 1.5rem;
        }

        .filter-tab {
            padding: 10px 24px;
            border: 2px solid var(--light-gray);
            background: white;
            border-radius: 25px;
            cursor: pointer;
            font-weight: 600;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .filter-tab.active {
            background: var(--gold);
            border-color: var(--gold);
            color: var(--black);
        }

        .filter-tab:hover:not(.active) {
            border-color: var(--gold);
            color: var(--gold-dark);
        }

        .filter-controls {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 1rem;
        }

        .filter-group {
            display: flex;
            flex-direction: column;
            gap: 0.5rem;
        }

        .filter-group label {
            font-weight: 600;
            color: var(--dark-gray);
            font-size: 0.9rem;
        }

        .filter-group select {
            padding: 12px 16px;
            border: 2px solid var(--light-gray);
            border-radius: 10px;
            font-size: 0.95rem;
            outline: none;
            background: white;
            transition: all 0.3s ease;
        }

        .filter-group select:focus {
            border-color: var(--gold);
            box-shadow: 0 0 0 3px rgba(212, 175, 55, 0.1);
        }

        /* LIBRARY GRID */
        .library-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
            gap: 1.5rem;
            margin-bottom: 3rem;
        }

        /* BOOK CARD */
        .book-card {
            background: var(--white);
            border: 1px solid var(--light-gray);
            border-radius: 16px;
            overflow: hidden;
            box-shadow: 0 4px 15px var(--shadow);
            transition: all 0.3s ease;
            position: relative;
            height: 100%;
            display: flex;
            flex-direction: column;
        }

        .book-card:hover {
            transform: translateY(-6px);
            box-shadow: 0 12px 25px var(--shadow);
        }

        .book-card.featured {
            border: 3px solid var(--gold);
        }

        .featured-badge {
            position: absolute;
            top: 15px;
            right: 15px;
            background: var(--gold);
            color: var(--black);
            padding: 6px 12px;
            border-radius: 20px;
            font-size: 0.8rem;
            font-weight: 700;
            z-index: 2;
            display: flex;
            align-items: center;
            gap: 6px;
        }

        .availability-badge {
            position: absolute;
            top: 15px;
            left: 15px;
            padding: 6px 12px;
            border-radius: 20px;
            font-size: 0.8rem;
            font-weight: 700;
            z-index: 2;
            color: white;
        }

        .available {
            background: var(--available);
        }

        .borrowed {
            background: var(--borrowed);
        }

        .reserved {
            background: var(--reserved);
        }

        .digital-only {
            background: var(--digital);
        }

        .book-cover {
            height: 200px;
            width: 100%;
            overflow: hidden;
            position: relative;
        }

        .book-cover img {
            width: 100%;
            height: 100%;
            object-fit: cover;
            transition: transform 0.5s ease;
        }

        .book-card:hover .book-cover img {
            transform: scale(1.05);
        }

        .book-content {
            padding: 1.5rem;
            flex: 1;
            display: flex;
            flex-direction: column;
        }

        .book-category {
            display: inline-block;
            padding: 4px 10px;
            border-radius: 12px;
            font-size: 0.75rem;
            font-weight: 700;
            margin-bottom: 0.8rem;
            align-self: flex-start;
        }

        .fiction {
            background: rgba(155, 89, 182, 0.1);
            color: var(--fiction);
        }

        .non-fiction {
            background: rgba(230, 126, 34, 0.1);
            color: var(--non-fiction);
        }

        .business {
            background: rgba(26, 188, 156, 0.1);
            color: var(--business);
        }

        .personal-growth {
            background: rgba(52, 152, 219, 0.1);
            color: #3498db;
        }

        .finance {
            background: rgba(46, 204, 113, 0.1);
            color: #27ae60;
        }

        .book-title {
            font-size: 1.2rem;
            color: var(--gold-dark);
            margin-bottom: 0.5rem;
            line-height: 1.3;
            font-weight: 700;
            flex: 1;
        }

        .book-author {
            color: var(--dark-gray);
            font-size: 0.9rem;
            margin-bottom: 0.8rem;
        }

        .book-rating {
            display: flex;
            align-items: center;
            gap: 6px;
            margin-bottom: 1rem;
        }

        .stars {
            color: var(--gold);
        }

        .rating-value {
            font-weight: 600;
            color: var(--dark-gray);
            font-size: 0.9rem;
        }

        .book-meta-small {
            display: flex;
            gap: 1rem;
            margin-bottom: 1rem;
            font-size: 0.85rem;
            color: var(--dark-gray);
        }

        .book-actions {
            display: flex;
            gap: 10px;
            margin-top: auto;
            padding-top: 1rem;
            border-top: 1px solid var(--light-gray);
        }

        .book-action-btn {
            padding: 10px 16px;
            border-radius: 8px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            font-size: 0.9rem;
            border: none;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            flex: 1;
        }

        .borrow-book-btn {
            background: linear-gradient(135deg, var(--gold), var(--gold-dark));
            color: var(--black);
        }

        .borrow-book-btn:hover:not(:disabled) {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(212, 175, 55, 0.3);
        }

        .borrow-book-btn:disabled {
            opacity: 0.6;
            cursor: not-allowed;
        }

        .details-btn {
            background: var(--gray);
            color: var(--dark-gray);
            border: 1px solid var(--light-gray);
        }

        .details-btn:hover {
            background: var(--light-gray);
            transform: translateY(-2px);
        }

        /* MY BOOKS SECTION */
        .my-books-section {
            margin: 3rem 0;
        }

        .section-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1.5rem;
        }

        .section-title {
            font-size: 1.5rem;
            color: var(--gold-dark);
            font-weight: 700;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .view-all-btn {
            background: var(--gold-light);
            color: var(--gold-dark);
            border: none;
            padding: 8px 16px;
            border-radius: 8px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .view-all-btn:hover {
            background: var(--gold);
            transform: translateY(-2px);
        }

        .borrowed-books {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
            gap: 1.5rem;
        }

        .borrowed-book-card {
            background: white;
            border-radius: 12px;
            padding: 1.5rem;
            border: 2px solid var(--gold-light);
            display: flex;
            gap: 1rem;
            align-items: center;
        }

        .borrowed-book-cover {
            width: 80px;
            height: 100px;
            border-radius: 8px;
            overflow: hidden;
            flex-shrink: 0;
        }

        .borrowed-book-cover img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        .borrowed-book-info {
            flex: 1;
        }

        .borrowed-book-title {
            font-weight: 700;
            color: var(--gold-dark);
            margin-bottom: 0.5rem;
        }

        .due-date {
            color: var(--borrowed);
            font-weight: 600;
            font-size: 0.9rem;
            display: flex;
            align-items: center;
            gap: 6px;
        }

        .borrowed-actions {
            display: flex;
            gap: 8px;
        }

        .renew-btn {
            background: var(--gold-light);
            color: var(--gold-dark);
            border: none;
            padding: 8px 16px;
            border-radius: 6px;
            font-weight: 600;
            cursor: pointer;
            font-size: 0.85rem;
            transition: all 0.3s ease;
        }

        .renew-btn:hover:not(:disabled) {
            background: var(--gold);
            transform: translateY(-2px);
        }

        .renew-btn:disabled {
            opacity: 0.6;
            cursor: not-allowed;
        }

        /* ARTICLES SECTION */
        .articles-section {
            margin: 3rem 0;
        }

        .articles-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
            gap: 1.5rem;
        }

        .article-card {
            background: white;
            border-radius: 12px;
            overflow: hidden;
            box-shadow: 0 4px 15px var(--shadow);
            transition: all 0.3s ease;
        }

        .article-card:hover {
            transform: translateY(-4px);
            box-shadow: 0 12px 25px var(--shadow);
        }

        .article-image {
            height: 160px;
            width: 100%;
            overflow: hidden;
        }

        .article-image img {
            width: 100%;
            height: 100%;
            object-fit: cover;
            transition: transform 0.5s ease;
        }

        .article-card:hover .article-image img {
            transform: scale(1.05);
        }

        .article-content {
            padding: 1.5rem;
        }

        .article-title {
            font-size: 1.1rem;
            color: var(--gold-dark);
            margin-bottom: 0.8rem;
            line-height: 1.3;
        }

        .article-excerpt {
            color: var(--dark-gray);
            font-size: 0.9rem;
            line-height: 1.6;
            margin-bottom: 1rem;
            display: -webkit-box;
            -webkit-line-clamp: 3;
            -webkit-box-orient: vertical;
            overflow: hidden;
        }

        .article-meta {
            display: flex;
            justify-content: space-between;
            align-items: center;
            font-size: 0.85rem;
            color: var(--dark-gray);
        }

        .read-time {
            display: flex;
            align-items: center;
            gap: 6px;
        }

        /* LOADING AND EMPTY STATES */
        .loading {
            text-align: center;
            padding: 4rem;
            color: var(--gold-dark);
            grid-column: 1 / -1;
        }

        .loading-spinner {
            border: 4px solid var(--gold-light);
            border-top: 4px solid var(--gold);
            border-radius: 50%;
            width: 48px;
            height: 48px;
            animation: spin 1s linear infinite;
            margin: 0 auto 1.5rem;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .empty-state {
            text-align: center;
            padding: 4rem;
            color: var(--dark-gray);
            grid-column: 1 / -1;
        }

        .empty-state i {
            font-size: 3.5rem;
            color: var(--gold-light);
            margin-bottom: 1.5rem;
        }

        .empty-state h3 {
            font-size: 1.4rem;
            margin-bottom: 0.8rem;
            color: var(--gold-dark);
        }

        /* NOTIFICATION */
        .notification {
            position: fixed;
            top: 80px;
            right: 20px;
            background: var(--black);
            color: white;
            padding: 14px 24px;
            border-radius: 12px;
            z-index: 1000;
            opacity: 0;
            transform: translateY(-20px);
            transition: all 0.3s ease;
            max-width: 300px;
            box-shadow: 0 8px 25px var(--shadow);
            font-weight: 500;
        }

        .notification.show {
            opacity: 1;
            transform: translateY(0);
        }

        .notification.error {
            background: #e74c3c;
        }

        .notification.success {
            background: var(--gold);
            color: var(--black);
        }

        .notification.info {
            background: #3498db;
        }

        /* BOTTOM NAVIGATION */
        .bottom-nav {
            position: fixed;
            bottom: 0;
            left: 0;
            width: 100%;
            background-color: var(--white);
            display: flex;
            justify-content: space-around;
            padding: 0.8rem 0;
            z-index: 100;
            border-top: 1px solid var(--light-gray);
            backdrop-filter: blur(10px);
            box-shadow: 0 -2px 10px rgba(0, 0, 0, 0.05);
        }

        .nav-item {
            display: flex;
            flex-direction: column;
            align-items: center;
            color: var(--dark-gray);
            text-decoration: none;
            font-size: 0.85rem;
            transition: all 0.3s ease;
            position: relative;
            padding: 8px 12px;
            border-radius: 12px;
        }

        .nav-icon {
            font-size: 1.4rem;
            margin-bottom: 4px;
        }

        .nav-item.active {
            color: var(--gold-dark);
            background: var(--gold-light);
            font-weight: 600;
        }

        .nav-item:hover {
            color: var(--gold-dark);
            transform: translateY(-3px);
        }

        /* RESPONSIVE DESIGN */
        @media (max-width: 992px) {
            .library-grid {
                grid-template-columns: repeat(auto-fill, minmax(250px, 1fr));
            }
            
            .borrowed-books,
            .articles-grid {
                grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
            }
            
            .membership-info {
                flex-direction: column;
                text-align: center;
            }
            
            .membership-details {
                min-width: 100%;
            }
        }

        @media (max-width: 768px) {
            .search-container {
                display: none;
            }
            
            .user-name {
                display: none;
            }
            
            .filter-tabs {
                justify-content: center;
            }
            
            .filter-controls {
                grid-template-columns: 1fr;
            }
            
            .library-grid {
                grid-template-columns: repeat(auto-fill, minmax(220px, 1fr));
            }
            
            .book-modal-body {
                grid-template-columns: 1fr;
            }
            
            .book-cover-large {
                height: 300px;
                margin: 0 auto;
                max-width: 300px;
            }
            
            .book-actions {
                flex-direction: column;
            }
            
            .section-header {
                flex-direction: column;
                align-items: flex-start;
                gap: 1rem;
            }
            
            .borrowed-book-card {
                flex-direction: column;
                text-align: center;
            }
            
            .borrowed-actions {
                justify-content: center;
            }
        }

        @media (max-width: 480px) {
            .brand-subtitle {
                display: none;
            }
            
            .library-title {
                font-size: 1.8rem;
            }
            
            .library-subtitle {
                font-size: 1rem;
            }
            
            .filter-tab {
                padding: 8px 16px;
                font-size: 0.9rem;
            }
            
            .library-grid {
                grid-template-columns: 1fr;
            }
            
            .stat-item {
                min-width: 100px;
                padding: 0.6rem 0.8rem;
            }
            
            .bottom-nav {
                padding: 0.6rem 0;
            }
            
            .nav-item {
                font-size: 0.75rem;
                padding: 6px 8px;
            }
            
            .nav-icon {
                font-size: 1.2rem;
            }
        }

        /* SCROLLBAR STYLING */
        ::-webkit-scrollbar {
            width: 10px;
        }

        ::-webkit-scrollbar-track {
            background: var(--light-gray);
            border-radius: 5px;
        }

        ::-webkit-scrollbar-thumb {
            background: var(--gold);
            border-radius: 5px;
        }

        ::-webkit-scrollbar-thumb:hover {
            background: var(--gold-dark);
        }

        /* QUICK STATS */
        .quick-stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 1rem;
            margin-bottom: 2rem;
        }

        .stat-card {
            background: white;
            border-radius: 12px;
            padding: 1.5rem;
            text-align: center;
            box-shadow: 0 4px 12px var(--shadow);
            border: 1px solid var(--light-gray);
            transition: all 0.3s ease;
        }

        .stat-card:hover {
            transform: translateY(-4px);
            box-shadow: 0 8px 20px var(--shadow);
        }

        .stat-icon {
            width: 60px;
            height: 60px;
            background: var(--gold-light);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            margin: 0 auto 1rem;
            font-size: 1.5rem;
            color: var(--gold-dark);
        }

        .stat-number {
            font-size: 2rem;
            font-weight: 800;
            color: var(--gold-dark);
            margin-bottom: 0.5rem;
        }

        .stat-text {
            color: var(--dark-gray);
            font-size: 0.9rem;
        }

        /* CATEGORY BADGES */
        .category-badges {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            margin-bottom: 2rem;
        }

        .category-badge {
            padding: 10px 20px;
            border-radius: 25px;
            background: var(--gray);
            color: var(--dark-gray);
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .category-badge.active {
            background: var(--gold);
            color: var(--black);
        }

        .category-badge:hover:not(.active) {
            background: var(--light-gray);
            transform: translateY(-2px);
        }

        .category-badge i {
            font-size: 1rem;
        }
    </style>
</head>
<body>
    <!-- Notification -->
    <div class="notification" id="notification"></div>

    <!-- Sign In Modal -->
    <div class="signin-modal" id="signinModal">
        <div class="signin-content">
            <div class="signin-header">
                <h2>Welcome to THE SONGA</h2>
                <p>UNBOUND | UNBENT | UNBROKEN</p>
                <button class="close-signin-modal" id="closeSigninModal">&times;</button>
            </div>
            <div class="signin-body">
                <p>Sign in to access our library, borrow books, and read exclusive articles.</p>
                
                <div class="google-signin-container">
                    <div id="g_id_onload"
                         data-client_id="123922889572-9dmjivsoese0b0o78poo5mgu7nqqm6e6.apps.googleusercontent.com"
                         data-context="signin"
                         data-ux_mode="popup"
                         data-callback="handleGoogleSignIn"
                         data-auto_prompt="false">
                    </div>
                    <div class="g_id_signin"
                         data-type="standard"
                         data-shape="rectangular"
                         data-theme="outline"
                         data-text="signin_with"
                         data-size="large"
                         data-logo_alignment="left">
                    </div>
                </div>
                
                <div class="signin-footer">
                    By signing in, you agree to our community guidelines and membership terms.
                </div>
            </div>
        </div>
    </div>

    <!-- Book Details Modal -->
    <div class="book-modal" id="bookModal">
        <div class="book-modal-content">
            <div class="book-modal-header">
                <h2 id="bookModalTitle">Book Title</h2>
                <p id="bookModalAuthor">by Author Name</p>
                <button class="close-book-modal" id="closeBookModal">&times;</button>
            </div>
            <div class="book-modal-body">
                <div class="book-cover-large">
                    <img id="bookModalCover" src="" alt="Book Cover">
                </div>
                <div class="book-info">
                    <div class="book-meta">
                        <div class="book-meta-item">
                            <i class="fas fa-star"></i>
                            <span id="bookModalRating">4.5</span>
                        </div>
                        <div class="book-meta-item">
                            <i class="fas fa-book"></i>
                            <span id="bookModalPages">320 pages</span>
                        </div>
                        <div class="book-meta-item">
                            <i class="fas fa-calendar"></i>
                            <span id="bookModalYear">2023</span>
                        </div>
                        <div class="book-meta-item">
                            <i class="fas fa-layer-group"></i>
                            <span id="bookModalFormat">Paperback</span>
                        </div>
                    </div>
                    
                    <div class="book-description" id="bookModalDescription">
                        Book description will appear here...
                    </div>
                    
                    <div class="book-tags" id="bookModalTags">
                        <!-- Tags will be populated here -->
                    </div>
                    
                    <div class="book-availability">
                        <div class="availability-status">
                            <span class="status-label">Availability:</span>
                            <span class="status-value" id="bookModalStatus">Available</span>
                        </div>
                        <div class="availability-details" id="bookModalAvailabilityDetails">
                            <!-- Availability details will be populated here -->
                        </div>
                    </div>
                    
                    <div class="book-actions">
                        <button class="book-action-btn borrow-btn" id="borrowFromModalBtn">
                            <i class="fas fa-book-reader"></i> Borrow Book
                        </button>
                        <button class="book-action-btn digital-btn" id="digitalAccessBtn" style="display: none;">
                            <i class="fas fa-file-pdf"></i> Digital Access
                        </button>
                        <button class="book-action-btn wishlist-btn">
                            <i class="fas fa-heart"></i> Wishlist
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Borrow Confirmation Modal -->
    <div class="borrow-modal" id="borrowModal">
        <div class="borrow-modal-content">
            <div class="borrow-modal-header">
                <h2>Borrow Book</h2>
                <p id="borrowBookTitle">Book Title</p>
                <button class="close-borrow-modal" id="closeBorrowModal">&times;</button>
            </div>
            <div class="borrow-modal-body">
                <div class="borrow-details">
                    <div class="borrow-detail-item">
                        <span class="borrow-detail-label">Book:</span>
                        <span class="borrow-detail-value" id="borrowBookName"></span>
                    </div>
                    <div class="borrow-detail-item">
                        <span class="borrow-detail-label">Author:</span>
                        <span class="borrow-detail-value" id="borrowBookAuthor"></span>
                    </div>
                    <div class="borrow-detail-item">
                        <span class="borrow-detail-label">Borrow Period:</span>
                        <span class="borrow-detail-value" id="borrowPeriod">14 days</span>
                    </div>
                    <div class="borrow-detail-item">
                        <span class="borrow-detail-label">Due Date:</span>
                        <span class="borrow-detail-value" id="borrowDueDate"></span>
                    </div>
                    <div class="borrow-detail-item">
                        <span class="borrow-detail-label">Pickup Location:</span>
                        <span class="borrow-detail-value" id="borrowLocation"></span>
                    </div>
                </div>
                
                <div class="borrow-terms">
                    <p><strong>Borrowing Terms:</strong></p>
                    <ul style="margin-left: 1.5rem; margin-top: 0.5rem;">
                        <li>Return books on or before due date</li>
                        <li>Late returns incur daily fines of KSh 50</li>
                        <li>Maximum 2 renewals per book</li>
                        <li>Handle books with care, no writing/damage</li>
                        <li>Report lost books immediately</li>
                    </ul>
                </div>
                
                <div class="borrow-modal-footer">
                    <button class="cancel-borrow-btn" id="cancelBorrowBtn">Cancel</button>
                    <button class="confirm-borrow-btn" id="confirmBorrowBtn">Confirm Borrow</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Header -->
    <header>
        <div class="header-container">
            <div class="logo" onclick="window.location.href='index.html'">
                <img src="https://i.postimg.cc/BbdzCkxQ/20260116-0851-Elegant-Lion-Emblem-remix-01kf2npwbtf06ttr4htekjnd47-removebg-preview-2.webp" alt="THE SONGA Logo">
                <div class="brand-info">
                    <div class="brand-name">THE SONGA</div>
                    <div class="brand-subtitle">UNBOUND | UNBENT | UNBROKEN</div>
                </div>
            </div>
            
            <div class="search-container">
                <div class="search-box">
                    <i class="fas fa-search"></i>
                    <input type="text" placeholder="Search books, authors, topics..." id="searchInput">
                </div>
            </div>
            
            <div class="auth-section">
                <div id="userProfile" class="user-profile" style="display: none;">
                    <div class="user-avatar">
                        <img id="userAvatar" src="" alt="User Avatar">
                    </div>
                    <div class="user-name" id="userDisplayName"></div>
                    <div class="user-dropdown" id="userDropdown">
                        <div class="dropdown-item" onclick="window.location.href='profile.html'">
                            <i class="fas fa-user"></i>
                            <span>My Profile</span>
                        </div>
                        <div class="dropdown-item" id="signOutOption">
                            <i class="fas fa-sign-out-alt"></i>
                            <span>Sign Out</span>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </header>

    <!-- Main Content -->
    <main class="container">
        <div class="library-header">
            <h1 class="library-title">Knowledge Library</h1>
            <p class="library-subtitle">
                Access our curated collection of books and articles on personal growth, business, 
                finance, and spirituality. Expand your knowledge with THE SONGA.
            </p>
        </div>

        <!-- Quick Stats -->
        <div class="quick-stats" id="quickStats">
            <div class="stat-card">
                <div class="stat-icon">
                    <i class="fas fa-book"></i>
                </div>
                <div class="stat-number" id="totalBooks">0</div>
                <div class="stat-text">Books Available</div>
            </div>
            <div class="stat-card">
                <div class="stat-icon">
                    <i class="fas fa-user-graduate"></i>
                </div>
                <div class="stat-number" id="totalBorrows">0</div>
                <div class="stat-text">Books Borrowed</div>
            </div>
            <div class="stat-card">
                <div class="stat-icon">
                    <i class="fas fa-newspaper"></i>
                </div>
                <div class="stat-number" id="totalArticles">0</div>
                <div class="stat-text">Articles</div>
            </div>
            <div class="stat-card">
                <div class="stat-icon">
                    <i class="fas fa-users"></i>
                </div>
                <div class="stat-number" id="activeReaders">0</div>
                <div class="stat-text">Active Readers</div>
            </div>
        </div>

        <!-- Membership Info -->
        <div class="membership-info" id="membershipInfo" style="display: none;">
            <div class="membership-details">
                <div class="membership-tier">
                    <span class="tier-badge" id="tierBadge">EXPLORER</span>
                    <span class="tier-name" id="tierName">Explorer Plan</span>
                </div>
                <p id="tierDescription">Basic access to community and limited library resources</p>
                <div class="membership-stats">
                    <div class="stat-item">
                        <div class="stat-value" id="booksBorrowed">0</div>
                        <div class="stat-label">Books Borrowed</div>
                    </div>
                    <div class="stat-item">
                        <div class="stat-value" id="booksLimit">5</div>
                        <div class="stat-label">Monthly Limit</div>
                    </div>
                    <div class="stat-item">
                        <div class="stat-value" id="renewalsLeft">0</div>
                        <div class="stat-label">Renewals Left</div>
                    </div>
                </div>
            </div>
            <div class="upgrade-prompt">
                <h4>Upgrade for More Access</h4>
                <p>Get unlimited books, priority access, and exclusive content</p>
                <button class="upgrade-btn" onclick="showUpgradeOptions()">
                    <i class="fas fa-crown"></i> Upgrade Now
                </button>
            </div>
        </div>

        <!-- Category Badges -->
        <div class="category-badges" id="categoryBadges">
            <div class="category-badge active" data-category="all">
                <i class="fas fa-th-large"></i> All Books
            </div>
            <div class="category-badge" data-category="business">
                <i class="fas fa-briefcase"></i> Business
            </div>
            <div class="category-badge" data-category="finance">
                <i class="fas fa-chart-line"></i> Finance
            </div>
            <div class="category-badge" data-category="personal-growth">
                <i class="fas fa-brain"></i> Personal Growth
            </div>
            <div class="category-badge" data-category="non-fiction">
                <i class="fas fa-book-open"></i> Non-Fiction
            </div>
            <div class="category-badge" data-category="fiction">
                <i class="fas fa-theater-masks"></i> Fiction
            </div>
        </div>

        <!-- Filters Section -->
        <div class="filters-section">
            <div class="filter-tabs" id="filterTabs">
                <button class="filter-tab active" data-filter="all">
                    All Books
                    <span class="count" id="countAll">0</span>
                </button>
                <button class="filter-tab" data-filter="available">
                    <i class="fas fa-check-circle"></i> Available
                    <span class="count" id="countAvailable">0</span>
                </button>
                <button class="filter-tab" data-filter="featured">
                    <i class="fas fa-star"></i> Featured
                    <span class="count" id="countFeatured">0</span>
                </button>
                <button class="filter-tab" data-filter="digital">
                    <i class="fas fa-file-pdf"></i> Digital
                    <span class="count" id="countDigital">0</span>
                </button>
            </div>
            
            <div class="filter-controls">
                <div class="filter-group">
                    <label for="sortFilter"><i class="fas fa-sort"></i> Sort By</label>
                    <select id="sortFilter">
                        <option value="popularity">Most Popular</option>
                        <option value="title">Title A-Z</option>
                        <option value="author">Author A-Z</option>
                        <option value="rating">Highest Rated</option>
                        <option value="date-added">Recently Added</option>
                    </select>
                </div>
                
                <div class="filter-group">
                    <label for="availabilityFilter"><i class="fas fa-filter"></i> Availability</label>
                    <select id="availabilityFilter">
                        <option value="all">All Status</option>
                        <option value="available">Available Now</option>
                        <option value="borrowed">Currently Borrowed</option>
                        <option value="digital">Digital Only</option>
                    </select>
                </div>
                
                <div class="filter-group">
                    <label for="formatFilter"><i class="fas fa-book"></i> Format</label>
                    <select id="formatFilter">
                        <option value="all">All Formats</option>
                        <option value="physical">Physical Books</option>
                        <option value="digital">Digital Books</option>
                        <option value="both">Both Formats</option>
                    </select>
                </div>
            </div>
        </div>

        <!-- My Books Section -->
        <div class="my-books-section" id="myBooksSection" style="display: none;">
            <div class="section-header">
                <h2 class="section-title">
                    <i class="fas fa-bookmark"></i> My Books
                </h2>
                <button class="view-all-btn" onclick="showAllBorrowedBooks()">
                    View All <i class="fas fa-arrow-right"></i>
                </button>
            </div>
            
            <div class="borrowed-books" id="borrowedBooksList">
                <!-- Borrowed books will be populated here -->
            </div>
        </div>

        <!-- Library Grid -->
        <div class="library-grid" id="libraryGrid">
            <div class="loading">
                <div class="loading-spinner"></div>
                <p>Loading library books...</p>
            </div>
        </div>

        <!-- Articles Section -->
        <div class="articles-section">
            <div class="section-header">
                <h2 class="section-title">
                    <i class="fas fa-newspaper"></i> Featured Articles
                </h2>
                <button class="view-all-btn">
                    View All <i class="fas fa-arrow-right"></i>
                </button>
            </div>
            
            <div class="articles-grid" id="articlesGrid">
                <!-- Articles will be populated here -->
            </div>
        </div>

        <!-- Empty State Template -->
        <template id="emptyStateTemplate">
            <div class="empty-state">
                <i class="fas fa-book-open"></i>
                <h3>No Books Found</h3>
                <p>Try adjusting your filters or check back for new additions to our library.</p>
            </div>
        </template>
    </main>

    <!-- Bottom Navigation -->
    <nav class="bottom-nav">
        <a href="index.html" class="nav-item">
            <i class="fas fa-home nav-icon"></i>
            <span>Feed</span>
        </a>
        <a href="events.html" class="nav-item">
            <i class="fas fa-calendar-alt nav-icon"></i>
            <span>Events</span>
        </a>
        <a href="library.html" class="nav-item active">
            <i class="fas fa-book nav-icon"></i>
            <span>Library</span>
        </a>
        <a href="profile.html" class="nav-item">
            <i class="fas fa-user nav-icon"></i>
            <span>Profile</span>
        </a>
    </nav>

    <!-- Firebase and Google Sign-In SDKs -->
    <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-database-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-auth-compat.js"></script>
    <script src="https://accounts.google.com/gsi/client" async></script>

    <script>
        // Firebase configuration (same as other pages)
        const firebaseConfig = {
            apiKey: "AIzaSyBDZicoo7dFLtSmgRPvQE_gdm-tNOyCTXA",
            authDomain: "the-songa-77b1b.firebaseapp.com",
            databaseURL: "https://the-songa-77b1b-default-rtdb.europe-west1.firebasedatabase.app",
            projectId: "the-songa-77b1b",
            storageBucket: "the-songa-77b1b.firebasestorage.app",
            messagingSenderId: "123922889572",
            appId: "1:123922889572:web:482b2a624930baaf92d871"
        };

        // Initialize Firebase
        let database;
        try {
            firebase.initializeApp(firebaseConfig);
            database = firebase.database();
            console.log("Firebase initialized successfully for library");
        } catch (error) {
            console.error("Firebase initialization error:", error);
            document.getElementById('libraryGrid').innerHTML = `
                <div class="empty-state">
                    <i class="fas fa-exclamation-triangle"></i>
                    <h3>Connection Error</h3>
                    <p>Unable to connect to database. Please refresh the page.</p>
                </div>
            `;
        }

        // Global variables
        let currentUser = null;
        let currentUserData = null;
        let books = [];
        let articles = [];
        let filteredBooks = [];
        let selectedBook = null;
        let userBorrowedBooks = [];
        let dropdownOpen = false;
        let subscriptionPlans = {};

        // DOM Elements
        const signinModal = document.getElementById('signinModal');
        const bookModal = document.getElementById('bookModal');
        const borrowModal = document.getElementById('borrowModal');
        const userProfile = document.getElementById('userProfile');
        const userAvatar = document.getElementById('userAvatar');
        const userDisplayName = document.getElementById('userDisplayName');
        const notification = document.getElementById('notification');
        const libraryGrid = document.getElementById('libraryGrid');
        const membershipInfo = document.getElementById('membershipInfo');
        const myBooksSection = document.getElementById('myBooksSection');
        const articlesGrid = document.getElementById('articlesGrid');
        const quickStats = document.getElementById('quickStats');

        // Show notification
        function showNotification(message, type = 'success', duration = 4000) {
            const notification = document.getElementById('notification');
            notification.textContent = message;
            notification.className = `notification show ${type}`;
            setTimeout(() => {
                notification.classList.remove('show');
            }, duration);
        }

        // Check authentication status
        function checkAuthStatus() {
            libraryGrid.innerHTML = `
                <div class="loading">
                    <div class="loading-spinner"></div>
                    <p>Loading library books...</p>
                </div>
            `;

            const storedUser = localStorage.getItem('the_songa_welfare_user');
            if (storedUser) {
                try {
                    currentUser = JSON.parse(storedUser);
                    updateUIForMember();
                    signinModal.classList.remove('active');
                    fetchUserData(currentUser.uid);
                    setupRealtimeData();
                } catch (error) {
                    console.error("Error parsing stored user:", error);
                    localStorage.removeItem('the_songa_welfare_user');
                    signinModal.classList.add('active');
                }
            } else {
                signinModal.classList.add('active');
                setupRealtimeData();
            }
        }

        // Parse JWT token
        function parseJwt(token) {
            try {
                const base64Url = token.split('.')[1];
                const base64 = base64Url.replace(/-/g, '+').replace(/_/g, '/');
                const jsonPayload = decodeURIComponent(atob(base64).split('').map(c => 
                    '%' + ('00' + c.charCodeAt(0).toString(16)).slice(-2)
                ).join(''));
                return JSON.parse(jsonPayload);
            } catch (error) {
                console.error('Error parsing JWT:', error);
                return {};
            }
        }

        // Google Sign-In Handler
        async function handleGoogleSignIn(response) {
            try {
                const userData = parseJwt(response.credential);
                
                currentUser = {
                    uid: userData.sub,
                    email: userData.email,
                    firstName: userData.given_name,
                    lastName: userData.family_name,
                    fullName: userData.name,
                    picture: userData.picture,
                    emailVerified: userData.email_verified
                };
                
                localStorage.setItem('the_songa_welfare_user', JSON.stringify(currentUser));
                
                const userRef = database.ref(`users/${currentUser.uid}`);
                const snapshot = await userRef.once('value');
                
                if (!snapshot.exists()) {
                    const newUser = {
                        uid: currentUser.uid,
                        email: currentUser.email,
                        firstName: currentUser.firstName,
                        lastName: currentUser.lastName,
                        profilePicture: currentUser.picture,
                        joinedDate: new Date().toISOString(),
                        lastLogin: new Date().toISOString(),
                        membershipStatus: "active",
                        membershipTier: "explorer",
                        borrowedBooks: [],
                        readingPreferences: ["personal-growth", "business"],
                        isAdmin: false,
                        status: "active"
                    };
                    
                    await userRef.set(newUser);
                    currentUserData = newUser;
                    showNotification(`Welcome to THE SONGA Library, ${currentUser.firstName}!`, 'success');
                } else {
                    await userRef.update({ lastLogin: new Date().toISOString() });
                    currentUserData = snapshot.val();
                    showNotification(`Welcome back, ${currentUser.firstName}!`, 'success');
                }
                
                updateUIForMember();
                signinModal.classList.remove('active');
                setupRealtimeData();
                
            } catch (error) {
                console.error('Error in Google Sign-In:', error);
                showNotification('Error signing in. Please try again.', 'error');
            }
        }

        // Update UI for signed-in members
        function updateUIForMember() {
            if (userProfile && currentUser) {
                userProfile.style.display = 'flex';
                userAvatar.src = currentUser.picture;
                userDisplayName.textContent = currentUser.firstName;
            }
        }

        // Fetch user data
        async function fetchUserData(userId) {
            try {
                const userRef = database.ref(`users/${userId}`);
                const snapshot = await userRef.once('value');
                if (snapshot.exists()) {
                    currentUserData = snapshot.val();
                    updateMembershipInfo();
                    loadUserBorrowedBooks();
                }
            } catch (error) {
                console.error('Error fetching user data:', error);
            }
        }

        // Update membership info display
        function updateMembershipInfo() {
            if (!currentUserData) return;
            
            const tier = currentUserData.membershipTier || 'explorer';
            const borrowedBooks = currentUserData.borrowedBooks || [];
            
            // Get subscription plan details
            fetchSubscriptionPlans().then(plans => {
                const plan = plans[`${tier}_plan`];
                
                document.getElementById('membershipInfo').style.display = 'flex';
                document.getElementById('tierBadge').textContent = tier.toUpperCase();
                document.getElementById('tierName').textContent = plan ? plan.name : `${tier.charAt(0).toUpperCase() + tier.slice(1)} Plan`;
                document.getElementById('tierDescription').textContent = plan ? plan.description : '';
                
                document.getElementById('booksBorrowed').textContent = borrowedBooks.length;
                
                if (plan) {
                    document.getElementById('booksLimit').textContent = plan.maxBooks;
                    document.getElementById('renewalsLeft').textContent = plan.renewalsAllowed;
                }
            });
        }

        // Fetch subscription plans
        async function fetchSubscriptionPlans() {
            try {
                const plansRef = database.ref('subscriptionPlans');
                const snapshot = await plansRef.once('value');
                if (snapshot.exists()) {
                    subscriptionPlans = snapshot.val();
                }
                return subscriptionPlans;
            } catch (error) {
                console.error('Error fetching subscription plans:', error);
                return {};
            }
        }

        // Setup real-time data listeners
        function setupRealtimeData() {
            if (!database) {
                console.error("Database not initialized");
                showNotification("Database connection error", "error");
                return;
            }
            
            // Listen for books
            database.ref('libraryBooks').on('value', (snapshot) => {
                if (snapshot.exists()) {
                    const booksData = snapshot.val();
                    books = Object.keys(booksData).map(key => ({
                        id: key,
                        ...booksData[key]
                    }));
                    
                    updateBookCounts();
                    updateQuickStats();
                    filterAndRenderBooks();
                } else {
                    books = [];
                    renderBooks([]);
                }
            });
            
            // Listen for articles
            database.ref('libraryArticles').on('value', (snapshot) => {
                if (snapshot.exists()) {
                    const articlesData = snapshot.val();
                    articles = Object.keys(articlesData).map(key => ({
                        id: key,
                        ...articlesData[key]
                    }));
                    
                    renderArticles();
                } else {
                    articles = [];
                    renderArticles([]);
                }
            });
            
            // Listen for user's borrowed books if signed in
            if (currentUser) {
                loadUserBorrowedBooks();
            }
        }

        // Load user's borrowed books
        async function loadUserBorrowedBooks() {
            if (!currentUser || !database) return;
            
            try {
                const borrowRef = database.ref('borrowRecords');
                const snapshot = await borrowRef.once('value');
                
                if (snapshot.exists()) {
                    const allBorrows = snapshot.val();
                    userBorrowedBooks = [];
                    
                    for (const recordId in allBorrows) {
                        const record = allBorrows[recordId];
                        if (record.userId === currentUser.uid && record.status === 'borrowed') {
                            userBorrowedBooks.push(record);
                        }
                    }
                    
                    displayBorrowedBooks();
                }
            } catch (error) {
                console.error('Error loading borrowed books:', error);
            }
        }

        // Display borrowed books
        function displayBorrowedBooks() {
            const borrowedBooksList = document.getElementById('borrowedBooksList');
            const myBooksSection = document.getElementById('myBooksSection');
            
            if (!borrowedBooksList || !myBooksSection) return;
            
            if (userBorrowedBooks.length === 0) {
                myBooksSection.style.display = 'none';
                return;
            }
            
            myBooksSection.style.display = 'block';
            
            // Show only first 3 borrowed books
            const displayBooks = userBorrowedBooks.slice(0, 3);
            
            borrowedBooksList.innerHTML = displayBooks.map(record => {
                const dueDate = new Date(record.dueDate);
                const now = new Date();
                const daysLeft = Math.ceil((dueDate - now) / (1000 * 60 * 60 * 24));
                const isOverdue = daysLeft < 0;
                
                return `
                    <div class="borrowed-book-card">
                        <div class="borrowed-book-cover">
                            <img src="https://images.unsplash.com/photo-1544716278-e513176f20b5?ixlib=rb-4.0.3&auto=format&fit=crop&w=300&q=80" alt="${record.bookTitle}">
                        </div>
                        <div class="borrowed-book-info">
                            <h4 class="borrowed-book-title">${record.bookTitle}</h4>
                            <div class="due-date ${isOverdue ? 'overdue' : ''}">
                                <i class="far fa-calendar ${isOverdue ? 'fa-exclamation-circle' : ''}"></i>
                                ${isOverdue ? 'OVERDUE' : `Due in ${daysLeft} days`}
                            </div>
                        </div>
                        <div class="borrowed-actions">
                            <button class="renew-btn" onclick="renewBook('${record.id}')" ${record.renewals >= record.maxRenewals ? 'disabled' : ''}>
                                <i class="fas fa-redo"></i> Renew
                            </button>
                        </div>
                    </div>
                `;
            }).join('');
        }

        // Update quick stats
        async function updateQuickStats() {
            if (!database) return;
            
            try {
                // Total books
                document.getElementById('totalBooks').textContent = books.length;
                
                // Total borrows
                const borrowRef = database.ref('borrowRecords');
                const borrowSnapshot = await borrowRef.once('value');
                const totalBorrows = borrowSnapshot.exists() ? Object.keys(borrowSnapshot.val()).length : 0;
                document.getElementById('totalBorrows').textContent = totalBorrows;
                
                // Total articles
                document.getElementById('totalArticles').textContent = articles.length;
                
                // Active readers (users with borrowed books in last 30 days)
                const usersRef = database.ref('users');
                const usersSnapshot = await usersRef.once('value');
                let activeReaders = 0;
                
                if (usersSnapshot.exists()) {
                    const users = usersSnapshot.val();
                    const thirtyDaysAgo = new Date();
                    thirtyDaysAgo.setDate(thirtyDaysAgo.getDate() - 30);
                    
                    for (const userId in users) {
                        const user = users[userId];
                        if (user.lastLogin && new Date(user.lastLogin) > thirtyDaysAgo) {
                            activeReaders++;
                        }
                    }
                }
                
                document.getElementById('activeReaders').textContent = activeReaders;
                
            } catch (error) {
                console.error('Error updating quick stats:', error);
            }
        }

        // Update book count badges
        function updateBookCounts() {
            const availableBooks = books.filter(book => book.availability === 'available');
            const featuredBooks = books.filter(book => book.featured);
            const digitalBooks = books.filter(book => book.digitalLink);
            
            document.getElementById('countAll').textContent = books.length;
            document.getElementById('countAvailable').textContent = availableBooks.length;
            document.getElementById('countFeatured').textContent = featuredBooks.length;
            document.getElementById('countDigital').textContent = digitalBooks.length;
        }

        // Get book category class
        function getBookCategoryClass(category) {
            switch(category?.toLowerCase()) {
                case 'fiction': return 'fiction';
                case 'non-fiction': return 'non-fiction';
                case 'business': return 'business';
                case 'personal growth': return 'personal-growth';
                case 'finance': return 'finance';
                default: return 'non-fiction';
            }
        }

        // Get category display name
        function getCategoryDisplayName(category) {
            switch(category?.toLowerCase()) {
                case 'fiction': return 'Fiction';
                case 'non-fiction': return 'Non-Fiction';
                case 'business': return 'Business';
                case 'personal growth': return 'Personal Growth';
                case 'finance': return 'Finance';
                default: return category || 'General';
            }
        }

        // Get availability status
        function getAvailabilityStatus(book) {
            if (book.digitalLink) return 'digital-only';
            if (book.availability === 'available') return 'available';
            if (book.availability === 'borrowed') return 'borrowed';
            if (book.availability === 'reserved') return 'reserved';
            return 'available';
        }

        // Get availability text
        function getAvailabilityText(book) {
            if (book.digitalLink) return 'Digital Access';
            if (book.availability === 'available') return 'Available';
            if (book.availability === 'borrowed') return 'Borrowed';
            if (book.availability === 'reserved') return 'Reserved';
            return 'Available';
        }

        // Check if user can borrow more books
        function canUserBorrowMore() {
            if (!currentUserData) return false;
            
            const tier = currentUserData.membershipTier || 'explorer';
            const plan = subscriptionPlans[`${tier}_plan`];
            const borrowedCount = currentUserData.borrowedBooks ? currentUserData.borrowedBooks.length : 0;
            
            if (!plan) return borrowedCount < 5; // Default limit
            
            return borrowedCount < plan.maxBooks;
        }

        // Check if user already borrowed this book
        function hasUserBorrowedBook(bookId) {
            if (!currentUserData || !currentUserData.borrowedBooks) return false;
            return currentUserData.borrowedBooks.includes(bookId);
        }

        // Filter and render books
        function filterAndRenderBooks() {
            const activeFilter = document.querySelector('.filter-tab.active')?.dataset.filter || 'all';
            const activeCategory = document.querySelector('.category-badge.active')?.dataset.category || 'all';
            const sortFilter = document.getElementById('sortFilter').value;
            const availabilityFilter = document.getElementById('availabilityFilter').value;
            const formatFilter = document.getElementById('formatFilter').value;
            const searchTerm = document.getElementById('searchInput').value.toLowerCase();
            
            filteredBooks = books.filter(book => {
                // Filter by tab
                let filterMatch = true;
                switch(activeFilter) {
                    case 'available':
                        filterMatch = book.availability === 'available';
                        break;
                    case 'featured':
                        filterMatch = book.featured === true;
                        break;
                    case 'digital':
                        filterMatch = !!book.digitalLink;
                        break;
                }
                
                // Filter by category
                const categoryMatch = activeCategory === 'all' || 
                    (book.category && book.category.toLowerCase() === activeCategory) ||
                    (book.genre && book.genre.some(g => g.toLowerCase() === activeCategory));
                
                // Filter by availability
                let availabilityMatch = true;
                switch(availabilityFilter) {
                    case 'available':
                        availabilityMatch = book.availability === 'available';
                        break;
                    case 'borrowed':
                        availabilityMatch = book.availability === 'borrowed';
                        break;
                    case 'digital':
                        availabilityMatch = !!book.digitalLink;
                        break;
                }
                
                // Filter by format
                let formatMatch = true;
                switch(formatFilter) {
                    case 'physical':
                        formatMatch = !book.digitalLink;
                        break;
                    case 'digital':
                        formatMatch = !!book.digitalLink;
                        break;
                }
                
                // Filter by search term
                const searchMatch = searchTerm === '' || 
                    book.title.toLowerCase().includes(searchTerm) ||
                    book.author.toLowerCase().includes(searchTerm) ||
                    (book.tags && book.tags.some(tag => tag.toLowerCase().includes(searchTerm))) ||
                    (book.description && book.description.toLowerCase().includes(searchTerm));
                
                return filterMatch && categoryMatch && availabilityMatch && formatMatch && searchMatch;
            });
            
            // Sort books
            filteredBooks.sort((a, b) => {
                switch(sortFilter) {
                    case 'title':
                        return a.title.localeCompare(b.title);
                    case 'author':
                        return a.author.localeCompare(b.author);
                    case 'rating':
                        return (b.rating || 0) - (a.rating || 0);
                    case 'date-added':
                        const dateA = new Date(a.addedDate || 0);
                        const dateB = new Date(b.addedDate || 0);
                        return dateB - dateA;
                    case 'popularity':
                    default:
                        return (b.borrowCount || 0) - (a.borrowCount || 0);
                }
            });
            
            renderBooks(filteredBooks);
        }

        // Render books grid
        function renderBooks(booksArray) {
            if (!libraryGrid) return;
            
            if (!booksArray || booksArray.length === 0) {
                const emptyTemplate = document.getElementById('emptyStateTemplate');
                const emptyState = emptyTemplate.content.cloneNode(true);
                libraryGrid.innerHTML = '';
                libraryGrid.appendChild(emptyState);
                return;
            }

            libraryGrid.innerHTML = booksArray.map(book => {
                const categoryClass = getBookCategoryClass(book.category);
                const categoryName = getCategoryDisplayName(book.category);
                const availabilityStatus = getAvailabilityStatus(book);
                const availabilityText = getAvailabilityText(book);
                const isAvailable = book.availability === 'available';
                const hasDigital = !!book.digitalLink;
                const isBorrowedByUser = hasUserBorrowedBook(book.id);
                const canBorrow = canUserBorrowMore() && (isAvailable || hasDigital) && !isBorrowedByUser;
                
                const availabilityClass = availabilityStatus === 'digital-only' ? 'digital-only' : 
                                        availabilityStatus === 'available' ? 'available' : 
                                        availabilityStatus === 'borrowed' ? 'borrowed' : 'reserved';
                
                const actionButton = hasDigital ? `
                    <button class="book-action-btn digital-btn" onclick="openDigitalBook('${book.id}')">
                        <i class="fas fa-file-pdf"></i> Read
                    </button>
                ` : isBorrowedByUser ? `
                    <button class="book-action-btn borrow-book-btn" disabled>
                        <i class="fas fa-check-circle"></i> Borrowed
                    </button>
                ` : canBorrow ? `
                    <button class="book-action-btn borrow-book-btn" onclick="openBorrowModal('${book.id}')">
                        <i class="fas fa-book-reader"></i> Borrow
                    </button>
                ` : `
                    <button class="book-action-btn borrow-book-btn" disabled>
                        <i class="fas fa-times-circle"></i> Unavailable
                    </button>
                `;
                
                const tagsHtml = book.tags && book.tags.length > 0 ? 
                    book.tags.slice(0, 2).map(tag => `
                        <span class="book-tag" onclick="filterByTag('${tag}')">${tag}</span>
                    `).join('') : '';
                
                return `
                    <div class="book-card ${book.featured ? 'featured' : ''}" data-book-id="${book.id}">
                        ${book.featured ? `
                            <div class="featured-badge">
                                <i class="fas fa-star"></i> Featured
                            </div>
                        ` : ''}
                        
                        <div class="availability-badge ${availabilityClass}">
                            ${availabilityText}
                        </div>
                        
                        <div class="book-cover">
                            <img src="${book.coverImage || 'https://images.unsplash.com/photo-1544716278-ca5e3f4abd8c?ixlib=rb-4.0.3&auto=format&fit=crop&w=800&q=80'}" alt="${book.title}">
                        </div>
                        
                        <div class="book-content">
                            <div class="book-category ${categoryClass}">
                                ${categoryName}
                            </div>
                            <h3 class="book-title">${book.title}</h3>
                            <p class="book-author">by ${book.author}</p>
                            
                            <div class="book-rating">
                                <div class="stars">
                                    ${''.repeat(Math.floor(book.rating || 0))}${''.repeat(5 - Math.floor(book.rating || 0))}
                                </div>
                                <span class="rating-value">${(book.rating || 0).toFixed(1)}</span>
                            </div>
                            
                            <div class="book-meta-small">
                                <span><i class="far fa-file"></i> ${book.pages || 'N/A'} pages</span>
                                <span><i class="fas fa-calendar"></i> ${book.publishedYear || ''}</span>
                            </div>
                            
                            <div class="book-actions">
                                ${actionButton}
                                <button class="book-action-btn details-btn" onclick="openBookDetails('${book.id}')">
                                    <i class="fas fa-eye"></i> Details
                                </button>
                            </div>
                        </div>
                    </div>
                `;
            }).join('');
        }

        // Render articles
        function renderArticles() {
            if (!articlesGrid) return;
            
            const featuredArticles = articles.filter(article => article.featured).slice(0, 3);
            
            if (featuredArticles.length === 0) {
                articlesGrid.innerHTML = `
                    <div class="empty-state" style="grid-column: 1 / -1;">
                        <i class="fas fa-newspaper"></i>
                        <h3>No Articles Available</h3>
                        <p>Check back soon for featured articles.</p>
                    </div>
                `;
                return;
            }
            
            articlesGrid.innerHTML = featuredArticles.map(article => {
                return `
                    <div class="article-card">
                        <div class="article-image">
                            <img src="${article.coverImage || 'https://images.unsplash.com/photo-1589829545856-d10d557cf95f?ixlib=rb-4.0.3&auto=format&fit=crop&w=800&q=80'}" alt="${article.title}">
                        </div>
                        <div class="article-content">
                            <h3 class="article-title">${article.title}</h3>
                            <p class="article-excerpt">${article.excerpt || article.content?.substring(0, 150) || 'Read this insightful article...'}</p>
                            <div class="article-meta">
                                <span>${article.author}</span>
                                <span class="read-time">
                                    <i class="far fa-clock"></i> ${article.readTime || '5 min'}
                                </span>
                            </div>
                        </div>
                    </div>
                `;
            }).join('');
        }

        // Open book details modal
        function openBookDetails(bookId) {
            selectedBook = books.find(b => b.id === bookId);
            if (!selectedBook) {
                showNotification('Book not found', 'error');
                return;
            }
            
            // Update modal content
            document.getElementById('bookModalTitle').textContent = selectedBook.title;
            document.getElementById('bookModalAuthor').textContent = `by ${selectedBook.author}`;
            document.getElementById('bookModalCover').src = selectedBook.coverImage || 'https://images.unsplash.com/photo-1544716278-ca5e3f4abd8c?ixlib=rb-4.0.3&auto=format&fit=crop&w=800&q=80';
            document.getElementById('bookModalRating').textContent = (selectedBook.rating || 0).toFixed(1);
            document.getElementById('bookModalPages').textContent = `${selectedBook.pages || 'N/A'} pages`;
            document.getElementById('bookModalYear').textContent = selectedBook.publishedYear || 'N/A';
            document.getElementById('bookModalFormat').textContent = selectedBook.format || 'Paperback';
            document.getElementById('bookModalDescription').textContent = selectedBook.description || selectedBook.summary || 'No description available.';
            
            // Update tags
            const tagsHtml = selectedBook.tags && selectedBook.tags.length > 0 ? 
                selectedBook.tags.map(tag => `
                    <span class="book-tag" onclick="filterByTag('${tag}')">${tag}</span>
                `).join('') : '<span style="color: var(--dark-gray);">No tags</span>';
            document.getElementById('bookModalTags').innerHTML = tagsHtml;
            
            // Update availability
            const availabilityStatus = getAvailabilityStatus(selectedBook);
            const statusElement = document.getElementById('bookModalStatus');
            statusElement.textContent = getAvailabilityText(selectedBook);
            statusElement.className = `status-value status-${availabilityStatus.replace('-only', '')}`;
            
            // Update availability details
            const detailsElement = document.getElementById('bookModalAvailabilityDetails');
            if (selectedBook.digitalLink) {
                detailsElement.innerHTML = `
                    <p>Digital access available. Click the "Digital Access" button below to read online.</p>
                `;
                document.getElementById('digitalAccessBtn').style.display = 'flex';
                document.getElementById('borrowFromModalBtn').style.display = 'none';
            } else {
                const availableCopies = selectedBook.availableCopies || 0;
                const totalCopies = selectedBook.totalCopies || 0;
                detailsElement.innerHTML = `
                    <p>${availableCopies} of ${totalCopies} copies available</p>
                    <p style="margin-top: 0.5rem; font-size: 0.9rem;">
                        <i class="fas fa-map-marker-alt"></i> ${selectedBook.location || 'Main Library Shelf'}
                    </p>
                `;
                document.getElementById('digitalAccessBtn').style.display = 'none';
                document.getElementById('borrowFromModalBtn').style.display = 'flex';
            }
            
            // Setup borrow button
            const borrowBtn = document.getElementById('borrowFromModalBtn');
            if (hasUserBorrowedBook(selectedBook.id)) {
                borrowBtn.innerHTML = '<i class="fas fa-check-circle"></i> Already Borrowed';
                borrowBtn.disabled = true;
            } else if (!canUserBorrowMore()) {
                borrowBtn.innerHTML = '<i class="fas fa-times-circle"></i> Limit Reached';
                borrowBtn.disabled = true;
            } else if (selectedBook.availability !== 'available') {
                borrowBtn.innerHTML = '<i class="fas fa-times-circle"></i> Not Available';
                borrowBtn.disabled = true;
            } else {
                borrowBtn.innerHTML = '<i class="fas fa-book-reader"></i> Borrow Book';
                borrowBtn.disabled = false;
                borrowBtn.onclick = () => {
                    bookModal.classList.remove('active');
                    openBorrowModal(selectedBook.id);
                };
            }
            
            // Setup digital access button
            const digitalBtn = document.getElementById('digitalAccessBtn');
            if (selectedBook.digitalLink) {
                digitalBtn.onclick = () => openDigitalBook(selectedBook.id);
            }
            
            // Show modal
            bookModal.classList.add('active');
            document.body.classList.add('modal-open');
        }

        // Open digital book
        function openDigitalBook(bookId) {
            const book = books.find(b => b.id === bookId);
            if (!book || !book.digitalLink) {
                showNotification('Digital access not available for this book', 'error');
                return;
            }
            
            window.open(book.digitalLink, '_blank');
            showNotification('Opening digital book...', 'success');
        }

        // Open borrow modal
        function openBorrowModal(bookId) {
            if (!currentUser) {
                showNotification('Please sign in to borrow books', 'error');
                signinModal.classList.add('active');
                return;
            }
            
            selectedBook = books.find(b => b.id === bookId);
            if (!selectedBook) {
                showNotification('Book not found', 'error');
                return;
            }
            
            // Check if user can borrow
            if (hasUserBorrowedBook(bookId)) {
                showNotification('You have already borrowed this book', 'info');
                return;
            }
            
            if (!canUserBorrowMore()) {
                showNotification('You have reached your borrowing limit. Please return some books first.', 'error');
                return;
            }
            
            if (selectedBook.availability !== 'available') {
                showNotification('This book is not available for borrowing', 'error');
                return;
            }
            
            // Update modal content
            document.getElementById('borrowBookTitle').textContent = selectedBook.title;
            document.getElementById('borrowBookName').textContent = selectedBook.title;
            document.getElementById('borrowBookAuthor').textContent = selectedBook.author;
            
            // Calculate dates
            const borrowDuration = selectedBook.borrowDuration || 14;
            const dueDate = new Date();
            dueDate.setDate(dueDate.getDate() + borrowDuration);
            
            document.getElementById('borrowPeriod').textContent = `${borrowDuration} days`;
            document.getElementById('borrowDueDate').textContent = dueDate.toLocaleDateString('en-US', {
                weekday: 'short',
                year: 'numeric',
                month: 'short',
                day: 'numeric'
            });
            
            document.getElementById('borrowLocation').textContent = selectedBook.location || 'Main Library - Front Desk';
            
            // Show modal
            borrowModal.classList.add('active');
            document.body.classList.add('modal-open');
        }

        // Confirm borrow book
        async function confirmBorrowBook() {
            if (!selectedBook || !currentUser) return;
            
            try {
                // Create borrow record
                const borrowRef = database.ref('borrowRecords').push();
                const borrowDuration = selectedBook.borrowDuration || 14;
                const dueDate = new Date();
                dueDate.setDate(dueDate.getDate() + borrowDuration);
                
                const borrowRecord = {
                    id: borrowRef.key,
                    userId: currentUser.uid,
                    bookId: selectedBook.id,
                    bookTitle: selectedBook.title,
                    borrowDate: new Date().toISOString(),
                    dueDate: dueDate.toISOString(),
                    returnDate: null,
                    status: 'borrowed',
                    renewals: 0,
                    maxRenewals: 2,
                    fineAmount: 0,
                    paid: true
                };
                
                await borrowRef.set(borrowRecord);
                
                // Update book availability
                const bookRef = database.ref(`libraryBooks/${selectedBook.id}`);
                await bookRef.update({
                    availableCopies: Math.max((selectedBook.availableCopies || 1) - 1, 0),
                    borrowCount: (selectedBook.borrowCount || 0) + 1,
                    availability: (selectedBook.availableCopies || 1) <= 1 ? 'borrowed' : 'available'
                });
                
                // Update user's borrowed books
                const userRef = database.ref(`users/${currentUser.uid}`);
                const userSnapshot = await userRef.once('value');
                const userData = userSnapshot.val();
                const borrowedBooks = userData.borrowedBooks || [];
                
                if (!borrowedBooks.includes(selectedBook.id)) {
                    borrowedBooks.push(selectedBook.id);
                    await userRef.update({
                        borrowedBooks: borrowedBooks
                    });
                    currentUserData.borrowedBooks = borrowedBooks;
                }
                
                // Update membership info
                updateMembershipInfo();
                
                // Close modal and show success
                borrowModal.classList.remove('active');
                document.body.classList.remove('modal-open');
                
                showNotification(`Successfully borrowed "${selectedBook.title}"!`, 'success');
                
                // Refresh data
                setupRealtimeData();
                filterAndRenderBooks();
                
            } catch (error) {
                console.error('Error borrowing book:', error);
                showNotification('Error borrowing book. Please try again.', 'error');
            }
        }

        // Renew book
        async function renewBook(recordId) {
            if (!currentUser) return;
            
            try {
                const recordRef = database.ref(`borrowRecords/${recordId}`);
                const snapshot = await recordRef.once('value');
                const record = snapshot.val();
                
                if (!record || record.userId !== currentUser.uid) {
                    showNotification('Record not found', 'error');
                    return;
                }
                
                if (record.renewals >= record.maxRenewals) {
                    showNotification('Maximum renewals reached', 'error');
                    return;
                }
                
                // Add 7 days to due date
                const newDueDate = new Date(record.dueDate);
                newDueDate.setDate(newDueDate.getDate() + 7);
                
                await recordRef.update({
                    dueDate: newDueDate.toISOString(),
                    renewals: (record.renewals || 0) + 1
                });
                
                showNotification('Book renewed successfully! New due date: ' + newDueDate.toLocaleDateString(), 'success');
                
                // Refresh borrowed books
                loadUserBorrowedBooks();
                
            } catch (error) {
                console.error('Error renewing book:', error);
                showNotification('Error renewing book', 'error');
            }
        }

        // Filter by tag
        function filterByTag(tag) {
            document.getElementById('searchInput').value = tag;
            filterAndRenderBooks();
            showNotification(`Searching for books tagged: ${tag}`, 'info');
        }

        // Show upgrade options
        function showUpgradeOptions() {
            showNotification('Upgrade options coming soon!', 'info');
        }

        // Show all borrowed books
        function showAllBorrowedBooks() {
            showNotification('All borrowed books view coming soon!', 'info');
        }

        // Toggle dropdown
        function toggleDropdown() {
            dropdownOpen = !dropdownOpen;
            const dropdown = document.getElementById('userDropdown');
            if (dropdownOpen) {
                dropdown.classList.add('active');
            } else {
                dropdown.classList.remove('active');
            }
        }

        // Close dropdown
        function closeDropdown() {
            dropdownOpen = false;
            const dropdown = document.getElementById('userDropdown');
            if (dropdown) dropdown.classList.remove('active');
        }

        // Sign out user
        function signOut() {
            currentUser = null;
            currentUserData = null;
            localStorage.removeItem('the_songa_welfare_user');
            
            if (database) {
                database.ref('libraryBooks').off();
                database.ref('libraryArticles').off();
            }
            
            closeDropdown();
            signinModal.classList.add('active');
            document.body.classList.remove('modal-open');
            showNotification('Signed out successfully', 'success');
            
            // Hide member-only sections
            membershipInfo.style.display = 'none';
            myBooksSection.style.display = 'none';
            
            libraryGrid.innerHTML = `
                <div class="loading">
                    <div class="loading-spinner"></div>
                    <p>Loading library books...</p>
                </div>
            `;
        }

        // Initialize the page
        function initializePage() {
            checkAuthStatus();
            
            // Load sample data if empty
            if (database) {
                database.ref('libraryBooks').once('value').then(snapshot => {
                    if (!snapshot.exists()) {
                        loadSampleBooks();
                    }
                });
                
                database.ref('libraryArticles').once('value').then(snapshot => {
                    if (!snapshot.exists()) {
                        loadSampleArticles();
                    }
                });
                
                fetchSubscriptionPlans();
            }
            
            setupEventListeners();
        }

        // Load sample books
        async function loadSampleBooks() {
            if (!database) return;
            
            try {
                const booksRef = database.ref('libraryBooks');
                const snapshot = await booksRef.once('value');
                
                if (!snapshot.exists()) {
                    const sampleBooks = {
                        book_001: {
                            id: "book_001",
                            title: "Atomic Habits",
                            author: "James Clear",
                            category: "Personal Growth",
                            description: "Tiny Changes, Remarkable Results: An Easy & Proven Way to Build Good Habits & Break Bad Ones. This book reveals practical strategies that will teach you exactly how to form good habits, break bad ones, and master the tiny behaviors that lead to remarkable results.",
                            coverImage: "https://images.unsplash.com/photo-1544716278-e513176f20b5?ixlib=rb-4.0.3&auto=format&fit=crop&w=800&q=80",
                            rating: 4.8,
                            pages: 320,
                            isbn: "978-0735211292",
                            publisher: "Avery Publishing",
                            publishedYear: 2018,
                            genre: ["self-help", "psychology", "productivity"],
                            tags: ["habits", "productivity", "self-improvement", "behavior", "personal-growth"],
                            availability: "available",
                            totalCopies: 5,
                            availableCopies: 3,
                            borrowCount: 15,
                            featured: true,
                            featuredOrder: 1,
                            addedDate: new Date().toISOString(),
                            subscriptionTiers: ["explorer", "scholar", "visionary"],
                            language: "English",
                            format: "Paperback",
                            summary: "A revolutionary guide to building good habits and breaking bad ones through tiny changes.",
                            keyTakeaways: [
                                "1% improvement every day",
                                "Habit stacking technique",
                                "Environment design",
                                "Identity-based habits"
                            ],
                            borrowDuration: 14,
                            location: "Shelf A-12",
                            digitalLink: "https://drive.google.com/file/d/example1/view"
                        },
                        book_002: {
                            id: "book_002",
                            title: "The Lean Startup",
                            author: "Eric Ries",
                            category: "Business",
                            description: "How Today's Entrepreneurs Use Continuous Innovation to Create Radically Successful Businesses. The Lean Startup approach fosters companies that are both more capital efficient and that leverage human creativity more effectively.",
                            coverImage: "https://images.unsplash.com/photo-1450101499163-c8848c66ca85?ixlib=rb-4.0.3&auto=format&fit=crop&w=800&q=80",
                            rating: 4.6,
                            pages: 336,
                            isbn: "978-0307887894",
                            publisher: "Crown Business",
                            publishedYear: 2011,
                            genre: ["business", "entrepreneurship", "innovation"],
                            tags: ["startup", "entrepreneurship", "innovation", "business", "management"],
                            availability: "available",
                            totalCopies: 3,
                            availableCopies: 2,
                            borrowCount: 8,
                            featured: false,
                            addedDate: new Date().toISOString(),
                            subscriptionTiers: ["scholar", "visionary"],
                            language: "English",
                            format: "Hardcover",
                            summary: "A methodology for developing businesses and products through validated learning and rapid experimentation.",
                            borrowDuration: 14,
                            location: "Shelf B-07"
                        }
                    };
                    
                    await booksRef.set(sampleBooks);
                    console.log("Sample books loaded");
                }
            } catch (error) {
                console.error('Error loading sample books:', error);
            }
        }

        // Load sample articles
        async function loadSampleArticles() {
            if (!database) return;
            
            try {
                const articlesRef = database.ref('libraryArticles');
                const snapshot = await articlesRef.once('value');
                
                if (!snapshot.exists()) {
                    const sampleArticles = {
                        article_001: {
                            id: "article_001",
                            title: "The Psychology of Wealth: Mindset Matters",
                            author: "THE SONGA Team",
                            category: "Finance",
                            excerpt: "How your mindset influences your financial decisions and wealth accumulation journey.",
                            content: "Full article content about wealth psychology... Your mindset determines your financial destiny. Learn how to cultivate a wealth-building mentality.",
                            coverImage: "https://images.unsplash.com/photo-1554224155-6726b3ff858f?ixlib=rb-4.0.3&auto=format&fit=crop&w=1200&q=80",
                            readTime: "5 min",
                            publishedDate: new Date().toISOString(),
                            tags: ["wealth", "psychology", "mindset", "finance"],
                            views: 245,
                            likes: 56,
                            featured: true,
                            status: "published",
                            subscriptionTiers: ["all"]
                        }
                    };
                    
                    await articlesRef.set(sampleArticles);
                    console.log("Sample articles loaded");
                }
            } catch (error) {
                console.error('Error loading sample articles:', error);
            }
        }

        // Setup event listeners
        function setupEventListeners() {
            // User profile dropdown
            if (userProfile) {
                userProfile.addEventListener('click', function(e) {
                    e.stopPropagation();
                    toggleDropdown();
                });
            }
            
            // Close dropdowns when clicking outside
            document.addEventListener('click', function() {
                closeDropdown();
            });
            
            // Filter tabs
            document.querySelectorAll('.filter-tab').forEach(tab => {
                tab.addEventListener('click', function() {
                    document.querySelectorAll('.filter-tab').forEach(t => t.classList.remove('active'));
                    this.classList.add('active');
                    filterAndRenderBooks();
                });
            });
            
            // Category badges
            document.querySelectorAll('.category-badge').forEach(badge => {
                badge.addEventListener('click', function() {
                    document.querySelectorAll('.category-badge').forEach(b => b.classList.remove('active'));
                    this.classList.add('active');
                    filterAndRenderBooks();
                });
            });
            
            // Filter controls
            document.getElementById('sortFilter').addEventListener('change', filterAndRenderBooks);
            document.getElementById('availabilityFilter').addEventListener('change', filterAndRenderBooks);
            document.getElementById('formatFilter').addEventListener('change', filterAndRenderBooks);
            
            // Search input
            const searchInput = document.getElementById('searchInput');
            let searchTimeout;
            searchInput.addEventListener('input', function() {
                clearTimeout(searchTimeout);
                searchTimeout = setTimeout(() => {
                    filterAndRenderBooks();
                }, 500);
            });
            
            // Close modals
            document.getElementById('closeBookModal').addEventListener('click', function() {
                bookModal.classList.remove('active');
                document.body.classList.remove('modal-open');
            });
            
            document.getElementById('closeBorrowModal').addEventListener('click', function() {
                borrowModal.classList.remove('active');
                document.body.classList.remove('modal-open');
            });
            
            document.getElementById('closeSigninModal').addEventListener('click', function() {
                signinModal.classList.remove('active');
            });
            
            // Confirm borrow button
            document.getElementById('confirmBorrowBtn').addEventListener('click', confirmBorrowBook);
            document.getElementById('cancelBorrowBtn').addEventListener('click', function() {
                borrowModal.classList.remove('active');
                document.body.classList.remove('modal-open');
            });
            
            // Close modals when clicking outside
            bookModal.addEventListener('click', function(e) {
                if (e.target === this) {
                    bookModal.classList.remove('active');
                    document.body.classList.remove('modal-open');
                }
            });
            
            borrowModal.addEventListener('click', function(e) {
                if (e.target === this) {
                    borrowModal.classList.remove('active');
                    document.body.classList.remove('modal-open');
                }
            });
            
            signinModal.addEventListener('click', function(e) {
                if (e.target === this) {
                    signinModal.classList.remove('active');
                }
            });
            
            // Escape key to close modals
            document.addEventListener('keydown', function(e) {
                if (e.key === 'Escape') {
                    if (bookModal.classList.contains('active')) {
                        bookModal.classList.remove('active');
                        document.body.classList.remove('modal-open');
                    }
                    if (borrowModal.classList.contains('active')) {
                        borrowModal.classList.remove('active');
                        document.body.classList.remove('modal-open');
                    }
                    if (signinModal.classList.contains('active')) {
                        signinModal.classList.remove('active');
                    }
                }
            });
            
            // Dropdown options
            const signOutOption = document.getElementById('signOutOption');
            if (signOutOption) {
                signOutOption.addEventListener('click', function() {
                    signOut();
                    closeDropdown();
                });
            }
        }

        // Initialize when DOM is ready
        document.addEventListener('DOMContentLoaded', initializePage);

        // Global function for Google Sign-In callback
        window.handleGoogleSignIn = handleGoogleSignIn;
    </script>
</body>
</html>
