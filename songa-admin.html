<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=5.0">
    <title>THE SONGA - Admin Dashboard</title>
    
    <!-- Material Icons -->
    <link href="https://fonts.googleapis.com/icon?family=Material+Icons+Sharp" rel="stylesheet">
    
    <!-- Inter Font -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    
    <!-- Chart.js -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    
    <!-- Firebase -->
    <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-database-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-auth-compat.js"></script>

    <style>
        /* [Keep all your existing CSS styles exactly as they are] */
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        /* ... [All existing CSS remains unchanged] ... */
    </style>
</head>
<body>
    <div class="dashboard">
        <!-- Sidebar -->
        <aside class="sidebar">
            <div class="sidebar-header">
                <div class="logo">
                    <div class="logo-icon">TS</div>
                    <div>
                        <div class="logo-text">THE SONGA</div>
                        <div class="logo-subtext">Admin Dashboard</div>
                    </div>
                </div>
            </div>
            
            <div class="nav-section">
                <h3 class="nav-title">Main</h3>
                <ul class="nav-menu">
                    <li class="nav-item">
                        <a href="#dashboard" class="nav-link active" data-section="dashboard">
                            <span class="material-icons-sharp">dashboard</span>
                            <span>Dashboard</span>
                        </a>
                    </li>
                    <li class="nav-item">
                        <a href="#analytics" class="nav-link" data-section="analytics">
                            <span class="material-icons-sharp">insights</span>
                            <span>Analytics</span>
                        </a>
                    </li>
                </ul>
            </div>
            
            <div class="nav-section">
                <h3 class="nav-title">Content</h3>
                <ul class="nav-menu">
                    <li class="nav-item">
                        <a href="#users" class="nav-link" data-section="users">
                            <span class="material-icons-sharp">people</span>
                            <span>Users</span>
                        </a>
                    </li>
                    <li class="nav-item">
                        <a href="#posts" class="nav-link" data-section="posts">
                            <span class="material-icons-sharp">article</span>
                            <span>Posts</span>
                        </a>
                    </li>
                    <li class="nav-item">
                        <a href="#events" class="nav-link" data-section="events">
                            <span class="material-icons-sharp">event</span>
                            <span>Events</span>
                        </a>
                    </li>
                    <li class="nav-item">
                        <a href="#library" class="nav-link" data-section="library">
                            <span class="material-icons-sharp">library_books</span>
                            <span>Library</span>
                        </a>
                    </li>
                </ul>
            </div>
            
            <div class="nav-section">
                <h3 class="nav-title">System</h3>
                <ul class="nav-menu">
                    <li class="nav-item">
                        <a href="#settings" class="nav-link" data-section="settings">
                            <span class="material-icons-sharp">settings</span>
                            <span>Settings</span>
                        </a>
                    </li>
                    <li class="nav-item">
                        <a href="#backup" class="nav-link" data-section="backup">
                            <span class="material-icons-sharp">backup</span>
                            <span>Backup</span>
                        </a>
                    </li>
                    <li class="nav-item">
                        <a href="#logs" class="nav-link" data-section="logs">
                            <span class="material-icons-sharp">list_alt</span>
                            <span>Logs</span>
                        </a>
                    </li>
                </ul>
            </div>
            
            <div class="sidebar-footer">
                <div class="user-profile">
                    <div class="user-avatar" id="adminAvatar">A</div>
                    <div class="user-info">
                        <h4 id="adminName">Admin User</h4>
                        <p id="adminEmail">admin@thesongawelfare.com</p>
                    </div>
                </div>
            </div>
        </aside>

        <!-- Main Content -->
        <main class="main-content">
            <!-- Header -->
            <header class="header">
                <div class="header-title">
                    <h1 id="pageTitle">Dashboard</h1>
                    <p id="pageSubtitle">Welcome back, Admin</p>
                </div>
                <div class="header-actions">
                    <div class="search-box">
                        <span class="material-icons-sharp">search</span>
                        <input type="text" placeholder="Search..." id="globalSearch">
                    </div>
                    <button class="btn btn-secondary" id="refreshBtn">
                        <span class="material-icons-sharp">refresh</span>
                        Refresh
                    </button>
                    <button class="btn btn-danger" onclick="logout()">
                        <span class="material-icons-sharp">logout</span>
                        Logout
                    </button>
                </div>
            </header>

            <!-- Alert Container -->
            <div id="alertContainer"></div>

            <!-- Dashboard Content -->
            <div id="contentContainer">
                <!-- Content will be loaded here -->
            </div>
        </main>
    </div>

    <!-- Modals -->
    <div class="modal-overlay" id="modalOverlay"></div>

    <!-- Templates -->
    <template id="dashboardTemplate">
        <div class="stats-grid">
            <div class="stat-card">
                <div class="stat-header">
                    <div>
                        <div class="stat-title">Total Users</div>
                        <div class="stat-value" id="totalUsers">0</div>
                    </div>
                    <div class="stat-icon">
                        <span class="material-icons-sharp">people</span>
                    </div>
                </div>
                <div class="stat-change" id="userChange">
                    <span class="material-icons-sharp">trending_up</span>
                    <span>Loading...</span>
                </div>
            </div>
            
            <div class="stat-card">
                <div class="stat-header">
                    <div>
                        <div class="stat-title">Active Posts</div>
                        <div class="stat-value" id="activePosts">0</div>
                    </div>
                    <div class="stat-icon">
                        <span class="material-icons-sharp">article</span>
                    </div>
                </div>
                <div class="stat-change" id="postChange">
                    <span class="material-icons-sharp">trending_up</span>
                    <span>Loading...</span>
                </div>
            </div>
            
            <div class="stat-card">
                <div class="stat-header">
                    <div>
                        <div class="stat-title">Event Registrations</div>
                        <div class="stat-value" id="eventRegistrations">0</div>
                    </div>
                    <div class="stat-icon">
                        <span class="material-icons-sharp">event</span>
                    </div>
                </div>
                <div class="stat-change" id="eventChange">
                    <span class="material-icons-sharp">trending_up</span>
                    <span>Loading...</span>
                </div>
            </div>
            
            <div class="stat-card">
                <div class="stat-header">
                    <div>
                        <div class="stat-title">Books in Library</div>
                        <div class="stat-value" id="booksBorrowed">0</div>
                    </div>
                    <div class="stat-icon">
                        <span class="material-icons-sharp">library_books</span>
                    </div>
                </div>
                <div class="stat-change" id="bookChange">
                    <span class="material-icons-sharp">trending_up</span>
                    <span>Loading...</span>
                </div>
            </div>
        </div>

        <div class="charts-grid">
            <div class="chart-card">
                <div class="chart-header">
                    <h3 class="chart-title">User Growth</h3>
                    <select class="form-select" style="width: auto; padding: 0.5rem;" id="userGrowthPeriod" onchange="updateUserGrowthChart()">
                        <option value="7">Last 7 days</option>
                        <option value="30" selected>Last 30 days</option>
                        <option value="90">Last 90 days</option>
                    </select>
                </div>
                <div class="chart-container">
                    <canvas id="userGrowthChart"></canvas>
                </div>
            </div>
            
            <div class="chart-card">
                <div class="chart-header">
                    <h3 class="chart-title">Membership Distribution</h3>
                    <button class="btn btn-secondary btn-sm" onclick="refreshMembershipChart()">
                        <span class="material-icons-sharp">refresh</span>
                    </button>
                </div>
                <div class="chart-container">
                    <canvas id="membershipChart"></canvas>
                </div>
            </div>
        </div>

        <div class="section-header">
            <h2 class="section-title">Recent Activity</h2>
            <button class="btn btn-secondary" onclick="loadSection('logs')">
                View All
            </button>
        </div>
        
        <div class="data-table-container">
            <table class="data-table" id="recentActivityTable">
                <thead>
                    <tr>
                        <th>User</th>
                        <th>Action</th>
                        <th>Details</th>
                        <th>Time</th>
                    </tr>
                </thead>
                <tbody id="recentActivityBody">
                    <tr>
                        <td colspan="4" class="loading-cell">
                            <div class="spinner"></div>
                            Loading recent activity...
                        </td>
                    </tr>
                </tbody>
            </table>
        </div>
    </template>

    <template id="usersTemplate">
        <div class="section-header">
            <h2 class="section-title">User Management</h2>
            <div class="header-actions">
                <button class="btn btn-secondary" onclick="exportUsers()">
                    <span class="material-icons-sharp">download</span>
                    Export
                </button>
                <button class="btn btn-primary" onclick="showAddUserModal()">
                    <span class="material-icons-sharp">add</span>
                    Add User
                </button>
            </div>
        </div>
        
        <div class="tabs">
            <button class="tab active" onclick="filterUsers('all')">All Users</button>
            <button class="tab" onclick="filterUsers('active')">Active</button>
            <button class="tab" onclick="filterUsers('pending')">Pending</button>
            <button class="tab" onclick="filterUsers('suspended')">Suspended</button>
            <button class="tab" onclick="filterUsers('admins')">Admins</button>
        </div>
        
        <div class="data-table-container">
            <table class="data-table">
                <thead>
                    <tr>
                        <th>User</th>
                        <th>Email</th>
                        <th>Membership</th>
                        <th>Status</th>
                        <th>Joined</th>
                        <th>Actions</th>
                    </tr>
                </thead>
                <tbody id="usersTableBody">
                    <tr>
                        <td colspan="6" class="loading-cell">
                            <div class="spinner"></div>
                            Loading users...
                        </td>
                    </tr>
                </tbody>
            </table>
        </div>
        
        <div class="pagination" id="userPagination" style="display: none;">
            <button class="btn btn-secondary" onclick="prevPage()">Previous</button>
            <span id="pageInfo">Page 1 of 1</span>
            <button class="btn btn-secondary" onclick="nextPage()">Next</button>
        </div>
    </template>

    <template id="postsTemplate">
        <div class="section-header">
            <h2 class="section-title">Post Management</h2>
            <div class="header-actions">
                <select class="form-select" id="postFilter" onchange="filterPosts()" style="width: auto;">
                    <option value="all">All Posts</option>
                    <option value="published">Published</option>
                    <option value="draft">Drafts</option>
                    <option value="archived">Archived</option>
                </select>
                <button class="btn btn-primary" onclick="showAddPostModal()">
                    <span class="material-icons-sharp">add</span>
                    Create Post
                </button>
            </div>
        </div>
        
        <div class="data-table-container">
            <table class="data-table">
                <thead>
                    <tr>
                        <th>Title</th>
                        <th>Author</th>
                        <th>Category</th>
                        <th>Likes</th>
                        <th>Comments</th>
                        <th>Status</th>
                        <th>Created</th>
                        <th>Actions</th>
                    </tr>
                </thead>
                <tbody id="postsTableBody">
                    <tr>
                        <td colspan="8" class="loading-cell">
                            <div class="spinner"></div>
                            Loading posts...
                        </td>
                    </tr>
                </tbody>
            </table>
        </div>
    </template>

    <template id="eventsTemplate">
        <div class="section-header">
            <h2 class="section-title">Event Management</h2>
            <div class="header-actions">
                <select class="form-select" id="eventFilter" onchange="filterEvents()" style="width: auto;">
                    <option value="all">All Events</option>
                    <option value="upcoming">Upcoming</option>
                    <option value="past">Past</option>
                    <option value="active">Active</option>
                </select>
                <button class="btn btn-primary" onclick="showAddEventModal()">
                    <span class="material-icons-sharp">add</span>
                    Create Event
                </button>
            </div>
        </div>
        
        <div class="data-table-container">
            <table class="data-table">
                <thead>
                    <tr>
                        <th>Event</th>
                        <th>Date</th>
                        <th>Location</th>
                        <th>Registrations</th>
                        <th>Status</th>
                        <th>Type</th>
                        <th>Actions</th>
                    </tr>
                </thead>
                <tbody id="eventsTableBody">
                    <tr>
                        <td colspan="7" class="loading-cell">
                            <div class="spinner"></div>
                            Loading events...
                        </td>
                    </tr>
                </tbody>
            </table>
        </div>
    </template>

    <template id="libraryTemplate">
        <div class="section-header">
            <h2 class="section-title">Library Management</h2>
            <div class="header-actions">
                <select class="form-select" id="bookFilter" onchange="filterBooks()" style="width: auto;">
                    <option value="all">All Books</option>
                    <option value="available">Available</option>
                    <option value="borrowed">Borrowed</option>
                    <option value="featured">Featured</option>
                </select>
                <button class="btn btn-primary" onclick="showAddBookModal()">
                    <span class="material-icons-sharp">add</span>
                    Add Book
                </button>
            </div>
        </div>
        
        <div class="data-table-container">
            <table class="data-table">
                <thead>
                    <tr>
                        <th>Book</th>
                        <th>Author</th>
                        <th>Category</th>
                        <th>Copies</th>
                        <th>Available</th>
                        <th>Rating</th>
                        <th>Actions</th>
                    </tr>
                </thead>
                <tbody id="libraryTableBody">
                    <tr>
                        <td colspan="7" class="loading-cell">
                            <div class="spinner"></div>
                            Loading library...
                        </td>
                    </tr>
                </tbody>
            </table>
        </div>
    </template>

    <template id="analyticsTemplate">
        <div class="section-header">
            <h2 class="section-title">Advanced Analytics</h2>
            <div class="header-actions">
                <select class="form-select" id="analyticsPeriod" onchange="loadAnalyticsData()" style="width: auto;">
                    <option value="7">Last 7 days</option>
                    <option value="30" selected>Last 30 days</option>
                    <option value="90">Last 90 days</option>
                    <option value="365">Last year</option>
                </select>
            </div>
        </div>
        
        <div class="stats-grid">
            <div class="stat-card">
                <div class="stat-header">
                    <div>
                        <div class="stat-title">Daily Active Users</div>
                        <div class="stat-value" id="dauCount">0</div>
                    </div>
                    <div class="stat-icon">
                        <span class="material-icons-sharp">group</span>
                    </div>
                </div>
                <div class="stat-change" id="dauChange">
                    <span class="material-icons-sharp">trending_up</span>
                    <span>Loading...</span>
                </div>
            </div>
            
            <div class="stat-card">
                <div class="stat-header">
                    <div>
                        <div class="stat-title">Engagement Rate</div>
                        <div class="stat-value" id="engagementRate">0%</div>
                    </div>
                    <div class="stat-icon">
                        <span class="material-icons-sharp">trending_up</span>
                    </div>
                </div>
                <div class="stat-change" id="engagementChange">
                    <span class="material-icons-sharp">trending_up</span>
                    <span>Loading...</span>
                </div>
            </div>
            
            <div class="stat-card">
                <div class="stat-header">
                    <div>
                        <div class="stat-title">Avg. Session Duration</div>
                        <div class="stat-value" id="sessionDuration">0m</div>
                    </div>
                    <div class="stat-icon">
                        <span class="material-icons-sharp">schedule</span>
                    </div>
                </div>
                <div class="stat-change" id="sessionChange">
                    <span class="material-icons-sharp">trending_up</span>
                    <span>Loading...</span>
                </div>
            </div>
            
            <div class="stat-card">
                <div class="stat-header">
                    <div>
                        <div class="stat-title">Bounce Rate</div>
                        <div class="stat-value" id="bounceRate">0%</div>
                    </div>
                    <div class="stat-icon">
                        <span class="material-icons-sharp">trending_down</span>
                    </div>
                </div>
                <div class="stat-change" id="bounceChange">
                    <span class="material-icons-sharp">trending_down</span>
                    <span>Loading...</span>
                </div>
            </div>
        </div>

        <div class="charts-grid">
            <div class="chart-card">
                <div class="chart-header">
                    <h3 class="chart-title">Traffic Overview</h3>
                </div>
                <div class="chart-container">
                    <canvas id="trafficChart"></canvas>
                </div>
            </div>
            
            <div class="chart-card">
                <div class="chart-header">
                    <h3 class="chart-title">Content Performance</h3>
                </div>
                <div class="chart-container">
                    <canvas id="performanceChart"></canvas>
                </div>
            </div>
        </div>

        <div class="section-header">
            <h2 class="section-title">Top Performing Content</h2>
        </div>
        
        <div class="data-table-container">
            <table class="data-table">
                <thead>
                    <tr>
                        <th>Content</th>
                        <th>Type</th>
                        <th>Engagement</th>
                        <th>Views</th>
                        <th>Likes</th>
                        <th>Comments</th>
                        <th>Shares</th>
                    </tr>
                </thead>
                <tbody id="topContentBody">
                    <tr>
                        <td colspan="7" class="loading-cell">
                            <div class="spinner"></div>
                            Loading top content...
                        </td>
                    </tr>
                </tbody>
            </table>
        </div>
    </template>

    <template id="settingsTemplate">
        <div class="form-container">
            <div class="tabs" id="settingsTabs">
                <button class="tab active" onclick="showSettingsTab('general')">General</button>
                <button class="tab" onclick="showSettingsTab('posts')">Posts</button>
                <button class="tab" onclick="showSettingsTab('library')">Library</button>
                <button class="tab" onclick="showSettingsTab('events')">Events</button>
                <button class="tab" onclick="showSettingsTab('subscriptions')">Subscriptions</button>
            </div>
            
            <div id="generalSettings" class="tab-content active">
                <div class="form-section">
                    <h3 class="form-title">General Settings</h3>
                    <div class="form-grid">
                        <div class="form-group">
                            <label class="form-label">Site Name *</label>
                            <input type="text" class="form-input" id="siteName" value="THE SONGA WELFARE">
                        </div>
                        <div class="form-group">
                            <label class="form-label">Contact Email *</label>
                            <input type="email" class="form-input" id="contactEmail" value="info@thesongawelfare.com">
                        </div>
                        <div class="form-group">
                            <label class="form-label">Contact Phone</label>
                            <input type="text" class="form-input" id="contactPhone" value="+254727211191">
                        </div>
                        <div class="form-group">
                            <label class="form-label">WhatsApp Number</label>
                            <input type="text" class="form-input" id="whatsappNumber" value="254727211191">
                        </div>
                        <div class="form-group full-width">
                            <label class="form-label">Site Description *</label>
                            <textarea class="form-textarea" id="siteDescription" rows="3">UNBOUND | UNBENT | UNBROKEN - Community for personal growth and empowerment</textarea>
                        </div>
                    </div>
                </div>
            </div>
            
            <div id="postsSettings" class="tab-content">
                <div class="form-section">
                    <h3 class="form-title">Post Settings</h3>
                    <div class="form-grid">
                        <div class="form-group">
                            <label class="form-label">Allow Comments</label>
                            <select class="form-select" id="allowComments">
                                <option value="true">Yes</option>
                                <option value="false">No</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label class="form-label">Allow Sharing</label>
                            <select class="form-select" id="allowSharing">
                                <option value="true">Yes</option>
                                <option value="false">No</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label class="form-label">Auto-approve Posts</label>
                            <select class="form-select" id="autoApprovePosts">
                                <option value="false">No</option>
                                <option value="true">Yes</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label class="form-label">Max Image Size (MB)</label>
                            <input type="number" class="form-input" id="maxImageSize" value="5">
                        </div>
                    </div>
                </div>
            </div>
            
            <div id="librarySettings" class="tab-content">
                <div class="form-section">
                    <h3 class="form-title">Library Settings</h3>
                    <div class="form-grid">
                        <div class="form-group">
                            <label class="form-label">Default Borrow Duration (days) *</label>
                            <input type="number" class="form-input" id="borrowDuration" value="14" min="1" max="30">
                        </div>
                        <div class="form-group">
                            <label class="form-label">Max Renewals *</label>
                            <input type="number" class="form-input" id="maxRenewals" value="2" min="0" max="10">
                        </div>
                        <div class="form-group">
                            <label class="form-label">Daily Fine Amount (KSh) *</label>
                            <input type="number" class="form-input" id="dailyFine" value="50" min="0">
                        </div>
                        <div class="form-group">
                            <label class="form-label">Max Books Per User *</label>
                            <input type="number" class="form-input" id="maxBooksPerUser" value="5" min="1" max="20">
                        </div>
                    </div>
                </div>
            </div>
            
            <div class="form-actions">
                <button class="btn btn-secondary" onclick="resetSettings()">Reset</button>
                <button class="btn btn-primary" onclick="saveSettings()">Save Changes</button>
            </div>
        </div>
    </template>

    <template id="backupTemplate">
        <div class="form-container">
            <div class="form-section">
                <h3 class="form-title">Backup & Restore</h3>
                <div style="text-align: center; padding: 2rem;">
                    <div class="stat-icon" style="margin: 0 auto 1.5rem; width: 80px; height: 80px; font-size: 2rem;">
                        <span class="material-icons-sharp">backup</span>
                    </div>
                    <h3 style="margin-bottom: 1rem;">Database Management</h3>
                    <p style="color: var(--text-secondary); margin-bottom: 2rem;">
                        Create backups of your database and restore from previous backups.
                    </p>
                    <div style="display: flex; gap: 1rem; justify-content: center; flex-wrap: wrap;">
                        <button class="btn btn-primary" onclick="createBackup()">
                            <span class="material-icons-sharp">cloud_download</span>
                            Create Backup
                        </button>
                        <button class="btn btn-secondary" onclick="showRestoreModal()">
                            <span class="material-icons-sharp">cloud_upload</span>
                            Restore Backup
                        </button>
                        <button class="btn btn-danger" onclick="showCleanupModal()">
                            <span class="material-icons-sharp">delete_sweep</span>
                            Cleanup Old Data
                        </button>
                    </div>
                </div>
            </div>
            
            <div class="form-section">
                <h3 class="form-title">Recent Backups</h3>
                <div class="data-table-container">
                    <table class="data-table">
                        <thead>
                            <tr>
                                <th>Date</th>
                                <th>Size</th>
                                <th>Type</th>
                                <th>Status</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody id="backupsTableBody">
                            <tr>
                                <td colspan="5" class="loading-cell">
                                    <div class="spinner"></div>
                                    Loading backups...
                                </td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </template>

    <template id="logsTemplate">
        <div class="section-header">
            <h2 class="section-title">System Logs</h2>
            <div class="header-actions">
                <select class="form-select" id="logLevel" onchange="filterLogs()" style="width: auto;">
                    <option value="all">All Levels</option>
                    <option value="info">Info</option>
                    <option value="warning">Warning</option>
                    <option value="error">Error</option>
                </select>
                <button class="btn btn-secondary" onclick="clearLogs()">
                    <span class="material-icons-sharp">delete_sweep</span>
                    Clear Logs
                </button>
                <button class="btn btn-secondary" onclick="exportLogs()">
                    <span class="material-icons-sharp">download</span>
                    Export Logs
                </button>
            </div>
        </div>
        
        <div class="data-table-container">
            <table class="data-table">
                <thead>
                    <tr>
                        <th>Timestamp</th>
                        <th>Level</th>
                        <th>Module</th>
                        <th>Message</th>
                        <th>User</th>
                    </tr>
                </thead>
                <tbody id="logsTableBody">
                    <tr>
                        <td colspan="5" class="loading-cell">
                            <div class="spinner"></div>
                            Loading logs...
                        </td>
                    </tr>
                </tbody>
            </table>
        </div>
        
        <div class="pagination" id="logPagination" style="display: none;">
            <button class="btn btn-secondary" onclick="prevLogPage()">Previous</button>
            <span id="logPageInfo">Page 1 of 1</span>
            <button class="btn btn-secondary" onclick="nextLogPage()">Next</button>
        </div>
    </template>

    <!-- Modal Templates -->
    <template id="addUserModalTemplate">
        <div class="modal">
            <div class="modal-header">
                <h3 class="modal-title">Add New User</h3>
                <button class="modal-close" onclick="closeModal()">
                    <span class="material-icons-sharp">close</span>
                </button>
            </div>
            <div class="modal-body">
                <form id="addUserForm">
                    <div class="form-group">
                        <label class="form-label">Email Address *</label>
                        <input type="email" class="form-input" id="userEmail" required>
                    </div>
                    <div class="form-group">
                        <label class="form-label">First Name *</label>
                        <input type="text" class="form-input" id="userFirstName" required>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Last Name *</label>
                        <input type="text" class="form-input" id="userLastName" required>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Membership Tier *</label>
                        <select class="form-select" id="userTier" required>
                            <option value="explorer">Explorer</option>
                            <option value="scholar">Scholar</option>
                            <option value="visionary">Visionary</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Status *</label>
                        <select class="form-select" id="userStatus" required>
                            <option value="active">Active</option>
                            <option value="pending">Pending</option>
                            <option value="suspended">Suspended</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Initial Password</label>
                        <input type="password" class="form-input" id="userPassword" placeholder="Leave blank for auto-generate">
                        <small style="color: var(--text-secondary); display: block; margin-top: 0.25rem;">
                            If left blank, a random password will be generated
                        </small>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" onclick="closeModal()">Cancel</button>
                <button class="btn btn-primary" onclick="createUser()">Create User</button>
            </div>
        </div>
    </template>

    <script>
        // Firebase Configuration
        const firebaseConfig = {
            apiKey: "AIzaSyBDZicoo7dFLtSmgRPvQE_gdm-tNOyCTXA",
            authDomain: "the-songa-77b1b.firebaseapp.com",
            databaseURL: "https://the-songa-77b1b-default-rtdb.europe-west1.firebasedatabase.app",
            projectId: "the-songa-77b1b",
            storageBucket: "the-songa-77b1b.firebasestorage.app",
            messagingSenderId: "123922889572",
            appId: "1:123922889572:web:482b2a624930baaf92d871"
        };

        // Initialize Firebase
        let database;
        let auth;
        try {
            firebase.initializeApp(firebaseConfig);
            database = firebase.database();
            auth = firebase.auth();
            console.log("Firebase initialized successfully for admin panel");
        } catch (error) {
            console.error("Firebase initialization error:", error);
            showAlert("Failed to connect to database. Please refresh the page.", "error");
        }

        // Global State
        let currentUser = null;
        let users = [];
        let posts = [];
        let events = [];
        let books = [];
        let currentSection = 'dashboard';
        let currentModal = null;
        let currentEditId = null;
        let logs = [];
        
        // Chart Instances
        let userGrowthChart = null;
        let membershipChart = null;
        let trafficChart = null;
        let performanceChart = null;

        // DOM Elements
        const contentContainer = document.getElementById('contentContainer');
        const alertContainer = document.getElementById('alertContainer');
        const modalOverlay = document.getElementById('modalOverlay');

        // Initialize Admin Panel
        async function initializeAdminPanel() {
            // Check authentication
            await checkAdminAuth();
            
            // Setup event listeners
            setupEventListeners();
            
            // Load initial section
            loadSection('dashboard');
            
            // Start real-time updates
            startRealtimeUpdates();
        }

        // Check Admin Authentication
        async function checkAdminAuth() {
            const adminData = localStorage.getItem('the_songa_admin');
            
            if (!adminData) {
                showLoginModal();
                return;
            }
            
            try {
                const admin = JSON.parse(adminData);
                if (admin.isAdmin) {
                    currentUser = admin;
                    updateAdminUI();
                } else {
                    showLoginModal();
                }
            } catch (error) {
                showLoginModal();
            }
        }

        // Show Login Modal
        function showLoginModal() {
            const modalHTML = `
                <div class="modal" style="max-width: 400px;">
                    <div class="modal-header">
                        <h3 class="modal-title">Admin Login</h3>
                    </div>
                    <div class="modal-body">
                        <form id="loginForm">
                            <div class="form-group">
                                <label class="form-label">Email</label>
                                <input type="email" class="form-input" id="loginEmail" required value="admin@thesongawelfare.com">
                            </div>
                            <div class="form-group">
                                <label class="form-label">Password</label>
                                <input type="password" class="form-input" id="loginPassword" required value="admin123">
                            </div>
                            <div class="alert alert-warning">
                                <span class="material-icons-sharp" style="vertical-align: middle; margin-right: 0.5rem;">info</span>
                                Demo credentials prefilled
                            </div>
                        </form>
                    </div>
                    <div class="modal-footer">
                        <button class="btn btn-primary" onclick="attemptLogin()">Login</button>
                    </div>
                </div>
            `;
            
            showModal(modalHTML);
        }

        // Attempt Login
        async function attemptLogin() {
            const email = document.getElementById('loginEmail').value;
            const password = document.getElementById('loginPassword').value;
            
            // Simple demo authentication
            if (email === 'admin@thesongawelfare.com' && password === 'admin123') {
                const adminData = {
                    uid: 'admin_001',
                    email: email,
                    firstName: 'Admin',
                    lastName: 'User',
                    isAdmin: true
                };
                
                localStorage.setItem('the_songa_admin', JSON.stringify(adminData));
                currentUser = adminData;
                updateAdminUI();
                closeModal();
                showAlert('Login successful!', 'success');
                loadSection('dashboard');
            } else {
                showAlert('Invalid credentials', 'error');
            }
        }

        // Logout
        function logout() {
            localStorage.removeItem('the_songa_admin');
            currentUser = null;
            showLoginModal();
        }

        // Update Admin UI
        function updateAdminUI() {
            if (currentUser) {
                document.getElementById('adminName').textContent = 
                    `${currentUser.firstName} ${currentUser.lastName}`;
                document.getElementById('adminEmail').textContent = currentUser.email;
                document.getElementById('adminAvatar').textContent = 
                    currentUser.firstName.charAt(0) + currentUser.lastName.charAt(0);
                document.getElementById('pageSubtitle').textContent = 
                    `Welcome back, ${currentUser.firstName}`;
            }
        }

        // Setup Event Listeners
        function setupEventListeners() {
            // Navigation
            document.querySelectorAll('.nav-link').forEach(link => {
                link.addEventListener('click', (e) => {
                    e.preventDefault();
                    const section = link.dataset.section;
                    loadSection(section);
                    
                    // Update active state
                    document.querySelectorAll('.nav-link').forEach(l => l.classList.remove('active'));
                    link.classList.add('active');
                });
            });

            // Refresh button
            document.getElementById('refreshBtn').addEventListener('click', () => {
                loadSection(currentSection);
                showAlert('Data refreshed', 'success');
            });

            // Global search
            document.getElementById('globalSearch').addEventListener('input', debounce((e) => {
                const query = e.target.value.toLowerCase();
                searchData(query);
            }, 300));

            // Close modal on overlay click
            modalOverlay.addEventListener('click', (e) => {
                if (e.target === modalOverlay) {
                    closeModal();
                }
            });
            
            // Log search on Enter key
            document.addEventListener('keydown', (e) => {
                if (e.key === 'Enter' && document.activeElement.id === 'globalSearch') {
                    searchData(document.getElementById('globalSearch').value.toLowerCase());
                }
            });
        }

        // Load Section
        async function loadSection(section) {
            currentSection = section;
            
            // Update page title
            const pageTitle = document.getElementById('pageTitle');
            pageTitle.textContent = getSectionTitle(section);
            
            // Show loading
            contentContainer.innerHTML = `
                <div class="loading">
                    <div class="spinner"></div>
                    <p>Loading ${section}...</p>
                </div>
            `;
            
            // Load section content
            try {
                switch(section) {
                    case 'dashboard':
                        await loadDashboard();
                        break;
                    case 'users':
                        await loadUsers();
                        break;
                    case 'posts':
                        await loadPosts();
                        break;
                    case 'events':
                        await loadEvents();
                        break;
                    case 'library':
                        await loadLibrary();
                        break;
                    case 'analytics':
                        await loadAnalytics();
                        break;
                    case 'settings':
                        await loadSettings();
                        break;
                    case 'backup':
                        await loadBackup();
                        break;
                    case 'logs':
                        await loadLogs();
                        break;
                    default:
                        await loadDashboard();
                }
            } catch (error) {
                console.error(`Error loading ${section}:`, error);
                showAlert(`Failed to load ${section} data`, 'error');
                contentContainer.innerHTML = `
                    <div class="empty-state">
                        <span class="material-icons-sharp">error</span>
                        <h3>Failed to load data</h3>
                        <p>${error.message}</p>
                        <button class="btn btn-secondary" onclick="loadSection('${section}')" style="margin-top: 1rem;">
                            Retry
                        </button>
                    </div>
                `;
            }
        }

        // Get Section Title
        function getSectionTitle(section) {
            const titles = {
                dashboard: 'Dashboard',
                analytics: 'Analytics',
                users: 'User Management',
                posts: 'Post Management',
                events: 'Event Management',
                library: 'Library Management',
                settings: 'System Settings',
                backup: 'Backup & Restore',
                logs: 'System Logs'
            };
            return titles[section] || 'Dashboard';
        }

        // Load Dashboard
        async function loadDashboard() {
            const template = document.getElementById('dashboardTemplate');
            contentContainer.innerHTML = template.innerHTML;
            
            try {
                // Fetch all data in parallel
                await Promise.all([
                    fetchUsers(),
                    fetchPosts(),
                    fetchEvents(),
                    fetchBooks(),
                    fetchAnalytics()
                ]);
                
                // Update stats
                updateDashboardStats();
                
                // Initialize charts
                initUserGrowthChart();
                initMembershipChart();
                
                // Load recent activity
                loadRecentActivity();
                
            } catch (error) {
                console.error('Error loading dashboard:', error);
                showAlert('Failed to load dashboard data', 'error');
            }
        }

        // Fetch Users
        async function fetchUsers() {
            try {
                const usersSnapshot = await database.ref('users').once('value');
                users = usersSnapshot.exists() ? Object.entries(usersSnapshot.val()).map(([id, data]) => ({ id, ...data })) : [];
                return users;
            } catch (error) {
                console.error('Error fetching users:', error);
                throw error;
            }
        }

        // Fetch Posts
        async function fetchPosts() {
            try {
                const postsSnapshot = await database.ref('communityPosts').once('value');
                posts = postsSnapshot.exists() ? Object.entries(postsSnapshot.val()).map(([id, data]) => ({ id, ...data })) : [];
                return posts;
            } catch (error) {
                console.error('Error fetching posts:', error);
                throw error;
            }
        }

        // Fetch Events
        async function fetchEvents() {
            try {
                const eventsSnapshot = await database.ref('events').once('value');
                events = eventsSnapshot.exists() ? Object.entries(eventsSnapshot.val()).map(([id, data]) => ({ id, ...data })) : [];
                return events;
            } catch (error) {
                console.error('Error fetching events:', error);
                throw error;
            }
        }

        // Fetch Books
        async function fetchBooks() {
            try {
                const booksSnapshot = await database.ref('libraryBooks').once('value');
                books = booksSnapshot.exists() ? Object.entries(booksSnapshot.val()).map(([id, data]) => ({ id, ...data })) : [];
                return books;
            } catch (error) {
                console.error('Error fetching books:', error);
                throw error;
            }
        }

        // Fetch Analytics
        async function fetchAnalytics() {
            try {
                const analyticsSnapshot = await database.ref('analytics').once('value');
                return analyticsSnapshot.exists() ? analyticsSnapshot.val() : {};
            } catch (error) {
                console.error('Error fetching analytics:', error);
                return {};
            }
        }

        // Update Dashboard Stats
        function updateDashboardStats() {
            // Total Users
            document.getElementById('totalUsers').textContent = users.length;
            
            // Active Posts (published)
            const activePosts = posts.filter(post => post.status === 'published').length;
            document.getElementById('activePosts').textContent = activePosts;
            
            // Event Registrations
            let totalRegistrations = 0;
            events.forEach(event => {
                totalRegistrations += event.registeredCount || 0;
            });
            document.getElementById('eventRegistrations').textContent = totalRegistrations;
            
            // Books in Library
            document.getElementById('booksBorrowed').textContent = books.length;
            
            // Update change indicators
            updateChangeIndicators();
        }

        // Update Change Indicators
        function updateChangeIndicators() {
            // For demo purposes, show positive changes
            const changes = document.querySelectorAll('.stat-change');
            changes.forEach(change => {
                const randomPercent = Math.floor(Math.random() * 25) + 5;
                change.innerHTML = `
                    <span class="material-icons-sharp">trending_up</span>
                    <span>${randomPercent}% from last month</span>
                `;
                change.classList.add('positive');
            });
        }

        // Initialize User Growth Chart
        function initUserGrowthChart() {
            const ctx = document.getElementById('userGrowthChart').getContext('2d');
            
            // Generate sample data for the last 30 days
            const labels = [];
            const data = [];
            const today = new Date();
            
            for (let i = 29; i >= 0; i--) {
                const date = new Date(today);
                date.setDate(date.getDate() - i);
                labels.push(date.toLocaleDateString('en-US', { month: 'short', day: 'numeric' }));
                
                // Generate realistic user growth data
                const baseUsers = users.length;
                const dailyGrowth = Math.floor(Math.random() * 3);
                data.push(baseUsers + (dailyGrowth * (30 - i)));
            }
            
            userGrowthChart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: labels,
                    datasets: [{
                        label: 'Total Users',
                        data: data,
                        borderColor: 'rgb(212, 175, 55)',
                        backgroundColor: 'rgba(212, 175, 55, 0.1)',
                        fill: true,
                        tension: 0.4,
                        pointBackgroundColor: 'rgb(212, 175, 55)',
                        pointBorderColor: '#fff',
                        pointBorderWidth: 2,
                        pointRadius: 4
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            display: false
                        },
                        tooltip: {
                            mode: 'index',
                            intersect: false
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: false,
                            grid: {
                                drawBorder: false
                            },
                            ticks: {
                                callback: function(value) {
                                    return value.toLocaleString();
                                }
                            }
                        },
                        x: {
                            grid: {
                                display: false
                            }
                        }
                    }
                }
            });
        }

        // Update User Growth Chart
        function updateUserGrowthChart() {
            const period = parseInt(document.getElementById('userGrowthPeriod').value);
            const ctx = document.getElementById('userGrowthChart').getContext('2d');
            
            // Update chart data based on period
            const labels = [];
            const data = [];
            const today = new Date();
            
            for (let i = period - 1; i >= 0; i--) {
                const date = new Date(today);
                date.setDate(date.getDate() - i);
                
                if (period === 7) {
                    labels.push(date.toLocaleDateString('en-US', { weekday: 'short' }));
                } else if (period === 30) {
                    labels.push(date.toLocaleDateString('en-US', { month: 'short', day: 'numeric' }));
                } else {
                    labels.push(date.toLocaleDateString('en-US', { month: 'short' }));
                }
                
                // Generate realistic data
                const baseUsers = users.length;
                const dailyGrowth = Math.floor(Math.random() * 3);
                data.push(baseUsers + (dailyGrowth * (period - i)));
            }
            
            userGrowthChart.data.labels = labels;
            userGrowthChart.data.datasets[0].data = data;
            userGrowthChart.update();
        }

        // Initialize Membership Chart
        function initMembershipChart() {
            const ctx = document.getElementById('membershipChart').getContext('2d');
            
            // Calculate membership distribution
            const explorerCount = users.filter(u => u.membershipTier === 'explorer').length;
            const scholarCount = users.filter(u => u.membershipTier === 'scholar').length;
            const visionaryCount = users.filter(u => u.membershipTier === 'visionary').length;
            
            const data = {
                labels: ['Explorer', 'Scholar', 'Visionary'],
                datasets: [{
                    data: [explorerCount, scholarCount, visionaryCount],
                    backgroundColor: [
                        'rgb(14, 165, 233)',    // Blue
                        'rgb(59, 130, 246)',    // Lighter blue
                        'rgb(212, 175, 55)'     // Gold
                    ],
                    borderColor: [
                        'rgb(14, 165, 233)',
                        'rgb(59, 130, 246)',
                        'rgb(212, 175, 55)'
                    ],
                    borderWidth: 2,
                    hoverOffset: 15
                }]
            };
            
            membershipChart = new Chart(ctx, {
                type: 'doughnut',
                data: data,
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            position: 'bottom',
                            labels: {
                                padding: 20,
                                usePointStyle: true,
                                font: {
                                    size: 12
                                }
                            }
                        },
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    const label = context.label || '';
                                    const value = context.raw || 0;
                                    const total = context.dataset.data.reduce((a, b) => a + b, 0);
                                    const percentage = Math.round((value / total) * 100);
                                    return `${label}: ${value} (${percentage}%)`;
                                }
                            }
                        }
                    },
                    cutout: '60%'
                }
            });
        }

        // Refresh Membership Chart
        function refreshMembershipChart() {
            if (membershipChart) {
                membershipChart.destroy();
            }
            initMembershipChart();
            showAlert('Membership chart refreshed', 'success');
        }

        // Load Recent Activity
        async function loadRecentActivity() {
            const tableBody = document.getElementById('recentActivityBody');
            
            try {
                // Clear loading state
                tableBody.innerHTML = '';
                
                // Generate sample recent activity
                const activities = [
                    {
                        user: 'John Doe',
                        action: 'Registered',
                        details: 'New user registration',
                        time: '2 hours ago'
                    },
                    {
                        user: 'Sarah Johnson',
                        action: 'Upgraded',
                        details: 'Upgraded to Visionary tier',
                        time: '4 hours ago'
                    },
                    {
                        user: 'Michael Brown',
                        action: 'Posted',
                        details: 'Created new discussion post',
                        time: '6 hours ago'
                    },
                    {
                        user: 'System',
                        action: 'Backup',
                        details: 'Daily backup completed',
                        time: 'Yesterday'
                    },
                    {
                        user: 'Admin',
                        action: 'Updated',
                        details: 'Updated library settings',
                        time: '2 days ago'
                    }
                ];
                
                activities.forEach(activity => {
                    const row = document.createElement('tr');
                    row.innerHTML = `
                        <td><strong>${activity.user}</strong></td>
                        <td><span class="status-badge status-active">${activity.action}</span></td>
                        <td>${activity.details}</td>
                        <td>${activity.time}</td>
                    `;
                    tableBody.appendChild(row);
                });
                
            } catch (error) {
                console.error('Error loading recent activity:', error);
                tableBody.innerHTML = `
                    <tr>
                        <td colspan="4" style="text-align: center; color: var(--text-secondary); padding: 2rem;">
                            Failed to load recent activity
                        </td>
                    </tr>
                `;
            }
        }

        // Load Users
        async function loadUsers() {
            const template = document.getElementById('usersTemplate');
            contentContainer.innerHTML = template.innerHTML;
            
            try {
                await fetchUsers();
                renderUsersTable(users);
                
            } catch (error) {
                console.error('Error loading users:', error);
                showAlert('Failed to load users', 'error');
                document.getElementById('usersTableBody').innerHTML = `
                    <tr>
                        <td colspan="6" style="text-align: center; color: var(--text-secondary); padding: 2rem;">
                            Failed to load users
                        </td>
                    </tr>
                `;
            }
        }

        // Render Users Table
        function renderUsersTable(usersList) {
            const tableBody = document.getElementById('usersTableBody');
            tableBody.innerHTML = '';
            
            if (usersList.length === 0) {
                tableBody.innerHTML = `
                    <tr>
                        <td colspan="6" style="text-align: center; color: var(--text-secondary); padding: 2rem;">
                            No users found
                        </td>
                    </tr>
                `;
                return;
            }
            
            usersList.forEach(user => {
                const tierClass = `tier-${user.membershipTier || 'explorer'}`;
                const statusClass = `status-${user.membershipStatus || 'active'}`;
                const isAdmin = user.isAdmin ? 'Admin' : 'Member';
                
                row.innerHTML = `
                    <td>
                        <div style="display: flex; align-items: center; gap: 0.75rem;">
                            <div style="width: 32px; height: 32px; border-radius: 50%; background: var(--primary); display: flex; align-items: center; justify-content: center; font-weight: 600; font-size: 0.875rem; color: var(--secondary);">
                                ${(user.firstName?.charAt(0) || 'U') + (user.lastName?.charAt(0) || '')}
                            </div>
                            <div>
                                <div style="font-weight: 600;">${user.firstName || 'Unknown'} ${user.lastName || ''}</div>
                                <div style="font-size: 0.75rem; color: var(--text-secondary);">${isAdmin}</div>
                            </div>
                        </div>
                    </td>
                    <td>${user.email || 'N/A'}</td>
                    <td><span class="tier-badge ${tierClass}">${(user.membershipTier || 'explorer').toUpperCase()}</span></td>
                    <td><span class="status-badge ${statusClass}">${(user.membershipStatus || 'active').toUpperCase()}</span></td>
                    <td>${user.joinedDate ? formatDate(user.joinedDate) : 'N/A'}</td>
                    <td>
                        <div class="action-buttons">
                            <button class="btn-icon edit" onclick="editUser('${user.id}')" title="Edit">
                                <span class="material-icons-sharp">edit</span>
                            </button>
                            <button class="btn-icon delete" onclick="confirmDeleteUser('${user.id}')" title="Delete">
                                <span class="material-icons-sharp">delete</span>
                            </button>
                        </div>
                    </td>
                `;
                tableBody.appendChild(row);
            });
        }

        // Filter Users
        function filterUsers(filter) {
            let filteredUsers = [];
            
            switch(filter) {
                case 'active':
                    filteredUsers = users.filter(u => u.membershipStatus === 'active');
                    break;
                case 'pending':
                    filteredUsers = users.filter(u => u.membershipStatus === 'pending');
                    break;
                case 'suspended':
                    filteredUsers = users.filter(u => u.membershipStatus === 'suspended');
                    break;
                case 'admins':
                    filteredUsers = users.filter(u => u.isAdmin === true);
                    break;
                default:
                    filteredUsers = users;
            }
            
            renderUsersTable(filteredUsers);
            
            // Update tab active state
            document.querySelectorAll('.tab').forEach(tab => tab.classList.remove('active'));
            event.target.classList.add('active');
        }

        // Show Add User Modal
        function showAddUserModal() {
            const template = document.getElementById('addUserModalTemplate');
            showModal(template.innerHTML);
        }

        // Create User
        async function createUser() {
            const email = document.getElementById('userEmail').value;
            const firstName = document.getElementById('userFirstName').value;
            const lastName = document.getElementById('userLastName').value;
            const tier = document.getElementById('userTier').value;
            const status = document.getElementById('userStatus').value;
            const password = document.getElementById('userPassword').value;
            
            if (!email || !firstName || !lastName) {
                showAlert('Please fill in all required fields', 'error');
                return;
            }
            
            try {
                const userId = `user_${Date.now()}`;
                const userData = {
                    id: userId,
                    email: email,
                    firstName: firstName,
                    lastName: lastName,
                    fullName: `${firstName} ${lastName}`,
                    membershipTier: tier,
                    membershipStatus: status,
                    joinedDate: new Date().toISOString(),
                    lastLogin: new Date().toISOString(),
                    isAdmin: false,
                    profilePicture: `https://ui-avatars.com/api/?name=${firstName}+${lastName}&background=random`,
                    stats: {
                        postsCreated: 0,
                        postsLiked: 0,
                        commentsMade: 0,
                        booksBorrowed: 0,
                        eventsAttended: 0,
                        communityPoints: 0
                    }
                };
                
                await database.ref(`users/${userId}`).set(userData);
                showAlert('User created successfully', 'success');
                closeModal();
                loadUsers(); // Refresh the table
                
            } catch (error) {
                console.error('Error creating user:', error);
                showAlert('Failed to create user', 'error');
            }
        }

        // Edit User
        async function editUser(userId) {
            const user = users.find(u => u.id === userId);
            if (!user) {
                showAlert('User not found', 'error');
                return;
            }
            
            currentEditId = userId;
            
            const modalHTML = `
                <div class="modal">
                    <div class="modal-header">
                        <h3 class="modal-title">Edit User: ${user.firstName} ${user.lastName}</h3>
                        <button class="modal-close" onclick="closeModal()">
                            <span class="material-icons-sharp">close</span>
                        </button>
                    </div>
                    <div class="modal-body">
                        <form id="editUserForm">
                            <div class="form-group">
                                <label class="form-label">Email Address</label>
                                <input type="email" class="form-input" id="editUserEmail" value="${user.email || ''}">
                            </div>
                            <div class="form-group">
                                <label class="form-label">First Name</label>
                                <input type="text" class="form-input" id="editUserFirstName" value="${user.firstName || ''}">
                            </div>
                            <div class="form-group">
                                <label class="form-label">Last Name</label>
                                <input type="text" class="form-input" id="editUserLastName" value="${user.lastName || ''}">
                            </div>
                            <div class="form-group">
                                <label class="form-label">Membership Tier</label>
                                <select class="form-select" id="editUserTier">
                                    <option value="explorer" ${user.membershipTier === 'explorer' ? 'selected' : ''}>Explorer</option>
                                    <option value="scholar" ${user.membershipTier === 'scholar' ? 'selected' : ''}>Scholar</option>
                                    <option value="visionary" ${user.membershipTier === 'visionary' ? 'selected' : ''}>Visionary</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label class="form-label">Status</label>
                                <select class="form-select" id="editUserStatus">
                                    <option value="active" ${user.membershipStatus === 'active' ? 'selected' : ''}>Active</option>
                                    <option value="pending" ${user.membershipStatus === 'pending' ? 'selected' : ''}>Pending</option>
                                    <option value="suspended" ${user.membershipStatus === 'suspended' ? 'selected' : ''}>Suspended</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label class="form-label">Admin Access</label>
                                <select class="form-select" id="editUserIsAdmin">
                                    <option value="false" ${!user.isAdmin ? 'selected' : ''}>No</option>
                                    <option value="true" ${user.isAdmin ? 'selected' : ''}>Yes</option>
                                </select>
                            </div>
                        </form>
                    </div>
                    <div class="modal-footer">
                        <button class="btn btn-danger" onclick="deleteUser('${userId}')">Delete User</button>
                        <button class="btn btn-secondary" onclick="closeModal()">Cancel</button>
                        <button class="btn btn-primary" onclick="saveUser()">Save Changes</button>
                    </div>
                </div>
            `;
            
            showModal(modalHTML);
        }

        // Save User
        async function saveUser() {
            if (!currentEditId) return;
            
            const updates = {
                email: document.getElementById('editUserEmail').value,
                firstName: document.getElementById('editUserFirstName').value,
                lastName: document.getElementById('editUserLastName').value,
                fullName: `${document.getElementById('editUserFirstName').value} ${document.getElementById('editUserLastName').value}`,
                membershipTier: document.getElementById('editUserTier').value,
                membershipStatus: document.getElementById('editUserStatus').value,
                isAdmin: document.getElementById('editUserIsAdmin').value === 'true',
                updatedAt: new Date().toISOString()
            };
            
            try {
                await database.ref(`users/${currentEditId}`).update(updates);
                showAlert('User updated successfully', 'success');
                closeModal();
                loadUsers(); // Refresh the table
            } catch (error) {
                console.error('Error updating user:', error);
                showAlert('Failed to update user', 'error');
            }
        }

        // Delete User
        async function deleteUser(userId) {
            if (!confirm('Are you sure you want to delete this user? This action cannot be undone.')) {
                return;
            }
            
            try {
                await database.ref(`users/${userId}`).remove();
                showAlert('User deleted successfully', 'success');
                closeModal();
                loadUsers(); // Refresh the table
            } catch (error) {
                console.error('Error deleting user:', error);
                showAlert('Failed to delete user', 'error');
            }
        }

        // Confirm Delete User
        function confirmDeleteUser(userId) {
            if (confirm('Are you sure you want to delete this user?')) {
                deleteUser(userId);
            }
        }

        // Export Users
        function exportUsers() {
            const dataStr = JSON.stringify(users, null, 2);
            const dataUri = 'data:application/json;charset=utf-8,'+ encodeURIComponent(dataStr);
            
            const exportFileDefaultName = `the_songa_users_${new Date().toISOString().split('T')[0]}.json`;
            
            const linkElement = document.createElement('a');
            linkElement.setAttribute('href', dataUri);
            linkElement.setAttribute('download', exportFileDefaultName);
            linkElement.click();
            
            showAlert('Users exported successfully', 'success');
        }

        // Load Posts
        async function loadPosts() {
            const template = document.getElementById('postsTemplate');
            contentContainer.innerHTML = template.innerHTML;
            
            try {
                await fetchPosts();
                renderPostsTable(posts);
                
            } catch (error) {
                console.error('Error loading posts:', error);
                showAlert('Failed to load posts', 'error');
                document.getElementById('postsTableBody').innerHTML = `
                    <tr>
                        <td colspan="8" style="text-align: center; color: var(--text-secondary); padding: 2rem;">
                            Failed to load posts
                        </td>
                    </tr>
                `;
            }
        }

        // Render Posts Table
        function renderPostsTable(postsList) {
            const tableBody = document.getElementById('postsTableBody');
            tableBody.innerHTML = '';
            
            if (postsList.length === 0) {
                tableBody.innerHTML = `
                    <tr>
                        <td colspan="8" style="text-align: center; color: var(--text-secondary); padding: 2rem;">
                            No posts found
                        </td>
                    </tr>
                `;
                return;
            }
            
            postsList.forEach(post => {
                const statusClass = post.status === 'published' ? 'status-active' : 
                                  post.status === 'draft' ? 'status-pending' : 'status-suspended';
                
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td>
                        <div style="font-weight: 600;">${post.title || 'Untitled'}</div>
                        <div style="font-size: 0.75rem; color: var(--text-secondary);">${post.id.substring(0, 8)}</div>
                    </td>
                    <td>${post.authorName || 'Unknown'}</td>
                    <td><span class="status-badge">${post.category || 'announcement'}</span></td>
                    <td>${post.likes || 0}</td>
                    <td>${post.comments || 0}</td>
                    <td><span class="status-badge ${statusClass}">${post.status || 'draft'}</span></td>
                    <td>${post.createdAt ? formatDate(post.createdAt) : 'N/A'}</td>
                    <td>
                        <div class="action-buttons">
                            <button class="btn-icon edit" onclick="editPost('${post.id}')" title="Edit">
                                <span class="material-icons-sharp">edit</span>
                            </button>
                            <button class="btn-icon delete" onclick="deletePost('${post.id}')" title="Delete">
                                <span class="material-icons-sharp">delete</span>
                            </button>
                        </div>
                    </td>
                `;
                tableBody.appendChild(row);
            });
        }

        // Filter Posts
        function filterPosts() {
            const filter = document.getElementById('postFilter').value;
            let filteredPosts = [];
            
            switch(filter) {
                case 'published':
                    filteredPosts = posts.filter(p => p.status === 'published');
                    break;
                case 'draft':
                    filteredPosts = posts.filter(p => p.status === 'draft');
                    break;
                case 'archived':
                    filteredPosts = posts.filter(p => p.status === 'archived');
                    break;
                default:
                    filteredPosts = posts;
            }
            
            renderPostsTable(filteredPosts);
        }

        // Show Add Post Modal
        function showAddPostModal() {
            const modalHTML = `
                <div class="modal" style="max-width: 600px;">
                    <div class="modal-header">
                        <h3 class="modal-title">Create New Post</h3>
                        <button class="modal-close" onclick="closeModal()">
                            <span class="material-icons-sharp">close</span>
                        </button>
                    </div>
                    <div class="modal-body">
                        <form id="addPostForm">
                            <div class="form-group">
                                <label class="form-label">Title *</label>
                                <input type="text" class="form-input" id="postTitle" required>
                            </div>
                            <div class="form-group">
                                <label class="form-label">Content *</label>
                                <textarea class="form-textarea" id="postContent" rows="6" required></textarea>
                            </div>
                            <div class="form-grid">
                                <div class="form-group">
                                    <label class="form-label">Category</label>
                                    <select class="form-select" id="postCategory">
                                        <option value="announcement">Announcement</option>
                                        <option value="event">Event</option>
                                        <option value="discussion">Discussion</option>
                                        <option value="resource">Resource</option>
                                        <option value="motivation">Motivation</option>
                                        <option value="community">Community</option>
                                    </select>
                                </div>
                                <div class="form-group">
                                    <label class="form-label">Status</label>
                                    <select class="form-select" id="postStatus">
                                        <option value="published">Published</option>
                                        <option value="draft">Draft</option>
                                        <option value="archived">Archived</option>
                                    </select>
                                </div>
                            </div>
                            <div class="form-group">
                                <label class="form-label">Author</label>
                                <input type="text" class="form-input" id="postAuthor" value="THE SONGA">
                            </div>
                            <div class="form-group">
                                <label class="form-label">Tags (comma-separated)</label>
                                <input type="text" class="form-input" id="postTags" placeholder="community, welcome, announcement">
                            </div>
                            <div class="form-group">
                                <label class="form-label">
                                    <input type="checkbox" id="postPinned"> Pin this post
                                </label>
                            </div>
                        </form>
                    </div>
                    <div class="modal-footer">
                        <button class="btn btn-secondary" onclick="closeModal()">Cancel</button>
                        <button class="btn btn-primary" onclick="createPost()">Publish Post</button>
                    </div>
                </div>
            `;
            
            showModal(modalHTML);
        }

        // Create Post
        async function createPost() {
            const title = document.getElementById('postTitle').value;
            const content = document.getElementById('postContent').value;
            const category = document.getElementById('postCategory').value;
            const status = document.getElementById('postStatus').value;
            const author = document.getElementById('postAuthor').value;
            const tags = document.getElementById('postTags').value;
            const isPinned = document.getElementById('postPinned').checked;
            
            if (!title || !content) {
                showAlert('Please fill in title and content', 'error');
                return;
            }
            
            try {
                const postId = `post_${Date.now()}`;
                const postData = {
                    id: postId,
                    title: title,
                    content: content,
                    category: category,
                    authorName: author,
                    authorId: currentUser.uid,
                    tags: tags ? tags.split(',').map(t => t.trim()) : [],
                    isPinned: isPinned,
                    status: status,
                    likes: 0,
                    comments: 0,
                    shares: 0,
                    bookmarks: 0,
                    views: 0,
                    createdAt: new Date().toISOString(),
                    updatedAt: new Date().toISOString(),
                    visibility: 'public',
                    allowComments: true,
                    allowSharing: true
                };
                
                await database.ref(`communityPosts/${postId}`).set(postData);
                showAlert('Post created successfully', 'success');
                closeModal();
                loadPosts();
            } catch (error) {
                console.error('Error creating post:', error);
                showAlert('Failed to create post', 'error');
            }
        }

        // Edit Post
        async function editPost(postId) {
            const post = posts.find(p => p.id === postId);
            if (!post) {
                showAlert('Post not found', 'error');
                return;
            }
            
            currentEditId = postId;
            
            const modalHTML = `
                <div class="modal" style="max-width: 600px;">
                    <div class="modal-header">
                        <h3 class="modal-title">Edit Post: ${post.title}</h3>
                        <button class="modal-close" onclick="closeModal()">
                            <span class="material-icons-sharp">close</span>
                        </button>
                    </div>
                    <div class="modal-body">
                        <form id="editPostForm">
                            <div class="form-group">
                                <label class="form-label">Title</label>
                                <input type="text" class="form-input" id="editPostTitle" value="${post.title || ''}">
                            </div>
                            <div class="form-group">
                                <label class="form-label">Content</label>
                                <textarea class="form-textarea" id="editPostContent" rows="6">${post.content || ''}</textarea>
                            </div>
                            <div class="form-group">
                                <label class="form-label">Status</label>
                                <select class="form-select" id="editPostStatus">
                                    <option value="published" ${post.status === 'published' ? 'selected' : ''}>Published</option>
                                    <option value="draft" ${post.status === 'draft' ? 'selected' : ''}>Draft</option>
                                    <option value="archived" ${post.status === 'archived' ? 'selected' : ''}>Archived</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label class="form-label">Category</label>
                                <select class="form-select" id="editPostCategory">
                                    <option value="announcement" ${post.category === 'announcement' ? 'selected' : ''}>Announcement</option>
                                    <option value="event" ${post.category === 'event' ? 'selected' : ''}>Event</option>
                                    <option value="discussion" ${post.category === 'discussion' ? 'selected' : ''}>Discussion</option>
                                    <option value="resource" ${post.category === 'resource' ? 'selected' : ''}>Resource</option>
                                    <option value="motivation" ${post.category === 'motivation' ? 'selected' : ''}>Motivation</option>
                                    <option value="community" ${post.category === 'community' ? 'selected' : ''}>Community</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label class="form-label">
                                    <input type="checkbox" id="editPostPinned" ${post.isPinned ? 'checked' : ''}> Pin this post
                                </label>
                            </div>
                        </form>
                    </div>
                    <div class="modal-footer">
                        <button class="btn btn-danger" onclick="deletePost('${postId}')">Delete Post</button>
                        <button class="btn btn-secondary" onclick="closeModal()">Cancel</button>
                        <button class="btn btn-primary" onclick="updatePost()">Save Changes</button>
                    </div>
                </div>
            `;
            
            showModal(modalHTML);
        }

        // Update Post
        async function updatePost() {
            if (!currentEditId) return;
            
            const updates = {
                title: document.getElementById('editPostTitle').value,
                content: document.getElementById('editPostContent').value,
                status: document.getElementById('editPostStatus').value,
                category: document.getElementById('editPostCategory').value,
                isPinned: document.getElementById('editPostPinned').checked,
                updatedAt: new Date().toISOString()
            };
            
            try {
                await database.ref(`communityPosts/${currentEditId}`).update(updates);
                showAlert('Post updated successfully', 'success');
                closeModal();
                loadPosts();
            } catch (error) {
                console.error('Error updating post:', error);
                showAlert('Failed to update post', 'error');
            }
        }

        // Delete Post
        async function deletePost(postId) {
            if (!confirm('Are you sure you want to delete this post?')) {
                return;
            }
            
            try {
                await database.ref(`communityPosts/${postId}`).remove();
                showAlert('Post deleted successfully', 'success');
                closeModal();
                loadPosts();
            } catch (error) {
                console.error('Error deleting post:', error);
                showAlert('Failed to delete post', 'error');
            }
        }

        // Load Events
        async function loadEvents() {
            const template = document.getElementById('eventsTemplate');
            contentContainer.innerHTML = template.innerHTML;
            
            try {
                await fetchEvents();
                renderEventsTable(events);
                
            } catch (error) {
                console.error('Error loading events:', error);
                showAlert('Failed to load events', 'error');
                document.getElementById('eventsTableBody').innerHTML = `
                    <tr>
                        <td colspan="7" style="text-align: center; color: var(--text-secondary); padding: 2rem;">
                            Failed to load events
                        </td>
                    </tr>
                `;
            }
        }

        // Render Events Table
        function renderEventsTable(eventsList) {
            const tableBody = document.getElementById('eventsTableBody');
            tableBody.innerHTML = '';
            
            if (eventsList.length === 0) {
                tableBody.innerHTML = `
                    <tr>
                        <td colspan="7" style="text-align: center; color: var(--text-secondary); padding: 2rem;">
                            No events found
                        </td>
                    </tr>
                `;
                return;
            }
            
            eventsList.forEach(event => {
                const eventDate = new Date(event.date);
                const now = new Date();
                const isPast = eventDate < now;
                const statusClass = isPast ? 'status-suspended' : 'status-active';
                const statusText = isPast ? 'Past' : 'Upcoming';
                
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td>
                        <div style="font-weight: 600;">${event.title || 'Untitled Event'}</div>
                        <div style="font-size: 0.75rem; color: var(--text-secondary);">${event.id.substring(0, 8)}</div>
                    </td>
                    <td>${event.date ? formatDate(event.date) : 'N/A'}</td>
                    <td>${event.location || 'Virtual'}</td>
                    <td>${event.registeredCount || 0} / ${event.capacity || ''}</td>
                    <td><span class="status-badge ${statusClass}">${statusText}</span></td>
                    <td><span class="status-badge">${event.type || 'virtual'}</span></td>
                    <td>
                        <div class="action-buttons">
                            <button class="btn-icon edit" onclick="editEvent('${event.id}')" title="Edit">
                                <span class="material-icons-sharp">edit</span>
                            </button>
                            <button class="btn-icon delete" onclick="deleteEvent('${event.id}')" title="Delete">
                                <span class="material-icons-sharp">delete</span>
                            </button>
                        </div>
                    </td>
                `;
                tableBody.appendChild(row);
            });
        }

        // Filter Events
        function filterEvents() {
            const filter = document.getElementById('eventFilter').value;
            const now = new Date();
            let filteredEvents = [];
            
            switch(filter) {
                case 'upcoming':
                    filteredEvents = events.filter(e => new Date(e.date) > now);
                    break;
                case 'past':
                    filteredEvents = events.filter(e => new Date(e.date) < now);
                    break;
                case 'active':
                    filteredEvents = events.filter(e => e.status === 'active');
                    break;
                default:
                    filteredEvents = events;
            }
            
            renderEventsTable(filteredEvents);
        }

        // Show Add Event Modal
        function showAddEventModal() {
            const modalHTML = `
                <div class="modal" style="max-width: 600px;">
                    <div class="modal-header">
                        <h3 class="modal-title">Create New Event</h3>
                        <button class="modal-close" onclick="closeModal()">
                            <span class="material-icons-sharp">close</span>
                        </button>
                    </div>
                    <div class="modal-body">
                        <form id="addEventForm">
                            <div class="form-group">
                                <label class="form-label">Event Title *</label>
                                <input type="text" class="form-input" id="eventTitle" required>
                            </div>
                            <div class="form-group">
                                <label class="form-label">Description *</label>
                                <textarea class="form-textarea" id="eventDescription" rows="4" required></textarea>
                            </div>
                            <div class="form-grid">
                                <div class="form-group">
                                    <label class="form-label">Date & Time *</label>
                                    <input type="datetime-local" class="form-input" id="eventDate" required>
                                </div>
                                <div class="form-group">
                                    <label class="form-label">Type</label>
                                    <select class="form-select" id="eventType">
                                        <option value="virtual">Virtual</option>
                                        <option value="in-person">In-Person</option>
                                        <option value="hybrid">Hybrid</option>
                                    </select>
                                </div>
                            </div>
                            <div class="form-grid">
                                <div class="form-group">
                                    <label class="form-label">Location</label>
                                    <input type="text" class="form-input" id="eventLocation" placeholder="Virtual or physical address">
                                </div>
                                <div class="form-group">
                                    <label class="form-label">Capacity</label>
                                    <input type="number" class="form-input" id="eventCapacity" value="100">
                                </div>
                            </div>
                            <div class="form-grid">
                                <div class="form-group">
                                    <label class="form-label">Category</label>
                                    <select class="form-select" id="eventCategory">
                                        <option value="workshop">Workshop</option>
                                        <option value="networking">Networking</option>
                                        <option value="seminar">Seminar</option>
                                        <option value="community">Community</option>
                                    </select>
                                </div>
                                <div class="form-group">
                                    <label class="form-label">Price (KSh)</label>
                                    <input type="number" class="form-input" id="eventPrice" value="0" min="0">
                                </div>
                            </div>
                        </form>
                    </div>
                    <div class="modal-footer">
                        <button class="btn btn-secondary" onclick="closeModal()">Cancel</button>
                        <button class="btn btn-primary" onclick="createEvent()">Create Event</button>
                    </div>
                </div>
            `;
            
            // Set default date to tomorrow
            const tomorrow = new Date();
            tomorrow.setDate(tomorrow.getDate() + 1);
            const defaultDate = tomorrow.toISOString().slice(0, 16);
            
            showModal(modalHTML);
            
            // Set default date after modal is shown
            setTimeout(() => {
                document.getElementById('eventDate').value = defaultDate;
            }, 100);
        }

        // Create Event
        async function createEvent() {
            const title = document.getElementById('eventTitle').value;
            const description = document.getElementById('eventDescription').value;
            const date = document.getElementById('eventDate').value;
            const type = document.getElementById('eventType').value;
            const location = document.getElementById('eventLocation').value;
            const capacity = parseInt(document.getElementById('eventCapacity').value);
            const category = document.getElementById('eventCategory').value;
            const price = parseInt(document.getElementById('eventPrice').value);
            
            if (!title || !description || !date) {
                showAlert('Please fill in all required fields', 'error');
                return;
            }
            
            try {
                const eventId = `event_${Date.now()}`;
                const eventDate = new Date(date);
                
                const eventData = {
                    id: eventId,
                    title: title,
                    description: description,
                    category: category,
                    type: type,
                    date: eventDate.toISOString(),
                    endDate: new Date(eventDate.getTime() + 2 * 60 * 60 * 1000).toISOString(), // 2 hours later
                    location: location || 'Virtual',
                    address: location || 'Online Event',
                    capacity: capacity,
                    registeredCount: 0,
                    price: price,
                    currency: 'KSh',
                    organizer: 'THE SONGA WELFARE',
                    organizerId: currentUser.uid,
                    status: 'upcoming',
                    visibility: 'public',
                    tags: [category],
                    createdAt: new Date().toISOString(),
                    updatedAt: new Date().toISOString(),
                    requirements: [],
                    whatYouLearn: []
                };
                
                await database.ref(`events/${eventId}`).set(eventData);
                showAlert('Event created successfully', 'success');
                closeModal();
                loadEvents();
            } catch (error) {
                console.error('Error creating event:', error);
                showAlert('Failed to create event', 'error');
            }
        }

        // Edit Event
        async function editEvent(eventId) {
            const event = events.find(e => e.id === eventId);
            if (!event) {
                showAlert('Event not found', 'error');
                return;
            }
            
            currentEditId = eventId;
            const eventDate = new Date(event.date);
            const formattedDate = eventDate.toISOString().slice(0, 16);
            
            const modalHTML = `
                <div class="modal" style="max-width: 600px;">
                    <div class="modal-header">
                        <h3 class="modal-title">Edit Event: ${event.title}</h3>
                        <button class="modal-close" onclick="closeModal()">
                            <span class="material-icons-sharp">close</span>
                        </button>
                    </div>
                    <div class="modal-body">
                        <form id="editEventForm">
                            <div class="form-group">
                                <label class="form-label">Event Title</label>
                                <input type="text" class="form-input" id="editEventTitle" value="${event.title || ''}">
                            </div>
                            <div class="form-group">
                                <label class="form-label">Description</label>
                                <textarea class="form-textarea" id="editEventDescription" rows="4">${event.description || ''}</textarea>
                            </div>
                            <div class="form-group">
                                <label class="form-label">Date & Time</label>
                                <input type="datetime-local" class="form-input" id="editEventDate" value="${formattedDate}">
                            </div>
                            <div class="form-grid">
                                <div class="form-group">
                                    <label class="form-label">Type</label>
                                    <select class="form-select" id="editEventType">
                                        <option value="virtual" ${event.type === 'virtual' ? 'selected' : ''}>Virtual</option>
                                        <option value="in-person" ${event.type === 'in-person' ? 'selected' : ''}>In-Person</option>
                                        <option value="hybrid" ${event.type === 'hybrid' ? 'selected' : ''}>Hybrid</option>
                                    </select>
                                </div>
                                <div class="form-group">
                                    <label class="form-label">Status</label>
                                    <select class="form-select" id="editEventStatus">
                                        <option value="upcoming" ${event.status === 'upcoming' ? 'selected' : ''}>Upcoming</option>
                                        <option value="active" ${event.status === 'active' ? 'selected' : ''}>Active</option>
                                        <option value="completed" ${event.status === 'completed' ? 'selected' : ''}>Completed</option>
                                        <option value="cancelled" ${event.status === 'cancelled' ? 'selected' : ''}>Cancelled</option>
                                    </select>
                                </div>
                            </div>
                            <div class="form-grid">
                                <div class="form-group">
                                    <label class="form-label">Location</label>
                                    <input type="text" class="form-input" id="editEventLocation" value="${event.location || ''}">
                                </div>
                                <div class="form-group">
                                    <label class="form-label">Capacity</label>
                                    <input type="number" class="form-input" id="editEventCapacity" value="${event.capacity || 100}">
                                </div>
                            </div>
                        </form>
                    </div>
                    <div class="modal-footer">
                        <button class="btn btn-danger" onclick="deleteEvent('${eventId}')">Delete Event</button>
                        <button class="btn btn-secondary" onclick="closeModal()">Cancel</button>
                        <button class="btn btn-primary" onclick="updateEvent()">Save Changes</button>
                    </div>
                </div>
            `;
            
            showModal(modalHTML);
        }

        // Update Event
        async function updateEvent() {
            if (!currentEditId) return;
            
            const updates = {
                title: document.getElementById('editEventTitle').value,
                description: document.getElementById('editEventDescription').value,
                date: new Date(document.getElementById('editEventDate').value).toISOString(),
                type: document.getElementById('editEventType').value,
                status: document.getElementById('editEventStatus').value,
                location: document.getElementById('editEventLocation').value,
                capacity: parseInt(document.getElementById('editEventCapacity').value),
                updatedAt: new Date().toISOString()
            };
            
            try {
                await database.ref(`events/${currentEditId}`).update(updates);
                showAlert('Event updated successfully', 'success');
                closeModal();
                loadEvents();
            } catch (error) {
                console.error('Error updating event:', error);
                showAlert('Failed to update event', 'error');
            }
        }

        // Delete Event
        async function deleteEvent(eventId) {
            if (!confirm('Are you sure you want to delete this event?')) {
                return;
            }
            
            try {
                await database.ref(`events/${eventId}`).remove();
                showAlert('Event deleted successfully', 'success');
                closeModal();
                loadEvents();
            } catch (error) {
                console.error('Error deleting event:', error);
                showAlert('Failed to delete event', 'error');
            }
        }

        // Load Library
        async function loadLibrary() {
            const template = document.getElementById('libraryTemplate');
            contentContainer.innerHTML = template.innerHTML;
            
            try {
                await fetchBooks();
                renderLibraryTable(books);
                
            } catch (error) {
                console.error('Error loading library:', error);
                showAlert('Failed to load library', 'error');
                document.getElementById('libraryTableBody').innerHTML = `
                    <tr>
                        <td colspan="7" style="text-align: center; color: var(--text-secondary); padding: 2rem;">
                            Failed to load library
                        </td>
                    </tr>
                `;
            }
        }

        // Render Library Table
        function renderLibraryTable(booksList) {
            const tableBody = document.getElementById('libraryTableBody');
            tableBody.innerHTML = '';
            
            if (booksList.length === 0) {
                tableBody.innerHTML = `
                    <tr>
                        <td colspan="7" style="text-align: center; color: var(--text-secondary); padding: 2rem;">
                            No books found
                        </td>
                    </tr>
                `;
                return;
            }
            
            booksList.forEach(book => {
                const availabilityClass = book.availability === 'available' ? 'status-active' : 'status-suspended';
                const availableCopies = book.availableCopies || 0;
                const totalCopies = book.totalCopies || 0;
                
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td>
                        <div style="font-weight: 600;">${book.title || 'Untitled Book'}</div>
                        <div style="font-size: 0.75rem; color: var(--text-secondary);">${book.id.substring(0, 8)}</div>
                    </td>
                    <td>${book.author || 'Unknown'}</td>
                    <td><span class="status-badge">${book.category || 'General'}</span></td>
                    <td>${totalCopies}</td>
                    <td>
                        <span class="status-badge ${availabilityClass}">
                            ${availableCopies} available
                        </span>
                    </td>
                    <td>${book.rating ? book.rating.toFixed(1) + '' : 'N/A'}</td>
                    <td>
                        <div class="action-buttons">
                            <button class="btn-icon edit" onclick="editBook('${book.id}')" title="Edit">
                                <span class="material-icons-sharp">edit</span>
                            </button>
                            <button class="btn-icon delete" onclick="deleteBook('${book.id}')" title="Delete">
                                <span class="material-icons-sharp">delete</span>
                            </button>
                        </div>
                    </td>
                `;
                tableBody.appendChild(row);
            });
        }

        // Filter Books
        function filterBooks() {
            const filter = document.getElementById('bookFilter').value;
            let filteredBooks = [];
            
            switch(filter) {
                case 'available':
                    filteredBooks = books.filter(b => b.availability === 'available');
                    break;
                case 'borrowed':
                    filteredBooks = books.filter(b => b.availability === 'borrowed');
                    break;
                case 'featured':
                    filteredBooks = books.filter(b => b.featured === true);
                    break;
                default:
                    filteredBooks = books;
            }
            
            renderLibraryTable(filteredBooks);
        }

        // Show Add Book Modal
        function showAddBookModal() {
            const modalHTML = `
                <div class="modal" style="max-width: 600px;">
                    <div class="modal-header">
                        <h3 class="modal-title">Add New Book</h3>
                        <button class="modal-close" onclick="closeModal()">
                            <span class="material-icons-sharp">close</span>
                        </button>
                    </div>
                    <div class="modal-body">
                        <form id="addBookForm">
                            <div class="form-group">
                                <label class="form-label">Book Title *</label>
                                <input type="text" class="form-input" id="bookTitle" required>
                            </div>
                            <div class="form-group">
                                <label class="form-label">Author *</label>
                                <input type="text" class="form-input" id="bookAuthor" required>
                            </div>
                            <div class="form-group">
                                <label class="form-label">Description</label>
                                <textarea class="form-textarea" id="bookDescription" rows="3"></textarea>
                            </div>
                            <div class="form-grid">
                                <div class="form-group">
                                    <label class="form-label">Category *</label>
                                    <select class="form-select" id="bookCategory" required>
                                        <option value="Personal Growth">Personal Growth</option>
                                        <option value="Business">Business</option>
                                        <option value="Finance">Finance</option>
                                        <option value="Spirituality">Spirituality</option>
                                        <option value="Health">Health</option>
                                        <option value="Fiction">Fiction</option>
                                        <option value="Non-Fiction">Non-Fiction</option>
                                    </select>
                                </div>
                                <div class="form-group">
                                    <label class="form-label">ISBN</label>
                                    <input type="text" class="form-input" id="bookISBN" placeholder="Optional">
                                </div>
                            </div>
                            <div class="form-grid">
                                <div class="form-group">
                                    <label class="form-label">Total Copies *</label>
                                    <input type="number" class="form-input" id="bookTotalCopies" value="1" min="1" required>
                                </div>
                                <div class="form-group">
                                    <label class="form-label">Available Copies *</label>
                                    <input type="number" class="form-input" id="bookAvailableCopies" value="1" min="0" required>
                                </div>
                            </div>
                            <div class="form-grid">
                                <div class="form-group">
                                    <label class="form-label">Publisher</label>
                                    <input type="text" class="form-input" id="bookPublisher">
                                </div>
                                <div class="form-group">
                                    <label class="form-label">Published Year</label>
                                    <input type="number" class="form-input" id="bookPublishedYear" min="1900" max="${new Date().getFullYear()}">
                                </div>
                            </div>
                            <div class="form-group">
                                <label class="form-label">Tags (comma-separated)</label>
                                <input type="text" class="form-input" id="bookTags" placeholder="self-help, productivity, habits">
                            </div>
                            <div class="form-group">
                                <label class="form-label">
                                    <input type="checkbox" id="bookFeatured"> Feature this book
                                </label>
                            </div>
                        </form>
                    </div>
                    <div class="modal-footer">
                        <button class="btn btn-secondary" onclick="closeModal()">Cancel</button>
                        <button class="btn btn-primary" onclick="createBook()">Add Book</button>
                    </div>
                </div>
            `;
            
            showModal(modalHTML);
        }

        // Create Book
        async function createBook() {
            const title = document.getElementById('bookTitle').value;
            const author = document.getElementById('bookAuthor').value;
            const description = document.getElementById('bookDescription').value;
            const category = document.getElementById('bookCategory').value;
            const isbn = document.getElementById('bookISBN').value;
            const totalCopies = parseInt(document.getElementById('bookTotalCopies').value);
            const availableCopies = parseInt(document.getElementById('bookAvailableCopies').value);
            const publisher = document.getElementById('bookPublisher').value;
            const publishedYear = document.getElementById('bookPublishedYear').value;
            const tags = document.getElementById('bookTags').value;
            const featured = document.getElementById('bookFeatured').checked;
            
            if (!title || !author || !category) {
                showAlert('Please fill in all required fields', 'error');
                return;
            }
            
            if (availableCopies > totalCopies) {
                showAlert('Available copies cannot exceed total copies', 'error');
                return;
            }
            
            try {
                const bookId = `book_${Date.now()}`;
                const bookData = {
                    id: bookId,
                    title: title,
                    author: author,
                    description: description || `${title} by ${author}`,
                    category: category,
                    isbn: isbn || '',
                    totalCopies: totalCopies,
                    availableCopies: availableCopies,
                    availability: availableCopies > 0 ? 'available' : 'borrowed',
                    publisher: publisher || '',
                    publishedYear: publishedYear || new Date().getFullYear(),
                    tags: tags ? tags.split(',').map(t => t.trim()) : [],
                    featured: featured,
                    rating: 0,
                    borrowCount: 0,
                    addedDate: new Date().toISOString(),
                    updatedDate: new Date().toISOString(),
                    subscriptionTiers: ['explorer', 'scholar', 'visionary'],
                    language: 'English',
                    format: 'Paperback',
                    borrowDuration: 14
                };
                
                await database.ref(`libraryBooks/${bookId}`).set(bookData);
                showAlert('Book added successfully', 'success');
                closeModal();
                loadLibrary();
            } catch (error) {
                console.error('Error creating book:', error);
                showAlert('Failed to add book', 'error');
            }
        }

        // Edit Book
        async function editBook(bookId) {
            const book = books.find(b => b.id === bookId);
            if (!book) {
                showAlert('Book not found', 'error');
                return;
            }
            
            currentEditId = bookId;
            
            const modalHTML = `
                <div class="modal" style="max-width: 600px;">
                    <div class="modal-header">
                        <h3 class="modal-title">Edit Book: ${book.title}</h3>
                        <button class="modal-close" onclick="closeModal()">
                            <span class="material-icons-sharp">close</span>
                        </button>
                    </div>
                    <div class="modal-body">
                        <form id="editBookForm">
                            <div class="form-group">
                                <label class="form-label">Book Title</label>
                                <input type="text" class="form-input" id="editBookTitle" value="${book.title || ''}">
                            </div>
                            <div class="form-group">
                                <label class="form-label">Author</label>
                                <input type="text" class="form-input" id="editBookAuthor" value="${book.author || ''}">
                            </div>
                            <div class="form-grid">
                                <div class="form-group">
                                    <label class="form-label">Total Copies</label>
                                    <input type="number" class="form-input" id="editBookTotalCopies" value="${book.totalCopies || 1}" min="1">
                                </div>
                                <div class="form-group">
                                    <label class="form-label">Available Copies</label>
                                    <input type="number" class="form-input" id="editBookAvailableCopies" value="${book.availableCopies || 0}" min="0">
                                </div>
                            </div>
                            <div class="form-group">
                                <label class="form-label">Category</label>
                                <select class="form-select" id="editBookCategory">
                                    <option value="Personal Growth" ${book.category === 'Personal Growth' ? 'selected' : ''}>Personal Growth</option>
                                    <option value="Business" ${book.category === 'Business' ? 'selected' : ''}>Business</option>
                                    <option value="Finance" ${book.category === 'Finance' ? 'selected' : ''}>Finance</option>
                                    <option value="Spirituality" ${book.category === 'Spirituality' ? 'selected' : ''}>Spirituality</option>
                                    <option value="Health" ${book.category === 'Health' ? 'selected' : ''}>Health</option>
                                    <option value="Fiction" ${book.category === 'Fiction' ? 'selected' : ''}>Fiction</option>
                                    <option value="Non-Fiction" ${book.category === 'Non-Fiction' ? 'selected' : ''}>Non-Fiction</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label class="form-label">
                                    <input type="checkbox" id="editBookFeatured" ${book.featured ? 'checked' : ''}> Feature this book
                                </label>
                            </div>
                        </form>
                    </div>
                    <div class="modal-footer">
                        <button class="btn btn-danger" onclick="deleteBook('${bookId}')">Delete Book</button>
                        <button class="btn btn-secondary" onclick="closeModal()">Cancel</button>
                        <button class="btn btn-primary" onclick="updateBook()">Save Changes</button>
                    </div>
                </div>
            `;
            
            showModal(modalHTML);
        }

        // Update Book
        async function updateBook() {
            if (!currentEditId) return;
            
            const totalCopies = parseInt(document.getElementById('editBookTotalCopies').value);
            const availableCopies = parseInt(document.getElementById('editBookAvailableCopies').value);
            
            if (availableCopies > totalCopies) {
                showAlert('Available copies cannot exceed total copies', 'error');
                return;
            }
            
            const updates = {
                title: document.getElementById('editBookTitle').value,
                author: document.getElementById('editBookAuthor').value,
                totalCopies: totalCopies,
                availableCopies: availableCopies,
                availability: availableCopies > 0 ? 'available' : 'borrowed',
                category: document.getElementById('editBookCategory').value,
                featured: document.getElementById('editBookFeatured').checked,
                updatedDate: new Date().toISOString()
            };
            
            try {
                await database.ref(`libraryBooks/${currentEditId}`).update(updates);
                showAlert('Book updated successfully', 'success');
                closeModal();
                loadLibrary();
            } catch (error) {
                console.error('Error updating book:', error);
                showAlert('Failed to update book', 'error');
            }
        }

        // Delete Book
        async function deleteBook(bookId) {
            if (!confirm('Are you sure you want to delete this book?')) {
                return;
            }
            
            try {
                await database.ref(`libraryBooks/${bookId}`).remove();
                showAlert('Book deleted successfully', 'success');
                closeModal();
                loadLibrary();
            } catch (error) {
                console.error('Error deleting book:', error);
                showAlert('Failed to delete book', 'error');
            }
        }

        // Load Analytics
        async function loadAnalytics() {
            const template = document.getElementById('analyticsTemplate');
            contentContainer.innerHTML = template.innerHTML;
            
            try {
                await loadAnalyticsData();
                
            } catch (error) {
                console.error('Error loading analytics:', error);
                showAlert('Failed to load analytics', 'error');
            }
        }

        // Load Analytics Data
        async function loadAnalyticsData() {
            // Generate sample analytics data
            const period = parseInt(document.getElementById('analyticsPeriod')?.value || 30);
            
            // Update stats
            document.getElementById('dauCount').textContent = Math.floor(Math.random() * 50) + 20;
            document.getElementById('engagementRate').textContent = `${Math.floor(Math.random() * 30) + 20}%`;
            document.getElementById('sessionDuration').textContent = `${Math.floor(Math.random() * 10) + 5}m`;
            document.getElementById('bounceRate').textContent = `${Math.floor(Math.random() * 20) + 10}%`;
            
            // Initialize charts
            initTrafficChart(period);
            initPerformanceChart();
            
            // Load top content
            loadTopContent();
        }

        // Initialize Traffic Chart
        function initTrafficChart(period) {
            const ctx = document.getElementById('trafficChart').getContext('2d');
            
            if (trafficChart) {
                trafficChart.destroy();
            }
            
            // Generate sample data
            const labels = [];
            const sessions = [];
            const pageviews = [];
            const today = new Date();
            
            for (let i = period - 1; i >= 0; i--) {
                const date = new Date(today);
                date.setDate(date.getDate() - i);
                
                if (period === 7) {
                    labels.push(date.toLocaleDateString('en-US', { weekday: 'short' }));
                } else if (period === 30) {
                    labels.push(date.toLocaleDateString('en-US', { month: 'short', day: 'numeric' }));
                } else {
                    labels.push(date.toLocaleDateString('en-US', { month: 'short' }));
                }
                
                sessions.push(Math.floor(Math.random() * 100) + 50);
                pageviews.push(Math.floor(Math.random() * 300) + 150);
            }
            
            trafficChart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: labels,
                    datasets: [
                        {
                            label: 'Sessions',
                            data: sessions,
                            borderColor: 'rgb(212, 175, 55)',
                            backgroundColor: 'rgba(212, 175, 55, 0.1)',
                            fill: true,
                            tension: 0.4
                        },
                        {
                            label: 'Pageviews',
                            data: pageviews,
                            borderColor: 'rgb(59, 130, 246)',
                            backgroundColor: 'rgba(59, 130, 246, 0.1)',
                            fill: true,
                            tension: 0.4
                        }
                    ]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            position: 'top',
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            grid: {
                                drawBorder: false
                            }
                        },
                        x: {
                            grid: {
                                display: false
                            }
                        }
                    }
                }
            });
        }

        // Initialize Performance Chart
        function initPerformanceChart() {
            const ctx = document.getElementById('performanceChart').getContext('2d');
            
            if (performanceChart) {
                performanceChart.destroy();
            }
            
            // Generate sample data by content type
            const contentTypes = ['Posts', 'Events', 'Books', 'Articles'];
            const engagementData = contentTypes.map(() => Math.floor(Math.random() * 100) + 20);
            const conversionData = contentTypes.map(() => Math.floor(Math.random() * 30) + 5);
            
            performanceChart = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: contentTypes,
                    datasets: [
                        {
                            label: 'Engagement Rate (%)',
                            data: engagementData,
                            backgroundColor: 'rgba(212, 175, 55, 0.7)',
                            borderColor: 'rgb(212, 175, 55)',
                            borderWidth: 1
                        },
                        {
                            label: 'Conversion Rate (%)',
                            data: conversionData,
                            backgroundColor: 'rgba(59, 130, 246, 0.7)',
                            borderColor: 'rgb(59, 130, 246)',
                            borderWidth: 1
                        }
                    ]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            position: 'top',
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            grid: {
                                drawBorder: false
                            },
                            ticks: {
                                callback: function(value) {
                                    return value + '%';
                                }
                            }
                        },
                        x: {
                            grid: {
                                display: false
                            }
                        }
                    }
                }
            });
        }

        // Load Top Content
        function loadTopContent() {
            const tableBody = document.getElementById('topContentBody');
            tableBody.innerHTML = '';
            
            // Get top posts by engagement
            const topPosts = [...posts]
                .sort((a, b) => (b.likes || 0) + (b.comments || 0) + (b.shares || 0) - 
                               (a.likes || 0) + (a.comments || 0) + (a.shares || 0))
                .slice(0, 5);
            
            topPosts.forEach(post => {
                const engagement = (post.likes || 0) + (post.comments || 0) + (post.shares || 0);
                
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td>
                        <div style="font-weight: 600;">${post.title || 'Untitled'}</div>
                        <div style="font-size: 0.75rem; color: var(--text-secondary);">${post.category || 'post'}</div>
                    </td>
                    <td><span class="status-badge">Post</span></td>
                    <td>${engagement}</td>
                    <td>${post.views || 0}</td>
                    <td>${post.likes || 0}</td>
                    <td>${post.comments || 0}</td>
                    <td>${post.shares || 0}</td>
                `;
                tableBody.appendChild(row);
            });
        }

        // Load Settings
        async function loadSettings() {
            const template = document.getElementById('settingsTemplate');
            contentContainer.innerHTML = template.innerHTML;
            
            try {
                // Load current settings
                const settingsSnapshot = await database.ref('systemSettings').once('value');
                const settings = settingsSnapshot.exists() ? settingsSnapshot.val() : {};
                
                // Populate form with current settings
                if (settings.general) {
                    document.getElementById('siteName').value = settings.general.siteName || 'THE SONGA WELFARE';
                    document.getElementById('contactEmail').value = settings.general.contactEmail || 'info@thesongawelfare.com';
                    document.getElementById('contactPhone').value = settings.general.contactPhone || '+254727211191';
                    document.getElementById('whatsappNumber').value = settings.general.whatsappNumber || '254727211191';
                    document.getElementById('siteDescription').value = settings.general.siteDescription || 'UNBOUND | UNBENT | UNBROKEN - Community for personal growth and empowerment';
                }
                
                if (settings.posts) {
                    document.getElementById('allowComments').value = settings.posts.allowComments !== false ? 'true' : 'false';
                    document.getElementById('allowSharing').value = settings.posts.allowSharing !== false ? 'true' : 'false';
                    document.getElementById('autoApprovePosts').value = settings.posts.autoApprovePosts ? 'true' : 'false';
                    document.getElementById('maxImageSize').value = settings.posts.maxImageSize || 5;
                }
                
                if (settings.library) {
                    document.getElementById('borrowDuration').value = settings.library.defaultBorrowDuration || 14;
                    document.getElementById('maxRenewals').value = settings.library.maxRenewals || 2;
                    document.getElementById('dailyFine').value = settings.library.dailyFine || 50;
                    document.getElementById('maxBooksPerUser').value = settings.library.maxBooksPerUser || 5;
                }
                
            } catch (error) {
                console.error('Error loading settings:', error);
                showAlert('Failed to load settings', 'error');
            }
        }

        // Show Settings Tab
        function showSettingsTab(tabId) {
            // Hide all tab contents
            document.querySelectorAll('.tab-content').forEach(content => {
                content.classList.remove('active');
            });
            
            // Show selected tab content
            document.getElementById(tabId + 'Settings').classList.add('active');
            
            // Update tab active state
            document.querySelectorAll('#settingsTabs .tab').forEach(tab => {
                tab.classList.remove('active');
            });
            event.target.classList.add('active');
        }

        // Save Settings
        async function saveSettings() {
            const settings = {
                general: {
                    siteName: document.getElementById('siteName').value,
                    contactEmail: document.getElementById('contactEmail').value,
                    contactPhone: document.getElementById('contactPhone').value,
                    whatsappNumber: document.getElementById('whatsappNumber').value,
                    siteDescription: document.getElementById('siteDescription').value,
                    primaryColor: '#D4AF37',
                    secondaryColor: '#000000'
                },
                posts: {
                    allowComments: document.getElementById('allowComments').value === 'true',
                    allowSharing: document.getElementById('allowSharing').value === 'true',
                    autoApprovePosts: document.getElementById('autoApprovePosts').value === 'true',
                    maxImageSize: parseInt(document.getElementById('maxImageSize').value),
                    defaultVisibility: 'public',
                    postCategories: ['announcement', 'event', 'discussion', 'resource', 'motivation', 'community']
                },
                library: {
                    defaultBorrowDuration: parseInt(document.getElementById('borrowDuration').value),
                    maxRenewals: parseInt(document.getElementById('maxRenewals').value),
                    dailyFine: parseInt(document.getElementById('dailyFine').value),
                    maxBooksPerUser: parseInt(document.getElementById('maxBooksPerUser').value),
                    reservationDuration: 48
                },
                events: {
                    registrationOpenDays: 30,
                    maxCapacity: 100,
                    allowWaitlist: true
                }
            };
            
            try {
                await database.ref('systemSettings').set(settings);
                showAlert('Settings saved successfully', 'success');
            } catch (error) {
                console.error('Error saving settings:', error);
                showAlert('Failed to save settings', 'error');
            }
        }

        // Reset Settings
        function resetSettings() {
            if (confirm('Are you sure you want to reset all settings to default?')) {
                loadSettings();
                showAlert('Settings reset to default', 'warning');
            }
        }

        // Load Backup
        async function loadBackup() {
            const template = document.getElementById('backupTemplate');
            contentContainer.innerHTML = template.innerHTML;
            
            try {
                // Load backup data
                await loadBackupsList();
                
            } catch (error) {
                console.error('Error loading backup:', error);
                showAlert('Failed to load backup data', 'error');
            }
        }

        // Load Backups List
        async function loadBackupsList() {
            const tableBody = document.getElementById('backupsTableBody');
            tableBody.innerHTML = '';
            
            try {
                // In a real app, you would fetch backups from storage
                // For demo, show sample backups
                const sampleBackups = [
                    {
                        date: '2024-03-20',
                        size: '2.4 MB',
                        type: 'Full',
                        status: 'completed'
                    },
                    {
                        date: '2024-03-19',
                        size: '1.8 MB',
                        type: 'Incremental',
                        status: 'completed'
                    },
                    {
                        date: '2024-03-18',
                        size: '2.5 MB',
                        type: 'Full',
                        status: 'completed'
                    }
                ];
                
                sampleBackups.forEach(backup => {
                    const row = document.createElement('tr');
                    row.innerHTML = `
                        <td>${formatDate(backup.date)}</td>
                        <td>${backup.size}</td>
                        <td><span class="status-badge">${backup.type}</span></td>
                        <td><span class="status-badge status-active">${backup.status}</span></td>
                        <td>
                            <div class="action-buttons">
                                <button class="btn-icon" onclick="downloadBackup('${backup.date}')" title="Download">
                                    <span class="material-icons-sharp">download</span>
                                </button>
                                <button class="btn-icon delete" onclick="deleteBackup('${backup.date}')" title="Delete">
                                    <span class="material-icons-sharp">delete</span>
                                </button>
                            </div>
                        </td>
                    `;
                    tableBody.appendChild(row);
                });
                
            } catch (error) {
                tableBody.innerHTML = `
                    <tr>
                        <td colspan="5" style="text-align: center; color: var(--text-secondary); padding: 2rem;">
                            No backups available
                        </td>
                    </tr>
                `;
            }
        }

        // Create Backup
        async function createBackup() {
            try {
                showAlert('Creating backup...', 'info');
                
                // In a real app, you would create a backup of the database
                // For demo, simulate backup creation
                setTimeout(() => {
                    showAlert('Backup created successfully', 'success');
                    loadBackupsList();
                }, 2000);
                
            } catch (error) {
                console.error('Error creating backup:', error);
                showAlert('Failed to create backup', 'error');
            }
        }

        // Show Restore Modal
        function showRestoreModal() {
            const modalHTML = `
                <div class="modal" style="max-width: 500px;">
                    <div class="modal-header">
                        <h3 class="modal-title">Restore Backup</h3>
                        <button class="modal-close" onclick="closeModal()">
                            <span class="material-icons-sharp">close</span>
                        </button>
                    </div>
                    <div class="modal-body">
                        <div class="alert alert-warning">
                            <span class="material-icons-sharp" style="vertical-align: middle; margin-right: 0.5rem;">warning</span>
                            Restoring a backup will overwrite current data. This action cannot be undone.
                        </div>
                        <div class="form-group">
                            <label class="form-label">Select Backup File</label>
                            <input type="file" class="form-input" id="backupFile" accept=".json,.backup">
                            <small style="color: var(--text-secondary); display: block; margin-top: 0.25rem;">
                                Select a JSON backup file to restore
                            </small>
                        </div>
                    </div>
                    <div class="modal-footer">
                        <button class="btn btn-secondary" onclick="closeModal()">Cancel</button>
                        <button class="btn btn-primary" onclick="restoreBackup()">Restore Backup</button>
                    </div>
                </div>
            `;
            
            showModal(modalHTML);
        }

        // Restore Backup
        async function restoreBackup() {
            const fileInput = document.getElementById('backupFile');
            
            if (!fileInput.files.length) {
                showAlert('Please select a backup file', 'error');
                return;
            }
            
            if (!confirm('WARNING: This will overwrite all current data. Are you sure you want to continue?')) {
                return;
            }
            
            try {
                showAlert('Restoring backup...', 'info');
                
                // In a real app, you would restore from the backup file
                // For demo, simulate restoration
                setTimeout(() => {
                    showAlert('Backup restored successfully', 'success');
                    closeModal();
                }, 3000);
                
            } catch (error) {
                console.error('Error restoring backup:', error);
                showAlert('Failed to restore backup', 'error');
            }
        }

        // Show Cleanup Modal
        function showCleanupModal() {
            const modalHTML = `
                <div class="modal" style="max-width: 500px;">
                    <div class="modal-header">
                        <h3 class="modal-title">Cleanup Old Data</h3>
                        <button class="modal-close" onclick="closeModal()">
                            <span class="material-icons-sharp">close</span>
                        </button>
                    </div>
                    <div class="modal-body">
                        <div class="alert alert-warning">
                            <span class="material-icons-sharp" style="vertical-align: middle; margin-right: 0.5rem;">warning</span>
                            This will permanently delete old data. This action cannot be undone.
                        </div>
                        <div class="form-group">
                            <label class="form-label">Delete data older than:</label>
                            <select class="form-select" id="cleanupDays">
                                <option value="30">30 days</option>
                                <option value="90">90 days</option>
                                <option value="180">6 months</option>
                                <option value="365">1 year</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label class="form-label">Data types to cleanup:</label>
                            <div style="margin-top: 0.5rem;">
                                <label style="display: block; margin-bottom: 0.5rem;">
                                    <input type="checkbox" id="cleanupLogs" checked> System logs
                                </label>
                                <label style="display: block; margin-bottom: 0.5rem;">
                                    <input type="checkbox" id="cleanupBackups"> Old backups
                                </label>
                                <label style="display: block;">
                                    <input type="checkbox" id="cleanupTemp"> Temporary files
                                </label>
                            </div>
                        </div>
                    </div>
                    <div class="modal-footer">
                        <button class="btn btn-secondary" onclick="closeModal()">Cancel</button>
                        <button class="btn btn-danger" onclick="performCleanup()">Cleanup Data</button>
                    </div>
                </div>
            `;
            
            showModal(modalHTML);
        }

        // Perform Cleanup
        async function performCleanup() {
            if (!confirm('This will permanently delete old data. Are you sure?')) {
                return;
            }
            
            try {
                showAlert('Cleaning up old data...', 'info');
                
                // In a real app, you would delete old data
                // For demo, simulate cleanup
                setTimeout(() => {
                    showAlert('Cleanup completed successfully', 'success');
                    closeModal();
                }, 2000);
                
            } catch (error) {
                console.error('Error during cleanup:', error);
                showAlert('Failed to cleanup data', 'error');
            }
        }

        // Download Backup
        function downloadBackup(backupDate) {
            // In a real app, you would download the backup file
            showAlert(`Downloading backup from ${backupDate}...`, 'info');
        }

        // Delete Backup
        function deleteBackup(backupDate) {
            if (confirm(`Delete backup from ${backupDate}?`)) {
                showAlert(`Backup from ${backupDate} deleted`, 'success');
                loadBackupsList();
            }
        }

        // Load Logs
        async function loadLogs() {
            const template = document.getElementById('logsTemplate');
            contentContainer.innerHTML = template.innerHTML;
            
            try {
                await fetchLogs();
                renderLogsTable(logs);
                
            } catch (error) {
                console.error('Error loading logs:', error);
                showAlert('Failed to load logs', 'error');
            }
        }

        // Fetch Logs
        async function fetchLogs() {
            try {
                // In a real app, you would fetch logs from database
                // For demo, generate sample logs
                logs = generateSampleLogs();
                return logs;
            } catch (error) {
                console.error('Error fetching logs:', error);
                return [];
            }
        }

        // Generate Sample Logs
        function generateSampleLogs() {
            const logLevels = ['info', 'warning', 'error'];
            const modules = ['auth', 'database', 'posts', 'events', 'library', 'system'];
            const messages = [
                'User login successful',
                'Database query executed',
                'New post created',
                'Event registration completed',
                'Book borrowed',
                'System backup completed',
                'Error processing request',
                'User account updated',
                'Email notification sent',
                'API request received'
            ];
            
            const sampleLogs = [];
            const now = new Date();
            
            for (let i = 0; i < 50; i++) {
                const logDate = new Date(now);
                logDate.setMinutes(logDate.getMinutes() - Math.floor(Math.random() * 1440)); // Up to 24 hours ago
                
                const level = logLevels[Math.floor(Math.random() * logLevels.length)];
                const module = modules[Math.floor(Math.random() * modules.length)];
                const message = messages[Math.floor(Math.random() * messages.length)];
                const user = Math.random() > 0.7 ? 'admin_001' : 
                            Math.random() > 0.5 ? 'user_001' : 'system';
                
                sampleLogs.push({
                    id: `log_${i}`,
                    timestamp: logDate.toISOString(),
                    level: level,
                    module: module,
                    message: message,
                    user: user
                });
            }
            
            // Sort by timestamp (newest first)
            return sampleLogs.sort((a, b) => new Date(b.timestamp) - new Date(a.timestamp));
        }

        // Render Logs Table
        function renderLogsTable(logsList) {
            const tableBody = document.getElementById('logsTableBody');
            tableBody.innerHTML = '';
            
            if (logsList.length === 0) {
                tableBody.innerHTML = `
                    <tr>
                        <td colspan="5" style="text-align: center; color: var(--text-secondary); padding: 2rem;">
                            No logs found
                        </td>
                    </tr>
                `;
                return;
            }
            
            logsList.forEach(log => {
                const levelClass = `status-${log.level === 'error' ? 'suspended' : 
                                  log.level === 'warning' ? 'pending' : 'active'}`;
                
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td>${formatDate(log.timestamp)}</td>
                    <td><span class="status-badge ${levelClass}">${log.level.toUpperCase()}</span></td>
                    <td>${log.module}</td>
                    <td>${log.message}</td>
                    <td>${log.user}</td>
                `;
                tableBody.appendChild(row);
            });
        }

        // Filter Logs
        function filterLogs() {
            const level = document.getElementById('logLevel').value;
            let filteredLogs = [];
            
            if (level === 'all') {
                filteredLogs = logs;
            } else {
                filteredLogs = logs.filter(log => log.level === level);
            }
            
            renderLogsTable(filteredLogs);
        }

        // Clear Logs
        async function clearLogs() {
            if (!confirm('Are you sure you want to clear all logs? This action cannot be undone.')) {
                return;
            }
            
            try {
                // In a real app, you would clear logs from database
                logs = [];
                renderLogsTable(logs);
                showAlert('Logs cleared successfully', 'success');
            } catch (error) {
                console.error('Error clearing logs:', error);
                showAlert('Failed to clear logs', 'error');
            }
        }

        // Export Logs
        function exportLogs() {
            const dataStr = JSON.stringify(logs, null, 2);
            const dataUri = 'data:application/json;charset=utf-8,'+ encodeURIComponent(dataStr);
            
            const exportFileDefaultName = `the_songa_logs_${new Date().toISOString().split('T')[0]}.json`;
            
            const linkElement = document.createElement('a');
            linkElement.setAttribute('href', dataUri);
            linkElement.setAttribute('download', exportFileDefaultName);
            linkElement.click();
            
            showAlert('Logs exported successfully', 'success');
        }

        // Show Modal
        function showModal(content) {
            modalOverlay.innerHTML = content;
            modalOverlay.classList.add('active');
            document.body.style.overflow = 'hidden';
        }

        // Close Modal
        function closeModal() {
            modalOverlay.classList.remove('active');
            modalOverlay.innerHTML = '';
            document.body.style.overflow = '';
            currentEditId = null;
        }

        // Show Alert
        function showAlert(message, type = 'info') {
            const alert = document.createElement('div');
            alert.className = `alert alert-${type}`;
            alert.innerHTML = `
                <span class="material-icons-sharp" style="vertical-align: middle; margin-right: 0.5rem;">
                    ${type === 'success' ? 'check_circle' : type === 'error' ? 'error' : 'info'}
                </span>
                ${message}
            `;
            
            alertContainer.appendChild(alert);
            
            // Auto-remove after 5 seconds
            setTimeout(() => {
                alert.remove();
            }, 5000);
        }

        // Format Date
        function formatDate(dateString) {
            try {
                const date = new Date(dateString);
                const now = new Date();
                const diffMs = now - date;
                const diffMins = Math.floor(diffMs / 60000);
                const diffHours = Math.floor(diffMs / 3600000);
                const diffDays = Math.floor(diffMs / 86400000);
                
                if (diffMins < 1) {
                    return 'Just now';
                } else if (diffMins < 60) {
                    return `${diffMins}m ago`;
                } else if (diffHours < 24) {
                    return `${diffHours}h ago`;
                } else if (diffDays < 7) {
                    return `${diffDays}d ago`;
                } else {
                    return date.toLocaleDateString('en-US', {
                        year: 'numeric',
                        month: 'short',
                        day: 'numeric',
                        hour: '2-digit',
                        minute: '2-digit'
                    });
                }
            } catch (error) {
                return dateString || 'N/A';
            }
        }

        // Debounce Function
        function debounce(func, wait) {
            let timeout;
            return function executedFunction(...args) {
                const later = () => {
                    clearTimeout(timeout);
                    func(...args);
                };
                clearTimeout(timeout);
                timeout = setTimeout(later, wait);
            };
        }

        // Search Data
        function searchData(query) {
            if (!query.trim()) {
                // If search is empty, show all data
                switch(currentSection) {
                    case 'users':
                        renderUsersTable(users);
                        break;
                    case 'posts':
                        renderPostsTable(posts);
                        break;
                    case 'events':
                        renderEventsTable(events);
                        break;
                    case 'library':
                        renderLibraryTable(books);
                        break;
                }
                return;
            }
            
            switch(currentSection) {
                case 'users':
                    const filteredUsers = users.filter(user => 
                        user.firstName?.toLowerCase().includes(query) ||
                        user.lastName?.toLowerCase().includes(query) ||
                        user.email?.toLowerCase().includes(query) ||
                        user.membershipTier?.toLowerCase().includes(query) ||
                        user.membershipStatus?.toLowerCase().includes(query)
                    );
                    renderUsersTable(filteredUsers);
                    break;
                    
                case 'posts':
                    const filteredPosts = posts.filter(post =>
                        post.title?.toLowerCase().includes(query) ||
                        post.authorName?.toLowerCase().includes(query) ||
                        post.category?.toLowerCase().includes(query) ||
                        (post.tags && post.tags.some(tag => tag.toLowerCase().includes(query))) ||
                        post.status?.toLowerCase().includes(query)
                    );
                    renderPostsTable(filteredPosts);
                    break;
                    
                case 'events':
                    const filteredEvents = events.filter(event =>
                        event.title?.toLowerCase().includes(query) ||
                        event.location?.toLowerCase().includes(query) ||
                        event.category?.toLowerCase().includes(query) ||
                        event.type?.toLowerCase().includes(query) ||
                        event.status?.toLowerCase().includes(query)
                    );
                    renderEventsTable(filteredEvents);
                    break;
                    
                case 'library':
                    const filteredBooks = books.filter(book =>
                        book.title?.toLowerCase().includes(query) ||
                        book.author?.toLowerCase().includes(query) ||
                        book.category?.toLowerCase().includes(query) ||
                        (book.tags && book.tags.some(tag => tag.toLowerCase().includes(query)))
                    );
                    renderLibraryTable(filteredBooks);
                    break;
            }
        }

        // Start Real-time Updates
        function startRealtimeUpdates() {
            // Listen for user changes
            database.ref('users').on('value', (snapshot) => {
                if (snapshot.exists()) {
                    users = Object.entries(snapshot.val()).map(([id, data]) => ({ id, ...data }));
                    
                    // Update UI if on users section
                    if (currentSection === 'users') {
                        renderUsersTable(users);
                    }
                    
                    // Update dashboard stats if on dashboard
                    if (currentSection === 'dashboard') {
                        updateDashboardStats();
                        refreshMembershipChart();
                    }
                }
            });
            
            // Listen for post changes
            database.ref('communityPosts').on('value', (snapshot) => {
                if (snapshot.exists()) {
                    posts = Object.entries(snapshot.val()).map(([id, data]) => ({ id, ...data }));
                    
                    // Update UI if on posts section
                    if (currentSection === 'posts') {
                        renderPostsTable(posts);
                    }
                    
                    // Update dashboard stats if on dashboard
                    if (currentSection === 'dashboard') {
                        updateDashboardStats();
                    }
                    
                    // Update analytics if on analytics section
                    if (currentSection === 'analytics') {
                        loadTopContent();
                    }
                }
            });
            
            // Listen for event changes
            database.ref('events').on('value', (snapshot) => {
                if (snapshot.exists()) {
                    events = Object.entries(snapshot.val()).map(([id, data]) => ({ id, ...data }));
                    
                    // Update UI if on events section
                    if (currentSection === 'events') {
                        renderEventsTable(events);
                    }
                    
                    // Update dashboard stats if on dashboard
                    if (currentSection === 'dashboard') {
                        updateDashboardStats();
                    }
                }
            });
            
            // Listen for book changes
            database.ref('libraryBooks').on('value', (snapshot) => {
                if (snapshot.exists()) {
                    books = Object.entries(snapshot.val()).map(([id, data]) => ({ id, ...data }));
                    
                    // Update UI if on library section
                    if (currentSection === 'library') {
                        renderLibraryTable(books);
                    }
                    
                    // Update dashboard stats if on dashboard
                    if (currentSection === 'dashboard') {
                        updateDashboardStats();
                    }
                }
            });
            
            // Log connection status
            database.ref('.info/connected').on('value', (snapshot) => {
                if (snapshot.val() === true) {
                    console.log('Realtime database connection active');
                } else {
                    console.log('Realtime database connection lost');
                    showAlert('Database connection lost. Attempting to reconnect...', 'warning');
                }
            });
        }

        // Initialize Admin Panel
        document.addEventListener('DOMContentLoaded', initializeAdminPanel);
    </script>
</body>
</html>
