<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>THE SONGA - Admin Panel</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <!-- Import Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-database-compat.js"></script>
    <style>
        :root {
            --primary-color: #D4AF37;
            --primary-dark: #B8941F;
            --secondary-color: #1a1a1a;
            --light-bg: #f8f9fa;
            --dark-bg: #121212;
            --sidebar-bg: #1e1e1e;
            --card-bg: #ffffff;
            --border-color: #e0e0e0;
            --text-primary: #333333;
            --text-secondary: #666666;
            --success-color: #10b981;
            --warning-color: #f59e0b;
            --danger-color: #ef4444;
            --info-color: #3b82f6;
        }

        .dark-mode {
            --light-bg: #121212;
            --card-bg: #1e1e1e;
            --border-color: #333333;
            --text-primary: #f0f0f0;
            --text-secondary: #a0a0a0;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Inter', sans-serif;
        }

        body {
            background-color: var(--light-bg);
            color: var(--text-primary);
            transition: background-color 0.3s, color 0.3s;
        }

        .admin-container {
            display: flex;
            min-height: 100vh;
        }

        /* Sidebar Styles */
        .sidebar {
            width: 260px;
            background-color: var(--sidebar-bg);
            color: white;
            padding: 20px 0;
            display: flex;
            flex-direction: column;
            position: fixed;
            height: 100vh;
            z-index: 100;
            box-shadow: 2px 0 10px rgba(0,0,0,0.1);
        }

        .logo-section {
            padding: 0 20px 30px;
            border-bottom: 1px solid rgba(255,255,255,0.1);
            text-align: center;
        }

        .logo {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 12px;
            margin-bottom: 10px;
        }

        .logo-img {
            width: 50px;
            height: 50px;
            border-radius: 50%;
            object-fit: contain;
        }

        .logo-text {
            font-size: 22px;
            font-weight: 700;
            color: var(--primary-color);
        }

        .logo-subtitle {
            font-size: 12px;
            color: rgba(255,255,255,0.7);
            letter-spacing: 1px;
        }

        .nav-menu {
            flex: 1;
            padding: 20px 0;
        }

        .nav-item {
            display: flex;
            align-items: center;
            padding: 14px 25px;
            color: rgba(255,255,255,0.8);
            text-decoration: none;
            transition: all 0.3s;
            border-left: 3px solid transparent;
        }

        .nav-item:hover {
            background-color: rgba(212, 175, 55, 0.1);
            color: white;
            border-left-color: var(--primary-color);
        }

        .nav-item.active {
            background-color: rgba(212, 175, 55, 0.15);
            color: var(--primary-color);
            border-left-color: var(--primary-color);
        }

        .nav-icon {
            width: 24px;
            margin-right: 12px;
            font-size: 18px;
            text-align: center;
        }

        .nav-text {
            font-size: 15px;
            font-weight: 500;
        }

        .sidebar-footer {
            padding: 20px;
            border-top: 1px solid rgba(255,255,255,0.1);
            text-align: center;
        }

        .admin-profile {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .admin-avatar {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            object-fit: cover;
            border: 2px solid var(--primary-color);
        }

        .admin-info h4 {
            font-size: 14px;
            color: white;
            margin-bottom: 2px;
        }

        .admin-info p {
            font-size: 12px;
            color: rgba(255,255,255,0.6);
        }

        /* Main Content Styles */
        .main-content {
            flex: 1;
            margin-left: 260px;
            padding: 20px;
        }

        .top-bar {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 15px 0;
            margin-bottom: 25px;
            border-bottom: 1px solid var(--border-color);
        }

        .page-title {
            font-size: 24px;
            font-weight: 700;
            color: var(--primary-color);
        }

        .top-bar-actions {
            display: flex;
            align-items: center;
            gap: 15px;
        }

        .mode-toggle, .notification-btn {
            background: none;
            border: none;
            color: var(--text-secondary);
            font-size: 18px;
            cursor: pointer;
            padding: 8px;
            border-radius: 8px;
            transition: all 0.3s;
        }

        .mode-toggle:hover, .notification-btn:hover {
            background-color: rgba(0,0,0,0.05);
            color: var(--primary-color);
        }

        .dark-mode .mode-toggle:hover, .dark-mode .notification-btn:hover {
            background-color: rgba(255,255,255,0.1);
        }

        /* Dashboard Cards */
        .dashboard-cards {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(240px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .card {
            background-color: var(--card-bg);
            border-radius: 12px;
            padding: 24px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.05);
            transition: transform 0.3s, box-shadow 0.3s;
            border: 1px solid var(--border-color);
        }

        .card:hover {
            transform: translateY(-5px);
            box-shadow: 0 8px 20px rgba(0,0,0,0.1);
        }

        .card-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
        }

        .card-title {
            font-size: 16px;
            font-weight: 600;
            color: var(--text-secondary);
        }

        .card-icon {
            width: 50px;
            height: 50px;
            border-radius: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 24px;
            color: white;
        }

        .users-icon { background-color: var(--info-color); }
        .posts-icon { background-color: var(--success-color); }
        .books-icon { background-color: var(--warning-color); }
        .events-icon { background-color: var(--danger-color); }

        .card-value {
            font-size: 32px;
            font-weight: 700;
            margin-bottom: 5px;
        }

        .card-change {
            font-size: 14px;
            display: flex;
            align-items: center;
            gap: 5px;
        }

        .positive {
            color: var(--success-color);
        }

        .negative {
            color: var(--danger-color);
        }

        /* Table Styles */
        .table-container {
            background-color: var(--card-bg);
            border-radius: 12px;
            overflow: hidden;
            box-shadow: 0 4px 12px rgba(0,0,0,0.05);
            margin-bottom: 30px;
            border: 1px solid var(--border-color);
        }

        .table-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 20px 24px;
            border-bottom: 1px solid var(--border-color);
        }

        .table-title {
            font-size: 18px;
            font-weight: 600;
        }

        .table-actions {
            display: flex;
            gap: 10px;
        }

        .btn {
            padding: 8px 16px;
            border-radius: 8px;
            border: none;
            font-weight: 500;
            cursor: pointer;
            display: inline-flex;
            align-items: center;
            gap: 8px;
            transition: all 0.3s;
        }

        .btn-primary {
            background-color: var(--primary-color);
            color: white;
        }

        .btn-primary:hover {
            background-color: var(--primary-dark);
        }

        .btn-secondary {
            background-color: transparent;
            color: var(--text-primary);
            border: 1px solid var(--border-color);
        }

        .btn-secondary:hover {
            background-color: rgba(0,0,0,0.05);
        }

        .btn-sm {
            padding: 6px 12px;
            font-size: 14px;
        }

        .btn-icon {
            font-size: 14px;
        }

        table {
            width: 100%;
            border-collapse: collapse;
        }

        th {
            text-align: left;
            padding: 16px 24px;
            background-color: rgba(0,0,0,0.03);
            font-weight: 600;
            color: var(--text-secondary);
            font-size: 14px;
            border-bottom: 1px solid var(--border-color);
        }

        .dark-mode th {
            background-color: rgba(255,255,255,0.05);
        }

        td {
            padding: 16px 24px;
            border-bottom: 1px solid var(--border-color);
            font-size: 14px;
        }

        tr:last-child td {
            border-bottom: none;
        }

        tr:hover {
            background-color: rgba(0,0,0,0.02);
        }

        .dark-mode tr:hover {
            background-color: rgba(255,255,255,0.05);
        }

        .status-badge {
            padding: 4px 10px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: 500;
            display: inline-block;
        }

        .status-active {
            background-color: rgba(16, 185, 129, 0.1);
            color: var(--success-color);
        }

        .status-inactive {
            background-color: rgba(239, 68, 68, 0.1);
            color: var(--danger-color);
        }

        .status-pending {
            background-color: rgba(245, 158, 11, 0.1);
            color: var(--warning-color);
        }

        .status-published {
            background-color: rgba(16, 185, 129, 0.1);
            color: var(--success-color);
        }

        .status-draft {
            background-color: rgba(245, 158, 11, 0.1);
            color: var(--warning-color);
        }

        .status-archived {
            background-color: rgba(107, 114, 128, 0.1);
            color: #6b7280;
        }

        .action-buttons {
            display: flex;
            gap: 8px;
        }

        .btn-edit {
            background-color: rgba(59, 130, 246, 0.1);
            color: var(--info-color);
        }

        .btn-delete {
            background-color: rgba(239, 68, 68, 0.1);
            color: var(--danger-color);
        }

        /* Modal Styles */
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0,0,0,0.5);
            z-index: 1000;
            align-items: center;
            justify-content: center;
        }

        .modal-content {
            background-color: var(--card-bg);
            border-radius: 16px;
            width: 90%;
            max-width: 600px;
            max-height: 90vh;
            overflow-y: auto;
            box-shadow: 0 20px 40px rgba(0,0,0,0.2);
        }

        .modal-header {
            padding: 24px;
            border-bottom: 1px solid var(--border-color);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .modal-title {
            font-size: 20px;
            font-weight: 600;
        }

        .close-modal {
            background: none;
            border: none;
            font-size: 24px;
            color: var(--text-secondary);
            cursor: pointer;
            line-height: 1;
        }

        .modal-body {
            padding: 24px;
        }

        .form-group {
            margin-bottom: 20px;
        }

        .form-label {
            display: block;
            margin-bottom: 8px;
            font-weight: 500;
            color: var(--text-primary);
        }

        .form-control {
            width: 100%;
            padding: 12px 16px;
            border-radius: 8px;
            border: 1px solid var(--border-color);
            background-color: var(--card-bg);
            color: var(--text-primary);
            font-size: 15px;
            transition: border-color 0.3s;
        }

        .form-control:focus {
            outline: none;
            border-color: var(--primary-color);
        }

        textarea.form-control {
            min-height: 100px;
            resize: vertical;
        }

        .form-row {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
        }

        .modal-footer {
            padding: 20px 24px;
            border-top: 1px solid var(--border-color);
            display: flex;
            justify-content: flex-end;
            gap: 12px;
        }

        /* Toast Notification */
        .toast {
            position: fixed;
            top: 20px;
            right: 20px;
            padding: 16px 24px;
            border-radius: 8px;
            color: white;
            font-weight: 500;
            display: flex;
            align-items: center;
            gap: 10px;
            z-index: 9999;
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
            transform: translateX(150%);
            transition: transform 0.3s ease-in-out;
        }

        .toast.show {
            transform: translateX(0);
        }

        .toast-success {
            background-color: var(--success-color);
        }

        .toast-error {
            background-color: var(--danger-color);
        }

        .toast-warning {
            background-color: var(--warning-color);
        }

        /* Login Form Styles */
        .login-container {
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            background-color: var(--light-bg);
            padding: 20px;
        }

        .login-card {
            background-color: var(--card-bg);
            border-radius: 16px;
            padding: 40px;
            width: 100%;
            max-width: 400px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.1);
            border: 1px solid var(--border-color);
        }

        .login-logo {
            text-align: center;
            margin-bottom: 30px;
        }

        .login-logo-img {
            width: 80px;
            height: 80px;
            border-radius: 50%;
            object-fit: contain;
            margin-bottom: 15px;
        }

        .login-title {
            font-size: 28px;
            font-weight: 700;
            color: var(--primary-color);
            text-align: center;
            margin-bottom: 5px;
        }

        .login-subtitle {
            font-size: 14px;
            color: var(--text-secondary);
            text-align: center;
            margin-bottom: 30px;
        }

        .alert {
            padding: 12px 16px;
            border-radius: 8px;
            margin-bottom: 20px;
            font-size: 14px;
            display: none;
        }

        .alert-success {
            background-color: rgba(16, 185, 129, 0.1);
            color: var(--success-color);
            border: 1px solid rgba(16, 185, 129, 0.2);
        }

        .alert-error {
            background-color: rgba(239, 68, 68, 0.1);
            color: var(--danger-color);
            border: 1px solid rgba(239, 68, 68, 0.2);
        }

        /* Loading Spinner */
        .spinner {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 3px solid rgba(255,255,255,.3);
            border-radius: 50%;
            border-top-color: white;
            animation: spin 1s ease-in-out infinite;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        /* Responsive Design */
        @media (max-width: 1200px) {
            .sidebar {
                width: 80px;
            }
            
            .main-content {
                margin-left: 80px;
            }
            
            .logo-text, .logo-subtitle, .nav-text, .admin-info {
                display: none;
            }
            
            .logo {
                justify-content: center;
            }
            
            .logo-img {
                width: 40px;
                height: 40px;
            }
            
            .nav-item {
                justify-content: center;
                padding: 16px;
            }
            
            .nav-icon {
                margin-right: 0;
                font-size: 20px;
            }
            
            .sidebar-footer {
                padding: 15px 10px;
            }
            
            .admin-profile {
                justify-content: center;
            }
        }

        @media (max-width: 768px) {
            .dashboard-cards {
                grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
            }
            
            .form-row {
                grid-template-columns: 1fr;
            }
            
            .table-header {
                flex-direction: column;
                align-items: flex-start;
                gap: 15px;
            }
            
            .table-actions {
                width: 100%;
                justify-content: flex-end;
            }
        }
    </style>
</head>
<body id="mainBody">
    <!-- Toast Notification -->
    <div id="toast" class="toast">
        <i id="toastIcon" class="fas fa-check-circle"></i>
        <span id="toastMessage">Operation completed successfully!</span>
    </div>

    <!-- Login Form (Initially visible) -->
    <div id="loginContainer" class="login-container">
        <div class="login-card">
            <div class="login-logo">
                <img src="https://i.postimg.cc/BbdzCkxQ/20260116_0851_Elegant_Lion_Emblem_remix_01kf2npwbtf06ttr4htekjnd47_removebg_preview_2.webp" alt="THE SONGA Logo" class="login-logo-img">
                <h1 class="login-title">THE SONGA</h1>
                <p class="login-subtitle">Admin Panel Login</p>
            </div>
            
            <div id="loginAlert" class="alert" style="display: none;"></div>
            
            <form id="loginForm">
                <div class="form-group">
                    <label class="form-label">Email Address</label>
                    <input type="email" class="form-control" id="loginEmail" required placeholder="admin@thesongawelfare.com">
                </div>
                
                <div class="form-group">
                    <label class="form-label">Password</label>
                    <input type="password" class="form-control" id="loginPassword" required>
                </div>
                
                <button type="submit" class="btn btn-primary" style="width: 100%; padding: 14px;" id="loginBtn">
                    <span id="loginBtnText">Login to Admin Panel</span>
                    <span id="loginSpinner" class="spinner" style="display: none;"></span>
                </button>
            </form>
        </div>
    </div>

    <!-- Admin Panel (Initially hidden) -->
    <div id="adminPanel" class="admin-container" style="display: none;">
        <!-- Sidebar -->
        <div class="sidebar">
            <div class="logo-section">
                <div class="logo">
                    <img src="https://i.postimg.cc/BbdzCkxQ/20260116_0851_Elegant_Lion_Emblem_remix_01kf2npwbtf06ttr4htekjnd47_removebg_preview_2.webp" alt="THE SONGA Logo" class="logo-img">
                    <div>
                        <div class="logo-text">SONGA</div>
                        <div class="logo-subtitle">ADMIN PANEL</div>
                    </div>
                </div>
            </div>
            
            <div class="nav-menu">
                <a href="#" class="nav-item active" data-section="dashboard">
                    <i class="fas fa-tachometer-alt nav-icon"></i>
                    <span class="nav-text">Dashboard</span>
                </a>
                <a href="#" class="nav-item" data-section="users">
                    <i class="fas fa-users nav-icon"></i>
                    <span class="nav-text">Users</span>
                </a>
                <a href="#" class="nav-item" data-section="posts">
                    <i class="fas fa-newspaper nav-icon"></i>
                    <span class="nav-text">Community Posts</span>
                </a>
                <a href="#" class="nav-item" data-section="library">
                    <i class="fas fa-book nav-icon"></i>
                    <span class="nav-text">Library</span>
                </a>
                <a href="#" class="nav-item" data-section="events">
                    <i class="fas fa-calendar-alt nav-icon"></i>
                    <span class="nav-text">Events</span>
                </a>
                <a href="#" class="nav-item" data-section="subscriptions">
                    <i class="fas fa-credit-card nav-icon"></i>
                    <span class="nav-text">Subscriptions</span>
                </a>
                <a href="#" class="nav-item" data-section="analytics">
                    <i class="fas fa-chart-bar nav-icon"></i>
                    <span class="nav-text">Analytics</span>
                </a>
            </div>
            
            <div class="sidebar-footer">
                <div class="admin-profile">
                    <img src="https://i.postimg.cc/BbdzCkxQ/20260116_0851_Elegant_Lion_Emblem_remix_01kf2npwbtf06ttr4htekjnd47_removebg_preview_2.webp" alt="Admin Avatar" class="admin-avatar" id="adminAvatar">
                    <div class="admin-info">
                        <h4 id="adminName">THE SONGA Admin</h4>
                        <p id="adminEmail"></p>
                    </div>
                </div>
            </div>
        </div>

        <!-- Main Content -->
        <div class="main-content">
            <div class="top-bar">
                <h1 class="page-title">Admin Dashboard</h1>
                <div class="top-bar-actions">
                    <button class="mode-toggle" id="modeToggle">
                        <i class="fas fa-moon"></i>
                    </button>
                    <button class="notification-btn" id="notificationBtn">
                        <i class="fas fa-bell"></i>
                        <span id="notificationCount" style="display: none; background: var(--danger-color); color: white; border-radius: 50%; width: 18px; height: 18px; font-size: 11px; position: absolute; top: -5px; right: -5px; display: flex; align-items: center; justify-content: center;">0</span>
                    </button>
                    <button class="btn btn-primary btn-sm" id="logoutBtn">
                        <i class="fas fa-sign-out-alt btn-icon"></i> Logout
                    </button>
                </div>
            </div>

            <!-- Dashboard Section -->
            <section id="dashboard-section" class="content-section">
                <div class="dashboard-cards">
                    <div class="card">
                        <div class="card-header">
                            <h3 class="card-title">Total Users</h3>
                            <div class="card-icon users-icon">
                                <i class="fas fa-users"></i>
                            </div>
                        </div>
                        <div class="card-value" id="totalUsers">0</div>
                        <div class="card-change positive">
                            <i class="fas fa-arrow-up"></i> <span id="usersChange">Loading...</span>
                        </div>
                    </div>
                    
                    <div class="card">
                        <div class="card-header">
                            <h3 class="card-title">Community Posts</h3>
                            <div class="card-icon posts-icon">
                                <i class="fas fa-newspaper"></i>
                            </div>
                        </div>
                        <div class="card-value" id="totalPosts">0</div>
                        <div class="card-change positive">
                            <i class="fas fa-arrow-up"></i> <span id="postsChange">Loading...</span>
                        </div>
                    </div>
                    
                    <div class="card">
                        <div class="card-header">
                            <h3 class="card-title">Library Books</h3>
                            <div class="card-icon books-icon">
                                <i class="fas fa-book"></i>
                            </div>
                        </div>
                        <div class="card-value" id="totalBooks">0</div>
                        <div class="card-change positive">
                            <i class="fas fa-arrow-up"></i> <span id="booksChange">Loading...</span>
                        </div>
                    </div>
                    
                    <div class="card">
                        <div class="card-header">
                            <h3 class="card-title">Active Events</h3>
                            <div class="card-icon events-icon">
                                <i class="fas fa-calendar-alt"></i>
                            </div>
                        </div>
                        <div class="card-value" id="totalEvents">0</div>
                        <div class="card-change negative">
                            <i class="fas fa-arrow-down"></i> <span id="eventsChange">Loading...</span>
                        </div>
                    </div>
                </div>

                <!-- Recent Activity Table -->
                <div class="table-container">
                    <div class="table-header">
                        <h3 class="table-title">Recent Activity</h3>
                        <div class="table-actions">
                            <button class="btn btn-secondary btn-sm" id="refreshActivityBtn">
                                <i class="fas fa-sync-alt btn-icon"></i> Refresh
                            </button>
                        </div>
                    </div>
                    <table>
                        <thead>
                            <tr>
                                <th>Timestamp</th>
                                <th>Action</th>
                                <th>User</th>
                                <th>Details</th>
                                <th>IP Address</th>
                            </tr>
                        </thead>
                        <tbody id="activityTable">
                            <tr>
                                <td colspan="5" style="text-align: center; padding: 40px;">
                                    <div style="display: flex; flex-direction: column; align-items: center; gap: 10px;">
                                        <div class="spinner"></div>
                                        <div>Loading activity...</div>
                                    </div>
                                </td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </section>

            <!-- Users Section -->
            <section id="users-section" class="content-section" style="display: none;">
                <div class="table-container">
                    <div class="table-header">
                        <h3 class="table-title">Manage Users</h3>
                        <div class="table-actions">
                            <button class="btn btn-secondary btn-sm" id="refreshUsersBtn">
                                <i class="fas fa-sync-alt btn-icon"></i> Refresh
                            </button>
                            <button class="btn btn-primary btn-sm" id="addUserBtn">
                                <i class="fas fa-plus btn-icon"></i> Add User
                            </button>
                        </div>
                    </div>
                    <table>
                        <thead>
                            <tr>
                                <th>Name</th>
                                <th>Email</th>
                                <th>Membership</th>
                                <th>Status</th>
                                <th>Joined</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody id="usersTable">
                            <tr>
                                <td colspan="6" style="text-align: center; padding: 40px;">
                                    <div style="display: flex; flex-direction: column; align-items: center; gap: 10px;">
                                        <div class="spinner"></div>
                                        <div>Loading users...</div>
                                    </div>
                                </td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </section>

            <!-- Posts Section -->
            <section id="posts-section" class="content-section" style="display: none;">
                <div class="table-container">
                    <div class="table-header">
                        <h3 class="table-title">Community Posts</h3>
                        <div class="table-actions">
                            <button class="btn btn-secondary btn-sm" id="refreshPostsBtn">
                                <i class="fas fa-sync-alt btn-icon"></i> Refresh
                            </button>
                            <button class="btn btn-primary btn-sm" id="addPostBtn">
                                <i class="fas fa-plus btn-icon"></i> New Post
                            </button>
                        </div>
                    </div>
                    <table>
                        <thead>
                            <tr>
                                <th>Title</th>
                                <th>Author</th>
                                <th>Category</th>
                                <th>Likes</th>
                                <th>Comments</th>
                                <th>Date</th>
                                <th>Status</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody id="postsTable">
                            <tr>
                                <td colspan="8" style="text-align: center; padding: 40px;">
                                    <div style="display: flex; flex-direction: column; align-items: center; gap: 10px;">
                                        <div class="spinner"></div>
                                        <div>Loading posts...</div>
                                    </div>
                                </td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </section>

            <!-- Library Section -->
            <section id="library-section" class="content-section" style="display: none;">
                <div class="table-container">
                    <div class="table-header">
                        <h3 class="table-title">Library Books</h3>
                        <div class="table-actions">
                            <button class="btn btn-secondary btn-sm" id="refreshBooksBtn">
                                <i class="fas fa-sync-alt btn-icon"></i> Refresh
                            </button>
                            <button class="btn btn-primary btn-sm" id="addBookBtn">
                                <i class="fas fa-plus btn-icon"></i> Add Book
                            </button>
                        </div>
                    </div>
                    <table>
                        <thead>
                            <tr>
                                <th>Title</th>
                                <th>Author</th>
                                <th>Category</th>
                                <th>Availability</th>
                                <th>Rating</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody id="booksTable">
                            <tr>
                                <td colspan="6" style="text-align: center; padding: 40px;">
                                    <div style="display: flex; flex-direction: column; align-items: center; gap: 10px;">
                                        <div class="spinner"></div>
                                        <div>Loading books...</div>
                                    </div>
                                </td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </section>

            <!-- Events Section -->
            <section id="events-section" class="content-section" style="display: none;">
                <div class="table-container">
                    <div class="table-header">
                        <h3 class="table-title">Events</h3>
                        <div class="table-actions">
                            <button class="btn btn-secondary btn-sm" id="refreshEventsBtn">
                                <i class="fas fa-sync-alt btn-icon"></i> Refresh
                            </button>
                            <button class="btn btn-primary btn-sm" id="addEventBtn">
                                <i class="fas fa-plus btn-icon"></i> Create Event
                            </button>
                        </div>
                    </div>
                    <table>
                        <thead>
                            <tr>
                                <th>Event Title</th>
                                <th>Date & Time</th>
                                <th>Location</th>
                                <th>Attendees</th>
                                <th>Status</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody id="eventsTable">
                            <tr>
                                <td colspan="6" style="text-align: center; padding: 40px;">
                                    <div style="display: flex; flex-direction: column; align-items: center; gap: 10px;">
                                        <div class="spinner"></div>
                                        <div>Loading events...</div>
                                    </div>
                                </td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </section>

            <!-- Subscriptions Section -->
            <section id="subscriptions-section" class="content-section" style="display: none;">
                <div class="table-container">
                    <div class="table-header">
                        <h3 class="table-title">User Subscriptions</h3>
                        <div class="table-actions">
                            <button class="btn btn-secondary btn-sm" id="refreshSubscriptionsBtn">
                                <i class="fas fa-sync-alt btn-icon"></i> Refresh
                            </button>
                        </div>
                    </div>
                    <table>
                        <thead>
                            <tr>
                                <th>User</th>
                                <th>Plan</th>
                                <th>Start Date</th>
                                <th>End Date</th>
                                <th>Status</th>
                                <th>Amount</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody id="subscriptionsTable">
                            <tr>
                                <td colspan="7" style="text-align: center; padding: 40px;">
                                    <div style="display: flex; flex-direction: column; align-items: center; gap: 10px;">
                                        <div class="spinner"></div>
                                        <div>Loading subscriptions...</div>
                                    </div>
                                </td>
                            </tr>
                        </tbody>
                    </table>
                </div>

                <div class="table-container" style="margin-top: 30px;">
                    <div class="table-header">
                        <h3 class="table-title">Subscription Plans</h3>
                        <div class="table-actions">
                            <button class="btn btn-primary btn-sm" id="addPlanBtn">
                                <i class="fas fa-plus btn-icon"></i> Add Plan
                            </button>
                        </div>
                    </div>
                    <table>
                        <thead>
                            <tr>
                                <th>Plan Name</th>
                                <th>Price</th>
                                <th>Duration</th>
                                <th>Popularity</th>
                                <th>Status</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody id="plansTable">
                            <tr>
                                <td colspan="6" style="text-align: center; padding: 40px;">
                                    <div style="display: flex; flex-direction: column; align-items: center; gap: 10px;">
                                        <div class="spinner"></div>
                                        <div>Loading plans...</div>
                                    </div>
                                </td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </section>

            <!-- Analytics Section -->
            <section id="analytics-section" class="content-section" style="display: none;">
                <div class="dashboard-cards">
                    <div class="card">
                        <div class="card-header">
                            <h3 class="card-title">Active Users Today</h3>
                            <div class="card-icon users-icon">
                                <i class="fas fa-user-check"></i>
                            </div>
                        </div>
                        <div class="card-value" id="activeUsers">0</div>
                        <div class="card-change positive">
                            <i class="fas fa-arrow-up"></i> <span id="activeUsersChange">Loading...</span>
                        </div>
                    </div>
                    
                    <div class="card">
                        <div class="card-header">
                            <h3 class="card-title">Books Borrowed</h3>
                            <div class="card-icon books-icon">
                                <i class="fas fa-book-reader"></i>
                            </div>
                        </div>
                        <div class="card-value" id="booksBorrowed">0</div>
                        <div class="card-change positive">
                            <i class="fas fa-arrow-up"></i> <span id="borrowedChange">Loading...</span>
                        </div>
                    </div>
                    
                    <div class="card">
                        <div class="card-header">
                            <h3 class="card-title">Page Views</h3>
                            <div class="card-icon posts-icon">
                                <i class="fas fa-eye"></i>
                            </div>
                        </div>
                        <div class="card-value" id="pageViews">0</div>
                        <div class="card-change positive">
                            <i class="fas fa-arrow-up"></i> <span id="viewsChange">Loading...</span>
                        </div>
                    </div>
                    
                    <div class="card">
                        <div class="card-header">
                            <h3 class="card-title">Revenue</h3>
                            <div class="card-icon events-icon">
                                <i class="fas fa-money-bill-wave"></i>
                            </div>
                        </div>
                        <div class="card-value" id="revenue">KSh 0</div>
                        <div class="card-change positive">
                            <i class="fas fa-arrow-up"></i> <span id="revenueChange">Loading...</span>
                        </div>
                    </div>
                </div>
                
                <div class="table-container">
                    <div class="table-header">
                        <h3 class="table-title">System Logs</h3>
                        <div class="table-actions">
                            <button class="btn btn-secondary btn-sm" id="clearLogsBtn">
                                <i class="fas fa-trash btn-icon"></i> Clear Old Logs
                            </button>
                        </div>
                    </div>
                    <table>
                        <thead>
                            <tr>
                                <th>Timestamp</th>
                                <th>Action</th>
                                <th>User</th>
                                <th>Details</th>
                                <th>IP Address</th>
                            </tr>
                        </thead>
                        <tbody id="logsTable">
                            <tr>
                                <td colspan="5" style="text-align: center; padding: 40px;">
                                    <div style="display: flex; flex-direction: column; align-items: center; gap: 10px;">
                                        <div class="spinner"></div>
                                        <div>Loading logs...</div>
                                    </div>
                                </td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </section>
        </div>
    </div>

    <!-- Modals -->
    <!-- User Modal -->
    <div id="userModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 class="modal-title" id="userModalTitle">Add New User</h3>
                <button class="close-modal">&times;</button>
            </div>
            <div class="modal-body">
                <form id="userForm">
                    <input type="hidden" id="userId">
                    <div class="form-row">
                        <div class="form-group">
                            <label class="form-label">First Name *</label>
                            <input type="text" class="form-control" id="firstName" required>
                        </div>
                        <div class="form-group">
                            <label class="form-label">Last Name *</label>
                            <input type="text" class="form-control" id="lastName" required>
                        </div>
                    </div>
                    
                    <div class="form-group">
                        <label class="form-label">Email *</label>
                        <input type="email" class="form-control" id="email" required>
                    </div>
                    
                    <div class="form-group">
                        <label class="form-label">Phone Number</label>
                        <input type="text" class="form-control" id="phone" placeholder="254712345678">
                    </div>
                    
                    <div class="form-row">
                        <div class="form-group">
                            <label class="form-label">Membership Tier *</label>
                            <select class="form-control" id="membershipTier" required>
                                <option value="explorer">Explorer</option>
                                <option value="scholar">Scholar</option>
                                <option value="visionary">Visionary</option>
                                <option value="admin">Admin</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label class="form-label">Status *</label>
                            <select class="form-control" id="userStatus" required>
                                <option value="active">Active</option>
                                <option value="inactive">Inactive</option>
                                <option value="suspended">Suspended</option>
                            </select>
                        </div>
                    </div>
                    
                    <div class="form-row">
                        <div class="form-group">
                            <label class="form-label">Profile Picture URL</label>
                            <input type="text" class="form-control" id="profilePicture" placeholder="https://example.com/image.jpg">
                        </div>
                        <div class="form-group">
                            <label class="form-label">Is Admin?</label>
                            <select class="form-control" id="isAdmin">
                                <option value="false">No</option>
                                <option value="true">Yes</option>
                            </select>
                        </div>
                    </div>
                    
                    <div class="form-group">
                        <label class="form-label">Reading Preferences (comma separated)</label>
                        <input type="text" class="form-control" id="readingPreferences" placeholder="personal_growth, business">
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary close-modal">Cancel</button>
                <button type="button" class="btn btn-primary" id="saveUserBtn">
                    <span id="saveUserBtnText">Save User</span>
                    <span id="saveUserSpinner" class="spinner" style="display: none; margin-left: 8px;"></span>
                </button>
            </div>
        </div>
    </div>

    <!-- Post Modal -->
    <div id="postModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 class="modal-title" id="postModalTitle">Create New Post</h3>
                <button class="close-modal">&times;</button>
            </div>
            <div class="modal-body">
                <form id="postForm">
                    <input type="hidden" id="postId">
                    <div class="form-group">
                        <label class="form-label">Title *</label>
                        <input type="text" class="form-control" id="postTitle" required>
                    </div>
                    
                    <div class="form-group">
                        <label class="form-label">Content *</label>
                        <textarea class="form-control" id="postContent" rows="6" required></textarea>
                    </div>
                    
                    <div class="form-row">
                        <div class="form-group">
                            <label class="form-label">Category *</label>
                            <select class="form-control" id="postCategory" required>
                                <option value="announcement">Announcement</option>
                                <option value="event">Event</option>
                                <option value="resource">Resource</option>
                                <option value="discussion">Discussion</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label class="form-label">Status *</label>
                            <select class="form-control" id="postStatus" required>
                                <option value="published">Published</option>
                                <option value="draft">Draft</option>
                                <option value="archived">Archived</option>
                            </select>
                        </div>
                    </div>
                    
                    <div class="form-row">
                        <div class="form-group">
                            <label class="form-label">Type</label>
                            <select class="form-control" id="postType">
                                <option value="general">General</option>
                                <option value="welcome">Welcome</option>
                                <option value="event">Event Announcement</option>
                                <option value="resource">Resource</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label class="form-label">Pinned?</label>
                            <select class="form-control" id="postIsPinned">
                                <option value="false">No</option>
                                <option value="true">Yes</option>
                            </select>
                        </div>
                    </div>
                    
                    <div class="form-group">
                        <label class="form-label">Tags (comma separated)</label>
                        <input type="text" class="form-control" id="postTags" placeholder="welcome, community, introduction">
                    </div>
                    
                    <div class="form-group">
                        <label class="form-label">Image URL</label>
                        <input type="text" class="form-control" id="postImage" placeholder="https://example.com/image.jpg">
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary close-modal">Cancel</button>
                <button type="button" class="btn btn-primary" id="savePostBtn">
                    <span id="savePostBtnText">Save Post</span>
                    <span id="savePostSpinner" class="spinner" style="display: none; margin-left: 8px;"></span>
                </button>
            </div>
        </div>
    </div>

    <!-- Book Modal -->
    <div id="bookModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 class="modal-title" id="bookModalTitle">Add New Book</h3>
                <button class="close-modal">&times;</button>
            </div>
            <div class="modal-body">
                <form id="bookForm">
                    <input type="hidden" id="bookId">
                    <div class="form-group">
                        <label class="form-label">Title *</label>
                        <input type="text" class="form-control" id="bookTitle" required>
                    </div>
                    
                    <div class="form-group">
                        <label class="form-label">Author *</label>
                        <input type="text" class="form-control" id="bookAuthor" required>
                    </div>
                    
                    <div class="form-row">
                        <div class="form-group">
                            <label class="form-label">Category *</label>
                            <input type="text" class="form-control" id="bookCategory" required>
                        </div>
                        <div class="form-group">
                            <label class="form-label">ISBN</label>
                            <input type="text" class="form-control" id="bookIsbn">
                        </div>
                    </div>
                    
                    <div class="form-group">
                        <label class="form-label">Description *</label>
                        <textarea class="form-control" id="bookDescription" rows="4" required></textarea>
                    </div>
                    
                    <div class="form-row">
                        <div class="form-group">
                            <label class="form-label">Total Copies *</label>
                            <input type="number" class="form-control" id="bookTotalCopies" value="1" min="1" required>
                        </div>
                        <div class="form-group">
                            <label class="form-label">Available Copies *</label>
                            <input type="number" class="form-control" id="bookAvailableCopies" value="1" min="0" required>
                        </div>
                    </div>
                    
                    <div class="form-row">
                        <div class="form-group">
                            <label class="form-label">Pages</label>
                            <input type="number" class="form-control" id="bookPages" min="1">
                        </div>
                        <div class="form-group">
                            <label class="form-label">Rating (0-5)</label>
                            <input type="number" class="form-control" id="bookRating" min="0" max="5" step="0.1" value="4.0">
                        </div>
                    </div>
                    
                    <div class="form-group">
                        <label class="form-label">Cover Image URL</label>
                        <input type="text" class="form-control" id="bookCover" placeholder="https://example.com/cover.jpg">
                    </div>
                    
                    <div class="form-group">
                        <label class="form-label">Tags (comma separated)</label>
                        <input type="text" class="form-control" id="bookTags" placeholder="self-help, productivity">
                    </div>
                    
                    <div class="form-group">
                        <label class="form-label">Subscription Tiers (comma separated)</label>
                        <input type="text" class="form-control" id="bookSubscriptionTiers" placeholder="explorer, scholar, visionary" value="explorer, scholar, visionary">
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary close-modal">Cancel</button>
                <button type="button" class="btn btn-primary" id="saveBookBtn">
                    <span id="saveBookBtnText">Save Book</span>
                    <span id="saveBookSpinner" class="spinner" style="display: none; margin-left: 8px;"></span>
                </button>
            </div>
        </div>
    </div>

    <!-- Event Modal -->
    <div id="eventModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 class="modal-title" id="eventModalTitle">Create New Event</h3>
                <button class="close-modal">&times;</button>
            </div>
            <div class="modal-body">
                <form id="eventForm">
                    <input type="hidden" id="eventId">
                    <div class="form-group">
                        <label class="form-label">Event Title *</label>
                        <input type="text" class="form-control" id="eventTitle" required>
                    </div>
                    
                    <div class="form-group">
                        <label class="form-label">Description *</label>
                        <textarea class="form-control" id="eventDescription" rows="4" required></textarea>
                    </div>
                    
                    <div class="form-row">
                        <div class="form-group">
                            <label class="form-label">Start Date & Time *</label>
                            <input type="datetime-local" class="form-control" id="eventStart" required>
                        </div>
                        <div class="form-group">
                            <label class="form-label">End Date & Time *</label>
                            <input type="datetime-local" class="form-control" id="eventEnd" required>
                        </div>
                    </div>
                    
                    <div class="form-row">
                        <div class="form-group">
                            <label class="form-label">Location *</label>
                            <input type="text" class="form-control" id="eventLocation" required>
                        </div>
                        <div class="form-group">
                            <label class="form-label">Max Attendees *</label>
                            <input type="number" class="form-control" id="eventMaxAttendees" value="50" min="1" required>
                        </div>
                    </div>
                    
                    <div class="form-row">
                        <div class="form-group">
                            <label class="form-label">Type *</label>
                            <select class="form-control" id="eventType" required>
                                <option value="workshop">Workshop</option>
                                <option value="session">Session</option>
                                <option value="webinar">Webinar</option>
                                <option value="meeting">Meeting</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label class="form-label">Category *</label>
                            <select class="form-control" id="eventCategory" required>
                                <option value="finance">Finance</option>
                                <option value="wellness">Wellness</option>
                                <option value="personal_growth">Personal Growth</option>
                                <option value="business">Business</option>
                            </select>
                        </div>
                    </div>
                    
                    <div class="form-row">
                        <div class="form-group">
                            <label class="form-label">Status *</label>
                            <select class="form-control" id="eventStatus" required>
                                <option value="upcoming">Upcoming</option>
                                <option value="ongoing">Ongoing</option>
                                <option value="past">Past</option>
                                <option value="cancelled">Cancelled</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label class="form-label">Registration Open?</label>
                            <select class="form-control" id="eventRegistrationOpen">
                                <option value="true">Yes</option>
                                <option value="false">No</option>
                            </select>
                        </div>
                    </div>
                    
                    <div class="form-group">
                        <label class="form-label">Event Image URL</label>
                        <input type="text" class="form-control" id="eventImage" placeholder="https://example.com/event.jpg">
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary close-modal">Cancel</button>
                <button type="button" class="btn btn-primary" id="saveEventBtn">
                    <span id="saveEventBtnText">Save Event</span>
                    <span id="saveEventSpinner" class="spinner" style="display: none; margin-left: 8px;"></span>
                </button>
            </div>
        </div>
    </div>

    <!-- Subscription Plan Modal -->
    <div id="planModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 class="modal-title" id="planModalTitle">Add Subscription Plan</h3>
                <button class="close-modal">&times;</button>
            </div>
            <div class="modal-body">
                <form id="planForm">
                    <input type="hidden" id="planId">
                    <div class="form-group">
                        <label class="form-label">Plan Name *</label>
                        <input type="text" class="form-control" id="planName" required>
                    </div>
                    
                    <div class="form-row">
                        <div class="form-group">
                            <label class="form-label">Price *</label>
                            <input type="number" class="form-control" id="planPrice" min="0" required>
                        </div>
                        <div class="form-group">
                            <label class="form-label">Currency *</label>
                            <select class="form-control" id="planCurrency" required>
                                <option value="KSh">KSh (Kenyan Shilling)</option>
                                <option value="USD">USD (US Dollar)</option>
                            </select>
                        </div>
                    </div>
                    
                    <div class="form-row">
                        <div class="form-group">
                            <label class="form-label">Duration *</label>
                            <select class="form-control" id="planDuration" required>
                                <option value="1 month">1 Month</option>
                                <option value="3 months">3 Months</option>
                                <option value="6 months">6 Months</option>
                                <option value="1 year">1 Year</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label class="form-label">Popularity</label>
                            <select class="form-control" id="planPopularity">
                                <option value="standard">Standard</option>
                                <option value="popular">Popular</option>
                                <option value="premium">Premium</option>
                            </select>
                        </div>
                    </div>
                    
                    <div class="form-group">
                        <label class="form-label">Features (one per line) *</label>
                        <textarea class="form-control" id="planFeatures" rows="5" required></textarea>
                        <small class="form-text" style="color: var(--text-secondary); margin-top: 5px; display: block;">
                            Enter each feature on a new line
                        </small>
                    </div>
                    
                    <div class="form-group">
                        <label class="form-label">Active?</label>
                        <select class="form-control" id="planActive">
                            <option value="true">Yes</option>
                            <option value="false">No</option>
                        </select>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary close-modal">Cancel</button>
                <button type="button" class="btn btn-primary" id="savePlanBtn">
                    <span id="savePlanBtnText">Save Plan</span>
                    <span id="savePlanSpinner" class="spinner" style="display: none; margin-left: 8px;"></span>
                </button>
            </div>
        </div>
    </div>

    <script>
        // Your Firebase configuration
        const firebaseConfig = {
            apiKey: "AIzaSyBDZicoo7dFLtSmgRPvQE_gdm-tNOyCTXA",
            authDomain: "the-songa-77b1b.firebaseapp.com",
            databaseURL: "https://the-songa-77b1b-default-rtdb.europe-west1.firebasedatabase.app",
            projectId: "the-songa-77b1b",
            storageBucket: "the-songa-77b1b.firebasestorage.app",
            messagingSenderId: "123922889572",
            appId: "1:123922889572:web:482b2a624930baaf92d871"
        };

        // Initialize Firebase
        firebase.initializeApp(firebaseConfig);
        const auth = firebase.auth();
        const database = firebase.database();

        // Global variables
        let currentUser = null;

        // Initialize the application
        document.addEventListener('DOMContentLoaded', function() {
            setupEventListeners();
            checkAuthState();
        });

        // Check authentication state
        function checkAuthState() {
            auth.onAuthStateChanged((user) => {
                if (user) {
                    currentUser = user;
                    showAdminPanel(user);
                    loadAllData();
                    logActivity('admin_login', `Admin logged in: ${user.email}`);
                } else {
                    showLoginForm();
                }
            });
        }

        // Setup all event listeners
        function setupEventListeners() {
            // Login form
            loginForm.addEventListener('submit', handleLogin);
            
            // Logout
            logoutBtn.addEventListener('click', handleLogout);
            
            // Navigation
            setupNavigation();
            
            // Theme toggle
            modeToggle.addEventListener('click', toggleTheme);
            
            // Modal controls
            setupModalControls();
            
            // Refresh buttons
            setupRefreshButtons();
            
            // Add buttons
            setupAddButtons();
            
            // Save buttons
            setupSaveButtons();
            
            // Other buttons
            clearLogsBtn?.addEventListener('click', clearOldLogs);
        }

        // Login handler
        async function handleLogin(e) {
            e.preventDefault();
            
            const email = document.getElementById('loginEmail').value;
            const password = document.getElementById('loginPassword').value;
            
            // Show loading state
            loginBtn.disabled = true;
            loginBtnText.textContent = 'Authenticating...';
            loginSpinner.style.display = 'inline-block';
            loginAlert.style.display = 'none';
            
            try {
                await auth.signInWithEmailAndPassword(email, password);
                // onAuthStateChanged will handle the rest
            } catch (error) {
                let errorMessage = 'Login failed. Please try again.';
                
                switch (error.code) {
                    case 'auth/user-not-found':
                        errorMessage = 'No user found with this email.';
                        break;
                    case 'auth/wrong-password':
                        errorMessage = 'Incorrect password.';
                        break;
                    case 'auth/invalid-email':
                        errorMessage = 'Invalid email address.';
                        break;
                    case 'auth/user-disabled':
                        errorMessage = 'This account has been disabled.';
                        break;
                }
                
                showAlert(errorMessage, 'error');
                loginBtn.disabled = false;
                loginBtnText.textContent = 'Login to Admin Panel';
                loginSpinner.style.display = 'none';
            }
        }

        // Logout handler
        function handleLogout() {
            if (confirm('Are you sure you want to logout?')) {
                logActivity('admin_logout', 'Admin logged out');
                auth.signOut();
            }
        }

        // Navigation setup
        function setupNavigation() {
            navItems.forEach(item => {
                item.addEventListener('click', function(e) {
                    e.preventDefault();
                    
                    navItems.forEach(nav => nav.classList.remove('active'));
                    this.classList.add('active');
                    
                    const sectionId = this.getAttribute('data-section');
                    contentSections.forEach(section => {
                        section.style.display = 'none';
                    });
                    
                    document.getElementById(`${sectionId}-section`).style.display = 'block';
                    
                    // Update page title
                    const pageTitle = document.querySelector('.page-title');
                    const sectionTitles = {
                        'dashboard': 'Admin Dashboard',
                        'users': 'User Management',
                        'posts': 'Community Posts',
                        'library': 'Library Management',
                        'events': 'Event Management',
                        'subscriptions': 'Subscriptions',
                        'analytics': 'Analytics & Reports'
                    };
                    
                    pageTitle.textContent = sectionTitles[sectionId] || 'Admin Panel';
                });
            });
        }

        // Theme toggle
        function toggleTheme() {
            document.body.classList.toggle('dark-mode');
            const icon = this.querySelector('i');
            if (document.body.classList.contains('dark-mode')) {
                icon.classList.remove('fa-moon');
                icon.classList.add('fa-sun');
                localStorage.setItem('theme', 'dark');
            } else {
                icon.classList.remove('fa-sun');
                icon.classList.add('fa-moon');
                localStorage.setItem('theme', 'light');
            }
        }

        // Load saved theme
        const savedTheme = localStorage.getItem('theme');
        if (savedTheme === 'dark') {
            document.body.classList.add('dark-mode');
            modeToggle.querySelector('i').classList.remove('fa-moon');
            modeToggle.querySelector('i').classList.add('fa-sun');
        }

        // Modal controls
        function setupModalControls() {
            // Close buttons
            document.querySelectorAll('.close-modal').forEach(btn => {
                btn.addEventListener('click', function() {
                    this.closest('.modal').style.display = 'none';
                });
            });
            
            // Close on outside click
            window.addEventListener('click', (e) => {
                if (e.target.classList.contains('modal')) {
                    e.target.style.display = 'none';
                }
            });
        }

        // Refresh buttons
        function setupRefreshButtons() {
            const refreshButtons = [
                'refreshActivityBtn', 'refreshUsersBtn', 'refreshPostsBtn',
                'refreshBooksBtn', 'refreshEventsBtn', 'refreshSubscriptionsBtn'
            ];
            
            refreshButtons.forEach(btnId => {
                const btn = document.getElementById(btnId);
                if (btn) {
                    btn.addEventListener('click', function() {
                        const section = this.id.replace('refresh', '').replace('Btn', '').toLowerCase();
                        switch(section) {
                            case 'activity':
                                loadActivity();
                                break;
                            case 'users':
                                loadUsers();
                                break;
                            case 'posts':
                                loadPosts();
                                break;
                            case 'books':
                                loadBooks();
                                break;
                            case 'events':
                                loadEvents();
                                break;
                            case 'subscriptions':
                                loadSubscriptions();
                                break;
                        }
                        showToast('Data refreshed successfully!', 'success');
                    });
                }
            });
        }

        // Add buttons
        function setupAddButtons() {
            // Add User
            addUserBtn.addEventListener('click', () => {
                document.getElementById('userForm').reset();
                document.getElementById('userId').value = '';
                document.getElementById('userModalTitle').textContent = 'Add New User';
                document.getElementById('saveUserBtnText').textContent = 'Save User';
                document.getElementById('userModal').style.display = 'flex';
            });
            
            // Add Post
            addPostBtn.addEventListener('click', () => {
                document.getElementById('postForm').reset();
                document.getElementById('postId').value = '';
                document.getElementById('postModalTitle').textContent = 'Create New Post';
                document.getElementById('savePostBtnText').textContent = 'Save Post';
                // Set default author info
                document.getElementById('postModal').style.display = 'flex';
            });
            
            // Add Book
            addBookBtn.addEventListener('click', () => {
                document.getElementById('bookForm').reset();
                document.getElementById('bookId').value = '';
                document.getElementById('bookModalTitle').textContent = 'Add New Book';
                document.getElementById('saveBookBtnText').textContent = 'Save Book';
                document.getElementById('bookModal').style.display = 'flex';
            });
            
            // Add Event
            addEventBtn.addEventListener('click', () => {
                document.getElementById('eventForm').reset();
                document.getElementById('eventId').value = '';
                document.getElementById('eventModalTitle').textContent = 'Create New Event';
                document.getElementById('saveEventBtnText').textContent = 'Save Event';
                // Set default dates
                const now = new Date();
                const tomorrow = new Date(now);
                tomorrow.setDate(tomorrow.getDate() + 1);
                
                document.getElementById('eventStart').value = formatDateTimeForInput(now);
                document.getElementById('eventEnd').value = formatDateTimeForInput(tomorrow);
                document.getElementById('eventModal').style.display = 'flex';
            });
            
            // Add Plan
            addPlanBtn?.addEventListener('click', () => {
                document.getElementById('planForm').reset();
                document.getElementById('planId').value = '';
                document.getElementById('planModalTitle').textContent = 'Add Subscription Plan';
                document.getElementById('savePlanBtnText').textContent = 'Save Plan';
                // Set default features
                document.getElementById('planFeatures').value = 'Access to basic books\n1 book at a time\nEmail support';
                document.getElementById('planModal').style.display = 'flex';
            });
        }

        // Save buttons
        function setupSaveButtons() {
            // Save User
            saveUserBtn.addEventListener('click', saveUser);
            
            // Save Post
            savePostBtn.addEventListener('click', savePost);
            
            // Save Book
            saveBookBtn.addEventListener('click', saveBook);
            
            // Save Event
            saveEventBtn.addEventListener('click', saveEvent);
            
            // Save Plan
            savePlanBtn?.addEventListener('click', savePlan);
        }

        // Load all data
        function loadAllData() {
            loadDashboardData();
            loadUsers();
            loadPosts();
            loadBooks();
            loadEvents();
            loadSubscriptions();
            loadPlans();
            loadActivity();
        }

        // Dashboard data
        function loadDashboardData() {
            // Users count
            database.ref('users').once('value').then((snapshot) => {
                const users = snapshot.val();
                const userCount = users ? Object.keys(users).length : 0;
                document.getElementById('totalUsers').textContent = userCount;
                
                // Calculate change (simplified - would be based on previous day)
                const change = Math.floor(Math.random() * 10) + 1;
                document.getElementById('usersChange').textContent = `+${change} this week`;
            });
            
            // Posts count
            database.ref('communityPosts').once('value').then((snapshot) => {
                const posts = snapshot.val();
                const postCount = posts ? Object.keys(posts).length : 0;
                document.getElementById('totalPosts').textContent = postCount;
                document.getElementById('postsChange').textContent = `+${Math.floor(Math.random() * 5) + 1} today`;
            });
            
            // Books count
            database.ref('libraryBooks').once('value').then((snapshot) => {
                const books = snapshot.val();
                const bookCount = books ? Object.keys(books).length : 0;
                document.getElementById('totalBooks').textContent = bookCount;
                document.getElementById('booksChange').textContent = `+${Math.floor(Math.random() * 8) + 1} borrowed`;
            });
            
            // Events count
            database.ref('events').once('value').then((snapshot) => {
                const events = snapshot.val();
                const eventCount = events ? Object.keys(events).length : 0;
                document.getElementById('totalEvents').textContent = eventCount;
                
                // Count upcoming events
                let upcomingCount = 0;
                if (events) {
                    Object.values(events).forEach(event => {
                        if (event.status === 'upcoming') upcomingCount++;
                    });
                }
                document.getElementById('eventsChange').textContent = `${upcomingCount} upcoming`;
            });
            
            // Analytics data
            const today = new Date().toISOString().split('T')[0];
            database.ref(`analytics/dailyStats/${today}`).once('value').then((snapshot) => {
                const dailyStats = snapshot.val();
                if (dailyStats) {
                    document.getElementById('activeUsers').textContent = dailyStats.activeUsers || 0;
                    document.getElementById('pageViews').textContent = dailyStats.pageViews || 0;
                    document.getElementById('booksBorrowed').textContent = dailyStats.booksBorrowed || 0;
                    
                    // Calculate revenue
                    database.ref('userSubscriptions').once('value').then((subSnapshot) => {
                        const subscriptions = subSnapshot.val();
                        let revenue = 0;
                        if (subscriptions) {
                            Object.values(subscriptions).forEach(sub => {
                                if (sub.status === 'active') {
                                    revenue += (sub.amount || 0);
                                }
                            });
                        }
                        document.getElementById('revenue').textContent = `KSh ${revenue.toLocaleString()}`;
                    });
                }
            });
        }

        // Users management
        function loadUsers() {
            const usersTable = document.getElementById('usersTable');
            
            database.ref('users').on('value', (snapshot) => {
                const users = snapshot.val();
                usersTable.innerHTML = '';
                
                if (!users) {
                    usersTable.innerHTML = `
                        <tr>
                            <td colspan="6" style="text-align: center; padding: 40px;">
                                No users found.
                            </td>
                        </tr>
                    `;
                    return;
                }
                
                Object.entries(users).forEach(([userId, user]) => {
                    const row = document.createElement('tr');
                    
                    const joinedDate = user.joinedDate ? 
                        new Date(user.joinedDate).toLocaleDateString() : 'N/A';
                    
                    row.innerHTML = `
                        <td>
                            <div style="display: flex; align-items: center; gap: 10px;">
                                <img src="${user.profilePicture || 'https://via.placeholder.com/36'}" 
                                     alt="${user.firstName}" 
                                     style="width: 36px; height: 36px; border-radius: 50%; object-fit: cover;">
                                <div>
                                    <div style="font-weight: 500;">${user.firstName} ${user.lastName}</div>
                                    <div style="font-size: 12px; color: var(--text-secondary);">${userId}</div>
                                </div>
                            </div>
                        </td>
                        <td>${user.email}</td>
                        <td>
                            <span class="status-badge ${getMembershipBadgeClass(user.membershipTier)}">
                                ${user.membershipTier || 'explorer'}
                            </span>
                        </td>
                        <td>
                            <span class="status-badge ${user.status === 'active' ? 'status-active' : 'status-inactive'}">
                                ${user.status || 'active'}
                            </span>
                        </td>
                        <td>${joinedDate}</td>
                        <td>
                            <div class="action-buttons">
                                <button class="btn btn-edit btn-sm" onclick="editUser('${userId}')">
                                    <i class="fas fa-edit btn-icon"></i>
                                </button>
                                <button class="btn btn-delete btn-sm" onclick="deleteUser('${userId}')">
                                    <i class="fas fa-trash btn-icon"></i>
                                </button>
                            </div>
                        </td>
                    `;
                    
                    usersTable.appendChild(row);
                });
            });
        }

        window.editUser = function(userId) {
            database.ref(`users/${userId}`).once('value').then((snapshot) => {
                const user = snapshot.val();
                
                if (user) {
                    document.getElementById('userId').value = userId;
                    document.getElementById('firstName').value = user.firstName || '';
                    document.getElementById('lastName').value = user.lastName || '';
                    document.getElementById('email').value = user.email || '';
                    document.getElementById('phone').value = user.phoneNumber || '';
                    document.getElementById('membershipTier').value = user.membershipTier || 'explorer';
                    document.getElementById('userStatus').value = user.status || 'active';
                    document.getElementById('profilePicture').value = user.profilePicture || '';
                    document.getElementById('isAdmin').value = user.isAdmin ? 'true' : 'false';
                    document.getElementById('readingPreferences').value = user.readingPreferences ? 
                        user.readingPreferences.join(', ') : '';
                    
                    document.getElementById('userModalTitle').textContent = 'Edit User';
                    document.getElementById('saveUserBtnText').textContent = 'Update User';
                    document.getElementById('userModal').style.display = 'flex';
                }
            });
        };

        window.deleteUser = function(userId) {
            if (confirm(`Are you sure you want to delete user ${userId}?`)) {
                database.ref(`users/${userId}`).remove()
                    .then(() => {
                        showToast('User deleted successfully!', 'success');
                        logActivity('user_deleted', `Deleted user: ${userId}`);
                    })
                    .catch((error) => {
                        showToast('Error deleting user: ' + error.message, 'error');
                    });
            }
        };

        async function saveUser() {
            const userId = document.getElementById('userId').value;
            const userData = {
                firstName: document.getElementById('firstName').value,
                lastName: document.getElementById('lastName').value,
                email: document.getElementById('email').value,
                phoneNumber: document.getElementById('phone').value,
                membershipTier: document.getElementById('membershipTier').value,
                status: document.getElementById('userStatus').value,
                profilePicture: document.getElementById('profilePicture').value || null,
                isAdmin: document.getElementById('isAdmin').value === 'true',
                readingPreferences: document.getElementById('readingPreferences').value ?
                    document.getElementById('readingPreferences').value.split(',').map(s => s.trim()) : [],
                updatedAt: new Date().toISOString()
            };
            
            // Show loading
            saveUserBtn.disabled = true;
            saveUserBtnText.textContent = 'Saving...';
            saveUserSpinner.style.display = 'inline-block';
            
            try {
                if (!userId) {
                    // New user
                    userData.joinedDate = new Date().toISOString();
                    userData.lastLogin = new Date().toISOString();
                    userData.membershipSince = new Date().toISOString();
                    
                    const newUserId = `user_${Date.now()}`;
                    await database.ref(`users/${newUserId}`).set(userData);
                    
                    showToast('User added successfully!', 'success');
                    logActivity('user_created', `Created user: ${newUserId}`);
                } else {
                    // Update existing user
                    await database.ref(`users/${userId}`).update(userData);
                    
                    showToast('User updated successfully!', 'success');
                    logActivity('user_updated', `Updated user: ${userId}`);
                }
                
                document.getElementById('userModal').style.display = 'none';
            } catch (error) {
                showToast('Error saving user: ' + error.message, 'error');
            } finally {
                saveUserBtn.disabled = false;
                saveUserBtnText.textContent = userId ? 'Update User' : 'Save User';
                saveUserSpinner.style.display = 'none';
            }
        }

        // Posts management
        function loadPosts() {
            const postsTable = document.getElementById('postsTable');
            
            database.ref('communityPosts').on('value', (snapshot) => {
                const posts = snapshot.val();
                postsTable.innerHTML = '';
                
                if (!posts) {
                    postsTable.innerHTML = `
                        <tr>
                            <td colspan="8" style="text-align: center; padding: 40px;">
                                No posts found.
                            </td>
                        </tr>
                    `;
                    return;
                }
                
                Object.entries(posts).forEach(([postId, post]) => {
                    const row = document.createElement('tr');
                    
                    const postDate = post.createdAt ? 
                        new Date(post.createdAt).toLocaleDateString() : 'N/A';
                    
                    row.innerHTML = `
                        <td>
                            <div style="font-weight: 500;">${post.title || 'Untitled'}</div>
                            <div style="font-size: 12px; color: var(--text-secondary); margin-top: 4px;">${postId}</div>
                        </td>
                        <td>${post.authorName || 'Unknown'}</td>
                        <td>
                            <span class="status-badge ${getCategoryBadgeClass(post.category)}">
                                ${post.category || 'general'}
                            </span>
                        </td>
                        <td>${post.likes || 0}</td>
                        <td>${post.comments || 0}</td>
                        <td>${postDate}</td>
                        <td>
                            <span class="status-badge ${getStatusBadgeClass(post.status)}">
                                ${post.status || 'draft'}
                            </span>
                        </td>
                        <td>
                            <div class="action-buttons">
                                <button class="btn btn-edit btn-sm" onclick="editPost('${postId}')">
                                    <i class="fas fa-edit btn-icon"></i>
                                </button>
                                <button class="btn btn-delete btn-sm" onclick="deletePost('${postId}')">
                                    <i class="fas fa-trash btn-icon"></i>
                                </button>
                                <button class="btn btn-secondary btn-sm" onclick="togglePinPost('${postId}', ${post.isPinned || false})">
                                    <i class="fas fa-thumbtack btn-icon ${post.isPinned ? 'text-primary' : ''}"></i>
                                </button>
                            </div>
                        </td>
                    `;
                    
                    postsTable.appendChild(row);
                });
            });
        }

        window.editPost = function(postId) {
            database.ref(`communityPosts/${postId}`).once('value').then((snapshot) => {
                const post = snapshot.val();
                
                if (post) {
                    document.getElementById('postId').value = postId;
                    document.getElementById('postTitle').value = post.title || '';
                    document.getElementById('postContent').value = post.content || '';
                    document.getElementById('postCategory').value = post.category || 'announcement';
                    document.getElementById('postStatus').value = post.status || 'published';
                    document.getElementById('postType').value = post.type || 'general';
                    document.getElementById('postIsPinned').value = post.isPinned ? 'true' : 'false';
                    document.getElementById('postTags').value = post.tags ? post.tags.join(', ') : '';
                    document.getElementById('postImage').value = post.imageUrl || '';
                    
                    document.getElementById('postModalTitle').textContent = 'Edit Post';
                    document.getElementById('savePostBtnText').textContent = 'Update Post';
                    document.getElementById('postModal').style.display = 'flex';
                }
            });
        };

        window.deletePost = function(postId) {
            if (confirm(`Are you sure you want to delete post ${postId}?`)) {
                database.ref(`communityPosts/${postId}`).remove()
                    .then(() => {
                        showToast('Post deleted successfully!', 'success');
                        logActivity('post_deleted', `Deleted post: ${postId}`);
                    })
                    .catch((error) => {
                        showToast('Error deleting post: ' + error.message, 'error');
                    });
            }
        };

        window.togglePinPost = function(postId, isPinned) {
            database.ref(`communityPosts/${postId}/isPinned`).set(!isPinned)
                .then(() => {
                    showToast(`Post ${!isPinned ? 'pinned' : 'unpinned'} successfully!`, 'success');
                    logActivity('post_pinned', `${!isPinned ? 'Pinned' : 'Unpinned'} post: ${postId}`);
                })
                .catch((error) => {
                    showToast('Error updating post: ' + error.message, 'error');
                });
        };

        async function savePost() {
            const postId = document.getElementById('postId').value;
            const postData = {
                title: document.getElementById('postTitle').value,
                content: document.getElementById('postContent').value,
                category: document.getElementById('postCategory').value,
                status: document.getElementById('postStatus').value,
                type: document.getElementById('postType').value,
                isPinned: document.getElementById('postIsPinned').value === 'true',
                tags: document.getElementById('postTags').value ?
                    document.getElementById('postTags').value.split(',').map(s => s.trim()) : [],
                imageUrl: document.getElementById('postImage').value || '',
                authorId: 'admin_001',
                authorName: 'THE SONGA',
                authorAvatar: 'https://i.postimg.cc/BbdzCkxQ/20260116_0851_Elegant_Lion_Emblem_remix_01kf2npwbtf06ttr4htekjnd47_removebg_preview_2.webp',
                updatedAt: new Date().toISOString()
            };
            
            // Show loading
            savePostBtn.disabled = true;
            savePostBtnText.textContent = 'Saving...';
            savePostSpinner.style.display = 'inline-block';
            
            try {
                if (!postId) {
                    // New post
                    postData.createdAt = new Date().toISOString();
                    postData.likes = 0;
                    postData.comments = 0;
                    postData.shares = 0;
                    postData.bookmarks = 0;
                    postData.likedBy = [];
                    
                    const newPostId = `post_${Date.now()}`;
                    await database.ref(`communityPosts/${newPostId}`).set(postData);
                    
                    showToast('Post created successfully!', 'success');
                    logActivity('post_created', `Created post: ${newPostId}`);
                } else {
                    // Update existing post
                    await database.ref(`communityPosts/${postId}`).update(postData);
                    
                    showToast('Post updated successfully!', 'success');
                    logActivity('post_updated', `Updated post: ${postId}`);
                }
                
                document.getElementById('postModal').style.display = 'none';
            } catch (error) {
                showToast('Error saving post: ' + error.message, 'error');
            } finally {
                savePostBtn.disabled = false;
                savePostBtnText.textContent = postId ? 'Update Post' : 'Save Post';
                savePostSpinner.style.display = 'none';
            }
        }

        // Books management
        function loadBooks() {
            const booksTable = document.getElementById('booksTable');
            
            database.ref('libraryBooks').on('value', (snapshot) => {
                const books = snapshot.val();
                booksTable.innerHTML = '';
                
                if (!books) {
                    booksTable.innerHTML = `
                        <tr>
                            <td colspan="6" style="text-align: center; padding: 40px;">
                                No books found.
                            </td>
                        </tr>
                    `;
                    return;
                }
                
                Object.entries(books).forEach(([bookId, book]) => {
                    const row = document.createElement('tr');
                    
                    row.innerHTML = `
                        <td>
                            <div style="font-weight: 500;">${book.title || 'Untitled'}</div>
                            <div style="font-size: 12px; color: var(--text-secondary); margin-top: 4px;">${bookId}</div>
                        </td>
                        <td>${book.author || 'Unknown'}</td>
                        <td>${book.category || 'Uncategorized'}</td>
                        <td>
                            <div style="display: flex; align-items: center; gap: 8px;">
                                <span class="status-badge ${book.availableCopies > 0 ? 'status-active' : 'status-inactive'}">
                                    ${book.availableCopies > 0 ? 'Available' : 'Out of Stock'}
                                </span>
                                <span style="font-size: 12px; color: var(--text-secondary);">
                                    (${book.availableCopies || 0}/${book.totalCopies || 0})
                                </span>
                            </div>
                        </td>
                        <td>${book.rating ? `${book.rating}/5.0` : 'N/A'}</td>
                        <td>
                            <div class="action-buttons">
                                <button class="btn btn-edit btn-sm" onclick="editBook('${bookId}')">
                                    <i class="fas fa-edit btn-icon"></i>
                                </button>
                                <button class="btn btn-delete btn-sm" onclick="deleteBook('${bookId}')">
                                    <i class="fas fa-trash btn-icon"></i>
                                </button>
                            </div>
                        </td>
                    `;
                    
                    booksTable.appendChild(row);
                });
            });
        }

        window.editBook = function(bookId) {
            database.ref(`libraryBooks/${bookId}`).once('value').then((snapshot) => {
                const book = snapshot.val();
                
                if (book) {
                    document.getElementById('bookId').value = bookId;
                    document.getElementById('bookTitle').value = book.title || '';
                    document.getElementById('bookAuthor').value = book.author || '';
                    document.getElementById('bookCategory').value = book.category || '';
                    document.getElementById('bookIsbn').value = book.isbn || '';
                    document.getElementById('bookDescription').value = book.description || '';
                    document.getElementById('bookTotalCopies').value = book.totalCopies || 1;
                    document.getElementById('bookAvailableCopies').value = book.availableCopies || 1;
                    document.getElementById('bookPages').value = book.pages || '';
                    document.getElementById('bookRating').value = book.rating || 4.0;
                    document.getElementById('bookCover').value = book.coverImage || '';
                    document.getElementById('bookTags').value = book.tags ? book.tags.join(', ') : '';
                    document.getElementById('bookSubscriptionTiers').value = book.subscriptionTiers ? 
                        book.subscriptionTiers.join(', ') : 'explorer, scholar, visionary';
                    
                    document.getElementById('bookModalTitle').textContent = 'Edit Book';
                    document.getElementById('saveBookBtnText').textContent = 'Update Book';
                    document.getElementById('bookModal').style.display = 'flex';
                }
            });
        };

        window.deleteBook = function(bookId) {
            if (confirm(`Are you sure you want to delete book ${bookId}?`)) {
                database.ref(`libraryBooks/${bookId}`).remove()
                    .then(() => {
                        showToast('Book deleted successfully!', 'success');
                        logActivity('book_deleted', `Deleted book: ${bookId}`);
                    })
                    .catch((error) => {
                        showToast('Error deleting book: ' + error.message, 'error');
                    });
            }
        };

        async function saveBook() {
            const bookId = document.getElementById('bookId').value;
            const bookData = {
                title: document.getElementById('bookTitle').value,
                author: document.getElementById('bookAuthor').value,
                category: document.getElementById('bookCategory').value,
                isbn: document.getElementById('bookIsbn').value || null,
                description: document.getElementById('bookDescription').value,
                totalCopies: parseInt(document.getElementById('bookTotalCopies').value) || 1,
                availableCopies: parseInt(document.getElementById('bookAvailableCopies').value) || 1,
                pages: document.getElementById('bookPages').value ? parseInt(document.getElementById('bookPages').value) : null,
                rating: parseFloat(document.getElementById('bookRating').value) || 4.0,
                coverImage: document.getElementById('bookCover').value || '',
                tags: document.getElementById('bookTags').value ?
                    document.getElementById('bookTags').value.split(',').map(s => s.trim()) : [],
                subscriptionTiers: document.getElementById('bookSubscriptionTiers').value ?
                    document.getElementById('bookSubscriptionTiers').value.split(',').map(s => s.trim()) : ['explorer', 'scholar', 'visionary'],
                availability: document.getElementById('bookAvailableCopies').value > 0 ? 'available' : 'unavailable',
                updatedAt: new Date().toISOString()
            };
            
            // Show loading
            saveBookBtn.disabled = true;
            saveBookBtnText.textContent = 'Saving...';
            saveBookSpinner.style.display = 'inline-block';
            
            try {
                if (!bookId) {
                    // New book
                    bookData.addedDate = new Date().toISOString();
                    bookData.borrowCount = 0;
                    bookData.totalRatings = 0;
                    bookData.featured = false;
                    bookData.genre = bookData.tags;
                    
                    const newBookId = `book_${Date.now()}`;
                    await database.ref(`libraryBooks/${newBookId}`).set(bookData);
                    
                    showToast('Book added successfully!', 'success');
                    logActivity('book_created', `Created book: ${newBookId}`);
                } else {
                    // Update existing book
                    await database.ref(`libraryBooks/${bookId}`).update(bookData);
                    
                    showToast('Book updated successfully!', 'success');
                    logActivity('book_updated', `Updated book: ${bookId}`);
                }
                
                document.getElementById('bookModal').style.display = 'none';
            } catch (error) {
                showToast('Error saving book: ' + error.message, 'error');
            } finally {
                saveBookBtn.disabled = false;
                saveBookBtnText.textContent = bookId ? 'Update Book' : 'Save Book';
                saveBookSpinner.style.display = 'none';
            }
        }

        // Events management
        function loadEvents() {
            const eventsTable = document.getElementById('eventsTable');
            
            database.ref('events').on('value', (snapshot) => {
                const events = snapshot.val();
                eventsTable.innerHTML = '';
                
                if (!events) {
                    eventsTable.innerHTML = `
                        <tr>
                            <td colspan="6" style="text-align: center; padding: 40px;">
                                No events found.
                            </td>
                        </tr>
                    `;
                    return;
                }
                
                Object.entries(events).forEach(([eventId, event]) => {
                    const row = document.createElement('tr');
                    
                    const eventDate = event.date ? 
                        new Date(event.date).toLocaleString() : 'N/A';
                    
                    const currentAttendees = event.currentAttendees || 0;
                    const maxAttendees = event.maxAttendees || 1;
                    const percentage = (currentAttendees / maxAttendees) * 100;
                    
                    row.innerHTML = `
                        <td>
                            <div style="font-weight: 500;">${event.title || 'Untitled Event'}</div>
                            <div style="font-size: 12px; color: var(--text-secondary); margin-top: 4px;">${eventId}</div>
                        </td>
                        <td>${eventDate}</td>
                        <td>${event.location || 'Virtual'}</td>
                        <td>
                            <div style="display: flex; align-items: center; gap: 8px;">
                                <span>${currentAttendees}/${maxAttendees}</span>
                                <div style="width: 60px; height: 6px; background-color: rgba(0,0,0,0.1); border-radius: 3px;">
                                    <div style="width: ${percentage}%; height: 100%; background-color: var(--success-color); border-radius: 3px;"></div>
                                </div>
                            </div>
                        </td>
                        <td>
                            <span class="status-badge ${getEventStatusBadgeClass(event.status)}">
                                ${event.status || 'upcoming'}
                            </span>
                        </td>
                        <td>
                            <div class="action-buttons">
                                <button class="btn btn-edit btn-sm" onclick="editEvent('${eventId}')">
                                    <i class="fas fa-edit btn-icon"></i>
                                </button>
                                <button class="btn btn-delete btn-sm" onclick="deleteEvent('${eventId}')">
                                    <i class="fas fa-trash btn-icon"></i>
                                </button>
                            </div>
                        </td>
                    `;
                    
                    eventsTable.appendChild(row);
                });
            });
        }

        window.editEvent = function(eventId) {
            database.ref(`events/${eventId}`).once('value').then((snapshot) => {
                const event = snapshot.val();
                
                if (event) {
                    document.getElementById('eventId').value = eventId;
                    document.getElementById('eventTitle').value = event.title || '';
                    document.getElementById('eventDescription').value = event.description || '';
                    
                    // Format dates for datetime-local input
                    if (event.date) {
                        document.getElementById('eventStart').value = formatDateTimeForInput(new Date(event.date));
                    }
                    if (event.endDate) {
                        document.getElementById('eventEnd').value = formatDateTimeForInput(new Date(event.endDate));
                    }
                    
                    document.getElementById('eventLocation').value = event.location || '';
                    document.getElementById('eventMaxAttendees').value = event.maxAttendees || 50;
                    document.getElementById('eventType').value = event.type || 'workshop';
                    document.getElementById('eventCategory').value = event.category || 'finance';
                    document.getElementById('eventStatus').value = event.status || 'upcoming';
                    document.getElementById('eventRegistrationOpen').value = event.registrationOpen ? 'true' : 'false';
                    document.getElementById('eventImage').value = event.imageUrl || '';
                    
                    document.getElementById('eventModalTitle').textContent = 'Edit Event';
                    document.getElementById('saveEventBtnText').textContent = 'Update Event';
                    document.getElementById('eventModal').style.display = 'flex';
                }
            });
        };

        window.deleteEvent = function(eventId) {
            if (confirm(`Are you sure you want to delete event ${eventId}?`)) {
                database.ref(`events/${eventId}`).remove()
                    .then(() => {
                        showToast('Event deleted successfully!', 'success');
                        logActivity('event_deleted', `Deleted event: ${eventId}`);
                    })
                    .catch((error) => {
                        showToast('Error deleting event: ' + error.message, 'error');
                    });
            }
        };

        async function saveEvent() {
            const eventId = document.getElementById('eventId').value;
            const startDate = new Date(document.getElementById('eventStart').value);
            const endDate = new Date(document.getElementById('eventEnd').value);
            
            const eventData = {
                title: document.getElementById('eventTitle').value,
                description: document.getElementById('eventDescription').value,
                date: startDate.toISOString(),
                endDate: endDate.toISOString(),
                location: document.getElementById('eventLocation').value,
                maxAttendees: parseInt(document.getElementById('eventMaxAttendees').value) || 50,
                type: document.getElementById('eventType').value,
                category: document.getElementById('eventCategory').value,
                status: document.getElementById('eventStatus').value,
                registrationOpen: document.getElementById('eventRegistrationOpen').value === 'true',
                imageUrl: document.getElementById('eventImage').value || '',
                host: 'THE SONGA',
                hostAvatar: 'https://i.postimg.cc/BbdzCkxQ/20260116_0851_Elegant_Lion_Emblem_remix_01kf2npwbtf06ttr4htekjnd47_removebg_preview_2.webp',
                updatedAt: new Date().toISOString()
            };
            
            // Show loading
            saveEventBtn.disabled = true;
            saveEventBtnText.textContent = 'Saving...';
            saveEventSpinner.style.display = 'inline-block';
            
            try {
                if (!eventId) {
                    // New event
                    eventData.createdAt = new Date().toISOString();
                    eventData.currentAttendees = 0;
                    eventData.attendeeIds = [];
                    
                    const newEventId = `event_${Date.now()}`;
                    await database.ref(`events/${newEventId}`).set(eventData);
                    
                    showToast('Event created successfully!', 'success');
                    logActivity('event_created', `Created event: ${newEventId}`);
                } else {
                    // Update existing event
                    await database.ref(`events/${eventId}`).update(eventData);
                    
                    showToast('Event updated successfully!', 'success');
                    logActivity('event_updated', `Updated event: ${eventId}`);
                }
                
                document.getElementById('eventModal').style.display = 'none';
            } catch (error) {
                showToast('Error saving event: ' + error.message, 'error');
            } finally {
                saveEventBtn.disabled = false;
                saveEventBtnText.textContent = eventId ? 'Update Event' : 'Save Event';
                saveEventSpinner.style.display = 'none';
            }
        }

        // Subscriptions management
        function loadSubscriptions() {
            const subscriptionsTable = document.getElementById('subscriptionsTable');
            
            database.ref('userSubscriptions').on('value', (snapshot) => {
                const subscriptions = snapshot.val();
                subscriptionsTable.innerHTML = '';
                
                if (!subscriptions) {
                    subscriptionsTable.innerHTML = `
                        <tr>
                            <td colspan="7" style="text-align: center; padding: 40px;">
                                No subscriptions found.
                            </td>
                        </tr>
                    `;
                    return;
                }
                
                // Also get users data for names
                database.ref('users').once('value').then((userSnapshot) => {
                    const users = userSnapshot.val() || {};
                    
                    Object.entries(subscriptions).forEach(([subId, subscription]) => {
                        const row = document.createElement('tr');
                        const user = users[subscription.userId] || {};
                        
                        const startDate = subscription.startDate ? 
                            new Date(subscription.startDate).toLocaleDateString() : 'N/A';
                        const endDate = subscription.endDate ? 
                            new Date(subscription.endDate).toLocaleDateString() : 'N/A';
                        
                        row.innerHTML = `
                            <td>
                                <div style="font-weight: 500;">${user.firstName || ''} ${user.lastName || ''}</div>
                                <div style="font-size: 12px; color: var(--text-secondary);">${subscription.userId}</div>
                            </td>
                            <td>${subscription.planId || 'N/A'}</td>
                            <td>${startDate}</td>
                            <td>${endDate}</td>
                            <td>
                                <span class="status-badge ${subscription.status === 'active' ? 'status-active' : 'status-inactive'}">
                                    ${subscription.status || 'inactive'}
                                </span>
                            </td>
                            <td>${subscription.currency || 'KSh'} ${subscription.amount || 0}</td>
                            <td>
                                <div class="action-buttons">
                                    <button class="btn btn-edit btn-sm" onclick="editSubscription('${subId}')">
                                        <i class="fas fa-edit btn-icon"></i>
                                    </button>
                                    <button class="btn btn-delete btn-sm" onclick="deleteSubscription('${subId}')">
                                        <i class="fas fa-trash btn-icon"></i>
                                    </button>
                                </div>
                            </td>
                        `;
                        
                        subscriptionsTable.appendChild(row);
                    });
                });
            });
        }

        function loadPlans() {
            const plansTable = document.getElementById('plansTable');
            
            database.ref('subscriptionPlans').on('value', (snapshot) => {
                const plans = snapshot.val();
                plansTable.innerHTML = '';
                
                if (!plans) {
                    plansTable.innerHTML = `
                        <tr>
                            <td colspan="6" style="text-align: center; padding: 40px;">
                                No plans found.
                            </td>
                        </tr>
                    `;
                    return;
                }
                
                Object.entries(plans).forEach(([planId, plan]) => {
                    const row = document.createElement('tr');
                    
                    row.innerHTML = `
                        <td>
                            <div style="font-weight: 500;">${plan.name || 'Untitled Plan'}</div>
                            <div style="font-size: 12px; color: var(--text-secondary);">${planId}</div>
                        </td>
                        <td>${plan.currency || 'KSh'} ${plan.price || 0}</td>
                        <td>${plan.duration || '1 month'}</td>
                        <td>
                            <span class="status-badge ${getPlanPopularityBadgeClass(plan.popularity)}">
                                ${plan.popularity || 'standard'}
                            </span>
                        </td>
                        <td>
                            <span class="status-badge ${plan.active ? 'status-active' : 'status-inactive'}">
                                ${plan.active ? 'Active' : 'Inactive'}
                            </span>
                        </td>
                        <td>
                            <div class="action-buttons">
                                <button class="btn btn-edit btn-sm" onclick="editPlan('${planId}')">
                                    <i class="fas fa-edit btn-icon"></i>
                                </button>
                                <button class="btn btn-delete btn-sm" onclick="deletePlan('${planId}')">
                                    <i class="fas fa-trash btn-icon"></i>
                                </button>
                            </div>
                        </td>
                    `;
                    
                    plansTable.appendChild(row);
                });
            });
        }

        window.editPlan = function(planId) {
            database.ref(`subscriptionPlans/${planId}`).once('value').then((snapshot) => {
                const plan = snapshot.val();
                
                if (plan) {
                    document.getElementById('planId').value = planId;
                    document.getElementById('planName').value = plan.name || '';
                    document.getElementById('planPrice').value = plan.price || 0;
                    document.getElementById('planCurrency').value = plan.currency || 'KSh';
                    document.getElementById('planDuration').value = plan.duration || '1 month';
                    document.getElementById('planPopularity').value = plan.popularity || 'standard';
                    document.getElementById('planFeatures').value = plan.features ? plan.features.join('\n') : '';
                    document.getElementById('planActive').value = plan.active ? 'true' : 'false';
                    
                    document.getElementById('planModalTitle').textContent = 'Edit Plan';
                    document.getElementById('savePlanBtnText').textContent = 'Update Plan';
                    document.getElementById('planModal').style.display = 'flex';
                }
            });
        };

        window.deletePlan = function(planId) {
            if (confirm(`Are you sure you want to delete plan ${planId}?`)) {
                database.ref(`subscriptionPlans/${planId}`).remove()
                    .then(() => {
                        showToast('Plan deleted successfully!', 'success');
                        logActivity('plan_deleted', `Deleted plan: ${planId}`);
                    })
                    .catch((error) => {
                        showToast('Error deleting plan: ' + error.message, 'error');
                    });
            }
        };

        async function savePlan() {
            const planId = document.getElementById('planId').value;
            const planData = {
                name: document.getElementById('planName').value,
                price: parseFloat(document.getElementById('planPrice').value) || 0,
                currency: document.getElementById('planCurrency').value,
                duration: document.getElementById('planDuration').value,
                popularity: document.getElementById('planPopularity').value,
                features: document.getElementById('planFeatures').value.split('\n').filter(f => f.trim()),
                active: document.getElementById('planActive').value === 'true',
                updatedAt: new Date().toISOString()
            };
            
            // Show loading
            savePlanBtn.disabled = true;
            savePlanBtnText.textContent = 'Saving...';
            savePlanSpinner.style.display = 'inline-block';
            
            try {
                if (!planId) {
                    // New plan
                    planData.createdAt = new Date().toISOString();
                    planData.id = `plan_${Date.now()}`;
                    
                    const newPlanId = planData.id;
                    await database.ref(`subscriptionPlans/${newPlanId}`).set(planData);
                    
                    showToast('Plan added successfully!', 'success');
                    logActivity('plan_created', `Created plan: ${newPlanId}`);
                } else {
                    // Update existing plan
                    await database.ref(`subscriptionPlans/${planId}`).update(planData);
                    
                    showToast('Plan updated successfully!', 'success');
                    logActivity('plan_updated', `Updated plan: ${planId}`);
                }
                
                document.getElementById('planModal').style.display = 'none';
            } catch (error) {
                showToast('Error saving plan: ' + error.message, 'error');
            } finally {
                savePlanBtn.disabled = false;
                savePlanBtnText.textContent = planId ? 'Update Plan' : 'Save Plan';
                savePlanSpinner.style.display = 'none';
            }
        }

        // Activity logs
        function loadActivity() {
            const activityTable = document.getElementById('activityTable');
            
            database.ref('systemLogs').limitToLast(50).on('value', (snapshot) => {
                const logs = snapshot.val();
                activityTable.innerHTML = '';
                
                if (!logs) {
                    activityTable.innerHTML = `
                        <tr>
                            <td colspan="5" style="text-align: center; padding: 40px;">
                                No activity logs found.
                            </td>
                        </tr>
                    `;
                    return;
                }
                
                // Convert to array and sort by timestamp (newest first)
                const logsArray = Object.entries(logs).map(([id, log]) => ({ id, ...log }));
                logsArray.sort((a, b) => new Date(b.timestamp) - new Date(a.timestamp));
                
                logsArray.forEach(log => {
                    const row = document.createElement('tr');
                    
                    const logTime = log.timestamp ? 
                        new Date(log.timestamp).toLocaleString() : 'N/A';
                    
                    row.innerHTML = `
                        <td>${logTime}</td>
                        <td>${log.action || 'Unknown'}</td>
                        <td>${log.userId || 'System'}</td>
                        <td>${log.details || 'No details'}</td>
                        <td>${log.ipAddress || 'N/A'}</td>
                    `;
                    
                    activityTable.appendChild(row);
                });
            });
        }

        function clearOldLogs() {
            if (confirm('Are you sure you want to clear logs older than 30 days?')) {
                database.ref('systemLogs').once('value').then((snapshot) => {
                    const logs = snapshot.val();
                    const thirtyDaysAgo = new Date();
                    thirtyDaysAgo.setDate(thirtyDaysAgo.getDate() - 30);
                    
                    const updates = {};
                    Object.entries(logs).forEach(([logId, log]) => {
                        const logDate = new Date(log.timestamp);
                        if (logDate < thirtyDaysAgo) {
                            updates[logId] = null;
                        }
                    });
                    
                    database.ref('systemLogs').update(updates)
                        .then(() => {
                            showToast('Old logs cleared successfully!', 'success');
                            logActivity('logs_cleared', 'Cleared logs older than 30 days');
                        })
                        .catch((error) => {
                            showToast('Error clearing logs: ' + error.message, 'error');
                        });
                });
            }
        }

        // Utility functions
        function showLoginForm() {
            loginContainer.style.display = 'flex';
            adminPanel.style.display = 'none';
            loginForm.reset();
            loginBtn.disabled = false;
            loginBtnText.textContent = 'Login to Admin Panel';
            loginSpinner.style.display = 'none';
        }

        function showAdminPanel(user) {
            loginContainer.style.display = 'none';
            adminPanel.style.display = 'flex';
            document.getElementById('adminName').textContent = user.displayName || 'THE SONGA Admin';
            document.getElementById('adminEmail').textContent = user.email;
        }

        function showToast(message, type) {
            const toast = document.getElementById('toast');
            const toastIcon = document.getElementById('toastIcon');
            const toastMessage = document.getElementById('toastMessage');
            
            // Set icon based on type
            switch(type) {
                case 'success':
                    toastIcon.className = 'fas fa-check-circle';
                    toast.className = 'toast toast-success';
                    break;
                case 'error':
                    toastIcon.className = 'fas fa-exclamation-circle';
                    toast.className = 'toast toast-error';
                    break;
                case 'warning':
                    toastIcon.className = 'fas fa-exclamation-triangle';
                    toast.className = 'toast toast-warning';
                    break;
            }
            
            toastMessage.textContent = message;
            toast.classList.add('show');
            
            // Auto-hide after 3 seconds
            setTimeout(() => {
                toast.classList.remove('show');
            }, 3000);
        }

        function showAlert(message, type) {
            const alert = document.getElementById('loginAlert');
            alert.textContent = message;
            alert.className = `alert alert-${type}`;
            alert.style.display = 'block';
            
            setTimeout(() => {
                alert.style.display = 'none';
            }, 5000);
        }

        function logActivity(action, details) {
            const logId = `log_${Date.now()}`;
            const logData = {
                id: logId,
                action: action,
                userId: currentUser?.uid || 'system',
                details: details,
                timestamp: new Date().toISOString(),
                ipAddress: '127.0.0.1' // In production, get real IP
            };
            
            database.ref(`systemLogs/${logId}`).set(logData);
        }

        function formatDateTimeForInput(date) {
            return date.toISOString().slice(0, 16);
        }

        function getMembershipBadgeClass(tier) {
            switch(tier) {
                case 'admin': return 'status-active';
                case 'visionary': return 'status-published';
                case 'scholar': return 'status-pending';
                default: return 'status-draft';
            }
        }

        function getCategoryBadgeClass(category) {
            switch(category) {
                case 'announcement': return 'status-active';
                case 'event': return 'status-published';
                case 'resource': return 'status-pending';
                default: return 'status-draft';
            }
        }

        function getStatusBadgeClass(status) {
            switch(status) {
                case 'published': return 'status-published';
                case 'draft': return 'status-draft';
                case 'archived': return 'status-archived';
                default: return 'status-draft';
            }
        }

        function getEventStatusBadgeClass(status) {
            switch(status) {
                case 'upcoming': return 'status-active';
                case 'ongoing': return 'status-published';
                case 'past': return 'status-archived';
                case 'cancelled': return 'status-inactive';
                default: return 'status-draft';
            }
        }

        function getPlanPopularityBadgeClass(popularity) {
            switch(popularity) {
                case 'premium': return 'status-active';
                case 'popular': return 'status-published';
                case 'standard': return 'status-draft';
                default: return 'status-draft';
            }
        }

        // Initialize notifications
        function checkNotifications() {
            // Check for upcoming events
            database.ref('events').once('value').then((snapshot) => {
                const events = snapshot.val();
                let notificationCount = 0;
                
                if (events) {
                    const now = new Date();
                    Object.values(events).forEach(event => {
                        if (event.status === 'upcoming' && event.date) {
                            const eventDate = new Date(event.date);
                            const hoursDiff = (eventDate - now) / (1000 * 60 * 60);
                            
                            // Notify for events happening in next 24 hours
                            if (hoursDiff > 0 && hoursDiff <= 24) {
                                notificationCount++;
                            }
                        }
                    });
                }
                
                // Check for overdue books
                database.ref('bookBorrowing').once('value').then((borrowSnapshot) => {
                    const borrows = borrowSnapshot.val();
                    
                    if (borrows) {
                        const today = new Date();
                        Object.values(borrows).forEach(borrow => {
                            if (borrow.status === 'borrowed' && borrow.dueDate) {
                                const dueDate = new Date(borrow.dueDate);
                                if (dueDate < today) {
                                    notificationCount++;
                                }
                            }
                        });
                    }
                    
                    // Update notification badge
                    const badge = document.getElementById('notificationCount');
                    if (notificationCount > 0) {
                        badge.textContent = notificationCount;
                        badge.style.display = 'flex';
                    } else {
                        badge.style.display = 'none';
                    }
                });
            });
        }

        // Check notifications every 5 minutes
        setInterval(checkNotifications, 300000);
        checkNotifications(); // Initial check
    </script>
</body>
</html>
