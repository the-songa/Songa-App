<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=yes">
    <title>THE SONGA ¬∑ Inner Circle</title>
    
    <!-- Preconnect -->
    <link rel="preconnect" href="https://cdnjs.cloudflare.com">
    <link rel="preconnect" href="https://www.gstatic.com">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://accounts.google.com">

    <!-- PWA -->
    <link rel="manifest" href="/manifest.json">
    <meta name="theme-color" content="#D4AF37">
    <link rel="icon" href="https://i.postimg.cc/BbdzCkxQ/20260116-0851-Elegant-Lion-Emblem-remix-01kf2npwbtf06ttr4htekjnd47-removebg-preview-2.webp">
    <meta name="apple-mobile-web-app-capable" content="yes">

    <!-- Fonts - Smaller & Professional -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

    <style>
        /* ==================== RESET ==================== */
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        :root {
            --gold: #D4AF37;
            --gold-light: #F5E6B3;
            --gold-dark: #B8860B;
            --black: #000000;
            --white: #ffffff;
            --gray-50: #f8f9fa;
            --gray-100: #f1f3f5;
            --gray-200: #e9ecef;
            --gray-300: #dee2e6;
            --gray-400: #ced4da;
            --gray-500: #adb5bd;
            --gray-600: #6c757d;
            --gray-700: #495057;
            --gray-800: #343a40;
            --gray-900: #212529;
            --success: #2ecc71;
            --error: #e74c3c;
            --border-color: #e9ecef;
            
            /* Layout */
            --sidebar-width: 260px;
            --header-height: 53px;
            --bottom-nav-height: 52px;
            
            /* Font sizes - smaller and professional */
            --fs-xs: 0.75rem;    /* 12px */
            --fs-sm: 0.8125rem;   /* 13px */
            --fs-md: 0.875rem;    /* 14px */
            --fs-lg: 0.9375rem;   /* 15px */
            --fs-xl: 1rem;        /* 16px */
            --fs-2xl: 1.125rem;   /* 18px */
        }

        html {
            font-size: 16px;
            scroll-behavior: smooth;
        }

        body {
            font-family: 'Inter', -apple-system, sans-serif;
            font-size: var(--fs-md);
            background: var(--white);
            color: var(--gray-900);
            line-height: 1.5;
            overflow-x: hidden;
            -webkit-font-smoothing: antialiased;
        }

        body.modal-open {
            overflow: hidden;
        }

        /* ==================== TYPOGRAPHY ==================== */
        h1 { font-size: var(--fs-2xl); font-weight: 700; }
        h2 { font-size: var(--fs-xl); font-weight: 700; }
        h3 { font-size: var(--fs-lg); font-weight: 600; }
        p { font-size: var(--fs-md); line-height: 1.5; color: var(--gray-700); }
        .text-sm { font-size: var(--fs-sm); }
        .text-xs { font-size: var(--fs-xs); }

        /* ==================== LAYOUT ==================== */
        .app-wrapper {
            display: flex;
            min-height: 100vh;
            max-width: 1280px;
            margin: 0 auto;
            position: relative;
        }

        /* Left Sidebar */
        .left-sidebar {
            width: var(--sidebar-width);
            position: sticky;
            top: 0;
            height: 100vh;
            padding: 0.75rem 1rem;
            border-right: 1px solid var(--border-color);
            display: flex;
            flex-direction: column;
            background: var(--white);
        }

        .logo {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            padding: 0.5rem 0.75rem;
            margin-bottom: 1rem;
        }

        .logo img {
            width: 32px;
            height: 32px;
            border-radius: 8px;
        }

        .logo span {
            font-weight: 700;
            font-size: var(--fs-lg);
            color: var(--gold-dark);
            letter-spacing: -0.3px;
        }

        .nav-menu {
            flex: 1;
            display: flex;
            flex-direction: column;
            gap: 0.125rem;
        }

        .nav-item {
            display: flex;
            align-items: center;
            gap: 1rem;
            padding: 0.625rem 0.75rem;
            border-radius: 30px;
            color: var(--gray-800);
            font-weight: 500;
            font-size: var(--fs-lg);
            transition: all 0.2s;
            cursor: pointer;
            position: relative;
        }

        .nav-item i {
            font-size: 1.25rem;
            width: 1.5rem;
        }

        .nav-item:hover {
            background: var(--gray-100);
            color: var(--gold-dark);
        }

        .nav-item.active {
            background: var(--gold-light);
            color: var(--gold-dark);
            font-weight: 600;
        }

        .badge {
            position: absolute;
            top: 0.25rem;
            left: 1.75rem;
            background: var(--error);
            color: white;
            font-size: var(--fs-xs);
            font-weight: 600;
            padding: 0.125rem 0.375rem;
            border-radius: 12px;
            min-width: 18px;
            text-align: center;
        }

        .post-btn-large {
            background: linear-gradient(135deg, var(--gold), var(--gold-dark));
            color: var(--black);
            border: none;
            padding: 0.75rem;
            border-radius: 30px;
            font-weight: 600;
            font-size: var(--fs-md);
            cursor: pointer;
            margin: 0.75rem 0;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 0.5rem;
            transition: all 0.2s;
        }

        .post-btn-large:hover {
            transform: scale(1.02);
            box-shadow: 0 4px 12px rgba(212, 175, 55, 0.25);
        }

        .user-section {
            display: flex;
            align-items: center;
            gap: 0.75rem;
            padding: 0.625rem 0.75rem;
            border-radius: 40px;
            margin-top: auto;
            cursor: pointer;
            transition: background 0.2s;
        }

        .user-section:hover {
            background: var(--gray-100);
        }

        .user-avatar {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            overflow: hidden;
            border: 2px solid var(--gold-light);
            flex-shrink: 0;
        }

        .user-avatar img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        .user-info {
            flex: 1;
            min-width: 0;
        }

        .user-name {
            font-weight: 600;
            font-size: var(--fs-sm);
            color: var(--gray-900);
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .user-handle {
            font-size: var(--fs-xs);
            color: var(--gray-600);
        }

        /* Main Content */
        .main-content {
            flex: 1;
            max-width: 600px;
            border-right: 1px solid var(--border-color);
            min-height: 100vh;
            background: var(--white);
        }

        .feed-header {
            position: sticky;
            top: 0;
            background: rgba(255, 255, 255, 0.98);
            backdrop-filter: blur(8px);
            padding: 0.75rem 1rem;
            border-bottom: 1px solid var(--border-color);
            z-index: 10;
            display: flex;
            align-items: center;
            justify-content: space-between;
        }

        .feed-header h1 {
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .badge-gold {
            background: linear-gradient(135deg, var(--gold), var(--gold-dark));
            color: var(--black);
            padding: 0.125rem 0.5rem;
            border-radius: 20px;
            font-size: var(--fs-xs);
            font-weight: 600;
        }

        .new-posts-indicator {
            background: var(--gold);
            color: var(--black);
            padding: 0.375rem 0.75rem;
            border-radius: 30px;
            font-size: var(--fs-xs);
            font-weight: 600;
            cursor: pointer;
            display: none;
            align-items: center;
            gap: 0.375rem;
            box-shadow: 0 2px 8px rgba(212, 175, 55, 0.25);
        }

        /* Compose Box */
        .compose-box {
            padding: 1rem;
            border-bottom: 1px solid var(--border-color);
            display: flex;
            gap: 0.75rem;
        }

        .compose-avatar {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            overflow: hidden;
            flex-shrink: 0;
        }

        .compose-avatar img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        .compose-area {
            flex: 1;
        }

        .compose-input {
            width: 100%;
            border: none;
            outline: none;
            font-size: var(--fs-md);
            padding: 0.5rem 0;
            resize: none;
            font-family: inherit;
            min-height: 60px;
        }

        .compose-input::placeholder {
            color: var(--gray-500);
        }

        .compose-preview {
            display: none;
            margin: 0.75rem 0;
            position: relative;
        }

        .compose-preview img {
            width: 100%;
            max-height: 280px;
            object-fit: cover;
            border-radius: 16px;
            border: 1px solid var(--border-color);
        }

        .remove-preview {
            position: absolute;
            top: 8px;
            right: 8px;
            background: rgba(0, 0, 0, 0.7);
            color: white;
            border: none;
            border-radius: 50%;
            width: 28px;
            height: 28px;
            cursor: pointer;
            font-size: var(--fs-sm);
        }

        .compose-actions {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-top: 0.5rem;
            padding-top: 0.5rem;
            border-top: 1px solid var(--border-color);
        }

        .compose-tools {
            display: flex;
            gap: 0.5rem;
        }

        .compose-tool {
            background: none;
            border: none;
            color: var(--gold-dark);
            font-size: 1rem;
            cursor: pointer;
            padding: 0.375rem;
            border-radius: 50%;
            width: 32px;
            height: 32px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .compose-tool:hover {
            background: var(--gold-light);
        }

        .compose-submit {
            background: linear-gradient(135deg, var(--gold), var(--gold-dark));
            color: var(--black);
            border: none;
            padding: 0.375rem 1rem;
            border-radius: 30px;
            font-weight: 600;
            font-size: var(--fs-sm);
            cursor: pointer;
        }

        .compose-submit:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        /* Categories */
        .categories {
            display: flex;
            gap: 0.25rem;
            padding: 0.5rem 1rem;
            overflow-x: auto;
            border-bottom: 1px solid var(--border-color);
            scrollbar-width: none;
        }

        .categories::-webkit-scrollbar {
            display: none;
        }

        .category-btn {
            padding: 0.375rem 0.75rem;
            border: 1px solid var(--border-color);
            border-radius: 30px;
            background: var(--white);
            color: var(--gray-700);
            font-weight: 500;
            font-size: var(--fs-xs);
            cursor: pointer;
            white-space: nowrap;
            transition: all 0.2s;
        }

        .category-btn:hover {
            background: var(--gray-100);
        }

        .category-btn.active {
            background: var(--gold);
            color: var(--black);
            border-color: var(--gold);
            font-weight: 600;
        }

        /* Posts */
        .posts-feed {
            padding-bottom: 1rem;
        }

        .post-card {
            padding: 1rem;
            border-bottom: 1px solid var(--border-color);
            transition: background 0.2s;
            cursor: pointer;
        }

        .post-card:hover {
            background: var(--gray-50);
        }

        .post-card.pinned {
            background: linear-gradient(135deg, #fefce8 0%, #fef3c7 100%);
        }

        .pinned-indicator {
            display: flex;
            align-items: center;
            gap: 0.375rem;
            color: var(--gold-dark);
            font-size: var(--fs-xs);
            margin-bottom: 0.5rem;
            font-weight: 600;
        }

        .post-header {
            display: flex;
            gap: 0.75rem;
            margin-bottom: 0.25rem;
            position: relative;
        }

        .post-avatar {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            overflow: hidden;
            border: 2px solid var(--gold-light);
            flex-shrink: 0;
        }

        .post-avatar img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        .post-info {
            flex: 1;
        }

        .post-row {
            display: flex;
            align-items: center;
            flex-wrap: wrap;
            gap: 0.25rem 0.375rem;
            margin-bottom: 0.125rem;
        }

        .post-author {
            font-weight: 600;
            font-size: var(--fs-sm);
            color: var(--gray-900);
        }

        .post-category {
            background: var(--gold-light);
            color: var(--gold-dark);
            padding: 0.125rem 0.375rem;
            border-radius: 12px;
            font-size: var(--fs-xs);
            font-weight: 600;
        }

        .post-time {
            font-size: var(--fs-xs);
            color: var(--gray-600);
        }

        .post-options-btn {
            position: absolute;
            top: 0;
            right: 0;
            background: none;
            border: none;
            color: var(--gray-500);
            padding: 0.375rem;
            border-radius: 50%;
            cursor: pointer;
        }

        .post-options-btn:hover {
            background: var(--gray-200);
            color: var(--gold-dark);
        }

        .post-options-dropdown {
            position: absolute;
            top: 32px;
            right: 0;
            background: var(--white);
            border-radius: 12px;
            box-shadow: 0 4px 16px rgba(0,0,0,0.1);
            min-width: 150px;
            z-index: 20;
            display: none;
            overflow: hidden;
            border: 1px solid var(--border-color);
        }

        .post-options-dropdown.active {
            display: block;
        }

        .post-option {
            padding: 0.5rem 0.75rem;
            display: flex;
            align-items: center;
            gap: 0.5rem;
            cursor: pointer;
            font-size: var(--fs-sm);
            color: var(--gray-700);
        }

        .post-option:hover {
            background: var(--gold-light);
            color: var(--gold-dark);
        }

        .post-option.delete {
            color: var(--error);
        }

        .post-content {
            margin-left: 52px;
            margin-bottom: 0.75rem;
        }

        .post-title {
            font-weight: 700;
            font-size: var(--fs-md);
            margin-bottom: 0.25rem;
            color: var(--gray-900);
        }

        .post-text {
            font-size: var(--fs-sm);
            color: var(--gray-700);
            white-space: pre-line;
            line-height: 1.5;
        }

        .post-media {
            margin: 0.75rem 0;
            border-radius: 12px;
            overflow: hidden;
            border: 1px solid var(--border-color);
        }

        .post-media img {
            width: 100%;
            max-height: 300px;
            object-fit: cover;
        }

        .post-tags {
            display: flex;
            flex-wrap: wrap;
            gap: 0.375rem;
            margin: 0.5rem 0;
        }

        .post-tag {
            color: var(--gold-dark);
            background: var(--gold-light);
            padding: 0.125rem 0.5rem;
            border-radius: 20px;
            font-size: var(--fs-xs);
            font-weight: 500;
        }

        .post-actions {
            display: flex;
            gap: 0.125rem;
            margin-left: 52px;
            margin-top: 0.5rem;
        }

        .post-action {
            display: flex;
            align-items: center;
            gap: 0.375rem;
            padding: 0.375rem 0.75rem;
            border: none;
            background: none;
            color: var(--gray-600);
            font-weight: 500;
            font-size: var(--fs-xs);
            cursor: pointer;
            border-radius: 30px;
            transition: all 0.2s;
        }

        .post-action:hover {
            background: var(--gray-100);
            color: var(--gold-dark);
        }

        .post-action.liked {
            color: var(--error);
        }

        .post-action.saved {
            color: var(--gold-dark);
        }

        /* Comments */
        .comments-section {
            margin-top: 0.75rem;
            padding-top: 0.75rem;
            border-top: 1px solid var(--border-color);
            display: none;
        }

        .comments-section.active {
            display: block;
        }

        .comments-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 0.75rem;
        }

        .comments-title {
            font-size: var(--fs-sm);
            font-weight: 600;
        }

        .close-comments {
            background: none;
            border: none;
            color: var(--gray-500);
            font-size: 1rem;
            cursor: pointer;
        }

        .comments-list {
            max-height: 300px;
            overflow-y: auto;
            margin-bottom: 0.75rem;
        }

        .comment-item {
            display: flex;
            gap: 0.5rem;
            margin-bottom: 0.75rem;
            padding: 0.5rem;
            background: var(--gray-50);
            border-radius: 8px;
        }

        .comment-avatar {
            width: 32px;
            height: 32px;
            border-radius: 50%;
            overflow: hidden;
            flex-shrink: 0;
        }

        .comment-avatar img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        .comment-content {
            flex: 1;
        }

        .comment-header {
            display: flex;
            align-items: center;
            gap: 0.375rem;
            margin-bottom: 0.125rem;
            flex-wrap: wrap;
        }

        .comment-author {
            font-weight: 600;
            font-size: var(--fs-xs);
        }

        .comment-time {
            font-size: var(--fs-xs);
            color: var(--gray-500);
        }

        .comment-text {
            font-size: var(--fs-xs);
            color: var(--gray-700);
        }

        .comment-form {
            display: flex;
            gap: 0.375rem;
            align-items: center;
        }

        .comment-input {
            flex: 1;
            padding: 0.5rem 0.75rem;
            border: 1px solid var(--border-color);
            border-radius: 30px;
            outline: none;
            font-size: var(--fs-xs);
        }

        .comment-input:focus {
            border-color: var(--gold);
        }

        .comment-submit {
            background: var(--gold);
            color: var(--black);
            border: none;
            width: 32px;
            height: 32px;
            border-radius: 50%;
            cursor: pointer;
        }

        /* Right Sidebar */
        .right-sidebar {
            width: var(--sidebar-width);
            position: sticky;
            top: 0;
            height: 100vh;
            padding: 0.75rem 1rem;
            overflow-y: auto;
        }

        .search-box {
            background: var(--gray-100);
            border-radius: 30px;
            padding: 0.5rem 0.75rem;
            display: flex;
            align-items: center;
            gap: 0.5rem;
            margin-bottom: 1rem;
        }

        .search-box i {
            color: var(--gray-500);
            font-size: var(--fs-sm);
        }

        .search-box input {
            background: none;
            border: none;
            outline: none;
            width: 100%;
            font-size: var(--fs-sm);
        }

        .card {
            background: var(--gray-50);
            border-radius: 16px;
            padding: 0.75rem;
            margin-bottom: 1rem;
        }

        .card-title {
            font-weight: 700;
            font-size: var(--fs-sm);
            margin-bottom: 0.75rem;
        }

        .trend-item {
            padding: 0.5rem 0;
            border-bottom: 1px solid var(--border-color);
        }

        .trend-item:last-child {
            border-bottom: none;
        }

        .trend-category {
            font-size: var(--fs-xs);
            color: var(--gray-600);
        }

        .trend-name {
            font-weight: 600;
            font-size: var(--fs-sm);
        }

        .trend-count {
            font-size: var(--fs-xs);
            color: var(--gray-600);
        }

        .follow-item {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            padding: 0.5rem 0;
            border-bottom: 1px solid var(--border-color);
        }

        .follow-item:last-child {
            border-bottom: none;
        }

        .follow-avatar {
            width: 36px;
            height: 36px;
            border-radius: 50%;
            overflow: hidden;
        }

        .follow-info {
            flex: 1;
        }

        .follow-name {
            font-weight: 600;
            font-size: var(--fs-xs);
        }

        .follow-handle {
            font-size: var(--fs-xs);
            color: var(--gray-600);
        }

        .follow-btn {
            background: var(--black);
            color: white;
            border: none;
            padding: 0.25rem 0.75rem;
            border-radius: 30px;
            font-weight: 500;
            font-size: var(--fs-xs);
            cursor: pointer;
        }

        .club-chip {
            display: inline-block;
            background: var(--white);
            padding: 0.25rem 0.5rem;
            border-radius: 30px;
            margin: 0.125rem;
            font-weight: 500;
            font-size: var(--fs-xs);
            border: 1px solid var(--border-color);
        }

        /* Mobile Navigation */
        .mobile-nav {
            display: none;
            position: fixed;
            bottom: 0;
            left: 0;
            width: 100%;
            background: rgba(255,255,255,0.98);
            backdrop-filter: blur(8px);
            border-top: 1px solid var(--border-color);
            padding: 0.375rem 0;
            z-index: 100;
        }

        .mobile-nav-items {
            display: flex;
            justify-content: space-around;
            align-items: center;
        }

        .mobile-nav-item {
            display: flex;
            flex-direction: column;
            align-items: center;
            color: var(--gray-600);
            text-decoration: none;
            font-size: var(--fs-xs);
            padding: 0.375rem;
        }

        .mobile-nav-item i {
            font-size: 1.25rem;
            margin-bottom: 0.125rem;
        }

        .mobile-nav-item.active {
            color: var(--gold-dark);
        }

        .mobile-post-btn {
            background: linear-gradient(135deg, var(--gold), var(--gold-dark));
            color: var(--black);
            width: 44px;
            height: 44px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.25rem;
            margin-top: -24px;
            box-shadow: 0 2px 8px rgba(212,175,55,0.3);
        }

        /* Modals */
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.85);
            z-index: 1000;
            justify-content: center;
            align-items: center;
            padding: 1rem;
        }

        .modal.active {
            display: flex;
        }

        .modal-content {
            background: var(--white);
            border-radius: 20px;
            width: 100%;
            max-width: 480px;
            max-height: 80vh;
            overflow: hidden;
            display: flex;
            flex-direction: column;
            animation: slideUp 0.3s ease;
        }

        @keyframes slideUp {
            from { transform: translateY(40px); opacity: 0; }
            to { transform: translateY(0); opacity: 1; }
        }

        .modal-header {
            background: linear-gradient(135deg, var(--gold), var(--gold-dark));
            color: var(--black);
            padding: 1rem;
            text-align: center;
            position: relative;
        }

        .modal-header h2 {
            font-size: var(--fs-lg);
        }

        .modal-header p {
            font-size: var(--fs-xs);
            color: var(--black);
            opacity: 0.9;
        }

        .close-modal {
            position: absolute;
            top: 0.75rem;
            right: 0.75rem;
            background: rgba(0,0,0,0.1);
            border: none;
            color: var(--black);
            width: 32px;
            height: 32px;
            border-radius: 50%;
            cursor: pointer;
            font-size: 1.25rem;
        }

        .modal-body {
            padding: 1rem;
            overflow-y: auto;
        }

        /* Onboarding */
        .steps {
            display: flex;
            justify-content: center;
            gap: 0.375rem;
            margin: 0.75rem 0;
        }

        .step-dot {
            width: 6px;
            height: 6px;
            border-radius: 50%;
            background: var(--gray-300);
            transition: all 0.3s;
        }

        .step-dot.active {
            width: 20px;
            border-radius: 10px;
            background: var(--gold);
        }

        .slide {
            display: none;
        }

        .slide.active {
            display: block;
        }

        .club-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 0.5rem;
            margin: 1rem 0;
        }

        .club-card {
            background: white;
            border: 1px solid var(--border-color);
            border-radius: 12px;
            padding: 0.75rem;
            text-align: center;
            cursor: pointer;
        }

        .club-card.selected {
            border-color: var(--gold);
            background: linear-gradient(135deg, rgba(212,175,55,0.05), rgba(212,175,55,0.1));
        }

        .club-icon {
            width: 36px;
            height: 36px;
            border-radius: 10px;
            background: linear-gradient(135deg, var(--gold-light), var(--gold));
            display: flex;
            align-items: center;
            justify-content: center;
            margin: 0 auto 0.5rem;
            font-size: var(--fs-sm);
        }

        .club-card h4 {
            font-size: var(--fs-sm);
            font-weight: 600;
        }

        .club-card p {
            font-size: var(--fs-xs);
        }

        .btn-primary {
            background: linear-gradient(135deg, var(--gold), var(--gold-dark));
            color: var(--black);
            border: none;
            padding: 0.5rem 1rem;
            border-radius: 30px;
            font-weight: 600;
            font-size: var(--fs-sm);
            cursor: pointer;
            width: 100%;
        }

        .btn-primary:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .btn-outline {
            background: transparent;
            border: 1px solid var(--border-color);
            padding: 0.5rem 1rem;
            border-radius: 30px;
            font-weight: 500;
            font-size: var(--fs-sm);
            cursor: pointer;
        }

        /* Toast */
        .toast {
            position: fixed;
            top: 70px;
            right: 16px;
            background: var(--gray-900);
            color: white;
            padding: 0.5rem 1rem;
            border-radius: 30px;
            z-index: 1000;
            font-size: var(--fs-xs);
            opacity: 0;
            transform: translateY(-20px);
            transition: all 0.3s;
            max-width: 280px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
        }

        .toast.show {
            opacity: 1;
            transform: translateY(0);
        }

        .toast.success {
            background: linear-gradient(135deg, var(--gold), var(--gold-dark));
            color: var(--black);
        }

        .toast.error {
            background: var(--error);
        }

        /* Back to Top */
        .back-to-top {
            position: fixed;
            bottom: 70px;
            right: 16px;
            width: 36px;
            height: 36px;
            background: linear-gradient(135deg, var(--gold), var(--gold-dark));
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            color: var(--black);
            cursor: pointer;
            opacity: 0;
            transform: translateY(20px);
            transition: all 0.3s;
            border: none;
            z-index: 99;
            font-size: var(--fs-sm);
        }

        .back-to-top.visible {
            opacity: 1;
            transform: translateY(0);
        }

        /* Session Status */
        .session-status {
            position: fixed;
            top: 10px;
            right: 10px;
            background: var(--gold);
            color: var(--black);
            padding: 0.375rem 0.75rem;
            border-radius: 30px;
            font-size: var(--fs-xs);
            font-weight: 500;
            z-index: 1000;
            display: none;
            align-items: center;
            gap: 0.375rem;
        }

        .session-status.visible {
            display: flex;
        }

        /* Loading */
        .loading-spinner {
            text-align: center;
            padding: 2rem;
        }

        .loading-spinner i {
            font-size: 1.5rem;
            color: var(--gold);
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .skeleton {
            padding: 1rem;
            border-bottom: 1px solid var(--border-color);
        }

        .skeleton-header {
            display: flex;
            gap: 0.5rem;
            margin-bottom: 0.75rem;
        }

        .skeleton-avatar {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background: linear-gradient(90deg, #f0f0f0 25%, #e0e0e0 50%, #f0f0f0 75%);
            background-size: 200% 100%;
            animation: loading 1.5s infinite;
        }

        .skeleton-line {
            height: 12px;
            background: linear-gradient(90deg, #f0f0f0 25%, #e0e0e0 50%, #f0f0f0 75%);
            background-size: 200% 100%;
            animation: loading 1.5s infinite;
            border-radius: 6px;
            margin-bottom: 0.375rem;
        }

        @keyframes loading {
            0% { background-position: 200% 0; }
            100% { background-position: -200% 0; }
        }

        .hidden {
            display: none !important;
        }

        /* Responsive */
        @media (max-width: 1024px) {
            .left-sidebar {
                width: 72px;
                padding: 0.75rem 0.5rem;
            }
            
            .logo span,
            .nav-item span:not(.nav-icon),
            .user-info,
            .post-btn-large span {
                display: none;
            }
            
            .nav-item {
                justify-content: center;
                padding: 0.625rem;
            }
            
            .nav-item i {
                margin: 0;
                font-size: 1.25rem;
            }
            
            .post-btn-large {
                padding: 0.625rem;
                justify-content: center;
            }
            
            .user-section {
                justify-content: center;
            }
        }

        @media (max-width: 768px) {
            .left-sidebar,
            .right-sidebar {
                display: none;
            }
            
            .mobile-nav {
                display: block;
            }
            
            .main-content {
                max-width: 100%;
                border-right: none;
                padding-bottom: var(--bottom-nav-height);
            }
            
            .post-content {
                margin-left: 0;
            }
            
            .post-actions {
                margin-left: 0;
                justify-content: space-around;
            }
            
            .post-action span {
                display: none;
            }
            
            .feed-header {
                padding: 0.5rem 0.75rem;
            }
        }
    </style>
</head>
<body>
    <!-- Session Status -->
    <div class="session-status" id="sessionStatus">
        <i class="fas fa-check-circle"></i>
        <span>Session restored</span>
    </div>

    <!-- Back to Top -->
    <button class="back-to-top" id="backToTop">
        <i class="fas fa-arrow-up"></i>
    </button>

    <!-- Toast Notification -->
    <div class="toast" id="toast"></div>

    <!-- App Wrapper -->
    <div class="app-wrapper">
        <!-- Left Sidebar -->
        <aside class="left-sidebar">
            <div class="logo">
                <img src="https://i.postimg.cc/BbdzCkxQ/20260116-0851-Elegant-Lion-Emblem-remix-01kf2npwbtf06ttr4htekjnd47-removebg-preview-2.webp" alt="THE SONGA">
                <span>SONGA</span>
            </div>

            <nav class="nav-menu" id="navMenu">
                <div class="nav-item active" data-page="home">
                    <i class="fas fa-home"></i>
                    <span>Home</span>
                </div>
                <div class="nav-item" data-page="explore">
                    <i class="fas fa-hashtag"></i>
                    <span>Explore</span>
                </div>
                <div class="nav-item" data-page="notifications" id="navNotifications">
                    <i class="fas fa-bell"></i>
                    <span>Notifications</span>
                    <span class="badge hidden" id="notificationBadge"></span>
                </div>
                <div class="nav-item" data-page="messages">
                    <i class="fas fa-envelope"></i>
                    <span>Messages</span>
                </div>
                <div class="nav-item" data-page="library">
                    <i class="fas fa-book"></i>
                    <span>Library</span>
                </div>
                <div class="nav-item" data-page="events">
                    <i class="fas fa-calendar-alt"></i>
                    <span>Events</span>
                </div>
                <div class="nav-item" data-page="profile" id="navProfile">
                    <i class="fas fa-user"></i>
                    <span>Profile</span>
                </div>

                <button class="post-btn-large" id="sidebarPostBtn">
                    <i class="fas fa-feather-alt"></i>
                    <span>Post</span>
                </button>
            </nav>

            <div class="user-section" id="userSection">
                <div class="user-avatar">
                    <img id="userAvatar" src="https://i.postimg.cc/BbdzCkxQ/20260116-0851-Elegant-Lion-Emblem-remix-01kf2npwbtf06ttr4htekjnd47-removebg-preview-2.webp" alt="">
                </div>
                <div class="user-info">
                    <div class="user-name" id="userName">Sign In</div>
                    <div class="user-handle" id="userHandle">@guest</div>
                </div>
                <i class="fas fa-ellipsis-h"></i>
            </div>

            <!-- User Dropdown -->
            <div class="post-options-dropdown" id="userDropdown" style="position: fixed; bottom: 70px; left: 16px;">
                <div class="post-option" id="profileOption">
                    <i class="fas fa-user-circle"></i>
                    <span>My Profile</span>
                </div>
                <div class="post-option" id="clubsOption">
                    <i class="fas fa-users"></i>
                    <span>My Clubs</span>
                </div>
                <div class="post-option" id="settingsOption">
                    <i class="fas fa-cog"></i>
                    <span>Settings</span>
                </div>
                <div class="post-option" id="signOutOption">
                    <i class="fas fa-sign-out-alt"></i>
                    <span>Sign Out</span>
                </div>
            </div>
        </aside>

        <!-- Main Content -->
        <main class="main-content">
            <div class="feed-header">
                <h1>
                    Home
                    <span class="badge-gold">Inner Circle</span>
                </h1>
                <div class="new-posts-indicator" id="newPostsIndicator">
                    <i class="fas fa-sync-alt"></i>
                    <span>New</span>
                </div>
            </div>

            <!-- Compose Box -->
            <div class="compose-box" id="composeBox">
                <div class="compose-avatar">
                    <img id="composeAvatar" src="https://i.postimg.cc/BbdzCkxQ/20260116-0851-Elegant-Lion-Emblem-remix-01kf2npwbtf06ttr4htekjnd47-removebg-preview-2.webp" alt="">
                </div>
                <div class="compose-area">
                    <textarea 
                        class="compose-input" 
                        id="composeInput" 
                        placeholder="What's happening?"
                        rows="1"
                        disabled
                    ></textarea>
                    
                    <div class="compose-preview" id="composePreview">
                        <img id="previewImage" src="" alt="Preview">
                        <button class="remove-preview" id="removePreview">
                            <i class="fas fa-times"></i>
                        </button>
                    </div>

                    <div class="compose-actions">
                        <div class="compose-tools">
                            <label for="imageUpload" class="compose-tool">
                                <i class="fas fa-image"></i>
                            </label>
                            <input type="file" id="imageUpload" accept="image/*" style="display: none;">
                            <button class="compose-tool" id="emojiBtn">
                                <i class="fas fa-smile"></i>
                            </button>
                        </div>
                        <button class="compose-submit" id="composeSubmit" disabled>
                            Post
                        </button>
                    </div>
                </div>
            </div>

            <!-- Categories -->
            <div class="categories" id="categories">
                <button class="category-btn active" data-category="all">For you</button>
                <button class="category-btn" data-category="announcement">Announcements</button>
                <button class="category-btn" data-category="event">Events</button>
                <button class="category-btn" data-category="discussion">Discussions</button>
                <button class="category-btn" data-category="resource">Resources</button>
            </div>

            <!-- Posts Feed -->
            <div class="posts-feed" id="postsFeed">
                <!-- Posts loaded from Firebase -->
            </div>
        </main>

        <!-- Right Sidebar -->
        <aside class="right-sidebar">
            <div class="search-box">
                <i class="fas fa-search"></i>
                <input type="text" placeholder="Search">
            </div>

            <!-- Trends -->
            <div class="card" id="trendsCard">
                <h3 class="card-title">Trends</h3>
                <div id="trendsList">
                    <!-- Loaded from Firebase -->
                </div>
            </div>

            <!-- Who to follow -->
            <div class="card" id="followCard">
                <h3 class="card-title">Who to follow</h3>
                <div id="followList">
                    <!-- Loaded from Firebase -->
                </div>
            </div>

            <!-- Your clubs -->
            <div class="card" id="clubsCard">
                <h3 class="card-title">Your clubs</h3>
                <div id="clubsList">
                    <!-- Loaded from Firebase -->
                </div>
            </div>

            <div class="text-xs" style="color: var(--gray-500); padding: 0.5rem 0;">
                ¬© 2026 THE SONGA
            </div>
        </aside>

        <!-- Mobile Navigation -->
        <nav class="mobile-nav">
            <div class="mobile-nav-items">
                <div class="mobile-nav-item active" data-page="home">
                    <i class="fas fa-home"></i>
                    <span>Home</span>
                </div>
                <div class="mobile-nav-item" data-page="explore">
                    <i class="fas fa-search"></i>
                    <span>Explore</span>
                </div>
                <div class="mobile-nav-item" id="mobilePostBtn">
                    <div class="mobile-post-btn">
                        <i class="fas fa-plus"></i>
                    </div>
                </div>
                <div class="mobile-nav-item" data-page="notifications">
                    <i class="fas fa-bell"></i>
                    <span>Alerts</span>
                </div>
                <div class="mobile-nav-item" data-page="profile">
                    <i class="fas fa-user"></i>
                    <span>Profile</span>
                </div>
            </div>
        </nav>
    </div>

    <!-- Sign In Modal -->
    <div class="modal" id="signinModal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>Join Inner Circle</h2>
                <p>UNBOUND | UNBENT | UNBROKEN</p>
                <button class="close-modal" id="closeSigninModal">&times;</button>
            </div>
            <div class="modal-body">
                <!-- Step 1 -->
                <div class="slide active" id="step1">
                    <h3 style="margin-bottom: 0.75rem;">Welcome</h3>
                    <p style="margin-bottom: 1rem;">Experience exclusive access to our members-only platform.</p>
                    
                    <div style="background: var(--gray-50); padding: 1rem; border-radius: 12px; margin-bottom: 1rem;">
                        <h4 style="margin-bottom: 0.5rem; color: var(--gold-dark);">Benefits:</h4>
                        <ul style="list-style: none; font-size: var(--fs-xs);">
                            <li style="margin-bottom: 0.375rem;">üìÖ Priority event updates</li>
                            <li style="margin-bottom: 0.375rem;">üìö Curated learning programs</li>
                            <li style="margin-bottom: 0.375rem;">üåü Talent development</li>
                            <li>ü§ù Exclusive networking</li>
                        </ul>
                    </div>
                    
                    <button class="btn-primary" id="startBtn">
                        Get Started <i class="fas fa-arrow-right"></i>
                    </button>
                </div>
                
                <!-- Step 2 -->
                <div class="slide" id="step2">
                    <h3 style="margin-bottom: 0.75rem;">Choose clubs</h3>
                    <p style="margin-bottom: 1rem; font-size: var(--fs-xs);">Select your interests:</p>
                    
                    <div class="club-grid">
                        <div class="club-card" data-club="logos">
                            <div class="club-icon"><i class="fas fa-book-open"></i></div>
                            <h4>Logos</h4>
                            <p>Reading</p>
                        </div>
                        <div class="club-card" data-club="workfit">
                            <div class="club-icon"><i class="fas fa-dumbbell"></i></div>
                            <h4>WorkFit</h4>
                            <p>Fitness</p>
                        </div>
                        <div class="club-card" data-club="talantae">
                            <div class="club-icon"><i class="fas fa-star"></i></div>
                            <h4>Talantae</h4>
                            <p>Talent</p>
                        </div>
                        <div class="club-card" data-club="stratum">
                            <div class="club-icon"><i class="fas fa-briefcase"></i></div>
                            <h4>Stratum</h4>
                            <p>Business</p>
                        </div>
                    </div>
                    
                    <div style="display: flex; gap: 0.5rem; margin-top: 1rem;">
                        <button class="btn-outline" id="backToStep1Btn" style="flex: 1;">Back</button>
                        <button class="btn-primary" id="continueBtn" style="flex: 1;" disabled>Continue</button>
                    </div>
                </div>
                
                <!-- Step 3 -->
                <div class="slide" id="step3">
                    <h3 style="margin-bottom: 0.75rem;">Sign in</h3>
                    <p style="margin-bottom: 1rem; font-size: var(--fs-xs);">Complete your membership</p>
                    
                    <div id="selectedClubsDisplay" style="margin: 1rem 0; padding: 0.75rem; background: var(--gray-50); border-radius: 8px;">
                        <h4 style="margin-bottom: 0.5rem; font-size: var(--fs-xs);">Your clubs:</h4>
                        <div id="selectedClubsList" style="display: flex; flex-wrap: wrap; gap: 0.25rem;"></div>
                    </div>
                    
                    <div style="margin: 1.5rem 0; text-align: center;">
                        <div id="g_id_onload"
                             data-client_id="123922889572-9dmjivsoese0b0o78poo5mgu7nqqm6e6.apps.googleusercontent.com"
                             data-context="signin"
                             data-ux_mode="popup"
                             data-callback="handleGoogleSignIn"
                             data-auto_prompt="false">
                        </div>
                        <div class="g_id_signin"
                             data-type="standard"
                             data-shape="rectangular"
                             data-theme="outline"
                             data-text="signin_with"
                             data-size="medium">
                        </div>
                    </div>
                    
                    <button class="btn-outline" id="backToStep2Btn" style="width: 100%;">Back</button>
                </div>
                
                <!-- Progress -->
                <div class="steps">
                    <div class="step-dot active" data-step="1"></div>
                    <div class="step-dot" data-step="2"></div>
                    <div class="step-dot" data-step="3"></div>
                </div>
            </div>
        </div>
    </div>

    <!-- Create Post Modal (Mobile) -->
    <div class="modal" id="createPostModal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>Create post</h2>
                <button class="close-modal" id="closeCreateModal">&times;</button>
            </div>
            <div class="modal-body">
                <textarea id="modalPostContent" class="compose-input" placeholder="What's happening?" rows="3" style="width: 100%; padding: 0.75rem; border: 1px solid var(--border-color); border-radius: 8px;"></textarea>
                
                <div style="margin: 0.75rem 0;">
                    <label for="modalImageUpload" style="display: flex; align-items: center; gap: 0.375rem; cursor: pointer; color: var(--gold-dark); font-size: var(--fs-xs);">
                        <i class="fas fa-image"></i> Add image
                    </label>
                    <input type="file" id="modalImageUpload" accept="image/*" style="display: none;">
                </div>
                
                <div class="compose-preview" id="modalPreview" style="display: none;">
                    <img id="modalPreviewImage" src="" style="width: 100%; border-radius: 8px;">
                    <button class="remove-preview" id="removeModalPreview">&times;</button>
                </div>
                
                <button class="btn-primary" id="submitModalPost" style="margin-top: 0.75rem;">Post</button>
            </div>
        </div>
    </div>

    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-database-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-storage-compat.js"></script>
    <script src="https://accounts.google.com/gsi/client" async defer></script>

    <script>
        // ==================== FIREBASE CONFIG ====================
        const firebaseConfig = {
            apiKey: "AIzaSyBDZicoo7dFLtSmgRPvQE_gdm-tNOyCTXA",
            authDomain: "the-songa-77b1b.firebaseapp.com",
            databaseURL: "https://the-songa-77b1b-default-rtdb.europe-west1.firebasedatabase.app",
            projectId: "the-songa-77b1b",
            storageBucket: "the-songa-77b1b.firebasestorage.app",
            messagingSenderId: "123922889572",
            appId: "1:123922889572:web:482b2a624930baaf92d871"
        };

        // Initialize Firebase
        let app, database, auth, storage;
        try {
            app = firebase.initializeApp(firebaseConfig);
            database = firebase.database();
            auth = firebase.auth();
            storage = firebase.storage();
            console.log('‚úÖ Firebase initialized');
        } catch (e) {
            console.error('‚ùå Firebase init error:', e);
        }

        // ==================== STATE ====================
        let currentUser = null;
        let currentUserData = null;
        let posts = [];
        let selectedClubs = [];
        let currentFilter = 'all';
        let postToDelete = null;
        let currentImageFile = null;
        let listeners = [];

        // DOM Elements
        const el = {
            sessionStatus: document.getElementById('sessionStatus'),
            backToTop: document.getElementById('backToTop'),
            toast: document.getElementById('toast'),
            
            // Sidebar
            userAvatar: document.getElementById('userAvatar'),
            userName: document.getElementById('userName'),
            userHandle: document.getElementById('userHandle'),
            userSection: document.getElementById('userSection'),
            userDropdown: document.getElementById('userDropdown'),
            signOutOption: document.getElementById('signOutOption'),
            profileOption: document.getElementById('profileOption'),
            clubsOption: document.getElementById('clubsOption'),
            sidebarPostBtn: document.getElementById('sidebarPostBtn'),
            notificationBadge: document.getElementById('notificationBadge'),
            
            // Compose
            composeAvatar: document.getElementById('composeAvatar'),
            composeInput: document.getElementById('composeInput'),
            composeSubmit: document.getElementById('composeSubmit'),
            imageUpload: document.getElementById('imageUpload'),
            composePreview: document.getElementById('composePreview'),
            previewImage: document.getElementById('previewImage'),
            removePreview: document.getElementById('removePreview'),
            
            // Feed
            postsFeed: document.getElementById('postsFeed'),
            newPostsIndicator: document.getElementById('newPostsIndicator'),
            categories: document.querySelectorAll('.category-btn'),
            
            // Right sidebar
            trendsList: document.getElementById('trendsList'),
            followList: document.getElementById('followList'),
            clubsList: document.getElementById('clubsList'),
            
            // Mobile
            mobilePostBtn: document.getElementById('mobilePostBtn'),
            mobileNavItems: document.querySelectorAll('.mobile-nav-item'),
            
            // Modals
            signinModal: document.getElementById('signinModal'),
            closeSigninModal: document.getElementById('closeSigninModal'),
            createPostModal: document.getElementById('createPostModal'),
            closeCreateModal: document.getElementById('closeCreateModal'),
            
            // Onboarding
            startBtn: document.getElementById('startBtn'),
            backToStep1Btn: document.getElementById('backToStep1Btn'),
            continueBtn: document.getElementById('continueBtn'),
            backToStep2Btn: document.getElementById('backToStep2Btn'),
            selectedClubsList: document.getElementById('selectedClubsList'),
            clubCards: document.querySelectorAll('.club-card'),
            stepDots: document.querySelectorAll('.step-dot'),
            slides: document.querySelectorAll('.slide'),
            
            // Modal post
            modalPostContent: document.getElementById('modalPostContent'),
            modalImageUpload: document.getElementById('modalImageUpload'),
            modalPreview: document.getElementById('modalPreview'),
            modalPreviewImage: document.getElementById('modalPreviewImage'),
            removeModalPreview: document.getElementById('removeModalPreview'),
            submitModalPost: document.getElementById('submitModalPost')
        };

        const clubs = {
            logos: { name: 'Logos', icon: 'fa-book-open', color: '#3498db' },
            workfit: { name: 'WorkFit', icon: 'fa-dumbbell', color: '#2ecc71' },
            talantae: { name: 'Talantae', icon: 'fa-star', color: '#9b59b6' },
            stratum: { name: 'Stratum', icon: 'fa-briefcase', color: '#e74c3c' }
        };

        // ==================== UTILITIES ====================
        function showToast(message, type = 'success', duration = 3000) {
            if (!el.toast) return;
            el.toast.textContent = message;
            el.toast.className = `toast show ${type}`;
            setTimeout(() => el.toast.classList.remove('show'), duration);
        }

        function showSessionStatus(message, type = 'restored') {
            if (!el.sessionStatus) return;
            el.sessionStatus.innerHTML = `<i class="fas fa-check-circle"></i><span>${message}</span>`;
            el.sessionStatus.className = `session-status visible ${type}`;
            setTimeout(() => el.sessionStatus.classList.remove('visible'), 3000);
        }

        function formatTime(timestamp) {
            if (!timestamp) return 'Just now';
            const now = new Date();
            const time = new Date(timestamp);
            const diff = Math.floor((now - time) / 1000);
            
            if (diff < 60) return 'Just now';
            if (diff < 3600) return `${Math.floor(diff / 60)}m`;
            if (diff < 86400) return `${Math.floor(diff / 3600)}h`;
            if (diff < 604800) return `${Math.floor(diff / 86400)}d`;
            return time.toLocaleDateString('en-US', { month: 'short', day: 'numeric' });
        }

        // ==================== AUTH ====================
        function checkAuth() {
            const stored = localStorage.getItem('songa_user');
            const token = localStorage.getItem('songa_token');
            const sessionTime = localStorage.getItem('songa_session_time');
            
            if (stored && token && sessionTime && (Date.now() - parseInt(sessionTime)) < 86400000) {
                try {
                    currentUser = JSON.parse(stored);
                    showSessionStatus('Session restored');
                    updateUIForUser();
                    
                    if (el.signinModal?.classList.contains('active')) {
                        el.signinModal.classList.remove('active');
                        document.body.classList.remove('modal-open');
                    }
                    
                    fetchUserData(currentUser.uid);
                    setupRealtimeListeners();
                    loadPostsFromFirebase();
                    loadTrendsFromFirebase();
                    loadSuggestionsFromFirebase();
                    return true;
                } catch (e) {
                    clearSession();
                    showSigninModal();
                    return false;
                }
            } else {
                clearSession();
                showSigninModal();
                loadPostsFromFirebase(); // Will show empty state
                return false;
            }
        }

        function saveSession(user, token) {
            localStorage.setItem('songa_user', JSON.stringify(user));
            localStorage.setItem('songa_token', token);
            localStorage.setItem('songa_session_time', Date.now().toString());
            localStorage.setItem('songa_clubs', JSON.stringify(selectedClubs));
        }

        function clearSession() {
            localStorage.removeItem('songa_user');
            localStorage.removeItem('songa_token');
            localStorage.removeItem('songa_session_time');
            localStorage.removeItem('songa_clubs');
            currentUser = null;
            currentUserData = null;
            
            listeners.forEach(off => off && off());
            listeners = [];
        }

        function updateUIForUser() {
            if (!currentUser) {
                // Guest state
                el.userAvatar.src = 'https://i.postimg.cc/BbdzCkxQ/20260116-0851-Elegant-Lion-Emblem-remix-01kf2npwbtf06ttr4htekjnd47-removebg-preview-2.webp';
                el.userName.textContent = 'Sign In';
                el.userHandle.textContent = '@guest';
                el.composeAvatar.src = 'https://i.postimg.cc/BbdzCkxQ/20260116-0851-Elegant-Lion-Emblem-remix-01kf2npwbtf06ttr4htekjnd47-removebg-preview-2.webp';
                el.composeInput.disabled = true;
                el.composeInput.placeholder = 'Sign in to post';
                return;
            }
            
            // Logged in user
            el.userAvatar.src = currentUser.picture || 'https://i.postimg.cc/BbdzCkxQ/20260116-0851-Elegant-Lion-Emblem-remix-01kf2npwbtf06ttr4htekjnd47-removebg-preview-2.webp';
            el.userName.textContent = currentUser.firstName || 'Member';
            el.userHandle.textContent = `@${(currentUser.firstName || 'user').toLowerCase()}`;
            el.composeAvatar.src = currentUser.picture || 'https://i.postimg.cc/BbdzCkxQ/20260116-0851-Elegant-Lion-Emblem-remix-01kf2npwbtf06ttr4htekjnd47-removebg-preview-2.webp';
            el.composeInput.disabled = false;
            el.composeInput.placeholder = "What's happening?";
        }

        async function fetchUserData(uid) {
            try {
                const snap = await database.ref(`users/${uid}`).once('value');
                if (snap.exists()) {
                    currentUserData = snap.val();
                    if (currentUserData.selectedClubs) {
                        selectedClubs = currentUserData.selectedClubs;
                    }
                    updateClubsList();
                }
            } catch (e) {
                console.error('Error fetching user data:', e);
            }
        }

        function showSigninModal() {
            if (el.signinModal) {
                el.signinModal.classList.add('active');
                document.body.classList.add('modal-open');
                resetOnboarding();
            }
        }

        function resetOnboarding() {
            selectedClubs = [];
            currentStep = 1;
            
            el.slides.forEach((slide, i) => {
                slide.classList.toggle('active', i === 0);
            });
            
            el.stepDots.forEach((dot, i) => {
                dot.classList.toggle('active', i === 0);
            });
            
            el.clubCards.forEach(card => card.classList.remove('selected'));
            if (el.continueBtn) el.continueBtn.disabled = true;
        }

        // ==================== ONBOARDING ====================
        let currentStep = 1;

        function goToStep(step) {
            currentStep = step;
            
            el.slides.forEach((slide, i) => {
                slide.classList.toggle('active', i + 1 === step);
            });
            
            el.stepDots.forEach((dot, i) => {
                dot.classList.toggle('active', i + 1 === step);
            });
            
            if (step === 3) updateSelectedClubsDisplay();
        }

        function toggleClub(card) {
            const club = card.dataset.club;
            const index = selectedClubs.indexOf(club);
            
            if (index === -1) {
                selectedClubs.push(club);
                card.classList.add('selected');
            } else {
                selectedClubs.splice(index, 1);
                card.classList.remove('selected');
            }
            
            if (el.continueBtn) {
                el.continueBtn.disabled = selectedClubs.length === 0;
            }
        }

        function updateSelectedClubsDisplay() {
            if (!el.selectedClubsList) return;
            
            el.selectedClubsList.innerHTML = selectedClubs.map(club => {
                const c = clubs[club];
                return `<span style="background: var(--gold-light); padding: 0.25rem 0.5rem; border-radius: 20px; font-size: var(--fs-xs);">
                    <i class="fas ${c.icon}" style="color: ${c.color};"></i> ${c.name}
                </span>`;
            }).join('');
        }

        // ==================== GOOGLE SIGN IN ====================
        window.handleGoogleSignIn = async function(response) {
            try {
                const credential = response.credential;
                const user = parseJwt(credential);
                
                currentUser = {
                    uid: user.sub,
                    email: user.email,
                    firstName: user.given_name,
                    lastName: user.family_name,
                    fullName: user.name,
                    picture: user.picture
                };
                
                saveSession(currentUser, credential);
                
                // Save to Firebase
                const userRef = database.ref(`users/${currentUser.uid}`);
                const snap = await userRef.once('value');
                
                if (!snap.exists()) {
                    await userRef.set({
                        uid: currentUser.uid,
                        email: currentUser.email,
                        firstName: currentUser.firstName,
                        lastName: currentUser.lastName,
                        profilePicture: currentUser.picture,
                        selectedClubs: selectedClubs,
                        joinedDate: new Date().toISOString(),
                        lastLogin: new Date().toISOString(),
                        membershipStatus: 'active',
                        membershipTier: 'inner-circle',
                        bookmarkedPosts: [],
                        followers: [],
                        following: []
                    });
                } else {
                    await userRef.update({
                        lastLogin: new Date().toISOString(),
                        selectedClubs: selectedClubs
                    });
                }
                
                updateUIForUser();
                
                el.signinModal.classList.remove('active');
                document.body.classList.remove('modal-open');
                
                showToast(`Welcome, ${currentUser.firstName}!`, 'success');
                
                // Load real data
                loadPostsFromFirebase();
                setupRealtimeListeners();
                loadTrendsFromFirebase();
                loadSuggestionsFromFirebase();
                
            } catch (e) {
                console.error('Sign in error:', e);
                showToast('Sign in failed', 'error');
            }
        };

        function parseJwt(token) {
            try {
                const base64Url = token.split('.')[1];
                const base64 = base64Url.replace(/-/g, '+').replace(/_/g, '/');
                return JSON.parse(atob(base64));
            } catch {
                return {};
            }
        }

        function signOut() {
            clearSession();
            updateUIForUser();
            showToast('Signed out', 'success');
            showSigninModal();
            loadPostsFromFirebase(); // Will show empty/guest view
        }

        // ==================== POSTS ====================
        function showSkeletons(count = 3) {
            let html = '';
            for (let i = 0; i < count; i++) {
                html += `
                    <div class="skeleton">
                        <div class="skeleton-header">
                            <div class="skeleton-avatar"></div>
                            <div style="flex: 1;">
                                <div class="skeleton-line" style="width: 40%;"></div>
                                <div class="skeleton-line" style="width: 30%;"></div>
                            </div>
                        </div>
                        <div class="skeleton-line" style="width: 90%;"></div>
                        <div class="skeleton-line" style="width: 80%;"></div>
                        <div class="skeleton-line" style="width: 85%;"></div>
                    </div>
                `;
            }
            el.postsFeed.innerHTML = html;
        }

        async function loadPostsFromFirebase() {
            if (!el.postsFeed) return;
            
            showSkeletons(3);
            
            try {
                const snap = await database.ref('communityPosts')
                    .orderByChild('createdAt')
                    .limitToLast(50)
                    .once('value');
                
                if (snap.exists()) {
                    const data = snap.val();
                    posts = Object.keys(data)
                        .map(key => ({ id: key, ...data[key] }))
                        .filter(p => p.status === 'published' || !p.status)
                        .sort((a, b) => new Date(b.createdAt || 0) - new Date(a.createdAt || 0));
                    
                    renderPosts(posts);
                    checkForNewPosts();
                } else {
                    renderEmptyState();
                }
            } catch (e) {
                console.error('Error loading posts:', e);
                renderEmptyState('Error loading posts. Please refresh.');
            }
        }

        function renderPosts(postsArray) {
            if (!el.postsFeed) return;
            
            if (!postsArray || postsArray.length === 0) {
                renderEmptyState();
                return;
            }
            
            const filtered = currentFilter === 'all' 
                ? postsArray 
                : postsArray.filter(p => p.category === currentFilter);
            
            if (filtered.length === 0) {
                renderEmptyState(`No ${currentFilter} posts yet`);
                return;
            }
            
            el.postsFeed.innerHTML = filtered.map(post => {
                const isLiked = currentUser && post.likedBy?.includes(currentUser.uid);
                const isSaved = currentUserData?.bookmarkedPosts?.includes(post.id);
                const isOwner = currentUser && post.authorId === currentUser.uid;
                
                return `
                    <div class="post-card ${post.isPinned ? 'pinned' : ''}" data-post-id="${post.id}" id="post-${post.id}">
                        ${post.isPinned ? `
                            <div class="pinned-indicator">
                                <i class="fas fa-thumbtack"></i>
                                <span>Pinned</span>
                            </div>
                        ` : ''}
                        
                        <div class="post-header">
                            <div class="post-avatar">
                                <img src="${post.authorAvatar || 'https://i.postimg.cc/BbdzCkxQ/20260116-0851-Elegant-Lion-Emblem-remix-01kf2npwbtf06ttr4htekjnd47-removebg-preview-2.webp'}" alt="">
                            </div>
                            <div class="post-info">
                                <div class="post-row">
                                    <span class="post-author">${post.authorName || 'Member'}</span>
                                    <span class="post-category">${post.category || 'post'}</span>
                                    <span class="post-time">¬∑ ${formatTime(post.createdAt)}</span>
                                    ${post.views ? `<span class="post-time">¬∑ ${post.views} views</span>` : ''}
                                    ${isOwner ? `
                                        <button class="post-options-btn" onclick="toggleOptions('${post.id}', event)">
                                            <i class="fas fa-ellipsis-h"></i>
                                        </button>
                                        <div class="post-options-dropdown" id="options-${post.id}">
                                            <div class="post-option delete" onclick="confirmDelete('${post.id}')">
                                                <i class="fas fa-trash-alt"></i> Delete
                                            </div>
                                        </div>
                                    ` : ''}
                                </div>
                            </div>
                        </div>
                        
                        <div class="post-content">
                            ${post.title ? `<div class="post-title">${post.title}</div>` : ''}
                            <div class="post-text">${post.content || ''}</div>
                            ${post.imageUrl ? `
                                <div class="post-media">
                                    <img src="${post.imageUrl}" onclick="viewImage('${post.imageUrl}')" loading="lazy">
                                </div>
                            ` : ''}
                            ${post.tags?.length ? `
                                <div class="post-tags">
                                    ${post.tags.map(t => `<span class="post-tag">#${t}</span>`).join('')}
                                </div>
                            ` : ''}
                        </div>
                        
                        <div class="post-actions">
                            <button class="post-action ${isLiked ? 'liked' : ''}" onclick="handleAction('${post.id}', 'like')">
                                <i class="fas fa-heart"></i>
                                <span>${post.likes || 0}</span>
                            </button>
                            <button class="post-action" onclick="handleAction('${post.id}', 'comment')">
                                <i class="fas fa-comment"></i>
                                <span>${post.comments || 0}</span>
                            </button>
                            <button class="post-action" onclick="handleAction('${post.id}', 'share')">
                                <i class="fas fa-retweet"></i>
                                <span>${post.shares || 0}</span>
                            </button>
                            <button class="post-action ${isSaved ? 'saved' : ''}" onclick="handleAction('${post.id}', 'save')">
                                <i class="fas fa-bookmark"></i>
                                <span>${post.bookmarks || 0}</span>
                            </button>
                        </div>
                        
                        <div class="comments-section" id="comments-${post.id}"></div>
                    </div>
                `;
            }).join('');
        }

        function renderEmptyState(message = 'No posts yet') {
            el.postsFeed.innerHTML = `
                <div style="text-align: center; padding: 3rem 1rem;">
                    <i class="fas fa-newspaper" style="font-size: 2.5rem; color: var(--gray-300); margin-bottom: 1rem;"></i>
                    <h3 style="font-size: var(--fs-md); margin-bottom: 0.5rem;">${message}</h3>
                    <p style="font-size: var(--fs-xs); color: var(--gray-500);">${currentUser ? 'Be the first to share something!' : 'Sign in to see posts from the community.'}</p>
                    ${currentUser ? '<button class="btn-primary" style="margin-top: 1rem; width: auto; padding: 0.5rem 1.5rem;" onclick="document.getElementById(\'composeInput\').focus()">Create post</button>' : ''}
                </div>
            `;
        }

        function checkForNewPosts() {
            const last = localStorage.getItem('songa_last_viewed');
            if (last) {
                const newPosts = posts.filter(p => new Date(p.createdAt) > new Date(parseInt(last)));
                if (newPosts.length > 0 && el.newPostsIndicator) {
                    el.newPostsIndicator.style.display = 'flex';
                    el.newPostsIndicator.querySelector('span').textContent = `${newPosts.length} new`;
                }
            }
        }

        // ==================== POST ACTIONS ====================
        window.handleAction = async function(postId, action) {
            if (!currentUser) {
                showToast('Please sign in', 'error');
                showSigninModal();
                return;
            }
            
            switch(action) {
                case 'like': await likePost(postId); break;
                case 'comment': toggleComments(postId); break;
                case 'share': await sharePost(postId); break;
                case 'save': await savePost(postId); break;
            }
        };

        async function likePost(postId) {
            try {
                const ref = database.ref(`communityPosts/${postId}`);
                const snap = await ref.once('value');
                const post = snap.val();
                if (!post) return;
                
                let liked = post.likedBy || [];
                let likes = post.likes || 0;
                
                if (liked.includes(currentUser.uid)) {
                    liked = liked.filter(id => id !== currentUser.uid);
                    likes--;
                } else {
                    liked.push(currentUser.uid);
                    likes++;
                    
                    if (post.authorId !== currentUser.uid) {
                        await createNotification(post.authorId, 'like', {
                            postId, postTitle: post.title,
                            userId: currentUser.uid, 
                            userName: currentUser.firstName,
                            userAvatar: currentUser.picture
                        });
                    }
                }
                
                await ref.update({ likedBy: liked, likes });
                
                // Update UI
                const btn = document.querySelector(`#post-${postId} .post-action:first-child span`);
                if (btn) btn.textContent = likes;
                
            } catch (e) {
                console.error('Like error:', e);
            }
        }

        async function sharePost(postId) {
            try {
                const ref = database.ref(`communityPosts/${postId}`);
                const snap = await ref.once('value');
                const post = snap.val();
                if (!post) return;
                
                const shares = (post.shares || 0) + 1;
                await ref.update({ shares });
                
                const btn = document.querySelector(`#post-${postId} .post-action:nth-child(3) span`);
                if (btn) btn.textContent = shares;
                
                showToast('Post shared!', 'success');
                
            } catch (e) {
                console.error('Share error:', e);
            }
        }

        async function savePost(postId) {
            try {
                const userRef = database.ref(`users/${currentUser.uid}`);
                const snap = await userRef.once('value');
                const user = snap.val();
                
                let bookmarks = user.bookmarkedPosts || [];
                
                if (bookmarks.includes(postId)) {
                    bookmarks = bookmarks.filter(id => id !== postId);
                    showToast('Removed from bookmarks');
                } else {
                    bookmarks.push(postId);
                    showToast('Added to bookmarks');
                }
                
                await userRef.update({ bookmarkedPosts: bookmarks });
                
                const postRef = database.ref(`communityPosts/${postId}`);
                const postSnap = await postRef.once('value');
                const post = postSnap.val();
                
                if (post) {
                    let count = post.bookmarks || 0;
                    count = bookmarks.includes(postId) ? count + 1 : Math.max(count - 1, 0);
                    await postRef.update({ bookmarks: count });
                    
                    const btn = document.querySelector(`#post-${postId} .post-action:last-child span`);
                    if (btn) btn.textContent = count;
                }
                
            } catch (e) {
                console.error('Save error:', e);
            }
        }

        async function toggleComments(postId) {
            const section = document.getElementById(`comments-${postId}`);
            if (!section) return;
            
            document.querySelectorAll('.comments-section.active').forEach(s => s.classList.remove('active'));
            
            if (!section.classList.contains('active')) {
                section.classList.add('active');
                await loadComments(postId);
            }
        }

        async function loadComments(postId) {
            const section = document.getElementById(`comments-${postId}`);
            if (!section) return;
            
            try {
                const snap = await database.ref(`comments/${postId}`)
                    .orderByChild('createdAt')
                    .limitToLast(20)
                    .once('value');
                
                if (snap.exists()) {
                    const comments = Object.values(snap.val()).reverse();
                    
                    section.innerHTML = `
                        <div class="comments-header">
                            <h4 class="comments-title">Comments</h4>
                            <button class="close-comments" onclick="toggleComments('${postId}')">&times;</button>
                        </div>
                        <div class="comments-list">
                            ${comments.map(c => `
                                <div class="comment-item">
                                    <div class="comment-avatar">
                                        <img src="${c.authorAvatar || 'https://i.postimg.cc/BbdzCkxQ/20260116-0851-Elegant-Lion-Emblem-remix-01kf2npwbtf06ttr4htekjnd47-removebg-preview-2.webp'}" loading="lazy">
                                    </div>
                                    <div class="comment-content">
                                        <div class="comment-header">
                                            <span class="comment-author">${c.authorName}</span>
                                            <span class="comment-time">${formatTime(c.createdAt)}</span>
                                        </div>
                                        <div class="comment-text">${c.text}</div>
                                    </div>
                                </div>
                            `).join('')}
                        </div>
                        ${currentUser ? `
                            <div class="comment-form">
                                <input type="text" class="comment-input" id="comment-${postId}" placeholder="Add a comment...">
                                <button class="comment-submit" onclick="submitComment('${postId}')">
                                    <i class="fas fa-paper-plane"></i>
                                </button>
                            </div>
                        ` : ''}
                    `;
                } else {
                    section.innerHTML = `
                        <div class="comments-header">
                            <h4 class="comments-title">Comments</h4>
                            <button class="close-comments" onclick="toggleComments('${postId}')">&times;</button>
                        </div>
                        <div style="text-align: center; padding: 1rem; color: var(--gray-500); font-size: var(--fs-xs);">
                            <p>No comments yet</p>
                        </div>
                        ${currentUser ? `
                            <div class="comment-form">
                                <input type="text" class="comment-input" id="comment-${postId}" placeholder="Add a comment...">
                                <button class="comment-submit" onclick="submitComment('${postId}')">
                                    <i class="fas fa-paper-plane"></i>
                                </button>
                            </div>
                        ` : ''}
                    `;
                }
            } catch (e) {
                console.error('Error loading comments:', e);
            }
        }

        window.submitComment = async function(postId) {
            if (!currentUser) return;
            
            const input = document.getElementById(`comment-${postId}`);
            const text = input?.value.trim();
            if (!text) return;
            
            try {
                const ref = database.ref(`comments/${postId}`).push();
                await ref.set({
                    id: ref.key,
                    postId,
                    authorId: currentUser.uid,
                    authorName: currentUser.firstName || 'Member',
                    authorAvatar: currentUser.picture,
                    text,
                    createdAt: new Date().toISOString()
                });
                
                const postRef = database.ref(`communityPosts/${postId}`);
                const snap = await postRef.once('value');
                const post = snap.val();
                
                if (post) {
                    const comments = (post.comments || 0) + 1;
                    await postRef.update({ comments });
                    
                    const btn = document.querySelector(`#post-${postId} .post-action:nth-child(2) span`);
                    if (btn) btn.textContent = comments;
                }
                
                input.value = '';
                await loadComments(postId);
                
            } catch (e) {
                console.error('Comment error:', e);
            }
        };

        window.toggleOptions = function(postId, e) {
            e.stopPropagation();
            document.querySelectorAll('.post-options-dropdown.active').forEach(d => d.classList.remove('active'));
            const opt = document.getElementById(`options-${postId}`);
            if (opt) opt.classList.toggle('active');
        };

        window.confirmDelete = function(postId) {
            postToDelete = postId;
            if (confirm('Delete this post? This cannot be undone.')) {
                deletePost();
            }
            closeOptions();
        };

        async function deletePost() {
            if (!postToDelete || !currentUser) return;
            
            try {
                await database.ref(`communityPosts/${postToDelete}`).remove();
                await database.ref(`comments/${postToDelete}`).remove();
                showToast('Post deleted', 'success');
                postToDelete = null;
            } catch (e) {
                console.error('Delete error:', e);
                showToast('Error deleting post', 'error');
            }
        }

        function closeOptions() {
            document.querySelectorAll('.post-options-dropdown.active').forEach(d => d.classList.remove('active'));
        }

        window.viewImage = function(url) {
            const modal = document.createElement('div');
            modal.className = 'modal active';
            modal.innerHTML = `
                <div class="modal-content" style="max-width: 90vw; background: transparent;">
                    <button class="close-modal" onclick="this.parentElement.parentElement.remove()">&times;</button>
                    <img src="${url}" style="width: 100%; border-radius: 8px;">
                </div>
            `;
            document.body.appendChild(modal);
            document.body.classList.add('modal-open');
        };

        // ==================== CREATE POST ====================
        function setupCompose() {
            if (!el.composeInput) return;
            
            el.composeInput.addEventListener('input', function() {
                this.style.height = 'auto';
                this.style.height = this.scrollHeight + 'px';
                if (el.composeSubmit) {
                    el.composeSubmit.disabled = !this.value.trim() && !currentImageFile;
                }
            });
            
            el.imageUpload?.addEventListener('change', handleImageSelect);
            
            el.removePreview?.addEventListener('click', () => {
                el.composePreview.style.display = 'none';
                el.imageUpload.value = '';
                currentImageFile = null;
                if (el.composeSubmit) {
                    el.composeSubmit.disabled = !el.composeInput.value.trim();
                }
            });
            
            el.composeSubmit?.addEventListener('click', submitPost);
            
            el.sidebarPostBtn?.addEventListener('click', () => {
                if (!currentUser) showSigninModal();
                else el.composeInput?.focus();
            });
            
            el.mobilePostBtn?.addEventListener('click', () => {
                if (!currentUser) showSigninModal();
                else openCreateModal();
            });
        }

        function handleImageSelect(e) {
            const file = e.target.files[0];
            if (!file) return;
            
            if (file.size > 10 * 1024 * 1024) {
                showToast('Image too large (max 10MB)', 'error');
                return;
            }
            
            if (!file.type.startsWith('image/')) {
                showToast('Please select an image', 'error');
                return;
            }
            
            currentImageFile = file;
            
            const reader = new FileReader();
            reader.onload = (e) => {
                el.previewImage.src = e.target.result;
                el.composePreview.style.display = 'block';
                if (el.composeSubmit) el.composeSubmit.disabled = false;
            };
            reader.readAsDataURL(file);
        }

        async function submitPost() {
            if (!currentUser) {
                showSigninModal();
                return;
            }
            
            const content = el.composeInput?.value.trim();
            if (!content && !currentImageFile) return;
            
            try {
                el.composeSubmit.disabled = true;
                el.composeSubmit.textContent = 'Posting...';
                
                let imageUrl = null;
                if (currentImageFile && storage) {
                    const ref = storage.ref().child(`posts/${Date.now()}_${currentImageFile.name}`);
                    await ref.put(currentImageFile);
                    imageUrl = await ref.getDownloadURL();
                }
                
                const postRef = database.ref('communityPosts').push();
                await postRef.set({
                    id: postRef.key,
                    authorId: currentUser.uid,
                    authorName: currentUser.firstName || 'Member',
                    authorAvatar: currentUser.picture,
                    content,
                    imageUrl,
                    category: 'discussion',
                    likes: 0,
                    likedBy: [],
                    comments: 0,
                    shares: 0,
                    bookmarks: 0,
                    views: 0,
                    createdAt: new Date().toISOString(),
                    status: 'published'
                });
                
                // Reset compose
                el.composeInput.value = '';
                el.composeInput.style.height = 'auto';
                el.composePreview.style.display = 'none';
                el.imageUpload.value = '';
                currentImageFile = null;
                
                showToast('Post published!', 'success');
                
            } catch (e) {
                console.error('Post error:', e);
                showToast('Error publishing post', 'error');
            } finally {
                el.composeSubmit.disabled = false;
                el.composeSubmit.textContent = 'Post';
            }
        }

        function openCreateModal() {
            if (!currentUser) {
                showSigninModal();
                return;
            }
            
            el.createPostModal?.classList.add('active');
            document.body.classList.add('modal-open');
        }

        function closeCreateModal() {
            el.createPostModal?.classList.remove('active');
            document.body.classList.remove('modal-open');
            el.modalPostContent.value = '';
            el.modalPreview.style.display = 'none';
        }

        // ==================== NOTIFICATIONS ====================
        async function createNotification(userId, type, data) {
            try {
                const ref = database.ref(`notifications/${userId}`).push();
                await ref.set({
                    id: ref.key,
                    type,
                    data,
                    read: false,
                    timestamp: new Date().toISOString()
                });
            } catch (e) {
                console.error('Notification error:', e);
            }
        }

        // ==================== TRENDS ====================
        async function loadTrendsFromFirebase() {
            if (!el.trendsList) return;
            
            try {
                // Get trending hashtags from posts
                const snap = await database.ref('communityPosts')
                    .orderByChild('createdAt')
                    .limitToLast(100)
                    .once('value');
                
                if (snap.exists()) {
                    const posts = Object.values(snap.val());
                    const tagCount = {};
                    
                    posts.forEach(post => {
                        if (post.tags) {
                            post.tags.forEach(tag => {
                                tagCount[tag] = (tagCount[tag] || 0) + 1;
                            });
                        }
                    });
                    
                    const trends = Object.entries(tagCount)
                        .sort((a, b) => b[1] - a[1])
                        .slice(0, 5);
                    
                    if (trends.length > 0) {
                        el.trendsList.innerHTML = trends.map(([tag, count]) => `
                            <div class="trend-item">
                                <div class="trend-category">Trending</div>
                                <div class="trend-name">#${tag}</div>
                                <div class="trend-count">${count} posts</div>
                            </div>
                        `).join('');
                    } else {
                        el.trendsList.innerHTML = '<div class="trend-item"><span class="text-sm">No trends yet</span></div>';
                    }
                } else {
                    el.trendsList.innerHTML = '<div class="trend-item"><span class="text-sm">No trends yet</span></div>';
                }
            } catch (e) {
                console.error('Error loading trends:', e);
                el.trendsList.innerHTML = '<div class="trend-item"><span class="text-sm">Error loading trends</span></div>';
            }
        }

        async function loadSuggestionsFromFirebase() {
            if (!el.followList) return;
            
            try {
                const snap = await database.ref('users')
                    .orderByChild('joinedDate')
                    .limitToFirst(5)
                    .once('value');
                
                if (snap.exists()) {
                    const users = Object.values(snap.val())
                        .filter(u => !currentUser || u.uid !== currentUser.uid)
                        .slice(0, 3);
                    
                    if (users.length > 0) {
                        el.followList.innerHTML = users.map(user => `
                            <div class="follow-item">
                                <div class="follow-avatar">
                                    <img src="${user.profilePicture || 'https://i.postimg.cc/BbdzCkxQ/20260116-0851-Elegant-Lion-Emblem-remix-01kf2npwbtf06ttr4htekjnd47-removebg-preview-2.webp'}" loading="lazy">
                                </div>
                                <div class="follow-info">
                                    <div class="follow-name">${user.firstName || 'Member'}</div>
                                    <div class="follow-handle">@${(user.firstName || 'user').toLowerCase()}</div>
                                </div>
                                <button class="follow-btn" onclick="followUser('${user.uid}')">Follow</button>
                            </div>
                        `).join('');
                    } else {
                        el.followList.innerHTML = '<div class="follow-item"><span class="text-sm">No suggestions</span></div>';
                    }
                } else {
                    el.followList.innerHTML = '<div class="follow-item"><span class="text-sm">No suggestions</span></div>';
                }
            } catch (e) {
                console.error('Error loading suggestions:', e);
                el.followList.innerHTML = '<div class="follow-item"><span class="text-sm">Error loading</span></div>';
            }
        }

        function updateClubsList() {
            if (!el.clubsList) return;
            
            if (selectedClubs.length > 0) {
                el.clubsList.innerHTML = selectedClubs.map(club => {
                    const c = clubs[club];
                    return `<span class="club-chip"><i class="fas ${c.icon}" style="color: ${c.color};"></i> ${c.name}</span>`;
                }).join('');
            } else {
                el.clubsList.innerHTML = '<span class="text-sm" style="color: var(--gray-500);">Join clubs to see them here</span>';
            }
        }

        // ==================== REALTIME LISTENERS ====================
        function setupRealtimeListeners() {
            if (!currentUser || !database) return;
            
            // Notifications listener
            const notifListener = database.ref(`notifications/${currentUser.uid}`)
                .limitToLast(20)
                .on('value', (snap) => {
                    if (snap.exists()) {
                        const unread = Object.values(snap.val()).filter(n => !n.read).length;
                        if (el.notificationBadge) {
                            el.notificationBadge.textContent = unread > 99 ? '99+' : unread;
                            el.notificationBadge.classList.toggle('hidden', unread === 0);
                        }
                    }
                });
            
            listeners.push(() => database.ref(`notifications/${currentUser.uid}`).off('value', notifListener));
            
            // Posts listener
            const postListener = database.ref('communityPosts')
                .orderByChild('createdAt')
                .limitToLast(50)
                .on('value', (snap) => {
                    if (snap.exists()) {
                        const data = snap.val();
                        posts = Object.keys(data)
                            .map(k => ({ id: k, ...data[k] }))
                            .filter(p => p.status === 'published' || !p.status)
                            .sort((a, b) => new Date(b.createdAt || 0) - new Date(a.createdAt || 0));
                        
                        renderPosts(posts);
                        checkForNewPosts();
                    }
                });
            
            listeners.push(() => database.ref('communityPosts').off('value', postListener));
        }

        // ==================== EVENT LISTENERS ====================
        function initEventListeners() {
            // Back to top
            window.addEventListener('scroll', () => {
                if (window.scrollY > 300) {
                    el.backToTop?.classList.add('visible');
                } else {
                    el.backToTop?.classList.remove('visible');
                }
            });
            
            el.backToTop?.addEventListener('click', () => {
                window.scrollTo({ top: 0, behavior: 'smooth' });
            });
            
            // User dropdown
            el.userSection?.addEventListener('click', (e) => {
                e.stopPropagation();
                if (!currentUser) {
                    showSigninModal();
                } else {
                    el.userDropdown?.classList.toggle('active');
                }
            });
            
            document.addEventListener('click', () => {
                el.userDropdown?.classList.remove('active');
                closeOptions();
            });
            
            // Sign out
            el.signOutOption?.addEventListener('click', signOut);
            
            // Close modals
            el.closeSigninModal?.addEventListener('click', () => {
                el.signinModal.classList.remove('active');
                document.body.classList.remove('modal-open');
            });
            
            el.closeCreateModal?.addEventListener('click', closeCreateModal);
            
            // Onboarding
            el.startBtn?.addEventListener('click', () => goToStep(2));
            el.backToStep1Btn?.addEventListener('click', () => goToStep(1));
            el.backToStep2Btn?.addEventListener('click', () => goToStep(2));
            el.continueBtn?.addEventListener('click', () => goToStep(3));
            
            // Club selection
            el.clubCards.forEach(card => {
                card.addEventListener('click', () => toggleClub(card));
            });
            
            // Category filters
            el.categories.forEach(btn => {
                btn.addEventListener('click', () => {
                    el.categories.forEach(b => b.classList.remove('active'));
                    btn.classList.add('active');
                    currentFilter = btn.dataset.category;
                    renderPosts(posts);
                });
            });
            
            // New posts indicator
            el.newPostsIndicator?.addEventListener('click', () => {
                localStorage.setItem('songa_last_viewed', Date.now().toString());
                el.newPostsIndicator.style.display = 'none';
                window.scrollTo({ top: 0, behavior: 'smooth' });
            });
            
            // Mobile nav
            el.mobileNavItems.forEach(item => {
                item.addEventListener('click', () => {
                    el.mobileNavItems.forEach(i => i.classList.remove('active'));
                    item.classList.add('active');
                });
            });
            
            // Modal image upload
            el.modalImageUpload?.addEventListener('change', (e) => {
                const file = e.target.files[0];
                if (file) {
                    if (file.size > 10 * 1024 * 1024) {
                        showToast('Image too large', 'error');
                        return;
                    }
                    const reader = new FileReader();
                    reader.onload = (e) => {
                        el.modalPreviewImage.src = e.target.result;
                        el.modalPreview.style.display = 'block';
                    };
                    reader.readAsDataURL(file);
                }
            });
            
            el.removeModalPreview?.addEventListener('click', () => {
                el.modalPreview.style.display = 'none';
                el.modalImageUpload.value = '';
            });
            
            el.submitModalPost?.addEventListener('click', async () => {
                const content = el.modalPostContent?.value.trim();
                if (!content) return;
                
                try {
                    el.submitModalPost.disabled = true;
                    el.submitModalPost.textContent = 'Posting...';
                    
                    let imageUrl = null;
                    const file = el.modalImageUpload?.files[0];
                    if (file && storage) {
                        const ref = storage.ref().child(`posts/${Date.now()}_${file.name}`);
                        await ref.put(file);
                        imageUrl = await ref.getDownloadURL();
                    }
                    
                    const postRef = database.ref('communityPosts').push();
                    await postRef.set({
                        id: postRef.key,
                        authorId: currentUser.uid,
                        authorName: currentUser.firstName || 'Member',
                        authorAvatar: currentUser.picture,
                        content,
                        imageUrl,
                        category: 'discussion',
                        likes: 0,
                        likedBy: [],
                        comments: 0,
                        shares: 0,
                        bookmarks: 0,
                        views: 0,
                        createdAt: new Date().toISOString(),
                        status: 'published'
                    });
                    
                    closeCreateModal();
                    showToast('Post published!', 'success');
                    
                } catch (e) {
                    console.error('Error:', e);
                    showToast('Error publishing post', 'error');
                } finally {
                    el.submitModalPost.disabled = false;
                    el.submitModalPost.textContent = 'Post';
                }
            });
            
            // Close modals on outside click
            document.querySelectorAll('.modal').forEach(modal => {
                modal.addEventListener('click', (e) => {
                    if (e.target === modal) {
                        modal.classList.remove('active');
                        document.body.classList.remove('modal-open');
                    }
                });
            });
        }

        // ==================== INIT ====================
        function init() {
            checkAuth();
            setupCompose();
            initEventListeners();
            
            // Load data from Firebase (will show empty states if none)
            loadPostsFromFirebase();
            loadTrendsFromFirebase();
            loadSuggestionsFromFirebase();
        }

        document.addEventListener('DOMContentLoaded', init);
    </script>
</body>
</html>
